import{t as l}from"./index-SvB4RLMK.js";import{d as q}from"./debounce-BLSYdMKs.js";import{r as $,c as f,p as J}from"./app-B19RVYzd.js";function B(c,b){const{url:v,resourceId:p=null,resourceIdField:A="candidatura_id",debounceTime:F=3e3,showNotifications:i=!0,useLocalStorage:m=!0,localStorageKey:d="draft",additionalData:S={}}=b,r=$({status:"idle",lastSaved:null,lastError:null,resourceId:p}),O=f(()=>r.value.status==="saving"),R=f(()=>r.value.lastSaved!==null),L=f(()=>r.value.status==="error"),h=()=>{if(m)try{const e={data:c.value,timestamp:new Date().toISOString(),resourceId:r.value.resourceId,additionalData:S};localStorage.setItem(d,JSON.stringify(e))}catch(e){console.error("Error guardando en localStorage:",e)}},x=()=>{if(!m)return null;try{const e=localStorage.getItem(d);if(e){const t=JSON.parse(e),s=new Date(t.timestamp);if((Date.now()-s.getTime())/(1e3*60*60)<24)return t;localStorage.removeItem(d)}}catch(e){console.error("Error cargando desde localStorage:",e)}return null},w=()=>{m&&localStorage.removeItem(d)},D=async()=>{try{const e=await fetch(window.location.href,{method:"GET",credentials:"same-origin"});if(e.ok){const t=await e.text(),o=new DOMParser().parseFromString(t,"text/html").querySelector('meta[name="csrf-token"]');if(o){const u=o.getAttribute("content"),y=document.querySelector('meta[name="csrf-token"]');if(y&&u)return y.setAttribute("content",u),u}}}catch(e){console.error("Error renovando token CSRF:",e)}return null},E=async(e,t,s=0)=>{const a=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":t,Accept:"application/json"},credentials:"same-origin",body:JSON.stringify({...S,formulario_data:c.value,respuestas:c.value})});if(a.status===419&&s<1){const o=await D();if(o)return i&&l.info("Renovando sesión...",{description:"Se detectó una sesión expirada, renovando automáticamente",duration:2e3}),E(e,o,s+1)}return a},I=async()=>{var e;if(r.value.status!=="saving"&&!(!c.value||Object.keys(c.value).length===0)){r.value.status="saving",r.value.lastError=null;try{const t=r.value.resourceId?v.replace("autosave",`${r.value.resourceId}/autosave`):v,s=((e=document.querySelector('meta[name="csrf-token"]'))==null?void 0:e.getAttribute("content"))||"";if(!s)throw new Error("Token CSRF no encontrado");const a=await E(t,s);if(!a.ok)throw new Error(`Error ${a.status}: ${a.statusText}`);const o=await a.json();if(o.success){if(r.value.status="saved",r.value.lastSaved=new Date,!r.value.resourceId){const u=o[A]||o.respuesta_id||o.candidatura_id||o.id;u&&(r.value.resourceId=u)}h(),i&&l.success("Cambios guardados",{description:`Autoguardado a las ${o.timestamp||new Date().toLocaleTimeString()}`,duration:2e3})}else throw new Error(o.message||"Error al guardar")}catch(t){r.value.status="error",r.value.lastError=t instanceof Error?t.message:"Error desconocido",h(),t instanceof Error&&t.message.includes("419")?i&&l.warning("Sesión expirada",{description:"Recarga la página para continuar. Los cambios se guardaron localmente.",duration:5e3}):i&&l.error("Error al guardar",{description:"Los cambios se guardaron localmente",duration:3e3}),console.error("Error en autoguardado:",t)}}},g=q(I,F),N=()=>(g.cancel(),I());let n=null;const _=()=>(n&&n(),n=J(c,()=>{r.value.status!=="error"&&g()},{deep:!0}),n),T=()=>{g.cancel(),n&&(n(),n=null)},k=T,C=()=>{k(),r.value={status:"idle",lastSaved:null,lastError:null,resourceId:p},w()},j=()=>{const e=x();return e&&(e.data||e.formulario_data)?(i&&l.info("Borrador recuperado",{description:"Se recuperaron los cambios no guardados",duration:3e3}),{...e,data:e.data||e.formulario_data}):null};return{state:f(()=>r.value),isSaving:O,hasSaved:R,hasError:L,saveNow:N,startWatching:_,stopWatching:T,stopAutoSave:k,reset:C,restoreDraft:j,clearLocalStorage:w}}export{B as u};
