import{a as L,_ as P}from"./index-BaCJCCFv.js";import{_ as I}from"./AlertTitle.vue_vue_type_script_setup_true_lang-D9JrfKQx.js";import{_ as w}from"./createLucideIcon-BfVy0SFr.js";import{a as A,b as M,c as D,_ as j}from"./CardTitle.vue_vue_type_script_setup_true_lang-CfXCxct6.js";import{_ as B}from"./CardDescription.vue_vue_type_script_setup_true_lang-R8khDAHy.js";import{t as S}from"./index-DlY_kZJS.js";import{d as re,k as v,c as _,p as oe,O as le,a as k,o as n,f as u,i as p,j as c,b as s,u as a,e as t,n as ne,g as l,t as x,q as G}from"./app-DDSU5uN7.js";import{V as O}from"./video-Cui6UdLq.js";import{R as F}from"./refresh-cw-D_dnlNAp.js";import{L as U}from"./loader-circle-DsF-i-yL.js";import{C as Z}from"./index-BTN_CKnm.js";import{C as ie}from"./circle-check-nrwGFM4x.js";import{C as J}from"./clock-DFrTRM55.js";import{E as ue}from"./external-link-C7eqqddT.js";import{_ as de}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./Input.vue_vue_type_script_setup_true_lang-DloUOX4w.js";const ce={class:"space-y-4"},me={class:"flex items-center gap-2 mb-4"},fe={key:0,class:"text-center py-8"},ge={key:2},pe={class:"flex gap-2"},ve={key:0},_e={class:"text-sm"},xe={key:1},be={class:"text-sm font-mono bg-gray-50 px-2 py-1 rounded"},ye={class:"pt-2"},we={key:0,class:"mb-3"},ke={class:"flex gap-2"},Ee=5*60*1e3,Ce=re({__name:"ZoomApiMeeting",props:{asambleaId:{}},setup(Y){const R=Y,f=v(!1),b=v(!1),m=v(!1),y=v(null),N=v(null),d=v(null),i=v(null),{route:T}=window,E=async(r=!1)=>{try{r||(f.value=!0),d.value=null;const o=(await G.get(T("api.zoom.registrants.status",R.asambleaId))).data;o.success?(m.value&&!o.existing_registration&&!o.processing&&(o.processing=!0),i.value=o,o.existing_registration&&o.existing_registration.status==="completed"||o.existing_registration&&o.existing_registration.status==="failed"?C():(o.processing||m.value)&&(y.value||q())):d.value=o.error||"Error obteniendo estado"}catch(e){console.error("Error fetching status:",e),d.value="Error de conexiÃ³n"}finally{f.value=!1}},h=async()=>{d.value=null,i.value.existing_registration=null,await H()},H=async()=>{var r,e;try{b.value=!0,d.value=null;const o=await G.post(T("api.zoom.registrants.register"),{asamblea_id:R.asambleaId});o.data.success?o.data.processing?(m.value=!0,i.value=o.data,q(),S.success("ðŸ”„ Procesando registro",{description:"Se estÃ¡ generando tu enlace de videoconferencia...",duration:4e3})):await E():d.value=o.data.error||"Error registrando usuario"}catch(o){console.error("Error registering user:",o),(e=(r=o.response)==null?void 0:r.data)!=null&&e.error?d.value=o.response.data.error:d.value="Error de conexiÃ³n"}finally{b.value=!1}},K=async()=>{try{f.value=!0,d.value=null;const e=(await G.delete(T("api.zoom.registrants.destroy",R.asambleaId))).data;e.success?await E():d.value=e.error||"Error cancelando registro"}catch(r){console.error("Error canceling registration:",r),d.value="Error de conexiÃ³n"}finally{f.value=!1}},Q=async()=>{var r,e;try{(await G.post(T("asambleas.marcar-asistencia",R.asambleaId))).data.success&&S.success("âœ… Asistencia registrada",{description:"Tu asistencia ha sido marcada exitosamente",duration:3e3})}catch(o){console.error("Error marcando asistencia:",o),((r=o.response)==null?void 0:r.status)===400?S.warning("La asamblea no estÃ¡ en curso",{duration:3e3}):((e=o.response)==null?void 0:e.status)===403?S.error("No eres participante de esta asamblea",{duration:3e3}):S.error("Error al registrar asistencia",{description:"Tu asistencia no pudo ser registrada, pero puedes unirte a la reuniÃ³n",duration:4e3})}},W=async()=>{var r;await Q(),(r=g.value)!=null&&r.zoom_join_url&&window.open(g.value.zoom_join_url,"_blank","noopener,noreferrer")},q=()=>{C(),N.value=Date.now(),y.value=setInterval(async()=>{try{if(N.value&&Date.now()-N.value>Ee){console.warn("Polling timeout alcanzado (5 minutos)"),d.value="El proceso estÃ¡ tomando mÃ¡s tiempo del esperado. Por favor, recarga la pÃ¡gina.",C();return}await E(!0)}catch(r){console.error("Error en polling:",r)}},2e3)},C=()=>{y.value&&(clearInterval(y.value),y.value=null),N.value=null,m.value=!1},g=_(()=>{var e;if(!((e=i.value)!=null&&e.existing_registration))return null;const r=i.value.existing_registration;return{...r,statusColor:r.status==="completed"?"bg-green-100 text-green-800":r.status==="pending"?"bg-yellow-100 text-yellow-800":r.status==="failed"?"bg-red-100 text-red-800":"bg-gray-100 text-gray-800"}}),V=_(()=>{var r,e;return((e=(r=i.value)==null?void 0:r.existing_registration)==null?void 0:e.status)==="failed"}),X=_(()=>{var e,o;if(!V.value)return null;const r=((o=(e=i.value)==null?void 0:e.existing_registration)==null?void 0:o.error_message)||"Error desconocido al registrar";return r.toLowerCase().includes("rate limit")?"Se ha alcanzado el lÃ­mite diario de registros. Por favor, intenta nuevamente maÃ±ana.":r}),ee=_(()=>{var o,z;if(!V.value)return!1;const r=((z=(o=i.value)==null?void 0:o.existing_registration)==null?void 0:z.error_message)||"";return!["no existe","capacidad mÃ¡xima","no tiene permisos"].some($=>r.toLowerCase().includes($))}),ae=_(()=>{var r,e,o;return V.value?!1:((r=i.value)==null?void 0:r.can_register)&&!((e=i.value)!=null&&e.existing_registration)&&!m.value&&!((o=i.value)!=null&&o.processing)}),se=_(()=>{var o,z,$;const r=(o=i.value)==null?void 0:o.existing_registration,e=(($=(z=i.value)==null?void 0:z.asamblea)==null?void 0:$.estado)==="en_curso";return r&&r.status==="completed"&&r.zoom_join_url&&e}),te=_(()=>{var r,e;return((e=(r=i.value)==null?void 0:r.asamblea)==null?void 0:e.estado)==="en_curso"});return oe(()=>{E()}),le(()=>{C()}),(r,e)=>(n(),k("div",ce,[u("div",me,[s(a(O),{class:"h-5 w-5 text-blue-600"}),e[0]||(e[0]=u("h3",{class:"text-lg font-semibold"},"Videoconferencia",-1)),s(a(w),{variant:"ghost",size:"sm",onClick:E,disabled:f.value,class:"ml-auto"},{default:t(()=>[s(a(F),{class:ne(["h-4 w-4",{"animate-spin":f.value}])},null,8,["class"])]),_:1},8,["disabled"])]),f.value&&!i.value?(n(),k("div",fe,[s(a(U),{class:"h-8 w-8 animate-spin mx-auto mb-2"}),e[1]||(e[1]=u("p",{class:"text-muted-foreground"},"Cargando informaciÃ³n...",-1))])):p("",!0),d.value?(n(),c(a(P),{key:1,variant:"destructive"},{default:t(()=>[s(a(Z),{class:"h-4 w-4"}),s(a(I),null,{default:t(()=>e[2]||(e[2]=[l("Error")])),_:1}),s(a(L),null,{default:t(()=>[l(x(d.value),1)]),_:1})]),_:1})):p("",!0),i.value&&!f.value?(n(),k("div",ge,[m.value||i.value.processing?(n(),c(a(j),{key:0,class:"border-blue-200 bg-blue-50"},{default:t(()=>[s(a(A),null,{default:t(()=>[s(a(M),{class:"flex items-center gap-2 text-blue-700"},{default:t(()=>[s(a(U),{class:"h-5 w-5 animate-spin"}),e[3]||(e[3]=l(" Procesando registro "))]),_:1}),s(a(B),null,{default:t(()=>e[4]||(e[4]=[l(" Se estÃ¡ generando tu enlace personal de videoconferencia... ")])),_:1})]),_:1}),s(a(D),null,{default:t(()=>e[5]||(e[5]=[u("div",{class:"space-y-2"},[u("div",{class:"text-sm text-blue-600"},[l(" âœ… Validaciones completadas"),u("br"),l(" ðŸ”„ Registrando en Zoom..."),u("br"),l(" ðŸ“§ Preparando notificaciÃ³n por email ")]),u("p",{class:"text-xs text-muted-foreground"}," Este proceso toma entre 1-2 minutos. La pÃ¡gina se actualizarÃ¡ automÃ¡ticamente. ")],-1)])),_:1})]),_:1})):V.value?(n(),c(a(j),{key:1,class:"border-red-200 bg-red-50"},{default:t(()=>[s(a(A),null,{default:t(()=>[s(a(M),{class:"flex items-center gap-2 text-red-700"},{default:t(()=>[s(a(Z),{class:"h-5 w-5"}),e[6]||(e[6]=l(" Error en el registro "))]),_:1}),s(a(B),{class:"text-red-600"},{default:t(()=>e[7]||(e[7]=[l(" No se pudo completar tu registro en la videoconferencia ")])),_:1})]),_:1}),s(a(D),{class:"space-y-4"},{default:t(()=>[s(a(P),{variant:"destructive"},{default:t(()=>[s(a(Z),{class:"h-4 w-4"}),s(a(I),null,{default:t(()=>e[8]||(e[8]=[l("Detalles del error")])),_:1}),s(a(L),null,{default:t(()=>[l(x(X.value),1)]),_:1})]),_:1}),u("div",pe,[ee.value?(n(),c(a(w),{key:0,onClick:h,disabled:b.value||m.value,class:"flex-1"},{default:t(()=>[b.value||m.value?(n(),c(a(F),{key:0,class:"mr-2 h-4 w-4 animate-spin"})):(n(),c(a(F),{key:1,class:"mr-2 h-4 w-4"})),e[9]||(e[9]=l(" Reintentar registro "))]),_:1},8,["disabled"])):(n(),c(a(w),{key:1,variant:"outline",disabled:"",class:"flex-1"},{default:t(()=>e[10]||(e[10]=[l(" No se puede reintentar ")])),_:1}))]),e[11]||(e[11]=u("p",{class:"text-xs text-muted-foreground"}," Si el problema persiste, contacta al administrador. ",-1))]),_:1})]),_:1})):g.value&&g.value.status==="completed"?(n(),c(a(j),{key:2,class:"border-green-200"},{default:t(()=>[s(a(A),null,{default:t(()=>[s(a(M),{class:"flex items-center gap-2 text-green-700"},{default:t(()=>[s(a(ie),{class:"h-5 w-5"}),e[12]||(e[12]=l(" Ya estÃ¡s registrado "))]),_:1}),s(a(B),null,{default:t(()=>e[13]||(e[13]=[l(" Tienes acceso a esta videoconferencia ")])),_:1})]),_:1}),s(a(D),{class:"space-y-4"},{default:t(()=>[g.value.zoom_start_time?(n(),k("div",ve,[e[14]||(e[14]=u("p",{class:"text-sm font-medium text-muted-foreground"},"Hora de inicio",-1)),u("p",_e,x(new Date(g.value.zoom_start_time).toLocaleString("es-ES")),1)])):p("",!0),g.value.zoom_registrant_id?(n(),k("div",xe,[e[15]||(e[15]=u("p",{class:"text-sm font-medium text-muted-foreground"},"Token Ãºnico de ingreso",-1)),u("p",be,x(g.value.zoom_registrant_id),1)])):p("",!0),u("div",ye,[te.value?p("",!0):(n(),k("div",we,[s(a(P),null,{default:t(()=>[s(a(J),{class:"h-4 w-4"}),s(a(I),null,{default:t(()=>e[16]||(e[16]=[l("ReuniÃ³n no disponible")])),_:1}),s(a(L),null,{default:t(()=>[l(' La videoconferencia solo estÃ¡ disponible cuando la asamblea estÃ¡ "En Curso". Estado actual: '+x(i.value.asamblea.estado_label),1)]),_:1})]),_:1})])),u("div",ke,[se.value?(n(),c(a(w),{key:0,onClick:W,class:"flex-1 bg-green-600 hover:bg-green-700 text-white"},{default:t(()=>[s(a(ue),{class:"mr-2 h-4 w-4"}),e[17]||(e[17]=l(" Unirse a la Videoconferencia "))]),_:1})):p("",!0),s(a(w),{variant:"outline",onClick:K,disabled:f.value,size:"sm",class:"hidden"},{default:t(()=>[f.value?(n(),c(a(U),{key:0,class:"mr-2 h-4 w-4 animate-spin"})):p("",!0),e[18]||(e[18]=l(" Cancelar "))]),_:1},8,["disabled"])])])]),_:1})]),_:1})):ae.value?(n(),c(a(j),{key:3},{default:t(()=>[s(a(A),null,{default:t(()=>[s(a(M),{class:"flex items-center gap-2"},{default:t(()=>[s(a(O),{class:"h-5 w-5"}),e[19]||(e[19]=l(" Generar Acceso Personal "))]),_:1}),s(a(B),null,{default:t(()=>e[20]||(e[20]=[l(" Genera tu link personal para acceder a la videoconferencia ")])),_:1})]),_:1}),s(a(D),null,{default:t(()=>[s(a(w),{onClick:H,disabled:b.value||m.value,class:"w-full"},{default:t(()=>[b.value||m.value?(n(),c(a(U),{key:0,class:"mr-2 h-4 w-4 animate-spin"})):(n(),c(a(O),{key:1,class:"mr-2 h-4 w-4"})),l(" "+x(m.value?"Procesando...":"Generar link de ingreso"),1)]),_:1},8,["disabled"])]),_:1})]),_:1})):(n(),c(a(P),{key:4},{default:t(()=>[s(a(J),{class:"h-4 w-4"}),s(a(I),null,{default:t(()=>e[21]||(e[21]=[l("No disponible")])),_:1}),s(a(L),null,{default:t(()=>[l(x(i.value.reason),1)]),_:1})]),_:1})),s(a(P),{variant:"destructive",class:"mt-4"},{default:t(()=>[s(a(Z),{class:"h-4 w-4"}),s(a(I),null,{default:t(()=>e[22]||(e[22]=[l("Advertencia")])),_:1}),s(a(L),null,{default:t(()=>e[23]||(e[23]=[l(" Tu link es Ãºnico, cuÃ­dalo, no lo compartas, si lo compartes podrÃ­as quedarte por fuera de la reuniÃ³n, ya que solo se admite un usuario por link. ")])),_:1})]),_:1})])):p("",!0)]))}}),Ue=de(Ce,[["__scopeId","data-v-3b66422b"]]);export{Ue as default};
