import{d as le,r as V,u as ie,c as w,b as k,w as i,j as g,e as t,f as a,h as r,t as p,i as _,g as o,n as E,F,k as T,s as ne,m as u}from"./app-BQOuftjp.js";import{_ as re,a as de,b as L,c as U}from"./TabsTrigger.vue_vue_type_script_setup_true_lang-wiG4DtAS.js";import{a as ue,b as me,c as ce,_ as fe}from"./CardTitle.vue_vue_type_script_setup_true_lang-COZtpGNd.js";import{_ as $}from"./createLucideIcon-u3b_FJqO.js";import{_ as D}from"./Input.vue_vue_type_script_setup_true_lang-CIUGnQxq.js";import{_ as N}from"./Label.vue_vue_type_script_setup_true_lang-B1DKvfl2.js";import{_ as O,a as P,b as q,c as G,d as j}from"./SelectValue.vue_vue_type_script_setup_true_lang-Dl66d_KU.js";import{_ as pe}from"./Checkbox.vue_vue_type_script_setup_true_lang-CY4a02pg.js";import{_ as _e,a as ve,b as R,c as z,d as ge,e as I}from"./TableHeader.vue_vue_type_script_setup_true_lang-DC47dxcE.js";import{_ as be,a as xe}from"./index-ChjO1gxC.js";import{U as ye}from"./upload-Cm3jy4M2.js";import{G as ke}from"./git-branch-BLy8Qfmc.js";import{F as K}from"./file-text-BS9_LkRg.js";import{C as A}from"./circle-alert-CktHmVBr.js";const $e={key:0,class:"mb-4"},Ce={class:"text-sm text-muted-foreground"},Se={class:"flex items-center gap-2"},Ve={class:"flex items-center gap-2"},we={class:"space-y-4"},ze={class:"space-y-2"},Ie={key:0,class:"text-sm text-red-500"},Me={class:"space-y-2"},Be={key:0,class:"text-sm text-red-500"},Ee={key:1,class:"mt-2"},Fe={class:"flex items-center gap-2 text-sm text-muted-foreground"},Te={key:0,class:"mt-2 p-3 bg-orange-50 border border-orange-200 rounded"},Ne={class:"flex items-start gap-2"},je={class:"text-sm text-orange-700"},Ae={class:"space-y-2"},Le={class:"flex justify-end gap-2"},Ue={key:0},De={class:"space-y-2"},Oe={key:0},Pe={key:1},qe={key:0,class:"p-3 bg-orange-100 border border-orange-200 rounded"},Ge={class:"flex items-start gap-2"},Re={class:"text-sm"},Ke={class:"mt-1 text-orange-700 space-y-1"},He={class:"text-sm"},We={key:0,class:"block mt-1"},Xe={key:1,class:"block mt-1"},Je={class:"border rounded-lg overflow-x-auto"},Qe={key:0},Ye={key:0,class:"text-sm text-muted-foreground italic"},Ze={class:"text-sm text-muted-foreground max-w-32 truncate"},he={class:"flex justify-between"},ea={class:"flex gap-2"},_a=le({__name:"CsvImportWizard",props:{mode:{},votacionId:{},votacionTitulo:{},asambleaId:{},asambleaTitulo:{},redirectOnSuccess:{type:Boolean,default:!0}},emits:["success","cancel"],setup(x,{emit:H}){const f=x,M=H,C=V("config"),y=V(null),b=V(null),l=ie({name:"",csv_file:null,import_mode:"both",field_mappings:{},update_fields:[],votacion_id:f.votacionId||null,asamblea_id:f.asambleaId||null}),S=V(!1),W=w(()=>l.name&&l.csv_file&&l.import_mode&&b.value),X=[{value:"insert",label:"Solo a√±adir usuarios nuevos"},{value:"update",label:"Solo actualizar usuarios existentes"},{value:"both",label:"A√±adir nuevos y actualizar existentes"}],J=w(()=>f.mode==="votacion"&&f.votacionTitulo?`Importar votantes para: ${f.votacionTitulo}`:f.mode==="asamblea"&&f.asambleaTitulo?`Importar participantes para: ${f.asambleaTitulo}`:"Nueva Importaci√≥n CSV"),Q=w(()=>f.mode==="votacion"?"Los usuarios importados ser√°n asignados autom√°ticamente a esta votaci√≥n":f.mode==="asamblea"?"Los usuarios importados ser√°n asignados autom√°ticamente como participantes de esta asamblea":"Importa usuarios desde un archivo CSV"),Y=d=>{var m;const s=(m=d.target.files)==null?void 0:m[0];s&&(y.value=s,l.csv_file=s,b.value=null)},Z=async()=>{var d;if(!(!y.value||!l.name.trim())){S.value=!0;try{const e=new FormData;e.append("csv_file",y.value);const s=await fetch("/admin/imports/analyze",{method:"POST",body:e,headers:{"X-CSRF-TOKEN":((d=document.querySelector('meta[name="csrf-token"]'))==null?void 0:d.getAttribute("content"))||""}}),m=await s.json();if(s.ok){b.value=m;const c={};m.headers.forEach(v=>{const n=v.toLowerCase().trim();n.includes("nombre")||n==="name"?c[v]="name":n.includes("email")||n.includes("correo")?c[v]="email":n.includes("documento")||n.includes("cedula")||n.includes("identification")?c[v]="documento_identidad":n==="tipo_documento"||n.includes("tipo")&&n.includes("doc")?c[v]="tipo_documento":n.includes("telefono")||n.includes("phone")?c[v]="telefono":n.includes("direccion")||n.includes("address")?c[v]="direccion":n==="territorio"||n==="territorio_id"?c[v]="territorio_id":n==="departamento"||n==="departamento_id"?c[v]="departamento_id":n==="municipio"||n==="municipio_id"?c[v]="municipio_id":n==="localidad"||n==="localidad_id"?c[v]="localidad_id":n==="cargo"||n==="cargo_id"?c[v]="cargo_id":n==="rol"||n==="role"?c[v]="rol":n==="activo"||n==="active"?c[v]="activo":(n==="es_miembro"||n==="miembro")&&(c[v]="es_miembro")}),l.field_mappings=c,f.mode==="votacion"&&!l.name&&(l.name=`Importaci√≥n votantes - ${new Date().toLocaleDateString()}`),C.value="mapping"}else alert(m.error||"Error al analizar archivo")}catch(e){console.error("Error:",e),alert("Error al analizar archivo")}finally{S.value=!1}}},h=(d,e)=>{const s=String(e);!s||s==="none"?delete l.field_mappings[d]:l.field_mappings[d]=s},ee=(d,e)=>{if(e)l.update_fields.includes(d)||l.update_fields.push(d);else{const s=l.update_fields.indexOf(d);s>-1&&l.update_fields.splice(s,1)}},ae=()=>{let d="/admin/imports";f.mode==="votacion"?d=`/admin/votaciones/${f.votacionId}/imports/store`:f.mode==="asamblea"&&(d=`/admin/asambleas/${f.asambleaId}/imports/store`),console.log("Creando importaci√≥n:",{url:d,mode:f.mode,name:l.name,import_mode:l.import_mode,field_mappings:l.field_mappings,update_fields:l.update_fields,csv_file:l.csv_file,asamblea_id:f.asambleaId,votacion_id:f.votacionId}),l.post(d,{preserveScroll:!0,forceFormData:!0,onSuccess:e=>{var m,c;console.log("Respuesta exitosa:",e);const s=((m=e.props.import)==null?void 0:m.id)||((c=e.props.flash)==null?void 0:c.import_id);s?(M("success",s),f.redirectOnSuccess&&ne.get(`/admin/imports/${s}`)):console.error("No se recibi√≥ ID de importaci√≥n en la respuesta")},onError:e=>{console.error("Error al crear importaci√≥n:",e)},onFinish:()=>{console.log("Petici√≥n finalizada")}})},se=w(()=>{const d=Object.values(l.field_mappings),e=d.includes("name"),s=d.includes("email");return e&&s}),B=d=>{if(d===0)return"0 Bytes";const e=1024,s=["Bytes","KB","MB","GB"],m=Math.floor(Math.log(d)/Math.log(e));return Math.round(d/Math.pow(e,m)*100)/100+" "+s[m]},te=()=>300,oe=d=>d>5242880;return(d,e)=>(u(),k(a(fe),null,{default:i(()=>[x.mode==="general"?(u(),k(a(ue),{key:0},{default:i(()=>[t(a(me),null,{default:i(()=>[r(p(J.value),1)]),_:1})]),_:1})):g("",!0),t(a(ce),{class:"p-6"},{default:i(()=>[x.mode==="votacion"?(u(),_("div",$e,[o("p",Ce,p(Q.value),1)])):g("",!0),t(a(re),{modelValue:C.value,"onUpdate:modelValue":e[5]||(e[5]=s=>C.value=s),class:"w-full"},{default:i(()=>[t(a(de),{class:"grid w-full grid-cols-2"},{default:i(()=>[t(a(L),{value:"config"},{default:i(()=>[o("span",Se,[t(a(ye),{class:"h-4 w-4"}),e[6]||(e[6]=r(" Configuraci√≥n ",-1))])]),_:1}),t(a(L),{value:"mapping",disabled:!W.value},{default:i(()=>[o("span",Ve,[t(a(ke),{class:"h-4 w-4"}),e[7]||(e[7]=r(" Mapeo de Campos ",-1))])]),_:1},8,["disabled"])]),_:1}),t(a(U),{value:"config",class:"space-y-6"},{default:i(()=>[o("div",we,[o("div",ze,[t(a(N),{for:"name"},{default:i(()=>[...e[8]||(e[8]=[r("Nombre de la Importaci√≥n",-1)])]),_:1}),t(a(D),{id:"name",modelValue:a(l).name,"onUpdate:modelValue":e[0]||(e[0]=s=>a(l).name=s),placeholder:x.mode==="votacion"?"Ej: Votantes primera vuelta":"Ej: Importaci√≥n militantes enero 2025",class:E({"border-red-500":a(l).errors.name})},null,8,["modelValue","placeholder","class"]),a(l).errors.name?(u(),_("p",Ie,p(a(l).errors.name),1)):g("",!0)]),o("div",Me,[t(a(N),{for:"csv_file"},{default:i(()=>[...e[9]||(e[9]=[r("Archivo CSV",-1)])]),_:1}),t(a(D),{id:"csv_file",type:"file",accept:".csv",onChange:Y,class:E({"border-red-500":a(l).errors.csv_file})},null,8,["class"]),a(l).errors.csv_file?(u(),_("p",Be,p(a(l).errors.csv_file),1)):g("",!0),y.value?(u(),_("div",Ee,[o("div",Fe,[t(a(K),{class:"h-4 w-4"}),o("span",null,p(y.value.name),1),e[10]||(e[10]=o("span",null,"¬∑",-1)),o("span",null,p(B(y.value.size)),1)]),oe(y.value.size)?(u(),_("div",Te,[o("div",Ne,[t(a(A),{class:"h-4 w-4 text-orange-600 mt-0.5 flex-shrink-0"}),o("div",je,[o("strong",null,"Archivo grande detectado ("+p(B(y.value.size))+")",1),e[11]||(e[11]=o("p",{class:"mt-1"},"Este archivo tardar√° varios minutos en procesar. Se recomienda:",-1)),e[12]||(e[12]=o("ul",{class:"mt-1 space-y-0.5 list-disc list-inside"},[o("li",null,"Tener una conexi√≥n estable a internet"),o("li",null,"No cerrar la pesta√±a durante el proceso"),o("li",null,"Verificar que el mapeo sea correcto antes de iniciar")],-1))])])])):g("",!0)])):g("",!0),e[13]||(e[13]=o("p",{class:"text-sm text-muted-foreground"}," El archivo debe contener al menos las columnas: nombre y email (m√°ximo 50MB) ",-1)),e[14]||(e[14]=o("p",{class:"text-sm text-blue-600"},[o("a",{href:"/ejemplo-usuarios.csv",download:"",class:"underline"}," üì• Descargar plantilla CSV de ejemplo ")],-1))]),o("div",Ae,[t(a(N),{for:"import_mode"},{default:i(()=>[...e[15]||(e[15]=[r("Modo de Importaci√≥n",-1)])]),_:1}),t(a(O),{modelValue:a(l).import_mode,"onUpdate:modelValue":e[1]||(e[1]=s=>a(l).import_mode=s)},{default:i(()=>[t(a(P),null,{default:i(()=>[t(a(q),{placeholder:"Selecciona el modo"})]),_:1}),t(a(G),null,{default:i(()=>[(u(),_(F,null,T(X,s=>t(a(j),{key:s.value,value:s.value},{default:i(()=>[r(p(s.label),1)]),_:2},1032,["value"])),64))]),_:1})]),_:1},8,["modelValue"]),e[16]||(e[16]=o("p",{class:"text-sm text-muted-foreground"}," Define c√≥mo manejar usuarios que ya existen en el sistema ",-1))]),o("div",Le,[x.mode==="votacion"||x.mode==="asamblea"?(u(),k(a($),{key:0,variant:"outline",onClick:e[2]||(e[2]=s=>M("cancel"))},{default:i(()=>[...e[17]||(e[17]=[r(" Cancelar ",-1)])]),_:1})):g("",!0),t(a($),{onClick:Z,disabled:!a(l).name||!y.value||S.value},{default:i(()=>[t(a(K),{class:"mr-2 h-4 w-4"}),r(" "+p(S.value?"Analizando...":"Analizar CSV"),1)]),_:1},8,["disabled"])])])]),_:1}),t(a(U),{value:"mapping",class:"space-y-6"},{default:i(()=>[b.value?(u(),_("div",Ue,[t(a(be),{class:E(["mb-4",{"border-orange-200 bg-orange-50":b.value.is_large_file}])},{default:i(()=>[t(a(A),{class:"h-4 w-4"}),t(a(xe),null,{default:i(()=>[o("div",De,[o("div",null,[b.value.estimated?(u(),_("span",Oe,[e[18]||(e[18]=r(" Se encontraron aproximadamente ",-1)),o("strong",null,"~"+p(b.value.total_rows.toLocaleString()),1),e[19]||(e[19]=r(" registros ",-1)),e[20]||(e[20]=o("span",{class:"text-sm text-muted-foreground"},"(estimaci√≥n)",-1))])):(u(),_("span",Pe,[e[21]||(e[21]=r(" Se encontraron ",-1)),o("strong",null,p(b.value.total_rows.toLocaleString()),1),e[22]||(e[22]=r(" registros ",-1))])),e[23]||(e[23]=r(" ¬∑ Tama√±o: ",-1)),o("strong",null,p(B(b.value.file_size)),1)]),b.value.is_large_file?(u(),_("div",qe,[o("div",Ge,[t(a(A),{class:"h-4 w-4 text-orange-600 mt-0.5 flex-shrink-0"}),o("div",Re,[e[27]||(e[27]=o("strong",{class:"text-orange-800"},"Archivo grande detectado",-1)),o("ul",Ke,[e[24]||(e[24]=o("li",null,"‚Ä¢ El procesamiento tomar√° varios minutos",-1)),o("li",null,"‚Ä¢ Se procesar√° en batches de "+p(te())+" registros",1),e[25]||(e[25]=o("li",null,"‚Ä¢ Puedes seguir el progreso en tiempo real",-1)),e[26]||(e[26]=o("li",null,"‚Ä¢ No cierres esta pesta√±a durante el proceso",-1))])])])])):g("",!0),o("div",He,[e[28]||(e[28]=r(" Los campos ",-1)),e[29]||(e[29]=o("strong",null,"Nombre",-1)),e[30]||(e[30]=r(" y ",-1)),e[31]||(e[31]=o("strong",null,"Email",-1)),e[32]||(e[32]=r(" son obligatorios. ",-1)),x.mode==="votacion"?(u(),_("span",We," Los usuarios ser√°n asignados autom√°ticamente a la votaci√≥n. ")):g("",!0),x.mode==="asamblea"?(u(),_("span",Xe," Los usuarios ser√°n asignados autom√°ticamente como participantes de la asamblea. ")):g("",!0)])])]),_:1})]),_:1},8,["class"]),o("div",Je,[t(a(_e),null,{default:i(()=>[t(a(ve),null,{default:i(()=>[t(a(R),null,{default:i(()=>[t(a(z),null,{default:i(()=>[...e[33]||(e[33]=[r("Columna del CSV",-1)])]),_:1}),t(a(z),null,{default:i(()=>[...e[34]||(e[34]=[r("Mapear a Campo",-1)])]),_:1}),a(l).import_mode!=="insert"?(u(),k(a(z),{key:0},{default:i(()=>[...e[35]||(e[35]=[r("Actualizar",-1)])]),_:1})):g("",!0),t(a(z),null,{default:i(()=>[...e[36]||(e[36]=[r("Vista Previa",-1)])]),_:1})]),_:1})]),_:1}),t(a(ge),null,{default:i(()=>[(u(!0),_(F,null,T(b.value.headers,s=>(u(),k(a(R),{key:s},{default:i(()=>[t(a(I),{class:"font-medium"},{default:i(()=>[r(p(s),1)]),_:2},1024),t(a(I),null,{default:i(()=>[t(a(O),{"model-value":a(l).field_mappings[s]||"none","onUpdate:modelValue":m=>h(s,m)},{default:i(()=>[t(a(P),{class:"w-full"},{default:i(()=>[t(a(q))]),_:1}),t(a(G),null,{default:i(()=>[t(a(j),{value:"none"},{default:i(()=>[...e[37]||(e[37]=[r("-- No mapear --",-1)])]),_:1}),(u(!0),_(F,null,T(b.value.available_fields,(m,c)=>(u(),k(a(j),{key:c,value:c},{default:i(()=>[r(p(m),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["model-value","onUpdate:modelValue"])]),_:2},1024),a(l).import_mode!=="insert"?(u(),k(a(I),{key:0},{default:i(()=>[a(l).field_mappings[s]&&a(l).field_mappings[s]!=="none"?(u(),_("div",Qe,[a(l).field_mappings[s]==="email"||a(l).field_mappings[s]==="documento_identidad"?(u(),_("div",Ye," Resoluci√≥n manual ")):(u(),k(a(pe),{key:1,checked:a(l).update_fields.includes(a(l).field_mappings[s]),"onUpdate:checked":m=>ee(a(l).field_mappings[s],m)},null,8,["checked","onUpdate:checked"]))])):g("",!0)]),_:2},1024)):g("",!0),t(a(I),null,{default:i(()=>{var m;return[o("div",Ze,p(((m=b.value.sample_data[0])==null?void 0:m[b.value.headers.indexOf(s)])||"-"),1)]}),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),o("div",he,[t(a($),{variant:"outline",onClick:e[3]||(e[3]=s=>C.value="config")},{default:i(()=>[...e[38]||(e[38]=[r(" Volver a Configuraci√≥n ",-1)])]),_:1}),o("div",ea,[x.mode==="votacion"||x.mode==="asamblea"?(u(),k(a($),{key:0,variant:"outline",onClick:e[4]||(e[4]=s=>M("cancel"))},{default:i(()=>[...e[39]||(e[39]=[r(" Cancelar ",-1)])]),_:1})):g("",!0),t(a($),{onClick:ae,disabled:!se.value||a(l).processing},{default:i(()=>[r(p(a(l).processing?"Procesando...":"Iniciar Importaci√≥n"),1)]),_:1},8,["disabled"])])])])):g("",!0)]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}))}});export{_a as _};
