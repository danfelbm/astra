import{d as ye,u as we,r as h,c as I,p as Se,o as ke,B as Ce,i as u,e as s,f as e,q as $e,w as l,g as r,b as x,j as g,m as n,t as _,h as v,F as E,k as P,x as ee,a4 as Ee,O as Ve}from"./app-D295TwpG.js";import{_ as je}from"./UserLayout.vue_vue_type_script_setup_true_lang-DlM8HxXB.js";import{_ as Te,a as Fe,b as Ae,c as Ie}from"./CardTitle.vue_vue_type_script_setup_true_lang-BxiJGsdC.js";import{_ as De}from"./CardDescription.vue_vue_type_script_setup_true_lang-C5ihZYBK.js";import{_ as C}from"./createLucideIcon-D-eVYV0X.js";import{_ as B}from"./Label.vue_vue_type_script_setup_true_lang-BJwJYrXW.js";import{_ as Be}from"./Textarea.vue_vue_type_script_setup_true_lang-BxR3qEQm.js";import{_ as Ne,a as Oe,b as ze,c as Me,d as Ge}from"./SelectValue.vue_vue_type_script_setup_true_lang-BgxQu3ec.js";import{_ as Pe}from"./Progress.vue_vue_type_script_setup_true_lang-F8q0aufm.js";import{_ as Ue}from"./index-pTKOFCV9.js";import{_ as We}from"./FileUploadField.vue_vue_type_script_setup_true_lang-BbovtZaI.js";import{_ as Le}from"./EntregableSelector.vue_vue_type_script_setup_true_lang-C89UjrSl.js";import{u as Re}from"./useAutoSave-CzGoNBS1.js";import{u as qe}from"./useFileUpload-CQ3qWbTU.js";import{t as m}from"./index-DDbup-j2.js";import{F as U}from"./file-text-C-TiYlL7.js";import{M as W}from"./music-DiHjgQJ8.js";import{V as L}from"./video-B9RK3ZCy.js";import{I as R}from"./image-DBKM0J8d.js";import{C as oe}from"./clock-DN-ZQrgB.js";import{C as te}from"./circle-check-big-GKWDCEY_.js";import{C as Ke}from"./circle-alert-d8VqH1J6.js";import{C as He}from"./camera-D5DjY746.js";import{T as Je}from"./trash-2-Dhclb-Fp.js";import{S as Qe}from"./save-_ergFzMH.js";import{_ as Xe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./useFlashMessages-BiQJq8LA.js";import"./index-B8JzT2zu.js";import"./floating-ui.vue-BqlKYY4i.js";import"./x-CxtBDhwy.js";import"./Input.vue_vue_type_script_setup_true_lang-BrdPP5Ww.js";import"./index-BVdoNKrK.js";import"./index-D-3TFOik.js";import"./shield-xTc-7YYA.js";import"./user-BAGTpZS5.js";import"./DropdownMenuTrigger.vue_vue_type_script_setup_true_lang-Cp4hDV3s.js";import"./chevron-right-G87vJ0iu.js";import"./DialogTitle.vue_vue_type_script_setup_true_lang-BvOGWYox.js";import"./VisuallyHidden-Ecf8f582.js";import"./GeographicSelector.vue_vue_type_script_setup_true_lang-7SHiCfms.js";import"./map-pin-B8mKGvxS.js";import"./AppLogo.vue_vue_type_script_setup_true_lang-B8HzPPP2.js";import"./ellipsis-pH1Ybgv7.js";import"./usePermissions-BUxUggtf.js";import"./square-check-big-BZvGns2f.js";import"./users-Vb3jmSQ5.js";import"./folder-open-RpPo5MZo.js";import"./milestone-SDr_BTbm.js";import"./index-IU7q-1dg.js";import"./check-Clo04847.js";import"./upload-BixeVlql.js";import"./file-j83VA2YX.js";import"./eye-BCeC5IXc.js";import"./download-JKiuERMu.js";import"./Checkbox.vue_vue_type_script_setup_true_lang-rKmUGAwP.js";import"./ScrollArea.vue_vue_type_script_setup_true_lang-D3qPf5Rm.js";import"./search-BTe269m8.js";import"./rotate-ccw-COc1S98O.js";import"./calendar-CmZyVkh_.js";import"./debounce-D7GcECfg.js";const Ye={class:"flex h-full flex-1 flex-col gap-4 rounded-xl p-0 sm:p-4 pb-24"},Ze={class:"flex items-center justify-end gap-2 text-sm text-muted-foreground"},eo={key:0,class:"flex items-center gap-1.5"},oo={key:1,class:"flex items-center gap-1.5"},to={key:2,class:"flex items-center gap-1.5 text-amber-600"},ao={class:"space-y-2"},io={key:0,class:"text-sm text-destructive"},so={class:"space-y-2"},ro={class:"grid grid-cols-2 md:grid-cols-4 gap-4"},no={key:0,class:"text-sm text-destructive"},lo={key:0,class:"space-y-2"},co={key:0,class:"mb-4 p-4 border rounded-lg bg-muted/50"},uo={class:"flex items-center justify-between mb-2"},mo={class:"grid grid-cols-2 md:grid-cols-4 gap-2"},po={class:"text-xs"},vo={key:1,class:"space-y-4"},fo={class:"flex gap-2"},_o=["srcObject"],ho={class:"space-y-2"},go={key:0,class:"text-sm text-destructive"},bo={class:"fixed bottom-0 left-0 right-0 z-50 px-2 sm:px-4 pb-2 sm:pb-4"},xo={class:"mx-auto max-w-7xl"},yo={class:"backdrop-blur-lg bg-tertiary-60 dark:bg-gray-900/80 border border-gray-200/50 dark:border-gray-700/50 rounded-xl sm:rounded-2xl shadow-2xl p-3 sm:p-4"},wo={class:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4"},So={class:"hidden sm:flex items-center"},ko={class:"flex-1 sm:max-w-xs lg:max-w-sm mx-0 sm:mx-4"},Co={class:"flex items-center gap-3"},$o={class:"text-xs sm:text-sm text-muted-foreground whitespace-nowrap font-medium"},Eo={class:"flex items-center gap-2 sm:gap-3"},Vo=ye({__name:"Create",props:{contrato:{},obligaciones:{},entregables:{},tiposEvidencia:{}},setup(V){const y=V,ae=[{title:"Dashboard",href:"/miembro/dashboard"},{title:"Mis Contratos",href:"/miembro/mis-contratos"},{title:y.contrato.nombre,href:`/miembro/mis-contratos/${y.contrato.id}`},{title:"Subir Evidencia",href:"#"}],{uploadFiles:q}=qe(),o=we({obligacion_id:null,tipo_evidencia:null,archivo_path:null,archivo_nombre:null,archivos_paths:[],archivos_nombres:[],tipos_archivos:null,descripcion:null,entregable_ids:[],metadata:null}),j=h([]),w=h({imagen:{paths:[],nombres:[],count:0},video:{paths:[],nombres:[],count:0},audio:{paths:[],nombres:[],count:0},documento:{paths:[],nombres:[],count:0}}),ie=h(null),b=h(!1),$=h(null),T=h(null),S=h(null),F=h(null),se=h(null),re=I(()=>o.data()),{state:ne,isSaving:N,hasSaved:le,hasError:K,saveNow:ce,startWatching:H,stopAutoSave:J,restoreDraft:de,clearLocalStorage:Q}=Re(re,{url:`/miembro/mis-contratos/${y.contrato.id}/evidencias/autosave`,debounceTime:3e3,showNotifications:!0,useLocalStorage:!0,localStorageKey:`evidencia_draft_contrato_${y.contrato.id}`}),ue=I(()=>{const a={imagen:{icon:R,accept:"image/*",capture:"environment",maxSize:10485760},video:{icon:L,accept:"video/*",capture:"environment",maxSize:524288e3},audio:{icon:W,accept:"audio/*",capture:!1,maxSize:52428800},documento:{icon:U,accept:".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.rtf",capture:!1,maxSize:20971520}};return o.tipo_evidencia?a[o.tipo_evidencia]:null}),O=I(()=>{const t=[o.obligacion_id,o.tipo_evidencia,o.archivo_path,o.descripcion,o.entregable_ids.length>0].filter(Boolean).length,c=Math.round(t/5*100);return{llenos:t,total:5,porcentaje:c}});Se(()=>o.tipo_evidencia,a=>{a&&(ie.value=a,b.value&&A())});const me=a=>{const t=a.type;return t.startsWith("image/")?"imagen":t.startsWith("video/")?"video":t.startsWith("audio/")?"audio":"documento"},X=()=>{const a=[],t=[],c={};if(Object.entries(w.value).forEach(([p,i])=>{i.paths.forEach((d,f)=>{a.push(d),t.push(i.nombres[f]),c[d]=p})}),o.archivos_paths=a,o.archivos_nombres=t,o.tipos_archivos=c,a.length>0&&!o.archivo_path&&(o.archivo_path=a[0],o.archivo_nombre=t[0]),j.value=a,Object.keys(c).length>0){const p=Object.values(c).reduce((d,f)=>(d[f]=(d[f]||0)+1,d),{}),i=Object.entries(p).reduce((d,f)=>d[1]>f[1]?d:f)[0];o.tipo_evidencia=i}},k=I(()=>Object.values(w.value).reduce((a,t)=>a+t.count,0)),pe=()=>{w.value={imagen:{paths:[],nombres:[],count:0},video:{paths:[],nombres:[],count:0},audio:{paths:[],nombres:[],count:0},documento:{paths:[],nombres:[],count:0}},o.archivos_paths=[],o.archivos_nombres=[],o.tipos_archivos=null,o.archivo_path=null,o.archivo_nombre=null,j.value=[],m.info("Todos los archivos han sido eliminados")},Y=I(()=>o.obligacion_id&&o.tipo_evidencia&&(k.value>0||se.value||F.value)),ve=async()=>{if(!o.tipo_evidencia||o.tipo_evidencia==="documento"){m.error("No se puede capturar este tipo de evidencia");return}try{b.value=!0;const a={video:o.tipo_evidencia==="imagen"||o.tipo_evidencia==="video",audio:o.tipo_evidencia==="audio"||o.tipo_evidencia==="video"};if($.value=await navigator.mediaDevices.getUserMedia(a),o.tipo_evidencia==="audio"||o.tipo_evidencia==="video"){S.value=new MediaRecorder($.value);const t=[];S.value.ondataavailable=c=>{t.push(c.data)},S.value.onstop=()=>{const c=new Blob(t,{type:o.tipo_evidencia==="audio"?"audio/webm":"video/webm"});F.value=c,Z(c)},S.value.start(),m.info("Grabación iniciada")}}catch(a){console.error("Error al iniciar captura:",a),m.error("No se pudo acceder a la cámara/micrófono"),b.value=!1}},A=()=>{$.value&&($.value.getTracks().forEach(a=>a.stop()),$.value=null),S.value&&S.value.state==="recording"&&S.value.stop(),b.value=!1},fe=()=>{if(!T.value)return;const a=document.createElement("canvas");a.width=T.value.videoWidth,a.height=T.value.videoHeight;const t=a.getContext("2d");t&&(t.drawImage(T.value,0,0),a.toBlob(c=>{c&&(F.value=c,Z(c),A())},"image/jpeg",.95))},Z=async a=>{const t=`captura_${Date.now()}.${_e(a.type)}`,c=new File([a],t,{type:a.type});F.value=a,o.archivo_nombre=t,o.metadata={mime_type:a.type,size:a.size,captured_at:new Date().toISOString()};try{m.info("Subiendo archivo capturado...");const p=o.entregable_ids.length>0?o.entregable_ids[0]:void 0,i=await q([c],{module:"evidencias",fieldId:o.tipo_evidencia||"archivo",proyectoId:y.contrato.proyecto_id,entregableId:p,onProgress:(d,f)=>{}});i.length>0&&(o.archivo_path=i[0].path,o.archivo_nombre=i[0].name,o.metadata=i[0].metadata,j.value=[i[0].path],F.value=null,m.success("Archivo subido exitosamente"))}catch(p){console.error("Error al subir archivo capturado:",p),m.error("Error al subir el archivo capturado")}},_e=a=>({"image/jpeg":"jpg","image/png":"png","image/webp":"webp","video/webm":"webm","audio/webm":"webm"})[a]||"bin",he=async a=>{if(a.length>0){const t=k.value,c=a.length;if(t+c>10){m.error(`No puedes subir más de 10 archivos. Actualmente tienes ${t} archivo(s).`);return}const p={imagen:[],video:[],audio:[],documento:[]};a.forEach(i=>{const d=me(i);p[d].push(i)});try{let i=0;const d=o.entregable_ids.length>0?o.entregable_ids[0]:void 0;for(const[f,z]of Object.entries(p)){if(z.length===0)continue;m.info(`Subiendo ${z.length} archivo(s) de tipo ${f}...`);const M=await q(z,{module:"evidencias",fieldId:f,proyectoId:y.contrato.proyecto_id,entregableId:d,onProgress:(D,G)=>{}});if(M.length>0){const D=f;M.forEach(G=>{w.value[D].paths.push(G.path),w.value[D].nombres.push(G.name),w.value[D].count++}),i+=M.length}}i>0&&(X(),m.success(`${i} archivo(s) subido(s) exitosamente. Total: ${k.value}/10`))}catch(i){console.error("Error al subir archivos:",i),m.error("Error al subir archivos")}}},ge=async()=>{await ce(),m.success("Borrador guardado")},be=async()=>{if(Y.value){if(k.value===0&&!o.archivo_path){m.error("Por favor seleccione o capture al menos un archivo");return}X(),J(),o.post(`/miembro/mis-contratos/${y.contrato.id}/evidencias`,{onSuccess:()=>{Q(),m.success(`Evidencia subida exitosamente con ${o.archivos_paths.length} archivo(s)`)},onError:a=>{console.error("Errores de validación:",a),H()}})}},xe=()=>{confirm("¿Estás seguro de descartar el borrador? Se perderán todos los cambios no enviados.")&&(Q(),o.reset(),pe(),b.value&&A(),m.success("Borrador descartado"))};return ke(()=>{const a=de();a&&a.data&&Object.assign(o,a.data),H()}),Ce(()=>{J(),A()}),(a,t)=>(n(),u(E,null,[s(e($e),{title:`Subir Evidencia - ${V.contrato.nombre}`},null,8,["title"]),s(je,{breadcrumbs:ae},{default:l(()=>{var c;return[r("div",Ye,[r("div",Ze,[e(N)?(n(),u("div",eo,[s(e(oe),{class:"h-4 w-4 animate-spin"}),t[4]||(t[4]=r("span",null,"Guardando automáticamente...",-1))])):e(le)&&!e(K)?(n(),u("div",oo,[s(e(te),{class:"h-4 w-4 text-green-600"}),r("span",null,"Guardado a las "+_((c=e(ne).lastSaved)==null?void 0:c.toLocaleTimeString()),1)])):e(K)?(n(),u("div",to,[s(e(Ke),{class:"h-4 w-4"}),t[5]||(t[5]=r("span",null,"Guardado localmente",-1))])):g("",!0)]),s(e(Te),null,{default:l(()=>[s(e(Fe),null,{default:l(()=>[s(e(Ae),null,{default:l(()=>[...t[6]||(t[6]=[v("Información de la Evidencia",-1)])]),_:1}),s(e(De),null,{default:l(()=>[...t[7]||(t[7]=[v(" Selecciona la obligación, el tipo de evidencia y adjunta el archivo correspondiente ",-1)])]),_:1})]),_:1}),s(e(Ie),{class:"space-y-6 sm:mb-16"},{default:l(()=>{var p;return[r("div",ao,[s(e(B),{htmlFor:"obligacion"},{default:l(()=>[...t[8]||(t[8]=[v("Obligación *",-1)])]),_:1}),s(e(Ne),{modelValue:e(o).obligacion_id,"onUpdate:modelValue":t[0]||(t[0]=i=>e(o).obligacion_id=i)},{default:l(()=>[s(e(Oe),null,{default:l(()=>[s(e(ze),{placeholder:"Selecciona una obligación"})]),_:1}),s(e(Me),null,{default:l(()=>[(n(!0),u(E,null,P(V.obligaciones,i=>(n(),x(e(Ge),{key:i.id,value:i.id},{default:l(()=>[v(_(i.titulo),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"]),e(o).errors.obligacion_id?(n(),u("p",io,_(e(o).errors.obligacion_id),1)):g("",!0)]),r("div",so,[s(e(B),null,{default:l(()=>[...t[9]||(t[9]=[v("Tipo de Evidencia *",-1)])]),_:1}),r("div",ro,[(n(!0),u(E,null,P(V.tiposEvidencia,i=>(n(),x(e(C),{key:i.value,onClick:d=>e(o).tipo_evidencia=i.value,variant:e(o).tipo_evidencia===i.value?"default":"outline",class:"h-20 flex flex-col gap-2"},{default:l(()=>[(n(),x(ee(i.value==="imagen"?e(R):i.value==="video"?e(L):i.value==="audio"?e(W):e(U)),{class:"h-6 w-6"})),r("span",null,_(i.label),1)]),_:2},1032,["onClick","variant"]))),128))]),e(o).errors.tipo_evidencia?(n(),u("p",no,_(e(o).errors.tipo_evidencia),1)):g("",!0)]),e(o).tipo_evidencia?(n(),u("div",lo,[s(e(B),null,{default:l(()=>[...t[10]||(t[10]=[v("Archivo de Evidencia *",-1)])]),_:1}),k.value>0?(n(),u("div",co,[r("div",uo,[t[11]||(t[11]=r("span",{class:"text-sm font-medium"},"Archivos subidos",-1)),s(e(Ue),{variant:"outline"},{default:l(()=>[v(_(k.value)+"/10",1)]),_:1})]),r("div",mo,[(n(!0),u(E,null,P(w.value,(i,d)=>(n(),u("div",{key:d,class:"flex items-center gap-2"},[(n(),x(ee(d==="imagen"?e(R):d==="video"?e(L):d==="audio"?e(W):e(U)),{class:"h-4 w-4 text-muted-foreground"})),r("span",po,_(i.count)+" "+_(d),1)]))),128))])])):g("",!0),e(o).tipo_evidencia!=="documento"?(n(),u("div",vo,[r("div",fo,[b.value?(n(),x(e(C),{key:1,onClick:A,variant:"destructive",class:"flex-1"},{default:l(()=>[...t[12]||(t[12]=[v(" Detener ",-1)])]),_:1})):(n(),x(e(C),{key:0,onClick:ve,variant:"outline",class:"flex-1"},{default:l(()=>[s(e(He),{class:"mr-2 h-4 w-4"}),v(" "+_(e(o).tipo_evidencia==="audio"?"Grabar Audio":"Capturar"),1)]),_:1}))]),b.value&&(e(o).tipo_evidencia==="imagen"||e(o).tipo_evidencia==="video")?(n(),u("video",{key:0,ref_key:"videoElement",ref:T,srcObject:$.value,autoplay:"",playsinline:"",muted:"",class:"w-full rounded-lg border"},null,8,_o)):g("",!0),b.value&&e(o).tipo_evidencia==="imagen"?(n(),x(e(C),{key:1,onClick:fe,class:"w-full"},{default:l(()=>[...t[13]||(t[13]=[v(" Tomar Foto ",-1)])]),_:1})):g("",!0)])):g("",!0),s(We,{modelValue:j.value,"onUpdate:modelValue":t[1]||(t[1]=i=>j.value=i),onFilesSelected:he,label:"",description:`Selecciona archivos desde tu dispositivo (${k.value}/10 archivos)`,required:!0,multiple:!0,"max-files":10,"max-file-size":(p=ue.value)==null?void 0:p.maxSize,accept:"image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx",error:e(o).errors.archivo_path||e(o).errors.archivos_paths,disabled:e(o).processing,module:"evidencias","field-id":e(o).tipo_evidencia||"archivo","auto-upload":!1},null,8,["modelValue","description","max-file-size","error","disabled","field-id"])])):g("",!0),s(Le,{modelValue:e(o).entregable_ids,"onUpdate:modelValue":t[2]||(t[2]=i=>e(o).entregable_ids=i),entregables:V.entregables,label:"Entregables Relacionados",description:"Selecciona los entregables del proyecto que se relacionan con esta evidencia",disabled:e(o).processing},null,8,["modelValue","entregables","disabled"]),r("div",ho,[s(e(B),{htmlFor:"descripcion"},{default:l(()=>[...t[14]||(t[14]=[v("Descripción",-1)])]),_:1}),s(e(Be),{id:"descripcion",modelValue:e(o).descripcion,"onUpdate:modelValue":t[3]||(t[3]=i=>e(o).descripcion=i),placeholder:"Describe brevemente la evidencia adjuntada",rows:"3"},null,8,["modelValue"]),e(o).errors.descripcion?(n(),u("p",go,_(e(o).errors.descripcion),1)):g("",!0)])]}),_:1})]),_:1})]),(n(),x(Ee,{to:"body"},[s(Ve,{name:"slide-up"},{default:l(()=>[r("div",bo,[r("div",xo,[r("div",yo,[r("div",wo,[r("div",So,[s(e(C),{variant:"outline",type:"button",onClick:xe,class:"backdrop-blur-sm flex-shrink-0 text-xs sm:text-sm py-2 px-3 text-destructive hover:text-destructive"},{default:l(()=>[s(e(Je),{class:"h-4 w-4"}),t[15]||(t[15]=r("span",{class:"ml-2"},"Descartar borrador",-1))]),_:1})]),r("div",ko,[r("div",Co,[s(e(Pe),{modelValue:O.value.porcentaje,class:"flex-1"},null,8,["modelValue"]),r("span",$o,_(O.value.llenos)+" / "+_(O.value.total),1)]),t[16]||(t[16]=r("p",{class:"text-xs text-muted-foreground mt-1 text-center hidden sm:block"}," Campos completados ",-1))]),r("div",Eo,[s(e(C),{onClick:ge,disabled:e(N),variant:"outline",class:"backdrop-blur-sm flex-1 sm:flex-none text-xs sm:text-sm py-2 px-3"},{default:l(()=>[e(N)?(n(),u(E,{key:0},[s(e(oe),{class:"mr-2 h-4 w-4 animate-spin"}),t[17]||(t[17]=v(" Guardando... ",-1))],64)):(n(),u(E,{key:1},[s(e(Qe),{class:"mr-2 h-4 w-4"}),t[18]||(t[18]=v(" Guardar borrador ",-1))],64))]),_:1},8,["disabled"]),s(e(C),{onClick:be,disabled:!Y.value||e(o).processing,class:"bg-green-600 hover:bg-green-700 text-white border-green-600 hover:border-green-700 disabled:bg-gray-400 disabled:border-gray-400 flex-1 sm:flex-none text-xs sm:text-sm py-2 px-3"},{default:l(()=>[s(e(te),{class:"h-4 w-4"}),t[19]||(t[19]=r("span",{class:"ml-2 whitespace-nowrap"},"Subir Evidencia",-1))]),_:1},8,["disabled"])])])])])])]),_:1})]))]}),_:1})],64))}}),Bt=Xe(Vo,[["__scopeId","data-v-f0f21315"]]);export{Bt as default};
