import{d as U,r as A,c as R,i as u,y as ae,n as Q,g as c,j as y,b as D,f as s,l as I,w as b,e as f,t as O,h as G,M as oe,m as n,F as M,k as V,T as ne,ax as H}from"./app-D-mMsgzO.js";import{_ as N}from"./createLucideIcon-DWtXnox6.js";import{_ as le}from"./Separator.vue_vue_type_script_setup_true_lang-DgV86fR4.js";import{u as W}from"./usePermissions-iaY3J2uU.js";import{C as X}from"./chevron-right-xhiFxKKv.js";import{C as se}from"./circle-D-CvtFxm.js";import{L as ie}from"./layers-DN0EXyqO.js";import{P as de}from"./paperclip-CswsLPHj.js";import{P as Y}from"./plus-QfbsJFd_.js";import{P as re}from"./pencil-6FAxY8K2.js";import{T as ce}from"./trash-2-BvQCrmF_.js";import{_ as Z}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{C as ue}from"./SelectValue.vue_vue_type_script_setup_true_lang-BnsZXqw_.js";import{L as ge}from"./loader-circle-DUcMV68D.js";const ve=["draggable"],fe={class:"flex items-start gap-2"},he={key:1,class:"w-6"},me={class:"h-6 w-6 rounded-full flex items-center justify-center shrink-0 bg-gray-100"},pe={class:"flex-1 min-w-0"},be={class:"flex items-start justify-between"},xe={class:"flex-1"},$e={class:"font-medium text-sm truncate"},ye={key:0,class:"text-xs text-gray-600 mt-1 line-clamp-2"},De={class:"flex items-center gap-3 mt-2 text-xs text-gray-500"},ke={key:0,class:"flex items-center gap-1"},Ce={key:1,class:"flex items-center gap-1"},je={key:0,class:"flex items-center gap-1 shrink-0"},we={key:0,class:"mt-2"},Se=U({__name:"ObligacionItem",props:{obligacion:{},nivel:{default:0},expanded:{type:Boolean,default:!1},selected:{type:Boolean,default:!1},editable:{type:Boolean,default:!0},onToggle:{},onSelect:{},onEdit:{},onDelete:{},onComplete:{},onAddChild:{},onDragStart:{},onDragOver:{},onDrop:{}},emits:["toggle","select","edit","delete","add-child","drag-start","drag-over","drop"],setup(l,{emit:q}){const h=l,m=q,{hasPermission:j}=W(),T=A(!1),d=R(()=>h.editable&&j("obligaciones.edit")),w=()=>{const r=h.obligacion.tiene_hijos?`¿Estás seguro de eliminar "${h.obligacion.titulo}" y todas sus obligaciones hijas?`:`¿Estás seguro de eliminar "${h.obligacion.titulo}"?`;confirm(r)&&m("delete")},E=r=>{d.value&&m("drag-start",h.obligacion,r)},x=r=>{d.value&&(r.preventDefault(),m("drag-over",r))},$=r=>{d.value&&(T.value=!1,m("drop",h.obligacion,r))},P=()=>{d.value&&(T.value=!0)},_=()=>{d.value&&(T.value=!1)};return(r,g)=>{var z,S;return n(),u("div",{class:Q(["obligacion-item group",l.selected&&"bg-blue-50 border-blue-300",T.value&&"bg-gray-100 border-dashed","border rounded-lg p-2 mb-1 transition-all hover:shadow-sm"]),style:ae({marginLeft:`${l.nivel*24}px`}),draggable:d.value&&l.editable,onDragstart:E,onDragover:x,onDrop:$,onDragenter:P,onDragleave:_},[c("div",fe,[l.obligacion.tiene_hijos?(n(),D(s(N),{key:0,variant:"ghost",size:"icon",class:"h-6 w-6 shrink-0",onClick:g[0]||(g[0]=I(k=>r.$emit("toggle"),["stop"]))},{default:b(()=>[f(s(X),{class:Q(["h-4 w-4 transition-transform",l.expanded&&"rotate-90"])},null,8,["class"])]),_:1})):(n(),u("div",he)),c("div",me,[f(s(se),{class:"h-3 w-3 text-gray-600"})]),c("div",pe,[c("div",be,[c("div",xe,[c("h4",$e,O(l.obligacion.titulo),1),l.obligacion.descripcion?(n(),u("p",ye,O(l.obligacion.descripcion),1)):y("",!0),c("div",De,[l.obligacion.tiene_hijos?(n(),u("div",ke,[f(s(ie),{class:"h-3 w-3"}),c("span",null,O(l.obligacion.total_hijos)+" hijos",1)])):y("",!0),(z=l.obligacion.archivos_adjuntos)!=null&&z.length?(n(),u("div",Ce,[f(s(de),{class:"h-3 w-3"}),c("span",null,O(l.obligacion.archivos_adjuntos.length),1)])):y("",!0)])]),l.editable?(n(),u("div",je,[s(j)("obligaciones.create")?(n(),D(s(N),{key:0,variant:"ghost",size:"sm",class:"h-7 px-2 text-xs",onClick:g[1]||(g[1]=I(k=>r.$emit("add-child"),["stop"]))},{default:b(()=>[f(s(Y),{class:"h-3 w-3 mr-1"}),g[3]||(g[3]=G(" Añadir ",-1))]),_:1})):y("",!0),s(j)("obligaciones.edit")?(n(),D(s(N),{key:1,variant:"ghost",size:"sm",class:"h-7 px-2 text-xs",onClick:g[2]||(g[2]=I(k=>r.$emit("edit"),["stop"]))},{default:b(()=>[f(s(re),{class:"h-3 w-3 mr-1"}),g[4]||(g[4]=G(" Editar ",-1))]),_:1})):y("",!0),s(j)("obligaciones.delete")?(n(),D(s(N),{key:2,variant:"ghost",size:"sm",class:"h-7 px-2 text-xs text-red-600 hover:text-red-700 hover:bg-red-50",onClick:I(w,["stop"])},{default:b(()=>[f(s(ce),{class:"h-3 w-3 mr-1"}),g[5]||(g[5]=G(" Eliminar ",-1))]),_:1})):y("",!0)])):y("",!0)])])]),l.expanded&&((S=l.obligacion.hijos)!=null&&S.length)?(n(),u("div",we,[oe(r.$slots,"children",{},void 0,!0)])):y("",!0)],46,ve)}}}),J=Z(Se,[["__scopeId","data-v-d7e57bf5"]]),Ne={class:"obligacion-tree"},Te={class:"flex items-center justify-between mb-4 p-2 bg-gray-50 rounded-lg"},Ee={class:"flex items-center gap-2"},_e={class:"flex items-center gap-2"},Oe={class:"text-sm text-gray-600"},Ae={key:0,class:"flex items-center justify-center py-8"},Pe={key:1,class:"text-center py-8 text-gray-500"},ze={key:0,class:"mt-4 bg-gray-50 p-2 rounded text-center"},Be={class:"text-2xl font-bold"},Le=U({__name:"ObligacionTree",props:{obligaciones:{},contratoId:{},editable:{type:Boolean,default:!0},selectable:{type:Boolean,default:!0},expandedNodes:{default:()=>[]},selectedNode:{default:null},onSelect:{},onEdit:{},onDelete:{},onComplete:{},onAddChild:{},onMove:{},onReorder:{}},emits:["select","edit","delete","add-child","create","move","reorder","update:expandedNodes","update:selectedNode"],setup(l,{emit:q}){const h=l,m=q,{hasPermission:j}=W(),T=A(!1),d=A(h.expandedNodes),w=A(h.selectedNode),E=A(null),x=R(()=>h.editable&&j("obligaciones.edit")),$=R(()=>{const e=[],a=o=>{o.forEach(p=>{var t;e.push(p),(t=p.hijos)!=null&&t.length&&a(p.hijos)})};return a(h.obligaciones),e}),P=R(()=>te(h.obligaciones)),_=e=>{const a=d.value.indexOf(e);a>-1?d.value.splice(a,1):d.value.push(e),m("update:expandedNodes",d.value)},r=e=>{if(w.value=e,m("update:selectedNode",e),e){const a=$.value.find(o=>o.id===e);a&&m("select",a)}},g=()=>{d.value=$.value.filter(e=>e.tiene_hijos).map(e=>e.id),m("update:expandedNodes",d.value)},z=()=>{d.value=[],m("update:expandedNodes",d.value)},S=(e,a)=>{x.value&&(E.value={obligacionId:e.id,parentId:e.parent_id,orden:e.orden,nivel:e.nivel},a.dataTransfer.effectAllowed="move",a.dataTransfer.setData("application/json",JSON.stringify(E.value)))},k=e=>{x.value&&(e.preventDefault(),e.dataTransfer.dropEffect="move")},B=(e,a)=>{if(!x.value)return;a.preventDefault(),a.stopPropagation();const o=JSON.parse(a.dataTransfer.getData("application/json"));if(!(!o||o.obligacionId===e.id)){if(K(o.obligacionId,e.id)){console.error("No se puede mover una obligación dentro de sus propios hijos");return}m("move",$.value.find(p=>p.id===o.obligacionId),e.id,e.orden+1),E.value=null}},ee=e=>{if(!x.value)return;e.preventDefault(),e.stopPropagation();const a=JSON.parse(e.dataTransfer.getData("application/json"));a&&(m("move",$.value.find(o=>o.id===a.obligacionId),null,1),E.value=null)},te=e=>{if(!e||e.length===0)return[];const a=new Map,o=[],p=new Set(e.map(t=>t.id));return e.forEach(t=>{a.set(t.id,{...t,hijos:t.hijos?[...t.hijos]:[]})}),e.forEach(t=>{const C=a.get(t.id);if(t.parent_id===null||!p.has(t.parent_id))o.push(C);else{const i=a.get(t.parent_id);i&&(i.hijos=i.hijos||[],i.hijos.some(L=>L.id===C.id)||i.hijos.push(C))}}),o.sort((t,C)=>t.orden-C.orden)},K=(e,a)=>{const o=$.value.find(p=>p.id===a);return o?o.parent_id===e?!0:o.parent_id===null?!1:K(e,o.parent_id):!1};return(e,a)=>(n(),u("div",Ne,[c("div",Te,[c("div",Ee,[f(s(N),{size:"sm",variant:"outline",onClick:g,title:"Expandir todo"},{default:b(()=>[f(s(ue),{class:"h-4 w-4"})]),_:1}),f(s(N),{size:"sm",variant:"outline",onClick:z,title:"Colapsar todo"},{default:b(()=>[f(s(X),{class:"h-4 w-4"})]),_:1}),f(s(le),{orientation:"vertical",class:"h-6"}),l.editable&&s(j)("obligaciones.create")?(n(),D(s(N),{key:0,size:"sm",variant:"outline",onClick:a[0]||(a[0]=o=>e.$emit("create"))},{default:b(()=>[f(s(Y),{class:"h-4 w-4 mr-1"}),a[1]||(a[1]=G(" Nueva Obligación ",-1))]),_:1})):y("",!0)]),c("div",_e,[c("span",Oe,O($.value.length)+" obligaciones ",1)])]),c("div",{class:"obligacion-tree-container border rounded-lg p-2 min-h-[200px]",onDragover:k,onDrop:ee},[T.value?(n(),u("div",Ae,[f(s(ge),{class:"h-8 w-8 animate-spin text-gray-400"})])):P.value.length?(n(),D(ne,{key:2,name:"list",tag:"div",class:"space-y-1"},{default:b(()=>[(n(!0),u(M,null,V(P.value,o=>{var p;return n(),D(J,{key:o.id,obligacion:o,nivel:0,expanded:d.value.includes(o.id),selected:w.value===o.id,editable:l.editable,draggable:x.value,onToggle:t=>_(o.id),onSelect:t=>r(o.id),onEdit:t=>e.$emit("edit",o),onDelete:t=>e.$emit("delete",o),onAddChild:t=>e.$emit("add-child",o),onDragStart:S,onDragOver:k,onDrop:B},H({_:2},[(p=o.hijos)!=null&&p.length?{name:"children",fn:b(()=>[(n(!0),u(M,null,V(o.hijos,t=>{var C;return n(),D(J,{key:t.id,obligacion:t,nivel:1,expanded:d.value.includes(t.id),selected:w.value===t.id,editable:l.editable,draggable:x.value,onToggle:i=>_(t.id),onSelect:i=>r(t.id),onEdit:i=>e.$emit("edit",t),onDelete:i=>e.$emit("delete",t),onAddChild:i=>e.$emit("add-child",t),onDragStart:S,onDragOver:k,onDrop:B},H({_:2},[(C=t.hijos)!=null&&C.length?{name:"children",fn:b(()=>[(n(!0),u(M,null,V(t.hijos,i=>{var L;return n(),D(J,{key:i.id,obligacion:i,nivel:2,expanded:d.value.includes(i.id),selected:w.value===i.id,editable:l.editable,draggable:x.value,onToggle:v=>_(i.id),onSelect:v=>r(i.id),onEdit:v=>e.$emit("edit",i),onDelete:v=>e.$emit("delete",i),onAddChild:v=>e.$emit("add-child",i),onDragStart:S,onDragOver:k,onDrop:B},H({_:2},[(L=i.hijos)!=null&&L.length?{name:"children",fn:b(()=>[(n(!0),u(M,null,V(i.hijos,v=>(n(),D(J,{key:v.id,obligacion:v,nivel:3,expanded:d.value.includes(v.id),selected:w.value===v.id,editable:l.editable,draggable:x.value,onToggle:F=>_(v.id),onSelect:F=>r(v.id),onEdit:F=>e.$emit("edit",v),onDelete:F=>e.$emit("delete",v),onAddChild:F=>e.$emit("add-child",v),onDragStart:S,onDragOver:k,onDrop:B},null,8,["obligacion","expanded","selected","editable","draggable","onToggle","onSelect","onEdit","onDelete","onAddChild"]))),128))]),key:"0"}:void 0]),1032,["obligacion","expanded","selected","editable","draggable","onToggle","onSelect","onEdit","onDelete","onAddChild"])}),128))]),key:"0"}:void 0]),1032,["obligacion","expanded","selected","editable","draggable","onToggle","onSelect","onEdit","onDelete","onAddChild"])}),128))]),key:"0"}:void 0]),1032,["obligacion","expanded","selected","editable","draggable","onToggle","onSelect","onEdit","onDelete","onAddChild"])}),128))]),_:1})):(n(),u("div",Pe," No hay obligaciones registradas "))],32),$.value.length?(n(),u("div",ze,[c("div",Be,O($.value.length),1),a[2]||(a[2]=c("div",{class:"text-xs text-gray-600"},"Total de Obligaciones",-1))])):y("",!0)]))}}),Ye=Z(Le,[["__scopeId","data-v-d1c586a4"]]);export{Ye as O};
