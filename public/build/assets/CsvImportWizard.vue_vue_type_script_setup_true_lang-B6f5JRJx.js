import{d as le,k as S,C as ie,c as V,j as x,o as u,e as i,i as g,b as o,u as a,g as d,t as f,a as _,f as t,n as B,F as E,r as T,W as ne}from"./app-BS9XlOI1.js";import{_ as re,a as de,b as A,c as L}from"./TabsTrigger.vue_vue_type_script_setup_true_lang-BFKmEdcQ.js";import{a as ue,b as me,c as ce,_ as pe}from"./CardTitle.vue_vue_type_script_setup_true_lang-D3Omm2ZH.js";import{_ as k}from"./createLucideIcon-CoiVMf3Y.js";import{_ as U}from"./Input.vue_vue_type_script_setup_true_lang-B0Lm-MVR.js";import{_ as F}from"./Label.vue_vue_type_script_setup_true_lang-COEXgYjN.js";import{_ as D,a as O,b as P,c as q,d as N}from"./SelectValue.vue_vue_type_script_setup_true_lang-JZr5JedR.js";import{_ as fe}from"./Checkbox.vue_vue_type_script_setup_true_lang-syDIs_2v.js";import{_ as _e,a as ve,b as G,c as w,d as ge,e as z}from"./TableHeader.vue_vue_type_script_setup_true_lang-E0bh2NGS.js";import{_ as be,a as ye}from"./index-B5ZOVRai.js";import{U as xe}from"./upload-BUpEaRqh.js";import{G as ke}from"./git-branch-D98VnIWL.js";import{F as R}from"./file-text-DCiL5M9z.js";import{C as j}from"./circle-alert-CiNzyy5h.js";const $e={key:0,class:"mb-4"},Ce={class:"text-sm text-muted-foreground"},Se={class:"flex items-center gap-2"},Ve={class:"flex items-center gap-2"},we={class:"space-y-4"},ze={class:"space-y-2"},Ie={key:0,class:"text-sm text-red-500"},Me={class:"space-y-2"},Be={key:0,class:"text-sm text-red-500"},Ee={key:1,class:"mt-2"},Te={class:"flex items-center gap-2 text-sm text-muted-foreground"},Fe={key:0,class:"mt-2 p-3 bg-orange-50 border border-orange-200 rounded"},Ne={class:"flex items-start gap-2"},je={class:"text-sm text-orange-700"},Ae={class:"space-y-2"},Le={class:"flex justify-end gap-2"},Ue={key:0},De={class:"space-y-2"},Oe={key:0},Pe={key:1},qe={key:0,class:"p-3 bg-orange-100 border border-orange-200 rounded"},Ge={class:"flex items-start gap-2"},Re={class:"text-sm"},We={class:"mt-1 text-orange-700 space-y-1"},Ke={class:"text-sm"},He={key:0,class:"block mt-1"},Xe={key:1,class:"block mt-1"},Je={class:"border rounded-lg overflow-x-auto"},Qe={key:0},Ye={key:0,class:"text-sm text-muted-foreground italic"},Ze={class:"text-sm text-muted-foreground max-w-32 truncate"},he={class:"flex justify-between"},ea={class:"flex gap-2"},_a=le({__name:"CsvImportWizard",props:{mode:{},votacionId:{},votacionTitulo:{},asambleaId:{},asambleaTitulo:{},redirectOnSuccess:{type:Boolean,default:!0}},emits:["success","cancel"],setup(W,{emit:K}){const p=W,I=K,$=S("config"),y=S(null),b=S(null),l=ie({name:"",csv_file:null,import_mode:"both",field_mappings:{},update_fields:[],votacion_id:p.votacionId||null,asamblea_id:p.asambleaId||null}),C=S(!1),H=V(()=>l.name&&l.csv_file&&l.import_mode&&b.value),X=[{value:"insert",label:"Solo añadir usuarios nuevos"},{value:"update",label:"Solo actualizar usuarios existentes"},{value:"both",label:"Añadir nuevos y actualizar existentes"}],J=V(()=>p.mode==="votacion"&&p.votacionTitulo?`Importar votantes para: ${p.votacionTitulo}`:p.mode==="asamblea"&&p.asambleaTitulo?`Importar participantes para: ${p.asambleaTitulo}`:"Nueva Importación CSV"),Q=V(()=>p.mode==="votacion"?"Los usuarios importados serán asignados automáticamente a esta votación":p.mode==="asamblea"?"Los usuarios importados serán asignados automáticamente como participantes de esta asamblea":"Importa usuarios desde un archivo CSV"),Y=n=>{var m;const s=(m=n.target.files)==null?void 0:m[0];s&&(y.value=s,l.csv_file=s,b.value=null)},Z=async()=>{var n;if(!(!y.value||!l.name.trim())){C.value=!0;try{const e=new FormData;e.append("csv_file",y.value);const s=await fetch("/admin/imports/analyze",{method:"POST",body:e,headers:{"X-CSRF-TOKEN":((n=document.querySelector('meta[name="csrf-token"]'))==null?void 0:n.getAttribute("content"))||""}}),m=await s.json();if(s.ok){b.value=m;const c={};m.headers.forEach(v=>{const r=v.toLowerCase().trim();r.includes("nombre")||r==="name"?c[v]="name":r.includes("email")||r.includes("correo")?c[v]="email":r.includes("documento")||r.includes("cedula")||r.includes("identification")?c[v]="documento_identidad":r==="tipo_documento"||r.includes("tipo")&&r.includes("doc")?c[v]="tipo_documento":r.includes("telefono")||r.includes("phone")?c[v]="telefono":r.includes("direccion")||r.includes("address")?c[v]="direccion":r==="territorio"||r==="territorio_id"?c[v]="territorio_id":r==="departamento"||r==="departamento_id"?c[v]="departamento_id":r==="municipio"||r==="municipio_id"?c[v]="municipio_id":r==="localidad"||r==="localidad_id"?c[v]="localidad_id":r==="cargo"||r==="cargo_id"?c[v]="cargo_id":r==="rol"||r==="role"?c[v]="rol":r==="activo"||r==="active"?c[v]="activo":(r==="es_miembro"||r==="miembro")&&(c[v]="es_miembro")}),l.field_mappings=c,p.mode==="votacion"&&!l.name&&(l.name=`Importación votantes - ${new Date().toLocaleDateString()}`),$.value="mapping"}else alert(m.error||"Error al analizar archivo")}catch(e){console.error("Error:",e),alert("Error al analizar archivo")}finally{C.value=!1}}},h=(n,e)=>{const s=String(e);!s||s==="none"?delete l.field_mappings[n]:l.field_mappings[n]=s},ee=(n,e)=>{if(e)l.update_fields.includes(n)||l.update_fields.push(n);else{const s=l.update_fields.indexOf(n);s>-1&&l.update_fields.splice(s,1)}},ae=()=>{let n="/admin/imports";p.mode==="votacion"?n=`/admin/votaciones/${p.votacionId}/imports/store`:p.mode==="asamblea"&&(n=`/admin/asambleas/${p.asambleaId}/imports/store`),console.log("Creando importación:",{url:n,mode:p.mode,name:l.name,import_mode:l.import_mode,field_mappings:l.field_mappings,update_fields:l.update_fields,csv_file:l.csv_file,asamblea_id:p.asambleaId,votacion_id:p.votacionId}),l.post(n,{preserveScroll:!0,forceFormData:!0,onSuccess:e=>{var m,c;console.log("Respuesta exitosa:",e);const s=((m=e.props.import)==null?void 0:m.id)||((c=e.props.flash)==null?void 0:c.import_id);s?(I("success",s),p.redirectOnSuccess&&ne.get(`/admin/imports/${s}`)):console.error("No se recibió ID de importación en la respuesta")},onError:e=>{console.error("Error al crear importación:",e)},onFinish:()=>{console.log("Petición finalizada")}})},se=V(()=>{const n=Object.values(l.field_mappings),e=n.includes("name"),s=n.includes("email");return e&&s}),M=n=>{if(n===0)return"0 Bytes";const e=1024,s=["Bytes","KB","MB","GB"],m=Math.floor(Math.log(n)/Math.log(e));return Math.round(n/Math.pow(e,m)*100)/100+" "+s[m]},oe=()=>300,te=n=>n>5242880;return(n,e)=>(u(),x(a(pe),null,{default:i(()=>[n.mode==="general"?(u(),x(a(ue),{key:0},{default:i(()=>[o(a(me),null,{default:i(()=>[d(f(J.value),1)]),_:1})]),_:1})):g("",!0),o(a(ce),{class:"p-6"},{default:i(()=>[n.mode==="votacion"?(u(),_("div",$e,[t("p",Ce,f(Q.value),1)])):g("",!0),o(a(re),{modelValue:$.value,"onUpdate:modelValue":e[5]||(e[5]=s=>$.value=s),class:"w-full"},{default:i(()=>[o(a(de),{class:"grid w-full grid-cols-2"},{default:i(()=>[o(a(A),{value:"config"},{default:i(()=>[t("span",Se,[o(a(xe),{class:"h-4 w-4"}),e[6]||(e[6]=d(" Configuración "))])]),_:1}),o(a(A),{value:"mapping",disabled:!H.value},{default:i(()=>[t("span",Ve,[o(a(ke),{class:"h-4 w-4"}),e[7]||(e[7]=d(" Mapeo de Campos "))])]),_:1},8,["disabled"])]),_:1}),o(a(L),{value:"config",class:"space-y-6"},{default:i(()=>[t("div",we,[t("div",ze,[o(a(F),{for:"name"},{default:i(()=>e[8]||(e[8]=[d("Nombre de la Importación")])),_:1}),o(a(U),{id:"name",modelValue:a(l).name,"onUpdate:modelValue":e[0]||(e[0]=s=>a(l).name=s),placeholder:n.mode==="votacion"?"Ej: Votantes primera vuelta":"Ej: Importación militantes enero 2025",class:B({"border-red-500":a(l).errors.name})},null,8,["modelValue","placeholder","class"]),a(l).errors.name?(u(),_("p",Ie,f(a(l).errors.name),1)):g("",!0)]),t("div",Me,[o(a(F),{for:"csv_file"},{default:i(()=>e[9]||(e[9]=[d("Archivo CSV")])),_:1}),o(a(U),{id:"csv_file",type:"file",accept:".csv",onChange:Y,class:B({"border-red-500":a(l).errors.csv_file})},null,8,["class"]),a(l).errors.csv_file?(u(),_("p",Be,f(a(l).errors.csv_file),1)):g("",!0),y.value?(u(),_("div",Ee,[t("div",Te,[o(a(R),{class:"h-4 w-4"}),t("span",null,f(y.value.name),1),e[10]||(e[10]=t("span",null,"·",-1)),t("span",null,f(M(y.value.size)),1)]),te(y.value.size)?(u(),_("div",Fe,[t("div",Ne,[o(a(j),{class:"h-4 w-4 text-orange-600 mt-0.5 flex-shrink-0"}),t("div",je,[t("strong",null,"Archivo grande detectado ("+f(M(y.value.size))+")",1),e[11]||(e[11]=t("p",{class:"mt-1"},"Este archivo tardará varios minutos en procesar. Se recomienda:",-1)),e[12]||(e[12]=t("ul",{class:"mt-1 space-y-0.5 list-disc list-inside"},[t("li",null,"Tener una conexión estable a internet"),t("li",null,"No cerrar la pestaña durante el proceso"),t("li",null,"Verificar que el mapeo sea correcto antes de iniciar")],-1))])])])):g("",!0)])):g("",!0),e[13]||(e[13]=t("p",{class:"text-sm text-muted-foreground"}," El archivo debe contener al menos las columnas: nombre y email (máximo 50MB) ",-1)),e[14]||(e[14]=t("p",{class:"text-sm text-blue-600"},[t("a",{href:"/ejemplo-usuarios.csv",download:"",class:"underline"}," 📥 Descargar plantilla CSV de ejemplo ")],-1))]),t("div",Ae,[o(a(F),{for:"import_mode"},{default:i(()=>e[15]||(e[15]=[d("Modo de Importación")])),_:1}),o(a(D),{modelValue:a(l).import_mode,"onUpdate:modelValue":e[1]||(e[1]=s=>a(l).import_mode=s)},{default:i(()=>[o(a(O),null,{default:i(()=>[o(a(P),{placeholder:"Selecciona el modo"})]),_:1}),o(a(q),null,{default:i(()=>[(u(),_(E,null,T(X,s=>o(a(N),{key:s.value,value:s.value},{default:i(()=>[d(f(s.label),1)]),_:2},1032,["value"])),64))]),_:1})]),_:1},8,["modelValue"]),e[16]||(e[16]=t("p",{class:"text-sm text-muted-foreground"}," Define cómo manejar usuarios que ya existen en el sistema ",-1))]),t("div",Le,[n.mode==="votacion"||n.mode==="asamblea"?(u(),x(a(k),{key:0,variant:"outline",onClick:e[2]||(e[2]=s=>I("cancel"))},{default:i(()=>e[17]||(e[17]=[d(" Cancelar ")])),_:1})):g("",!0),o(a(k),{onClick:Z,disabled:!a(l).name||!y.value||C.value},{default:i(()=>[o(a(R),{class:"mr-2 h-4 w-4"}),d(" "+f(C.value?"Analizando...":"Analizar CSV"),1)]),_:1},8,["disabled"])])])]),_:1}),o(a(L),{value:"mapping",class:"space-y-6"},{default:i(()=>[b.value?(u(),_("div",Ue,[o(a(be),{class:B(["mb-4",{"border-orange-200 bg-orange-50":b.value.is_large_file}])},{default:i(()=>[o(a(j),{class:"h-4 w-4"}),o(a(ye),null,{default:i(()=>[t("div",De,[t("div",null,[b.value.estimated?(u(),_("span",Oe,[e[18]||(e[18]=d(" Se encontraron aproximadamente ")),t("strong",null,"~"+f(b.value.total_rows.toLocaleString()),1),e[19]||(e[19]=d(" registros ")),e[20]||(e[20]=t("span",{class:"text-sm text-muted-foreground"},"(estimación)",-1))])):(u(),_("span",Pe,[e[21]||(e[21]=d(" Se encontraron ")),t("strong",null,f(b.value.total_rows.toLocaleString()),1),e[22]||(e[22]=d(" registros "))])),e[23]||(e[23]=d(" · Tamaño: ")),t("strong",null,f(M(b.value.file_size)),1)]),b.value.is_large_file?(u(),_("div",qe,[t("div",Ge,[o(a(j),{class:"h-4 w-4 text-orange-600 mt-0.5 flex-shrink-0"}),t("div",Re,[e[27]||(e[27]=t("strong",{class:"text-orange-800"},"Archivo grande detectado",-1)),t("ul",We,[e[24]||(e[24]=t("li",null,"• El procesamiento tomará varios minutos",-1)),t("li",null,"• Se procesará en batches de "+f(oe())+" registros",1),e[25]||(e[25]=t("li",null,"• Puedes seguir el progreso en tiempo real",-1)),e[26]||(e[26]=t("li",null,"• No cierres esta pestaña durante el proceso",-1))])])])])):g("",!0),t("div",Ke,[e[28]||(e[28]=d(" Los campos ")),e[29]||(e[29]=t("strong",null,"Nombre",-1)),e[30]||(e[30]=d(" y ")),e[31]||(e[31]=t("strong",null,"Email",-1)),e[32]||(e[32]=d(" son obligatorios. ")),n.mode==="votacion"?(u(),_("span",He," Los usuarios serán asignados automáticamente a la votación. ")):g("",!0),n.mode==="asamblea"?(u(),_("span",Xe," Los usuarios serán asignados automáticamente como participantes de la asamblea. ")):g("",!0)])])]),_:1})]),_:1},8,["class"]),t("div",Je,[o(a(_e),null,{default:i(()=>[o(a(ve),null,{default:i(()=>[o(a(G),null,{default:i(()=>[o(a(w),null,{default:i(()=>e[33]||(e[33]=[d("Columna del CSV")])),_:1}),o(a(w),null,{default:i(()=>e[34]||(e[34]=[d("Mapear a Campo")])),_:1}),a(l).import_mode!=="insert"?(u(),x(a(w),{key:0},{default:i(()=>e[35]||(e[35]=[d("Actualizar")])),_:1})):g("",!0),o(a(w),null,{default:i(()=>e[36]||(e[36]=[d("Vista Previa")])),_:1})]),_:1})]),_:1}),o(a(ge),null,{default:i(()=>[(u(!0),_(E,null,T(b.value.headers,s=>(u(),x(a(G),{key:s},{default:i(()=>[o(a(z),{class:"font-medium"},{default:i(()=>[d(f(s),1)]),_:2},1024),o(a(z),null,{default:i(()=>[o(a(D),{"model-value":a(l).field_mappings[s]||"none","onUpdate:modelValue":m=>h(s,m)},{default:i(()=>[o(a(O),{class:"w-full"},{default:i(()=>[o(a(P))]),_:1}),o(a(q),null,{default:i(()=>[o(a(N),{value:"none"},{default:i(()=>e[37]||(e[37]=[d("-- No mapear --")])),_:1}),(u(!0),_(E,null,T(b.value.available_fields,(m,c)=>(u(),x(a(N),{key:c,value:c},{default:i(()=>[d(f(m),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:2},1032,["model-value","onUpdate:modelValue"])]),_:2},1024),a(l).import_mode!=="insert"?(u(),x(a(z),{key:0},{default:i(()=>[a(l).field_mappings[s]&&a(l).field_mappings[s]!=="none"?(u(),_("div",Qe,[a(l).field_mappings[s]==="email"||a(l).field_mappings[s]==="documento_identidad"?(u(),_("div",Ye," Resolución manual ")):(u(),x(a(fe),{key:1,checked:a(l).update_fields.includes(a(l).field_mappings[s]),"onUpdate:checked":m=>ee(a(l).field_mappings[s],m)},null,8,["checked","onUpdate:checked"]))])):g("",!0)]),_:2},1024)):g("",!0),o(a(z),null,{default:i(()=>{var m;return[t("div",Ze,f(((m=b.value.sample_data[0])==null?void 0:m[b.value.headers.indexOf(s)])||"-"),1)]}),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),t("div",he,[o(a(k),{variant:"outline",onClick:e[3]||(e[3]=s=>$.value="config")},{default:i(()=>e[38]||(e[38]=[d(" Volver a Configuración ")])),_:1}),t("div",ea,[n.mode==="votacion"||n.mode==="asamblea"?(u(),x(a(k),{key:0,variant:"outline",onClick:e[4]||(e[4]=s=>I("cancel"))},{default:i(()=>e[39]||(e[39]=[d(" Cancelar ")])),_:1})):g("",!0),o(a(k),{onClick:ae,disabled:!se.value||a(l).processing},{default:i(()=>[d(f(a(l).processing?"Procesando...":"Iniciar Importación"),1)]),_:1},8,["disabled"])])])])):g("",!0)]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}))}});export{_a as _};
