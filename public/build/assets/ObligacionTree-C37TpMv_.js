import{G as ee,c as C,d as K,r as R,i as h,e as r,s as te,n as M,g as f,j as $,b as w,u as t,l as B,w as u,f as l,t as E,h as L,V as ae,T as se,F as G,k as q,ar as oe}from"./app-BY-r2Ws5.js";import{_ as A}from"./createLucideIcon-CuqvJpoP.js";import{_ as ne}from"./Separator.vue_vue_type_script_setup_true_lang-Ha5JJek3.js";import{a as I,b as V,c as F}from"./AdminLayout.vue_vue_type_script_setup_true_lang-rIgIF5sh.js";import{_ as le}from"./TooltipProvider.vue_vue_type_script_setup_true_lang-CASoHDz0.js";import{C as Q}from"./chevron-right-DkYrX6FT.js";import{C as ie}from"./circle-CBzkb3u1.js";import{L as re}from"./layers-DRiEVXTt.js";import{P as de}from"./paperclip-H9xSquDM.js";import{P as U}from"./plus-DP_VwEVQ.js";import{P as ce}from"./pencil-tFz13VVi.js";import{T as ue}from"./trash-2-B3ZZhlIi.js";import{_ as W}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{C as pe}from"./SelectValue.vue_vue_type_script_setup_true_lang-Cpe2WH2y.js";import{L as ge}from"./loader-circle-DRinwLpn.js";function X(){const N=ee(),S=C(()=>{var n;return((n=N.props.auth)==null?void 0:n.permissions)||[]}),g=C(()=>{var n;return((n=N.props.auth)==null?void 0:n.roles)||[]}),p=C(()=>g.value.some(n=>n.name==="super_admin")),D=C(()=>{var n;return((n=N.props.auth)==null?void 0:n.hasAdministrativeRole)||!1}),_=n=>p.value?!0:S.value.includes(n),d=n=>p.value?!0:n.every(v=>_(v)),j=n=>p.value?!0:n.some(v=>_(v)),y=n=>g.value.some(v=>v.name===n);return{authPermissions:S,authRoles:g,authIsSuperAdmin:p,hasAdministrativeRole:D,hasPermission:_,hasAllPermissions:d,hasAnyPermission:j,hasRole:y,hasAllRoles:n=>n.every(v=>y(v)),hasAnyRole:n=>n.some(v=>y(v))}}const fe=["draggable"],ve={class:"flex items-start gap-2"},me={key:1,class:"w-6"},he={class:"h-6 w-6 rounded-full flex items-center justify-center shrink-0 bg-gray-100"},be={class:"flex-1 min-w-0"},_e={class:"flex items-start justify-between"},ye={class:"flex-1"},$e={class:"font-medium text-sm truncate"},De={key:0,class:"text-xs text-gray-600 mt-1 line-clamp-2"},ke={class:"flex items-center gap-3 mt-2 text-xs text-gray-500"},xe={key:0,class:"flex items-center gap-1"},Ce={key:1,class:"flex items-center gap-1"},we={key:0,class:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity"},Ne={key:0,class:"mt-2"},je=K({__name:"ObligacionItem",props:{obligacion:{},nivel:{default:0},expanded:{type:Boolean,default:!1},selected:{type:Boolean,default:!1},editable:{type:Boolean,default:!0},onToggle:{},onSelect:{},onEdit:{},onDelete:{},onComplete:{},onAddChild:{},onDragStart:{},onDragOver:{},onDrop:{}},emits:["toggle","select","edit","delete","add-child","drag-start","drag-over","drop"],setup(N,{emit:S}){const g=N,p=S,{hasPermission:D}=X(),_=R(!1),d=C(()=>g.editable&&D("obligaciones.edit")),j=()=>{g.selected||p("select")},y=()=>{const o=g.obligacion.tiene_hijos?`¿Estás seguro de eliminar "${g.obligacion.titulo}" y todas sus obligaciones hijas?`:`¿Estás seguro de eliminar "${g.obligacion.titulo}"?`;confirm(o)&&p("delete")},k=o=>{d.value&&p("drag-start",g.obligacion,o)},b=o=>{d.value&&(o.preventDefault(),p("drag-over",o))},n=o=>{d.value&&(_.value=!1,p("drop",g.obligacion,o))},v=()=>{d.value&&(_.value=!0)},z=()=>{d.value&&(_.value=!1)};return(o,m)=>{var O,T;return r(),h("div",{class:M(["obligacion-item group",o.selected&&"bg-blue-50 border-blue-300",_.value&&"bg-gray-100 border-dashed","border rounded-lg p-2 mb-1 transition-all cursor-pointer hover:shadow-sm"]),style:te({marginLeft:`${o.nivel*24}px`}),draggable:d.value&&o.editable,onClick:j,onDragstart:k,onDragover:b,onDrop:n,onDragenter:v,onDragleave:z},[f("div",ve,[o.obligacion.tiene_hijos?(r(),w(t(A),{key:0,variant:"ghost",size:"icon",class:"h-6 w-6 shrink-0",onClick:m[0]||(m[0]=B(P=>o.$emit("toggle"),["stop"]))},{default:u(()=>[l(t(Q),{class:M(["h-4 w-4 transition-transform",o.expanded&&"rotate-90"])},null,8,["class"])]),_:1})):(r(),h("div",me)),f("div",he,[l(t(ie),{class:"h-3 w-3 text-gray-600"})]),f("div",be,[f("div",_e,[f("div",ye,[f("h4",$e,E(o.obligacion.titulo),1),o.obligacion.descripcion?(r(),h("p",De,E(o.obligacion.descripcion),1)):$("",!0),f("div",ke,[o.obligacion.tiene_hijos?(r(),h("div",xe,[l(t(re),{class:"h-3 w-3"}),f("span",null,E(o.obligacion.total_hijos)+" hijos",1)])):$("",!0),(O=o.obligacion.archivos_adjuntos)!=null&&O.length?(r(),h("div",Ce,[l(t(de),{class:"h-3 w-3"}),f("span",null,E(o.obligacion.archivos_adjuntos.length),1)])):$("",!0)])]),o.editable?(r(),h("div",we,[l(t(le),null,{default:u(()=>[l(t(I),null,{default:u(()=>[l(t(V),{asChild:""},{default:u(()=>[t(D)("obligaciones.create")?(r(),w(t(A),{key:0,variant:"ghost",size:"icon",class:"h-7 w-7",onClick:m[1]||(m[1]=B(P=>o.$emit("add-child"),["stop"]))},{default:u(()=>[l(t(U),{class:"h-3 w-3"})]),_:1})):$("",!0)]),_:1}),l(t(F),null,{default:u(()=>[...m[3]||(m[3]=[L("Añadir hijo",-1)])]),_:1})]),_:1}),l(t(I),null,{default:u(()=>[l(t(V),{asChild:""},{default:u(()=>[t(D)("obligaciones.edit")?(r(),w(t(A),{key:0,variant:"ghost",size:"icon",class:"h-7 w-7",onClick:m[2]||(m[2]=B(P=>o.$emit("edit"),["stop"]))},{default:u(()=>[l(t(ce),{class:"h-3 w-3"})]),_:1})):$("",!0)]),_:1}),l(t(F),null,{default:u(()=>[...m[4]||(m[4]=[L("Editar",-1)])]),_:1})]),_:1}),l(t(I),null,{default:u(()=>[l(t(V),{asChild:""},{default:u(()=>[t(D)("obligaciones.delete")?(r(),w(t(A),{key:0,variant:"ghost",size:"icon",class:"h-7 w-7 text-red-600 hover:text-red-700",onClick:B(y,["stop"])},{default:u(()=>[l(t(ue),{class:"h-3 w-3"})]),_:1})):$("",!0)]),_:1}),l(t(F),null,{default:u(()=>[...m[5]||(m[5]=[L("Eliminar",-1)])]),_:1})]),_:1})]),_:1})])):$("",!0)])])]),o.expanded&&((T=o.obligacion.hijos)!=null&&T.length)?(r(),h("div",Ne,[ae(o.$slots,"children",{},void 0,!0)])):$("",!0)],46,fe)}}}),H=W(je,[["__scopeId","data-v-43c5dc18"]]),Ae={class:"obligacion-tree"},Se={class:"flex items-center justify-between mb-4 p-2 bg-gray-50 rounded-lg"},Te={class:"flex items-center gap-2"},Ee={class:"flex items-center gap-2"},Oe={class:"text-sm text-gray-600"},Pe={key:0,class:"flex items-center justify-center py-8"},Re={key:1,class:"text-center py-8 text-gray-500"},ze={key:0,class:"mt-4 bg-gray-50 p-2 rounded text-center"},Be={class:"text-2xl font-bold"},Le=K({__name:"ObligacionTree",props:{obligaciones:{},contratoId:{},editable:{type:Boolean,default:!0},selectable:{type:Boolean,default:!0},expandedNodes:{default:()=>[]},selectedNode:{default:null},onSelect:{},onEdit:{},onDelete:{},onComplete:{},onAddChild:{},onMove:{},onReorder:{}},emits:["select","edit","delete","add-child","create","move","reorder","update:expandedNodes","update:selectedNode"],setup(N,{emit:S}){const g=N,p=S,{hasPermission:D}=X(),_=R(!1),d=R(g.expandedNodes),j=R(g.selectedNode),y=R(null),k=C(()=>g.editable&&D("obligaciones.edit")),b=C(()=>{const e=[],a=s=>{s.forEach(c=>{var i;e.push(c),(i=c.hijos)!=null&&i.length&&a(c.hijos)})};return a(g.obligaciones),e}),n=C(()=>Z(g.obligaciones)),v=e=>{const a=d.value.indexOf(e);a>-1?d.value.splice(a,1):d.value.push(e),p("update:expandedNodes",d.value)},z=e=>{if(j.value=e,p("update:selectedNode",e),e){const a=b.value.find(s=>s.id===e);a&&p("select",a)}},o=()=>{d.value=b.value.filter(e=>e.tiene_hijos).map(e=>e.id),p("update:expandedNodes",d.value)},m=()=>{d.value=[],p("update:expandedNodes",d.value)},O=(e,a)=>{k.value&&(y.value={obligacionId:e.id,parentId:e.parent_id,orden:e.orden,nivel:e.nivel},a.dataTransfer.effectAllowed="move",a.dataTransfer.setData("application/json",JSON.stringify(y.value)))},T=e=>{k.value&&(e.preventDefault(),e.dataTransfer.dropEffect="move")},P=(e,a)=>{if(!k.value)return;a.preventDefault(),a.stopPropagation();const s=JSON.parse(a.dataTransfer.getData("application/json"));if(!(!s||s.obligacionId===e.id)){if(J(s.obligacionId,e.id)){console.error("No se puede mover una obligación dentro de sus propios hijos");return}p("move",b.value.find(c=>c.id===s.obligacionId),e.id,e.orden+1),y.value=null}},Y=e=>{if(!k.value)return;e.preventDefault(),e.stopPropagation();const a=JSON.parse(e.dataTransfer.getData("application/json"));a&&(p("move",b.value.find(s=>s.id===a.obligacionId),null,1),y.value=null)},Z=e=>{const a=new Map,s=[];return e.forEach(c=>{a.set(c.id,{...c,hijos:[]})}),e.forEach(c=>{const i=a.get(c.id);if(c.parent_id===null)s.push(i);else{const x=a.get(c.parent_id);x&&(x.hijos=x.hijos||[],x.hijos.push(i))}}),s.sort((c,i)=>c.orden-i.orden)},J=(e,a)=>{const s=b.value.find(c=>c.id===a);return s?s.parent_id===e?!0:s.parent_id===null?!1:J(e,s.parent_id):!1};return(e,a)=>(r(),h("div",Ae,[f("div",Se,[f("div",Te,[l(t(A),{size:"sm",variant:"outline",onClick:o,title:"Expandir todo"},{default:u(()=>[l(t(pe),{class:"h-4 w-4"})]),_:1}),l(t(A),{size:"sm",variant:"outline",onClick:m,title:"Colapsar todo"},{default:u(()=>[l(t(Q),{class:"h-4 w-4"})]),_:1}),l(t(ne),{orientation:"vertical",class:"h-6"}),e.editable&&t(D)("obligaciones.create")?(r(),w(t(A),{key:0,size:"sm",variant:"outline",onClick:a[0]||(a[0]=s=>e.$emit("create"))},{default:u(()=>[l(t(U),{class:"h-4 w-4 mr-1"}),a[1]||(a[1]=L(" Nueva Obligación ",-1))]),_:1})):$("",!0)]),f("div",Ee,[f("span",Oe,E(b.value.length)+" obligaciones ",1)])]),f("div",{class:"obligacion-tree-container border rounded-lg p-2 min-h-[200px]",onDragover:T,onDrop:Y},[_.value?(r(),h("div",Pe,[l(t(ge),{class:"h-8 w-8 animate-spin text-gray-400"})])):n.value.length?(r(),w(se,{key:2,name:"list",tag:"div",class:"space-y-1"},{default:u(()=>[(r(!0),h(G,null,q(n.value,s=>{var c;return r(),w(H,{key:s.id,obligacion:s,nivel:0,expanded:d.value.includes(s.id),selected:j.value===s.id,editable:e.editable,draggable:k.value,onToggle:i=>v(s.id),onSelect:i=>z(s.id),onEdit:i=>e.$emit("edit",s),onDelete:i=>e.$emit("delete",s),onAddChild:i=>e.$emit("add-child",s),onDragStart:O,onDragOver:T,onDrop:P},oe({_:2},[(c=s.hijos)!=null&&c.length?{name:"children",fn:u(()=>[(r(!0),h(G,null,q(s.hijos,i=>(r(),w(H,{key:i.id,obligacion:i,nivel:1,expanded:d.value.includes(i.id),selected:j.value===i.id,editable:e.editable,draggable:k.value,onToggle:x=>v(i.id),onSelect:x=>z(i.id),onEdit:x=>e.$emit("edit",i),onDelete:x=>e.$emit("delete",i),onAddChild:x=>e.$emit("add-child",i),onDragStart:O,onDragOver:T,onDrop:P},null,8,["obligacion","expanded","selected","editable","draggable","onToggle","onSelect","onEdit","onDelete","onAddChild"]))),128))]),key:"0"}:void 0]),1032,["obligacion","expanded","selected","editable","draggable","onToggle","onSelect","onEdit","onDelete","onAddChild"])}),128))]),_:1})):(r(),h("div",Re," No hay obligaciones registradas "))],32),b.value.length?(r(),h("div",ze,[f("div",Be,E(b.value.length),1),a[2]||(a[2]=f("div",{class:"text-xs text-gray-600"},"Total de Obligaciones",-1))])):$("",!0)]))}}),et=W(Le,[["__scopeId","data-v-9e4e2634"]]);export{et as O,X as u};
