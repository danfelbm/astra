import{d as fe,r as c,c as ve,i as h,e as u,f as s,u as a,p as me,w as t,g as n,b,j as v,h as i,l as pe,t as _,F as M,k as K,a as I}from"./app-YX-Bh59c.js";import{_ as ge}from"./GuestLayout.vue_vue_type_script_setup_true_lang-B91-9Y2q.js";import{_ as W,a as F,b as Z,c as O}from"./CardTitle.vue_vue_type_script_setup_true_lang-CEXipE4i.js";import{_ as Q}from"./CardDescription.vue_vue_type_script_setup_true_lang-C5zKyXgU.js";import{_ as R}from"./createLucideIcon-6ox98eKE.js";import{_ as _e}from"./Input.vue_vue_type_script_setup_true_lang-DtRE74-R.js";import{_ as q}from"./Label.vue_vue_type_script_setup_true_lang-dMdLaxwj.js";import{_ as D,a as B}from"./index-FDFIrEGY.js";import{_ as ye}from"./AlertTitle.vue_vue_type_script_setup_true_lang-C-vqnDcE.js";import{_ as X,a as Y,b as ee}from"./PinInputSlot.vue_vue_type_script_setup_true_lang-D4fBNIKy.js";import{t as y}from"./index-BTUR61ux.js";import{S as we}from"./search-C388TDxM.js";import{C as G}from"./circle-alert-Dcf5wzqR.js";import{L as ae}from"./loader-circle-RpcFRhSb.js";import{U as be}from"./user-check-BmHIsIkd.js";import"./index-BKfwd4cF.js";import"./AppLogo.vue_vue_type_script_setup_true_lang-Bf0OBuaA.js";import"./index-CFLnPJ45.js";import"./VisuallyHidden-DDRJ2xSr.js";import"./VisuallyHiddenInput-DBAqBlF2.js";const xe={class:"max-w-2xl mx-auto"},ke={class:"bg-muted p-4 rounded-lg space-y-2"},Ce={class:"flex flex-col gap-2 mt-3"},he={key:0,class:"flex items-center gap-2"},$e={class:"text-sm"},Ve={key:1,class:"flex items-center gap-2"},Ae={class:"text-sm"},Se={class:"flex gap-3"},Ee={key:1,class:"pb-4 border-b"},Re={class:"space-y-3"},Te={key:2,class:"space-y-2"},Ue={class:"flex gap-2 items-center"},De={key:3,class:"space-y-2"},Be={class:"flex gap-2 items-center"},sa=fe({__name:"RegistrationConfirmation",setup(Ne){const A=c(!1),S=c(""),m=c(null),C=c(null),d=c(""),p=c(null),$=c("search"),f=c({email:"",whatsapp:""}),E=c(!1),P=c(!1),T=c(0),j=c(null),U=c(!1),L=c(!1),x=c({email:!1,whatsapp:!1}),se=async()=>{var l,e,o;if(!S.value){y.error("Por favor ingresa un número de documento");return}A.value=!0,d.value="",m.value=null,p.value=null;try{const r=await I.post("/confirmar-registro/buscar",{documento_identidad:S.value});r.data.success&&(m.value=r.data.user,C.value=r.data.verification_id,p.value=r.data.censo_restriction||null,$.value="found",y.success("Usuario encontrado correctamente"))}catch(r){((l=r.response)==null?void 0:l.status)===404?d.value="No se encontró ningún usuario registrado con ese documento.":d.value=((o=(e=r.response)==null?void 0:e.data)==null?void 0:o.message)||"Error al buscar el usuario",y.error(d.value)}finally{A.value=!1}},te=async()=>{var l,e,o;if(C.value){U.value=!0;try{const r=await I.post("/confirmar-registro/enviar-verificacion",{verification_id:C.value});r.data.success&&(L.value=!0,x.value=r.data.channels,$.value="verifying",le(),y.success("Códigos de verificación enviados"),x.value.email&&x.value.whatsapp?y.info("Revisa tu email y WhatsApp"):x.value.email?y.info("Revisa tu email"):x.value.whatsapp&&y.info("Revisa tu WhatsApp"))}catch(r){((l=r.response)==null?void 0:l.status)===429?d.value="Has excedido el límite de intentos. Por favor, espera 1 hora.":d.value=((o=(e=r.response)==null?void 0:e.data)==null?void 0:o.message)||"Error al enviar códigos",y.error(d.value)}finally{U.value=!1}}},le=()=>{T.value=10,j.value=setInterval(()=>{T.value--,T.value<=0&&(clearInterval(j.value),re())},1e3)},re=async()=>{if(C.value)try{(await I.post("/confirmar-registro/check-timeout",{verification_id:C.value})).data.can_proceed&&(P.value=!0)}catch(l){console.error("Error checking timeout:",l)}},N=async l=>{var r,w,k,V;const e=l==="email"?f.value.email:f.value.whatsapp,o=Array.isArray(e)?e.join(""):String(e);if(!o||o.length!==6){y.error("Por favor ingresa un código de 6 dígitos");return}E.value=!0;try{const g=await I.post("/confirmar-registro/verificar-codigo",{verification_id:C.value,code:o,channel:l});g.data.success&&(y.success("Código verificado correctamente"),g.data.fully_verified||g.data.can_proceed?H():l==="email"?x.value.email=!1:x.value.whatsapp=!1)}catch(g){(w=(r=g.response)==null?void 0:r.data)!=null&&w.expired?(d.value="Los códigos han expirado. Por favor, solicita nuevos códigos.",$.value="found",L.value=!1):d.value=((V=(k=g.response)==null?void 0:k.data)==null?void 0:V.message)||"Código incorrecto",y.error(d.value)}finally{E.value=!1}},H=()=>{window.location.href=`/confirmar-registro/actualizar-datos?verification_id=${C.value}`},oe=()=>{S.value="",m.value=null,C.value=null,p.value=null,$.value="search",L.value=!1,P.value=!1,d.value="",f.value={email:"",whatsapp:""},clearInterval(j.value)},J=ve(()=>T.value>0?`Si no recibes los códigos, podrás actualizar tus datos en ${T.value} segundos`:""),ie=l=>l?l.split(" ").map(o=>{if(o.length<=2)return o;const r=o.substring(0,2),w="*".repeat(o.length-2);return r+w}).join(" "):"",ne=l=>{if(!l)return"";const[e,o]=l.split("@");if(!e||!o)return l;const[r,w]=o.split(".");if(!r||!w)return l;let k="";if(e.length<=3)k=e;else{const g=e.substring(0,2),z=e.substring(e.length-1),ce="*".repeat(e.length-3);k=g+ce+z}const V=r[0]+"*".repeat(r.length-1);return`${k}@${V}.${w}`},ue=l=>{if(!l)return"";if(l.length<=6)return l;const e=l.substring(0,5),o=l.substring(l.length-1),r="*".repeat(l.length-6);return e+r+o},de=l=>{if(!l)return"";const e=l.includes("Z")||l.includes("+")?l:l+"Z",o=new Date(e),r={year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0,timeZone:"America/Bogota"};return o.toLocaleDateString("es-CO",r)+" (GMT-5)"};return(l,e)=>(u(),h(M,null,[s(a(me),{title:"Confirmar Registro"}),s(ge,{title:"Confirmación de Registro",description:"Verifica si estás registrado en el sistema y actualiza tus datos de contacto"},{default:t(()=>[n("div",xe,[$.value==="search"?(u(),b(a(W),{key:0,class:"shadow-lg"},{default:t(()=>[s(a(F),null,{default:t(()=>[s(a(Z),{class:"flex items-center gap-2"},{default:t(()=>[s(a(we),{class:"w-5 h-5"}),e[7]||(e[7]=i(" Buscar Registro ",-1))]),_:1}),s(a(Q),null,{default:t(()=>[...e[8]||(e[8]=[i(" Ingresa tu número de documento para verificar si estás registrado ",-1)])]),_:1})]),_:1}),s(a(O),null,{default:t(()=>[n("form",{onSubmit:pe(se,["prevent"]),class:"space-y-4"},[n("div",null,[s(a(q),{for:"documento"},{default:t(()=>[...e[9]||(e[9]=[i("Número de Documento",-1)])]),_:1}),s(a(_e),{id:"documento",modelValue:S.value,"onUpdate:modelValue":e[0]||(e[0]=o=>S.value=o),type:"text",placeholder:"Ej: 1234567890",disabled:A.value,class:"mt-1",autofocus:""},null,8,["modelValue","disabled"])]),d.value?(u(),b(a(D),{key:0,variant:"destructive"},{default:t(()=>[s(a(G),{class:"h-4 w-4"}),s(a(B),null,{default:t(()=>[i(_(d.value),1)]),_:1})]),_:1})):v("",!0),s(a(R),{type:"submit",disabled:A.value||!S.value,class:"w-full"},{default:t(()=>[A.value?(u(),b(a(ae),{key:0,class:"mr-2 h-4 w-4 animate-spin"})):v("",!0),i(" "+_(A.value?"Buscando...":"Buscar"),1)]),_:1},8,["disabled"])],32)]),_:1})]),_:1})):$.value==="found"?(u(),b(a(W),{key:1,class:"shadow-lg"},{default:t(()=>[s(a(F),null,{default:t(()=>[s(a(Z),{class:"flex items-center gap-2"},{default:t(()=>[s(a(be),{class:"w-5 h-5 text-green-600"}),e[10]||(e[10]=i(" Usuario Encontrado ",-1))]),_:1})]),_:1}),s(a(O),{class:"space-y-4"},{default:t(()=>{var o,r,w,k,V,g,z;return[n("div",ke,[n("p",null,[e[11]||(e[11]=n("strong",null,"Nombre:",-1)),i(" "+_(ie(((o=m.value)==null?void 0:o.name)||"")),1)]),n("p",null,[e[12]||(e[12]=n("strong",null,"Documento:",-1)),i(" "+_((r=m.value)==null?void 0:r.documento_identidad),1)]),n("p",null,[e[13]||(e[13]=n("strong",null,"Registrado en:",-1)),i(" "+_(de(((w=m.value)==null?void 0:w.created_at)||"")),1)]),n("div",Ce,[(k=m.value)!=null&&k.has_email&&((V=m.value)!=null&&V.email)?(u(),h("div",he,[e[15]||(e[15]=n("span",{class:"text-sm text-green-600"},"✓",-1)),n("span",$e,[e[14]||(e[14]=n("strong",null,"Email:",-1)),i(" "+_(ne(m.value.email)),1)])])):v("",!0),(g=m.value)!=null&&g.has_phone&&((z=m.value)!=null&&z.telefono)?(u(),h("div",Ve,[e[17]||(e[17]=n("span",{class:"text-sm text-green-600"},"✓",-1)),n("span",Ae,[e[16]||(e[16]=n("strong",null,"Teléfono:",-1)),i(" "+_(ue(m.value.telefono)),1)])])):v("",!0)])]),p.value&&p.value.restricted?(u(),b(a(D),{key:0,variant:"destructive",class:"my-4"},{default:t(()=>[s(a(G),{class:"h-4 w-4"}),s(a(ye),null,{default:t(()=>[...e[18]||(e[18]=[i("Restricción de Censo Electoral",-1)])]),_:1}),s(a(B),{class:"mt-2"},{default:t(()=>[i(_(p.value.message),1)]),_:1})]),_:1})):v("",!0),!p.value||!p.value.restricted?(u(),b(a(D),{key:1},{default:t(()=>[s(a(B),{class:"text-foreground"},{default:t(()=>[...e[19]||(e[19]=[i(" ¿Tus datos son correctos? Puedes validarlos a continuación y actualizarlos si deseas. Te enviaremos códigos de verificación a tu email y/o teléfono registrados (via WhatsApp). ",-1)])]),_:1})]),_:1})):v("",!0),n("div",Se,[s(a(R),{onClick:te,disabled:U.value||p.value&&p.value.restricted,class:"flex-1"},{default:t(()=>[U.value?(u(),b(a(ae),{key:0,class:"mr-2 h-4 w-4 animate-spin"})):v("",!0),i(" "+_(U.value?"Enviando...":p.value&&p.value.restricted?"Validación no disponible":"Validar Datos"),1)]),_:1},8,["disabled"]),s(a(R),{onClick:oe,variant:"outline"},{default:t(()=>[...e[20]||(e[20]=[i(" Buscar otro ",-1)])]),_:1})])]}),_:1})]),_:1})):$.value==="verifying"?(u(),b(a(W),{key:2,class:"shadow-lg"},{default:t(()=>[s(a(F),null,{default:t(()=>[s(a(Z),null,{default:t(()=>[...e[21]||(e[21]=[i("Valida datos existentes",-1)])]),_:1}),s(a(Q),null,{default:t(()=>[...e[22]||(e[22]=[i(" Si tus datos son correctos puedes validarlos a continuación; ingresa los códigos que recibiste por email y por whatsapp ",-1)])]),_:1})]),_:1}),s(a(O),{class:"space-y-4"},{default:t(()=>[J.value?(u(),b(a(D),{key:0,class:"border-green-200 bg-green-50"},{default:t(()=>[s(a(B),{class:"text-green-700"},{default:t(()=>[i(_(J.value),1)]),_:1})]),_:1})):v("",!0),P.value?(u(),h("div",Ee,[n("div",Re,[e[24]||(e[24]=n("p",{class:"text-sm text-muted-foreground"}," Si no recibiste los códigos, puedes esperar un poco y actualizar tus datos: ",-1)),s(a(R),{onClick:H,variant:"default",class:"w-full"},{default:t(()=>[...e[23]||(e[23]=[i(" ¿Deseas actualizar datos? ",-1)])]),_:1})])])):v("",!0),x.value.email?(u(),h("div",Te,[s(a(q),null,{default:t(()=>[...e[25]||(e[25]=[i("Código de Email",-1)])]),_:1}),n("div",Ue,[s(a(X),{modelValue:f.value.email,"onUpdate:modelValue":e[1]||(e[1]=o=>f.value.email=o),disabled:E.value,placeholder:"○",onComplete:e[2]||(e[2]=()=>N("email"))},{default:t(()=>[s(a(Y),null,{default:t(()=>[(u(),h(M,null,K(6,(o,r)=>s(a(ee),{key:r,index:r},null,8,["index"])),64))]),_:1})]),_:1},8,["modelValue","disabled"]),s(a(R),{onClick:e[3]||(e[3]=o=>N("email")),disabled:E.value||(Array.isArray(f.value.email)?f.value.email.join("").length!==6:f.value.email.length!==6),size:"sm"},{default:t(()=>[...e[26]||(e[26]=[i(" Verificar ",-1)])]),_:1},8,["disabled"])])])):v("",!0),x.value.whatsapp?(u(),h("div",De,[s(a(q),null,{default:t(()=>[...e[27]||(e[27]=[i("Código de WhatsApp",-1)])]),_:1}),n("div",Be,[s(a(X),{modelValue:f.value.whatsapp,"onUpdate:modelValue":e[4]||(e[4]=o=>f.value.whatsapp=o),disabled:E.value,placeholder:"○",onComplete:e[5]||(e[5]=()=>N("whatsapp"))},{default:t(()=>[s(a(Y),null,{default:t(()=>[(u(),h(M,null,K(6,(o,r)=>s(a(ee),{key:r,index:r},null,8,["index"])),64))]),_:1})]),_:1},8,["modelValue","disabled"]),s(a(R),{onClick:e[6]||(e[6]=o=>N("whatsapp")),disabled:E.value||(Array.isArray(f.value.whatsapp)?f.value.whatsapp.join("").length!==6:f.value.whatsapp.length!==6),size:"sm"},{default:t(()=>[...e[28]||(e[28]=[i(" Verificar ",-1)])]),_:1},8,["disabled"])])])):v("",!0),d.value?(u(),b(a(D),{key:4,variant:"destructive"},{default:t(()=>[s(a(G),{class:"h-4 w-4"}),s(a(B),null,{default:t(()=>[i(_(d.value),1)]),_:1})]),_:1})):v("",!0)]),_:1})]),_:1})):v("",!0)])]),_:1})],64))}});export{sa as default};
