import{a as L,_ as P}from"./index-RQ351I0Z.js";import{_ as I}from"./AlertTitle.vue_vue_type_script_setup_true_lang-64TwnJPX.js";import{_ as w}from"./createLucideIcon-C9mG6ZOc.js";import{a as A,b as M,c as D,_ as j,t as S,d as re}from"./index-B96tN2on.js";import{_ as B}from"./CardDescription.vue_vue_type_script_setup_true_lang-Bbj3gq6V.js";import{d as oe,k as v,c as _,p as le,x as ne,a as k,o as n,f as u,i as g,j as c,b as s,u as a,e as t,n as ie,g as o,t as x,q as G}from"./app-BKga0G81.js";import{V as O}from"./video-DvNyquUc.js";import{R as F}from"./refresh-cw-DNOzn06G.js";import{L as U}from"./loader-circle-C4CTnOPp.js";import{l as Z}from"./DialogTitle.vue_vue_type_script_setup_true_lang-BVlt7i95.js";import{C as ue}from"./circle-check-1FMEf-EB.js";import{C as J}from"./clock-CYmzFQXP.js";import{E as de}from"./external-link-Ci7hAoKC.js";import"./VisuallyHidden-DIFBjfe-.js";import"./Label.vue_vue_type_script_setup_true_lang-BnF8UYrH.js";import"./index-BfJuGmOx.js";const ce={class:"space-y-4"},me={class:"flex items-center gap-2 mb-4"},fe={key:0,class:"text-center py-8"},pe={key:2},ge={class:"flex gap-2"},ve={key:0},_e={class:"text-sm"},xe={key:1},be={class:"text-sm font-mono bg-gray-50 px-2 py-1 rounded"},ye={class:"pt-2"},we={key:0,class:"mb-3"},ke={class:"flex gap-2"},Ee=5*60*1e3,Ce=oe({__name:"ZoomApiMeeting",props:{asambleaId:{}},setup(Y){const R=Y,m=v(!1),b=v(!1),f=v(!1),y=v(null),N=v(null),d=v(null),i=v(null),{route:T}=window,E=async()=>{try{m.value=!0,d.value=null;const e=(await G.get(T("api.zoom.registrants.status",R.asambleaId))).data;e.success?(i.value=e,e.existing_registration&&e.existing_registration.status==="completed"||e.existing_registration&&e.existing_registration.status==="failed"?C():(e.processing||f.value)&&(y.value||q())):d.value=e.error||"Error obteniendo estado"}catch(r){console.error("Error fetching status:",r),d.value="Error de conexiÃ³n"}finally{m.value=!1}},h=async()=>{d.value=null,i.value.existing_registration=null,await H()},H=async()=>{var r,e;try{b.value=!0,d.value=null;const l=await G.post(T("api.zoom.registrants.register"),{asamblea_id:R.asambleaId});l.data.success?l.data.processing?(f.value=!0,i.value=l.data,q(),S.success("ðŸ”„ Procesando registro",{description:"Se estÃ¡ generando tu enlace de videoconferencia...",duration:4e3})):await E():d.value=l.data.error||"Error registrando usuario"}catch(l){console.error("Error registering user:",l),(e=(r=l.response)==null?void 0:r.data)!=null&&e.error?d.value=l.response.data.error:d.value="Error de conexiÃ³n"}finally{b.value=!1}},K=async()=>{try{m.value=!0,d.value=null;const e=(await G.delete(T("api.zoom.registrants.destroy",R.asambleaId))).data;e.success?await E():d.value=e.error||"Error cancelando registro"}catch(r){console.error("Error canceling registration:",r),d.value="Error de conexiÃ³n"}finally{m.value=!1}},Q=async()=>{var r,e;try{(await G.post(T("asambleas.marcar-asistencia",R.asambleaId))).data.success&&S.success("âœ… Asistencia registrada",{description:"Tu asistencia ha sido marcada exitosamente",duration:3e3})}catch(l){console.error("Error marcando asistencia:",l),((r=l.response)==null?void 0:r.status)===400?S.warning("La asamblea no estÃ¡ en curso",{duration:3e3}):((e=l.response)==null?void 0:e.status)===403?S.error("No eres participante de esta asamblea",{duration:3e3}):S.error("Error al registrar asistencia",{description:"Tu asistencia no pudo ser registrada, pero puedes unirte a la reuniÃ³n",duration:4e3})}},W=async()=>{var r;await Q(),(r=p.value)!=null&&r.zoom_join_url&&window.open(p.value.zoom_join_url,"_blank","noopener,noreferrer")},q=()=>{C(),N.value=Date.now(),y.value=setInterval(async()=>{try{if(N.value&&Date.now()-N.value>Ee){console.warn("Polling timeout alcanzado (5 minutos)"),d.value="El proceso estÃ¡ tomando mÃ¡s tiempo del esperado. Por favor, recarga la pÃ¡gina.",C();return}await E()}catch(r){console.error("Error en polling:",r)}},2e3)},C=()=>{y.value&&(clearInterval(y.value),y.value=null),N.value=null,f.value=!1},p=_(()=>{var e;if(!((e=i.value)!=null&&e.existing_registration))return null;const r=i.value.existing_registration;return{...r,statusColor:r.status==="completed"?"bg-green-100 text-green-800":r.status==="pending"?"bg-yellow-100 text-yellow-800":r.status==="failed"?"bg-red-100 text-red-800":"bg-gray-100 text-gray-800"}}),V=_(()=>{var r,e;return((e=(r=i.value)==null?void 0:r.existing_registration)==null?void 0:e.status)==="failed"}),X=_(()=>{var e,l;if(!V.value)return null;const r=((l=(e=i.value)==null?void 0:e.existing_registration)==null?void 0:l.error_message)||"Error desconocido al registrar";return r.toLowerCase().includes("rate limit")?"Se ha alcanzado el lÃ­mite diario de registros. Por favor, intenta nuevamente maÃ±ana.":r}),ee=_(()=>{var l,z;if(!V.value)return!1;const r=((z=(l=i.value)==null?void 0:l.existing_registration)==null?void 0:z.error_message)||"";return!["no existe","capacidad mÃ¡xima","no tiene permisos"].some($=>r.toLowerCase().includes($))}),ae=_(()=>{var r,e,l;return V.value?!1:((r=i.value)==null?void 0:r.can_register)&&!((e=i.value)!=null&&e.existing_registration)&&!f.value&&!((l=i.value)!=null&&l.processing)}),se=_(()=>{var l,z,$;const r=(l=i.value)==null?void 0:l.existing_registration,e=(($=(z=i.value)==null?void 0:z.asamblea)==null?void 0:$.estado)==="en_curso";return r&&r.status==="completed"&&r.zoom_join_url&&e}),te=_(()=>{var r,e;return((e=(r=i.value)==null?void 0:r.asamblea)==null?void 0:e.estado)==="en_curso"});return le(()=>{E()}),ne(()=>{C()}),(r,e)=>(n(),k("div",ce,[u("div",me,[s(a(O),{class:"h-5 w-5 text-blue-600"}),e[0]||(e[0]=u("h3",{class:"text-lg font-semibold"},"Videoconferencia",-1)),s(a(w),{variant:"ghost",size:"sm",onClick:E,disabled:m.value,class:"ml-auto"},{default:t(()=>[s(a(F),{class:ie(["h-4 w-4",{"animate-spin":m.value}])},null,8,["class"])]),_:1},8,["disabled"])]),m.value&&!i.value?(n(),k("div",fe,[s(a(U),{class:"h-8 w-8 animate-spin mx-auto mb-2"}),e[1]||(e[1]=u("p",{class:"text-muted-foreground"},"Cargando informaciÃ³n...",-1))])):g("",!0),d.value?(n(),c(a(P),{key:1,variant:"destructive"},{default:t(()=>[s(a(Z),{class:"h-4 w-4"}),s(a(I),null,{default:t(()=>e[2]||(e[2]=[o("Error")])),_:1}),s(a(L),null,{default:t(()=>[o(x(d.value),1)]),_:1})]),_:1})):g("",!0),i.value&&!m.value?(n(),k("div",pe,[f.value||i.value.processing?(n(),c(a(j),{key:0,class:"border-blue-200 bg-blue-50"},{default:t(()=>[s(a(A),null,{default:t(()=>[s(a(M),{class:"flex items-center gap-2 text-blue-700"},{default:t(()=>[s(a(U),{class:"h-5 w-5 animate-spin"}),e[3]||(e[3]=o(" Procesando registro "))]),_:1}),s(a(B),null,{default:t(()=>e[4]||(e[4]=[o(" Se estÃ¡ generando tu enlace personal de videoconferencia... ")])),_:1})]),_:1}),s(a(D),null,{default:t(()=>e[5]||(e[5]=[u("div",{class:"space-y-2"},[u("div",{class:"text-sm text-blue-600"},[o(" âœ… Validaciones completadas"),u("br"),o(" ðŸ”„ Registrando en Zoom..."),u("br"),o(" ðŸ“§ Preparando notificaciÃ³n por email ")]),u("p",{class:"text-xs text-muted-foreground"}," Este proceso toma entre 1-2 minutos. La pÃ¡gina se actualizarÃ¡ automÃ¡ticamente. ")],-1)])),_:1})]),_:1})):V.value?(n(),c(a(j),{key:1,class:"border-red-200 bg-red-50"},{default:t(()=>[s(a(A),null,{default:t(()=>[s(a(M),{class:"flex items-center gap-2 text-red-700"},{default:t(()=>[s(a(Z),{class:"h-5 w-5"}),e[6]||(e[6]=o(" Error en el registro "))]),_:1}),s(a(B),{class:"text-red-600"},{default:t(()=>e[7]||(e[7]=[o(" No se pudo completar tu registro en la videoconferencia ")])),_:1})]),_:1}),s(a(D),{class:"space-y-4"},{default:t(()=>[s(a(P),{variant:"destructive"},{default:t(()=>[s(a(Z),{class:"h-4 w-4"}),s(a(I),null,{default:t(()=>e[8]||(e[8]=[o("Detalles del error")])),_:1}),s(a(L),null,{default:t(()=>[o(x(X.value),1)]),_:1})]),_:1}),u("div",ge,[ee.value?(n(),c(a(w),{key:0,onClick:h,disabled:b.value||f.value,class:"flex-1"},{default:t(()=>[b.value||f.value?(n(),c(a(F),{key:0,class:"mr-2 h-4 w-4 animate-spin"})):(n(),c(a(F),{key:1,class:"mr-2 h-4 w-4"})),e[9]||(e[9]=o(" Reintentar registro "))]),_:1},8,["disabled"])):(n(),c(a(w),{key:1,variant:"outline",disabled:"",class:"flex-1"},{default:t(()=>e[10]||(e[10]=[o(" No se puede reintentar ")])),_:1}))]),e[11]||(e[11]=u("p",{class:"text-xs text-muted-foreground"}," Si el problema persiste, contacta al administrador. ",-1))]),_:1})]),_:1})):p.value&&p.value.status==="completed"?(n(),c(a(j),{key:2,class:"border-green-200"},{default:t(()=>[s(a(A),null,{default:t(()=>[s(a(M),{class:"flex items-center gap-2 text-green-700"},{default:t(()=>[s(a(ue),{class:"h-5 w-5"}),e[12]||(e[12]=o(" Ya estÃ¡s registrado "))]),_:1}),s(a(B),null,{default:t(()=>e[13]||(e[13]=[o(" Tienes acceso a esta videoconferencia ")])),_:1})]),_:1}),s(a(D),{class:"space-y-4"},{default:t(()=>[p.value.zoom_start_time?(n(),k("div",ve,[e[14]||(e[14]=u("p",{class:"text-sm font-medium text-muted-foreground"},"Hora de inicio",-1)),u("p",_e,x(new Date(p.value.zoom_start_time).toLocaleString("es-ES")),1)])):g("",!0),p.value.zoom_registrant_id?(n(),k("div",xe,[e[15]||(e[15]=u("p",{class:"text-sm font-medium text-muted-foreground"},"Token Ãºnico de ingreso",-1)),u("p",be,x(p.value.zoom_registrant_id),1)])):g("",!0),u("div",ye,[te.value?g("",!0):(n(),k("div",we,[s(a(P),null,{default:t(()=>[s(a(J),{class:"h-4 w-4"}),s(a(I),null,{default:t(()=>e[16]||(e[16]=[o("ReuniÃ³n no disponible")])),_:1}),s(a(L),null,{default:t(()=>[o(' La videoconferencia solo estÃ¡ disponible cuando la asamblea estÃ¡ "En Curso". Estado actual: '+x(i.value.asamblea.estado_label),1)]),_:1})]),_:1})])),u("div",ke,[se.value?(n(),c(a(w),{key:0,onClick:W,class:"flex-1 bg-green-600 hover:bg-green-700 text-white"},{default:t(()=>[s(a(de),{class:"mr-2 h-4 w-4"}),e[17]||(e[17]=o(" Unirse a la Videoconferencia "))]),_:1})):g("",!0),s(a(w),{variant:"outline",onClick:K,disabled:m.value,size:"sm",class:"hidden"},{default:t(()=>[m.value?(n(),c(a(U),{key:0,class:"mr-2 h-4 w-4 animate-spin"})):g("",!0),e[18]||(e[18]=o(" Cancelar "))]),_:1},8,["disabled"])])])]),_:1})]),_:1})):ae.value?(n(),c(a(j),{key:3},{default:t(()=>[s(a(A),null,{default:t(()=>[s(a(M),{class:"flex items-center gap-2"},{default:t(()=>[s(a(O),{class:"h-5 w-5"}),e[19]||(e[19]=o(" Generar Acceso Personal "))]),_:1}),s(a(B),null,{default:t(()=>e[20]||(e[20]=[o(" Genera tu link personal para acceder a la videoconferencia ")])),_:1})]),_:1}),s(a(D),null,{default:t(()=>[s(a(w),{onClick:H,disabled:b.value||f.value,class:"w-full"},{default:t(()=>[b.value||f.value?(n(),c(a(U),{key:0,class:"mr-2 h-4 w-4 animate-spin"})):(n(),c(a(O),{key:1,class:"mr-2 h-4 w-4"})),o(" "+x(f.value?"Procesando...":"Generar link de ingreso"),1)]),_:1},8,["disabled"])]),_:1})]),_:1})):(n(),c(a(P),{key:4},{default:t(()=>[s(a(J),{class:"h-4 w-4"}),s(a(I),null,{default:t(()=>e[21]||(e[21]=[o("No disponible")])),_:1}),s(a(L),null,{default:t(()=>[o(x(i.value.reason),1)]),_:1})]),_:1})),s(a(P),{variant:"destructive",class:"mt-4"},{default:t(()=>[s(a(Z),{class:"h-4 w-4"}),s(a(I),null,{default:t(()=>e[22]||(e[22]=[o("Advertencia")])),_:1}),s(a(L),null,{default:t(()=>e[23]||(e[23]=[o(" Tu link es Ãºnico, cuÃ­dalo, no lo compartas, si lo compartes podrÃ­as quedarte por fuera de la reuniÃ³n, ya que solo se admite un usuario por link. ")])),_:1})]),_:1})])):g("",!0)]))}}),Ue=re(Ce,[["__scopeId","data-v-f931da34"]]);export{Ue as default};
