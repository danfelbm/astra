import{d as ye,u as we,r as h,c as B,p as ke,o as Se,B as $e,i as u,e as s,f as e,q as Ce,w as n,g as r,b as x,s as Ee,h as p,j as b,m as l,t as v,F as $,k as O,x as Z,a5 as je,O as Te}from"./app-CuPKNjRO.js";import{_ as Ve}from"./UserLayout.vue_vue_type_script_setup_true_lang-DAf06Xk3.js";import{_ as Ae,a as Fe,b as De,c as Be}from"./CardTitle.vue_vue_type_script_setup_true_lang-B5M2cVcm.js";import{_ as ee}from"./CardDescription.vue_vue_type_script_setup_true_lang-xPCqXFys.js";import{_ as y}from"./createLucideIcon-BObe4JvD.js";import{_ as j}from"./Label.vue_vue_type_script_setup_true_lang-DWZMRsHf.js";import{_ as Ne}from"./Textarea.vue_vue_type_script_setup_true_lang-PtJl9XZy.js";import{_ as Oe,a as ze,b as Me,c as Ie,d as Ue}from"./SelectValue.vue_vue_type_script_setup_true_lang-DLLNMJzF.js";import{_ as Ge}from"./Checkbox.vue_vue_type_script_setup_true_lang-JWnmXqYL.js";import{_ as Pe}from"./Progress.vue_vue_type_script_setup_true_lang-B_vEIerM.js";import{_ as Le}from"./index-Dqfh2IyD.js";import{_ as We}from"./FileUploadField.vue_vue_type_script_setup_true_lang-aHi-XsmE.js";import{u as Re}from"./useAutoSave-DelcxU8h.js";import{u as qe}from"./useFileUpload-BmTJB0hu.js";import{t as f}from"./index-PFTinW9B.js";import{F as G}from"./file-text-CjkSuqdh.js";import{M as P}from"./music-DPUSUB5M.js";import{V as L}from"./video-BbCuZ1tV.js";import{I as W}from"./image-C9xtCgLh.js";import{A as He}from"./arrow-left-BlXD0jbm.js";import{C as oe}from"./clock-DhzyKniZ.js";import{C as te}from"./circle-check-big-DXh5PwCW.js";import{C as Ke}from"./circle-alert-Ba_Yj53z.js";import{C as Je}from"./camera-D8ST23qK.js";import{T as Qe}from"./trash-2-k67a6BL9.js";import{S as Xe}from"./save-C4RG_EL1.js";import{_ as Ye}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./useFlashMessages-BfDjbYiy.js";import"./index-CbF-qM1L.js";import"./floating-ui.vue-DR9WUQXn.js";import"./x-BiyEowpC.js";import"./Input.vue_vue_type_script_setup_true_lang-D7OgHwh6.js";import"./index-BwEmZnO7.js";import"./index-DV1Mcati.js";import"./shield-H48l3S7I.js";import"./user-DBHuXpUm.js";import"./DropdownMenuTrigger.vue_vue_type_script_setup_true_lang-CbwqaBg0.js";import"./chevron-right-DzV9kraT.js";import"./DialogTitle.vue_vue_type_script_setup_true_lang-DKwkyUyS.js";import"./VisuallyHidden-BsvUS3vM.js";import"./GeographicSelector.vue_vue_type_script_setup_true_lang-qYeTZmVg.js";import"./map-pin-BKwoikzG.js";import"./AppLogo.vue_vue_type_script_setup_true_lang-CXnU0e5j.js";import"./usePermissions-nDy7XKbH.js";import"./square-check-big-DjHT6TiI.js";import"./users-Cf6wJFUI.js";import"./folder-open-JcMCtjCy.js";import"./index-bhonFi1I.js";import"./check-31iqNvh0.js";import"./upload-D31JdUFs.js";import"./file-Dx09nrKS.js";import"./eye-BtR-cUP7.js";import"./download-C-96n0Y5.js";import"./debounce-B--9fpZO.js";const Ze={class:"flex h-full flex-1 flex-col gap-4 rounded-xl p-4 pb-24"},eo={class:"flex items-center justify-between"},oo={class:"flex items-center justify-end gap-2 text-sm text-muted-foreground"},to={key:0,class:"flex items-center gap-1.5"},ao={key:1,class:"flex items-center gap-1.5"},io={key:2,class:"flex items-center gap-1.5 text-amber-600"},so={class:"space-y-2"},ro={key:0,class:"text-sm text-destructive"},no={class:"space-y-2"},lo={class:"grid grid-cols-2 md:grid-cols-4 gap-4"},co={key:0,class:"text-sm text-destructive"},uo={key:0,class:"space-y-2"},mo={key:0,class:"mb-4 p-4 border rounded-lg bg-muted/50"},po={class:"flex items-center justify-between mb-2"},vo={class:"grid grid-cols-2 md:grid-cols-4 gap-2"},fo={class:"text-xs"},_o={key:1,class:"space-y-4"},ho={class:"flex gap-2"},bo=["srcObject"],go={class:"space-y-2"},xo={class:"space-y-2 max-h-60 overflow-y-auto border rounded-lg p-4"},yo={class:"flex-1"},wo={class:"text-muted-foreground text-xs block"},ko={class:"space-y-2"},So={key:0,class:"text-sm text-destructive"},$o={class:"fixed bottom-0 left-0 right-0 z-50 px-2 sm:px-4 pb-2 sm:pb-4"},Co={class:"mx-auto max-w-7xl"},Eo={class:"backdrop-blur-lg bg-tertiary-60 dark:bg-gray-900/80 border border-gray-200/50 dark:border-gray-700/50 rounded-xl sm:rounded-2xl shadow-2xl p-3 sm:p-4"},jo={class:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4"},To={class:"hidden sm:flex items-center"},Vo={class:"flex-1 sm:max-w-xs lg:max-w-sm mx-0 sm:mx-4"},Ao={class:"flex items-center gap-3"},Fo={class:"text-xs sm:text-sm text-muted-foreground whitespace-nowrap font-medium"},Do={class:"flex items-center gap-2 sm:gap-3"},Bo=ye({__name:"Create",props:{contrato:{},obligaciones:{},entregables:{},tiposEvidencia:{}},setup(C){const T=C,ae=[{title:"Dashboard",href:"/miembro/dashboard"},{title:"Mis Contratos",href:"/miembro/mis-contratos"},{title:T.contrato.nombre,href:`/miembro/mis-contratos/${T.contrato.id}`},{title:"Subir Evidencia",href:"#"}],{uploadFiles:R}=qe(),t=we({obligacion_id:null,tipo_evidencia:null,archivo_path:null,archivo_nombre:null,archivos_paths:[],archivos_nombres:[],tipos_archivos:null,descripcion:null,entregable_ids:[],metadata:null}),V=h([]),w=h({imagen:{paths:[],nombres:[],count:0},video:{paths:[],nombres:[],count:0},audio:{paths:[],nombres:[],count:0},documento:{paths:[],nombres:[],count:0}}),ie=h(null),g=h(!1),E=h(null),A=h(null),k=h(null),F=h(null),se=h(null),re=B(()=>t.data()),{state:ne,isSaving:z,hasSaved:le,hasError:q,saveNow:de,startWatching:H,stopAutoSave:K,restoreDraft:ce,clearLocalStorage:J}=Re(re,{url:`/miembro/mis-contratos/${T.contrato.id}/evidencias/autosave`,debounceTime:3e3,showNotifications:!0,useLocalStorage:!0,localStorageKey:`evidencia_draft_contrato_${T.contrato.id}`}),ue=B(()=>{const a={imagen:{icon:W,accept:"image/*",capture:"environment",maxSize:10485760},video:{icon:L,accept:"video/*",capture:"environment",maxSize:524288e3},audio:{icon:P,accept:"audio/*",capture:!1,maxSize:52428800},documento:{icon:G,accept:".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.rtf",capture:!1,maxSize:20971520}};return t.tipo_evidencia?a[t.tipo_evidencia]:null}),M=B(()=>{const o=[t.obligacion_id,t.tipo_evidencia,t.archivo_path,t.descripcion,t.entregable_ids.length>0].filter(Boolean).length,c=Math.round(o/5*100);return{llenos:o,total:5,porcentaje:c}});ke(()=>t.tipo_evidencia,a=>{a&&(ie.value=a,g.value&&D())});const me=a=>{const o=a.type;return o.startsWith("image/")?"imagen":o.startsWith("video/")?"video":o.startsWith("audio/")?"audio":"documento"},Q=()=>{const a=[],o=[],c={};if(Object.entries(w.value).forEach(([m,i])=>{i.paths.forEach((d,_)=>{a.push(d),o.push(i.nombres[_]),c[d]=m})}),t.archivos_paths=a,t.archivos_nombres=o,t.tipos_archivos=c,a.length>0&&!t.archivo_path&&(t.archivo_path=a[0],t.archivo_nombre=o[0]),V.value=a,Object.keys(c).length>0){const m=Object.values(c).reduce((d,_)=>(d[_]=(d[_]||0)+1,d),{}),i=Object.entries(m).reduce((d,_)=>d[1]>_[1]?d:_)[0];t.tipo_evidencia=i}},S=B(()=>Object.values(w.value).reduce((a,o)=>a+o.count,0)),pe=()=>{w.value={imagen:{paths:[],nombres:[],count:0},video:{paths:[],nombres:[],count:0},audio:{paths:[],nombres:[],count:0},documento:{paths:[],nombres:[],count:0}},t.archivos_paths=[],t.archivos_nombres=[],t.tipos_archivos=null,t.archivo_path=null,t.archivo_nombre=null,V.value=[],f.info("Todos los archivos han sido eliminados")},X=B(()=>t.obligacion_id&&t.tipo_evidencia&&(S.value>0||se.value||F.value)),ve=async()=>{if(!t.tipo_evidencia||t.tipo_evidencia==="documento"){f.error("No se puede capturar este tipo de evidencia");return}try{g.value=!0;const a={video:t.tipo_evidencia==="imagen"||t.tipo_evidencia==="video",audio:t.tipo_evidencia==="audio"||t.tipo_evidencia==="video"};if(E.value=await navigator.mediaDevices.getUserMedia(a),t.tipo_evidencia==="audio"||t.tipo_evidencia==="video"){k.value=new MediaRecorder(E.value);const o=[];k.value.ondataavailable=c=>{o.push(c.data)},k.value.onstop=()=>{const c=new Blob(o,{type:t.tipo_evidencia==="audio"?"audio/webm":"video/webm"});F.value=c,Y(c)},k.value.start(),f.info("Grabación iniciada")}}catch(a){console.error("Error al iniciar captura:",a),f.error("No se pudo acceder a la cámara/micrófono"),g.value=!1}},D=()=>{E.value&&(E.value.getTracks().forEach(a=>a.stop()),E.value=null),k.value&&k.value.state==="recording"&&k.value.stop(),g.value=!1},fe=()=>{if(!A.value)return;const a=document.createElement("canvas");a.width=A.value.videoWidth,a.height=A.value.videoHeight;const o=a.getContext("2d");o&&(o.drawImage(A.value,0,0),a.toBlob(c=>{c&&(F.value=c,Y(c),D())},"image/jpeg",.95))},Y=async a=>{const o=`captura_${Date.now()}.${_e(a.type)}`,c=new File([a],o,{type:a.type});F.value=a,t.archivo_nombre=o,t.metadata={mime_type:a.type,size:a.size,captured_at:new Date().toISOString()};try{f.info("Subiendo archivo capturado...");const m=await R([c],{module:"evidencias",fieldId:t.tipo_evidencia||"archivo",onProgress:(i,d)=>{}});m.length>0&&(t.archivo_path=m[0].path,t.archivo_nombre=m[0].name,t.metadata=m[0].metadata,V.value=[m[0].path],F.value=null,f.success("Archivo subido exitosamente"))}catch(m){console.error("Error al subir archivo capturado:",m),f.error("Error al subir el archivo capturado")}},_e=a=>({"image/jpeg":"jpg","image/png":"png","image/webp":"webp","video/webm":"webm","audio/webm":"webm"})[a]||"bin",he=async a=>{if(a.length>0){const o=S.value,c=a.length;if(o+c>10){f.error(`No puedes subir más de 10 archivos. Actualmente tienes ${o} archivo(s).`);return}const m={imagen:[],video:[],audio:[],documento:[]};a.forEach(i=>{const d=me(i);m[d].push(i)});try{let i=0;for(const[d,_]of Object.entries(m)){if(_.length===0)continue;f.info(`Subiendo ${_.length} archivo(s) de tipo ${d}...`);const I=await R(_,{module:"evidencias",fieldId:d,onProgress:(N,U)=>{}});if(I.length>0){const N=d;I.forEach(U=>{w.value[N].paths.push(U.path),w.value[N].nombres.push(U.name),w.value[N].count++}),i+=I.length}}i>0&&(Q(),f.success(`${i} archivo(s) subido(s) exitosamente. Total: ${S.value}/10`))}catch(i){console.error("Error al subir archivos:",i),f.error("Error al subir archivos")}}},be=async()=>{await de(),f.success("Borrador guardado")},ge=async()=>{if(X.value){if(S.value===0&&!t.archivo_path){f.error("Por favor seleccione o capture al menos un archivo");return}Q(),K(),t.post(`/miembro/mis-contratos/${T.contrato.id}/evidencias`,{onSuccess:()=>{J(),f.success(`Evidencia subida exitosamente con ${t.archivos_paths.length} archivo(s)`)},onError:a=>{console.error("Errores de validación:",a),H()}})}},xe=()=>{confirm("¿Estás seguro de descartar el borrador? Se perderán todos los cambios no enviados.")&&(J(),t.reset(),pe(),g.value&&D(),f.success("Borrador descartado"))};return Se(()=>{const a=ce();a&&a.data&&Object.assign(t,a.data),H()}),$e(()=>{K(),D()}),(a,o)=>(l(),u($,null,[s(e(Ce),{title:`Subir Evidencia - ${C.contrato.nombre}`},null,8,["title"]),s(Ve,{breadcrumbs:ae},{default:n(()=>{var c;return[r("div",Ze,[r("div",eo,[o[5]||(o[5]=r("div",null,[r("h1",{class:"text-3xl font-bold"},"Subir Evidencia"),r("p",{class:"text-muted-foreground"}," Adjunta las evidencias del cumplimiento de las obligaciones del contrato ")],-1)),s(e(y),{variant:"outline",onClick:o[0]||(o[0]=m=>e(Ee).visit(`/miembro/mis-contratos/${C.contrato.id}`))},{default:n(()=>[s(e(He),{class:"mr-2 h-4 w-4"}),o[4]||(o[4]=p(" Volver ",-1))]),_:1})]),r("div",oo,[e(z)?(l(),u("div",to,[s(e(oe),{class:"h-4 w-4 animate-spin"}),o[6]||(o[6]=r("span",null,"Guardando automáticamente...",-1))])):e(le)&&!e(q)?(l(),u("div",ao,[s(e(te),{class:"h-4 w-4 text-green-600"}),r("span",null,"Guardado a las "+v((c=e(ne).lastSaved)==null?void 0:c.toLocaleTimeString()),1)])):e(q)?(l(),u("div",io,[s(e(Ke),{class:"h-4 w-4"}),o[7]||(o[7]=r("span",null,"Guardado localmente",-1))])):b("",!0)]),s(e(Ae),null,{default:n(()=>[s(e(Fe),null,{default:n(()=>[s(e(De),null,{default:n(()=>[...o[8]||(o[8]=[p("Información de la Evidencia",-1)])]),_:1}),s(e(ee),null,{default:n(()=>[...o[9]||(o[9]=[p(" Selecciona la obligación, el tipo de evidencia y adjunta el archivo correspondiente ",-1)])]),_:1})]),_:1}),s(e(Be),{class:"space-y-6"},{default:n(()=>{var m;return[r("div",so,[s(e(j),{htmlFor:"obligacion"},{default:n(()=>[...o[10]||(o[10]=[p("Obligación *",-1)])]),_:1}),s(e(Oe),{modelValue:e(t).obligacion_id,"onUpdate:modelValue":o[1]||(o[1]=i=>e(t).obligacion_id=i)},{default:n(()=>[s(e(ze),null,{default:n(()=>[s(e(Me),{placeholder:"Selecciona una obligación"})]),_:1}),s(e(Ie),null,{default:n(()=>[(l(!0),u($,null,O(C.obligaciones,i=>(l(),x(e(Ue),{key:i.id,value:i.id},{default:n(()=>[p(v(i.titulo),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"]),e(t).errors.obligacion_id?(l(),u("p",ro,v(e(t).errors.obligacion_id),1)):b("",!0)]),r("div",no,[s(e(j),null,{default:n(()=>[...o[11]||(o[11]=[p("Tipo de Evidencia *",-1)])]),_:1}),r("div",lo,[(l(!0),u($,null,O(C.tiposEvidencia,i=>(l(),x(e(y),{key:i.value,onClick:d=>e(t).tipo_evidencia=i.value,variant:e(t).tipo_evidencia===i.value?"default":"outline",class:"h-20 flex flex-col gap-2"},{default:n(()=>[(l(),x(Z(i.value==="imagen"?e(W):i.value==="video"?e(L):i.value==="audio"?e(P):e(G)),{class:"h-6 w-6"})),r("span",null,v(i.label),1)]),_:2},1032,["onClick","variant"]))),128))]),e(t).errors.tipo_evidencia?(l(),u("p",co,v(e(t).errors.tipo_evidencia),1)):b("",!0)]),e(t).tipo_evidencia?(l(),u("div",uo,[s(e(j),null,{default:n(()=>[...o[12]||(o[12]=[p("Archivo de Evidencia *",-1)])]),_:1}),S.value>0?(l(),u("div",mo,[r("div",po,[o[13]||(o[13]=r("span",{class:"text-sm font-medium"},"Archivos subidos",-1)),s(e(Le),{variant:"outline"},{default:n(()=>[p(v(S.value)+"/10",1)]),_:1})]),r("div",vo,[(l(!0),u($,null,O(w.value,(i,d)=>(l(),u("div",{key:d,class:"flex items-center gap-2"},[(l(),x(Z(d==="imagen"?e(W):d==="video"?e(L):d==="audio"?e(P):e(G)),{class:"h-4 w-4 text-muted-foreground"})),r("span",fo,v(i.count)+" "+v(d),1)]))),128))])])):b("",!0),e(t).tipo_evidencia!=="documento"?(l(),u("div",_o,[r("div",ho,[g.value?(l(),x(e(y),{key:1,onClick:D,variant:"destructive",class:"flex-1"},{default:n(()=>[...o[14]||(o[14]=[p(" Detener ",-1)])]),_:1})):(l(),x(e(y),{key:0,onClick:ve,variant:"outline",class:"flex-1"},{default:n(()=>[s(e(Je),{class:"mr-2 h-4 w-4"}),p(" "+v(e(t).tipo_evidencia==="audio"?"Grabar Audio":"Capturar"),1)]),_:1}))]),g.value&&(e(t).tipo_evidencia==="imagen"||e(t).tipo_evidencia==="video")?(l(),u("video",{key:0,ref_key:"videoElement",ref:A,srcObject:E.value,autoplay:"",playsinline:"",muted:"",class:"w-full rounded-lg border"},null,8,bo)):b("",!0),g.value&&e(t).tipo_evidencia==="imagen"?(l(),x(e(y),{key:1,onClick:fe,class:"w-full"},{default:n(()=>[...o[15]||(o[15]=[p(" Tomar Foto ",-1)])]),_:1})):b("",!0)])):b("",!0),s(We,{modelValue:V.value,"onUpdate:modelValue":o[2]||(o[2]=i=>V.value=i),onFilesSelected:he,label:"",description:`Selecciona archivos desde tu dispositivo (${S.value}/10 archivos)`,required:!0,multiple:!0,"max-files":10,"max-file-size":(m=ue.value)==null?void 0:m.maxSize,accept:"image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx",error:e(t).errors.archivo_path||e(t).errors.archivos_paths,disabled:e(t).processing,module:"evidencias","field-id":e(t).tipo_evidencia||"archivo","auto-upload":!1},null,8,["modelValue","description","max-file-size","error","disabled","field-id"])])):b("",!0),r("div",go,[s(e(j),null,{default:n(()=>[...o[16]||(o[16]=[p("Entregables Relacionados",-1)])]),_:1}),s(e(ee),null,{default:n(()=>[...o[17]||(o[17]=[p(" Selecciona los entregables del proyecto que se relacionan con esta evidencia ",-1)])]),_:1}),r("div",xo,[(l(!0),u($,null,O(C.entregables,i=>(l(),u("div",{key:i.id,class:"flex items-start space-x-3"},[s(e(Ge),{id:`entregable-${i.id}`,checked:e(t).entregable_ids.includes(i.id),"onUpdate:checked":d=>{d?e(t).entregable_ids.push(i.id):e(t).entregable_ids=e(t).entregable_ids.filter(_=>_!==i.id)}},null,8,["id","checked","onUpdate:checked"]),r("div",yo,[s(e(j),{for:`entregable-${i.id}`,class:"text-sm font-normal cursor-pointer"},{default:n(()=>[p(v(i.nombre)+" ",1),r("span",wo," Hito: "+v(i.hito)+" "+v(i.fecha_fin?` • Vence: ${i.fecha_fin}`:""),1)]),_:2},1032,["for"])])]))),128))])]),r("div",ko,[s(e(j),{htmlFor:"descripcion"},{default:n(()=>[...o[18]||(o[18]=[p("Descripción",-1)])]),_:1}),s(e(Ne),{id:"descripcion",modelValue:e(t).descripcion,"onUpdate:modelValue":o[3]||(o[3]=i=>e(t).descripcion=i),placeholder:"Describe brevemente la evidencia adjuntada",rows:"3"},null,8,["modelValue"]),e(t).errors.descripcion?(l(),u("p",So,v(e(t).errors.descripcion),1)):b("",!0)])]}),_:1})]),_:1})]),(l(),x(je,{to:"body"},[s(Te,{name:"slide-up"},{default:n(()=>[r("div",$o,[r("div",Co,[r("div",Eo,[r("div",jo,[r("div",To,[s(e(y),{variant:"outline",type:"button",onClick:xe,class:"backdrop-blur-sm flex-shrink-0 text-xs sm:text-sm py-2 px-3 text-destructive hover:text-destructive"},{default:n(()=>[s(e(Qe),{class:"h-4 w-4"}),o[19]||(o[19]=r("span",{class:"ml-2"},"Descartar borrador",-1))]),_:1})]),r("div",Vo,[r("div",Ao,[s(e(Pe),{modelValue:M.value.porcentaje,class:"flex-1"},null,8,["modelValue"]),r("span",Fo,v(M.value.llenos)+" / "+v(M.value.total),1)]),o[20]||(o[20]=r("p",{class:"text-xs text-muted-foreground mt-1 text-center hidden sm:block"}," Campos completados ",-1))]),r("div",Do,[s(e(y),{onClick:be,disabled:e(z),variant:"outline",class:"backdrop-blur-sm flex-1 sm:flex-none text-xs sm:text-sm py-2 px-3"},{default:n(()=>[e(z)?(l(),u($,{key:0},[s(e(oe),{class:"mr-2 h-4 w-4 animate-spin"}),o[21]||(o[21]=p(" Guardando... ",-1))],64)):(l(),u($,{key:1},[s(e(Xe),{class:"mr-2 h-4 w-4"}),o[22]||(o[22]=p(" Guardar borrador ",-1))],64))]),_:1},8,["disabled"]),s(e(y),{onClick:ge,disabled:!X.value||e(t).processing,class:"bg-green-600 hover:bg-green-700 text-white border-green-600 hover:border-green-700 disabled:bg-gray-400 disabled:border-gray-400 flex-1 sm:flex-none text-xs sm:text-sm py-2 px-3"},{default:n(()=>[s(e(te),{class:"h-4 w-4"}),o[23]||(o[23]=r("span",{class:"ml-2 whitespace-nowrap"},"Subir Evidencia",-1))]),_:1},8,["disabled"])])])])])])]),_:1})]))]}),_:1})],64))}}),Nt=Ye(Bo,[["__scopeId","data-v-c07b4e55"]]);export{Nt as default};
