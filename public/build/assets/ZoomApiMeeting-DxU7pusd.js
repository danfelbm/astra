import{a as L,_ as P}from"./index-Gu6L08O4.js";import{_ as S}from"./AlertTitle.vue_vue_type_script_setup_true_lang-CsAdLZXP.js";import{_ as E}from"./createLucideIcon-CLq2BVfu.js";import{a as R,b as N,c as T,_ as V}from"./CardTitle.vue_vue_type_script_setup_true_lang-DgM8RJG1.js";import{_ as B}from"./CardDescription.vue_vue_type_script_setup_true_lang-dXO2Wfns.js";import{t as $}from"./index-C0iMcfV8.js";import{d as oe,k as b,c as y,p as le,O as ne,a as C,o as i,f as u,i as p,j as d,b as s,u as a,e as t,n as ie,g as l,t as _,q as G}from"./app-B9oe9ImA.js";import{V as O}from"./video-BF4iAe_c.js";import{R as h}from"./refresh-cw-D1r5glCg.js";import{L as U}from"./loader-circle-BK1AIr5y.js";import{C as Z}from"./circle-alert-BjH3iak5.js";import{I as ue}from"./info-Cmnd_Snn.js";import{C as de}from"./circle-check-B3ekwkQe.js";import{C as J}from"./clock-DZHbW8da.js";import{E as ce}from"./external-link-6Ze71Gzb.js";import{_ as me}from"./_plugin-vue_export-helper-DlAUqK2U.js";const fe={class:"space-y-4"},pe={class:"flex items-center gap-2 mb-4"},ge={key:0,class:"text-center py-8"},ve={class:"whitespace-pre-wrap text-gray-700"},_e={key:3},xe={class:"flex gap-2"},be={key:0},ye={class:"text-sm"},we={key:1},ke={class:"text-sm font-mono bg-gray-50 px-2 py-1 rounded"},Ee={class:"pt-2"},Ce={key:0,class:"mb-3"},ze={class:"flex gap-2"},Ie=5*60*1e3,Le=oe({__name:"ZoomApiMeeting",props:{asambleaId:{}},setup(Y){const A=Y,f=b(!1),w=b(!1),m=b(!1),k=b(null),M=b(null),c=b(null),n=b(null),{route:D}=window,z=async(o=!1)=>{try{o||(f.value=!0),c.value=null;const r=(await G.get(D("api.zoom.registrants.status",A.asambleaId))).data;r.success?(m.value&&!r.existing_registration&&!r.processing&&(r.processing=!0),n.value=r,r.existing_registration&&r.existing_registration.status==="completed"||r.existing_registration&&r.existing_registration.status==="failed"?I():(r.processing||m.value)&&(k.value||q())):c.value=r.error||"Error obteniendo estado"}catch(e){console.error("Error fetching status:",e),c.value="Error de conexi√≥n"}finally{f.value=!1}},K=async()=>{c.value=null,n.value.existing_registration=null,await F()},F=async()=>{var o,e;try{w.value=!0,c.value=null;const r=await G.post(D("api.zoom.registrants.register"),{asamblea_id:A.asambleaId});r.data.success?r.data.processing?(m.value=!0,n.value=r.data,q(),$.success("üîÑ Procesando registro",{description:"Se est√° generando tu enlace de videoconferencia...",duration:4e3})):await z():c.value=r.data.error||"Error registrando usuario"}catch(r){console.error("Error registering user:",r),(e=(o=r.response)==null?void 0:o.data)!=null&&e.error?c.value=r.response.data.error:c.value="Error de conexi√≥n"}finally{w.value=!1}},Q=async()=>{try{f.value=!0,c.value=null;const e=(await G.delete(D("api.zoom.registrants.destroy",A.asambleaId))).data;e.success?await z():c.value=e.error||"Error cancelando registro"}catch(o){console.error("Error canceling registration:",o),c.value="Error de conexi√≥n"}finally{f.value=!1}},W=async()=>{var o,e;try{(await G.post(D("asambleas.marcar-asistencia",A.asambleaId))).data.success&&$.success("‚úÖ Asistencia registrada",{description:"Tu asistencia ha sido marcada exitosamente",duration:3e3})}catch(r){console.error("Error marcando asistencia:",r),((o=r.response)==null?void 0:o.status)===400?$.warning("La asamblea no est√° en curso",{duration:3e3}):((e=r.response)==null?void 0:e.status)===403?$.error("No eres participante de esta asamblea",{duration:3e3}):$.error("Error al registrar asistencia",{description:"Tu asistencia no pudo ser registrada, pero puedes unirte a la reuni√≥n",duration:4e3})}},X=async()=>{var o;await W(),(o=g.value)!=null&&o.zoom_join_url&&window.open(g.value.zoom_join_url,"_blank","noopener,noreferrer")},q=()=>{I(),M.value=Date.now(),k.value=setInterval(async()=>{try{if(M.value&&Date.now()-M.value>Ie){console.warn("Polling timeout alcanzado (5 minutos)"),c.value="El proceso est√° tomando m√°s tiempo del esperado. Por favor, recarga la p√°gina.",I();return}await z(!0)}catch(o){console.error("Error en polling:",o)}},2e3)},I=()=>{k.value&&(clearInterval(k.value),k.value=null),M.value=null,m.value=!1},g=y(()=>{var e;if(!((e=n.value)!=null&&e.existing_registration))return null;const o=n.value.existing_registration;return{...o,statusColor:o.status==="completed"?"bg-green-100 text-green-800":o.status==="pending"?"bg-yellow-100 text-yellow-800":o.status==="failed"?"bg-red-100 text-red-800":"bg-gray-100 text-gray-800"}}),j=y(()=>{var o,e;return((e=(o=n.value)==null?void 0:o.existing_registration)==null?void 0:e.status)==="failed"}),ee=y(()=>{var e,r;if(!j.value)return null;const o=((r=(e=n.value)==null?void 0:e.existing_registration)==null?void 0:r.error_message)||"Error desconocido al registrar";return o.toLowerCase().includes("rate limit")?"Se ha alcanzado el l√≠mite diario de registros. Por favor, intenta nuevamente ma√±ana.":o}),ae=y(()=>{var r,v;if(!j.value)return!1;const o=((v=(r=n.value)==null?void 0:r.existing_registration)==null?void 0:v.error_message)||"";return!["no existe","capacidad m√°xima","no tiene permisos"].some(x=>o.toLowerCase().includes(x))}),se=y(()=>{var o,e,r;return j.value?!1:((o=n.value)==null?void 0:o.can_register)&&!((e=n.value)!=null&&e.existing_registration)&&!m.value&&!((r=n.value)!=null&&r.processing)}),te=y(()=>{var r,v,x;const o=(r=n.value)==null?void 0:r.existing_registration,e=((x=(v=n.value)==null?void 0:v.asamblea)==null?void 0:x.estado)==="en_curso";return o&&o.status==="completed"&&o.zoom_join_url&&e}),re=y(()=>{var o,e;return((e=(o=n.value)==null?void 0:o.asamblea)==null?void 0:e.estado)==="en_curso"});return le(()=>{z()}),ne(()=>{I()}),(o,e)=>{var r,v,x,H;return i(),C("div",fe,[u("div",pe,[s(a(O),{class:"h-5 w-5 text-blue-600"}),e[0]||(e[0]=u("h3",{class:"text-lg font-semibold"},"Videoconferencia",-1)),s(a(E),{variant:"ghost",size:"sm",onClick:z,disabled:f.value,class:"ml-auto"},{default:t(()=>[s(a(h),{class:ie(["h-4 w-4",{"animate-spin":f.value}])},null,8,["class"])]),_:1},8,["disabled"])]),f.value&&!n.value?(i(),C("div",ge,[s(a(U),{class:"h-8 w-8 animate-spin mx-auto mb-2"}),e[1]||(e[1]=u("p",{class:"text-muted-foreground"},"Cargando informaci√≥n...",-1))])):p("",!0),c.value?(i(),d(a(P),{key:1,variant:"destructive"},{default:t(()=>[s(a(Z),{class:"h-4 w-4"}),s(a(S),null,{default:t(()=>e[2]||(e[2]=[l("Error")])),_:1}),s(a(L),null,{default:t(()=>[l(_(c.value),1)]),_:1})]),_:1})):p("",!0),(v=(r=n.value)==null?void 0:r.asamblea)!=null&&v.zoom_api_message_enabled&&((H=(x=n.value)==null?void 0:x.asamblea)!=null&&H.zoom_api_message)?(i(),d(a(V),{key:2,class:"mb-4 border-blue-200 bg-blue-50"},{default:t(()=>[s(a(R),null,{default:t(()=>[s(a(N),{class:"flex items-center gap-2 text-blue-700"},{default:t(()=>[s(a(ue),{class:"h-5 w-5"}),e[3]||(e[3]=l(" Informaci√≥n Importante "))]),_:1})]),_:1}),s(a(T),null,{default:t(()=>[u("p",ve,_(n.value.asamblea.zoom_api_message),1)]),_:1})]),_:1})):p("",!0),n.value&&!f.value?(i(),C("div",_e,[m.value||n.value.processing?(i(),d(a(V),{key:0,class:"border-blue-200 bg-blue-50"},{default:t(()=>[s(a(R),null,{default:t(()=>[s(a(N),{class:"flex items-center gap-2 text-blue-700"},{default:t(()=>[s(a(U),{class:"h-5 w-5 animate-spin"}),e[4]||(e[4]=l(" Procesando registro "))]),_:1}),s(a(B),null,{default:t(()=>e[5]||(e[5]=[l(" Se est√° generando tu enlace personal de videoconferencia... ")])),_:1})]),_:1}),s(a(T),null,{default:t(()=>e[6]||(e[6]=[u("div",{class:"space-y-2"},[u("div",{class:"text-sm text-blue-600"},[l(" ‚úÖ Validaciones completadas"),u("br"),l(" üîÑ Registrando en Zoom..."),u("br"),l(" üìß Preparando notificaci√≥n por email ")]),u("p",{class:"text-xs text-muted-foreground"}," Este proceso toma entre 1-2 minutos. La p√°gina se actualizar√° autom√°ticamente. ")],-1)])),_:1})]),_:1})):j.value?(i(),d(a(V),{key:1,class:"border-red-200 bg-red-50"},{default:t(()=>[s(a(R),null,{default:t(()=>[s(a(N),{class:"flex items-center gap-2 text-red-700"},{default:t(()=>[s(a(Z),{class:"h-5 w-5"}),e[7]||(e[7]=l(" Error en el registro "))]),_:1}),s(a(B),{class:"text-red-600"},{default:t(()=>e[8]||(e[8]=[l(" No se pudo completar tu registro en la videoconferencia ")])),_:1})]),_:1}),s(a(T),{class:"space-y-4"},{default:t(()=>[s(a(P),{variant:"destructive"},{default:t(()=>[s(a(Z),{class:"h-4 w-4"}),s(a(S),null,{default:t(()=>e[9]||(e[9]=[l("Detalles del error")])),_:1}),s(a(L),null,{default:t(()=>[l(_(ee.value),1)]),_:1})]),_:1}),u("div",xe,[ae.value?(i(),d(a(E),{key:0,onClick:K,disabled:w.value||m.value,class:"flex-1"},{default:t(()=>[w.value||m.value?(i(),d(a(h),{key:0,class:"mr-2 h-4 w-4 animate-spin"})):(i(),d(a(h),{key:1,class:"mr-2 h-4 w-4"})),e[10]||(e[10]=l(" Reintentar registro "))]),_:1},8,["disabled"])):(i(),d(a(E),{key:1,variant:"outline",disabled:"",class:"flex-1"},{default:t(()=>e[11]||(e[11]=[l(" No se puede reintentar ")])),_:1}))]),e[12]||(e[12]=u("p",{class:"text-xs text-muted-foreground"}," Si el problema persiste, contacta al administrador. ",-1))]),_:1})]),_:1})):g.value&&g.value.status==="completed"?(i(),d(a(V),{key:2,class:"border-green-200"},{default:t(()=>[s(a(R),null,{default:t(()=>[s(a(N),{class:"flex items-center gap-2 text-green-700"},{default:t(()=>[s(a(de),{class:"h-5 w-5"}),e[13]||(e[13]=l(" Ya est√°s registrado "))]),_:1}),s(a(B),null,{default:t(()=>e[14]||(e[14]=[l(" Tienes acceso a esta videoconferencia ")])),_:1})]),_:1}),s(a(T),{class:"space-y-4"},{default:t(()=>[g.value.zoom_start_time?(i(),C("div",be,[e[15]||(e[15]=u("p",{class:"text-sm font-medium text-muted-foreground"},"Hora de inicio",-1)),u("p",ye,_(new Date(g.value.zoom_start_time).toLocaleString("es-ES")),1)])):p("",!0),g.value.zoom_registrant_id?(i(),C("div",we,[e[16]||(e[16]=u("p",{class:"text-sm font-medium text-muted-foreground"},"Token √∫nico de ingreso",-1)),u("p",ke,_(g.value.zoom_registrant_id),1)])):p("",!0),u("div",Ee,[re.value?p("",!0):(i(),C("div",Ce,[s(a(P),null,{default:t(()=>[s(a(J),{class:"h-4 w-4"}),s(a(S),null,{default:t(()=>e[17]||(e[17]=[l("Reuni√≥n no disponible")])),_:1}),s(a(L),null,{default:t(()=>[l(' La videoconferencia solo est√° disponible cuando la asamblea est√° "En Curso". Estado actual: '+_(n.value.asamblea.estado_label),1)]),_:1})]),_:1})])),u("div",ze,[te.value?(i(),d(a(E),{key:0,onClick:X,class:"flex-1 bg-green-600 hover:bg-green-700 text-white"},{default:t(()=>[s(a(ce),{class:"mr-2 h-4 w-4"}),e[18]||(e[18]=l(" Unirse a la Videoconferencia "))]),_:1})):p("",!0),s(a(E),{variant:"outline",onClick:Q,disabled:f.value,size:"sm",class:"hidden"},{default:t(()=>[f.value?(i(),d(a(U),{key:0,class:"mr-2 h-4 w-4 animate-spin"})):p("",!0),e[19]||(e[19]=l(" Cancelar "))]),_:1},8,["disabled"])])])]),_:1})]),_:1})):se.value?(i(),d(a(V),{key:3},{default:t(()=>[s(a(R),null,{default:t(()=>[s(a(N),{class:"flex items-center gap-2"},{default:t(()=>[s(a(O),{class:"h-5 w-5"}),e[20]||(e[20]=l(" Generar Acceso Personal "))]),_:1}),s(a(B),null,{default:t(()=>e[21]||(e[21]=[l(" Genera tu link personal para acceder a la videoconferencia ")])),_:1})]),_:1}),s(a(T),null,{default:t(()=>[s(a(E),{onClick:F,disabled:w.value||m.value,class:"w-full"},{default:t(()=>[w.value||m.value?(i(),d(a(U),{key:0,class:"mr-2 h-4 w-4 animate-spin"})):(i(),d(a(O),{key:1,class:"mr-2 h-4 w-4"})),l(" "+_(m.value?"Procesando...":"Generar link de ingreso"),1)]),_:1},8,["disabled"])]),_:1})]),_:1})):(i(),d(a(P),{key:4},{default:t(()=>[s(a(J),{class:"h-4 w-4"}),s(a(S),null,{default:t(()=>e[22]||(e[22]=[l("No disponible")])),_:1}),s(a(L),null,{default:t(()=>[l(_(n.value.reason),1)]),_:1})]),_:1})),s(a(P),{variant:"destructive",class:"mt-4"},{default:t(()=>[s(a(Z),{class:"h-4 w-4"}),s(a(S),null,{default:t(()=>e[23]||(e[23]=[l("Advertencia")])),_:1}),s(a(L),null,{default:t(()=>e[24]||(e[24]=[l(" Tu link es √∫nico, cu√≠dalo, no lo compartas, si lo compartes podr√≠as quedarte por fuera de la reuni√≥n, ya que solo se admite un usuario por link. ")])),_:1})]),_:1})])):p("",!0)])}}}),Oe=me(Le,[["__scopeId","data-v-283fe4a9"]]);export{Oe as default};
