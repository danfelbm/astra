import{d as ne,r as F,c as E,p as de,i as f,j as g,g as c,b as k,e as s,f as t,w as l,h as v,F as G,k as W,t as m,l as ue,n as A,m as r,a as ce}from"./app-B7PnGMAV.js";import{a as Z,b as ee,c as te,_ as ae}from"./CardTitle.vue_vue_type_script_setup_true_lang-Dn6Y_7jM.js";import{_ as S}from"./Label.vue_vue_type_script_setup_true_lang-DoPMf_am.js";import{_ as me}from"./Input.vue_vue_type_script_setup_true_lang-8PRhBqBe.js";import{_ as fe}from"./Textarea.vue_vue_type_script_setup_true_lang-CPrRdXey.js";import{_ as M}from"./createLucideIcon-DI6U3gwA.js";import{_ as ve,a as ge,b as pe,c as be,d as se}from"./SelectValue.vue_vue_type_script_setup_true_lang-CIqxaMm-.js";import{_ as q}from"./InputError.vue_vue_type_script_setup_true_lang-CqHGMa9G.js";import{_ as oe}from"./index-BTD9fiCJ.js";import{_ as xe,a as he}from"./index-DSZ-TYzn.js";import{U as le}from"./upload-Da0zqzr7.js";import{C as ye}from"./circle-alert-DiJEEPwx.js";import{P as _e}from"./paperclip-BDmDneaf.js";import{X}from"./x-C1SerbTX.js";import{_ as $e}from"./AddContratosModal.vue_vue_type_script_setup_true_lang-CHS2lFZp.js";import{F as ie}from"./file-text-CmH6cCEi.js";import{L as re}from"./loader-circle-BPKpLMPu.js";const ke={class:"space-y-4"},Fe={key:0,class:"space-y-2"},we={class:"space-y-2"},Ce={class:"flex items-center gap-3 flex-1 min-w-0"},Se={class:"min-w-0 flex-1"},ze={class:"text-sm font-medium truncate"},Be={key:0,class:"text-xs text-muted-foreground"},Me=["multiple","accept","disabled"],Ve={class:"text-sm font-medium mb-1"},Ie={class:"text-xs text-muted-foreground"},je={class:"text-xs text-muted-foreground mt-1"},Ee={key:0},Ae={key:1,class:"space-y-2"},De={class:"space-y-2"},Pe={class:"flex items-center gap-3 flex-1 min-w-0"},Ne={class:"min-w-0 flex-1"},Le={class:"text-sm font-medium truncate"},Ue={class:"text-xs text-muted-foreground"},qe={key:3,class:"text-xs text-muted-foreground"},Oe={key:0,class:"text-destructive"},Te=ne({__name:"FileAttachmentManager",props:{existingFiles:{default:()=>[]},label:{},description:{},multiple:{type:Boolean,default:!0},maxFiles:{default:10},maxSizeMB:{default:5},accept:{default:".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png"},disabled:{type:Boolean,default:!1},error:{}},emits:["files-added","file-removed"],setup(a,{expose:O,emit:p}){const h=a,n=p,z=F(),b=F(!1),y=F([]),B=F(""),_=E(()=>h.existingFiles||[]),$=E(()=>_.value.length+y.value.length),D=E(()=>$.value<h.maxFiles),P=()=>{var d;!h.disabled&&D.value&&((d=z.value)==null||d.click())},T=d=>{const i=d.target;i.files&&(N(Array.from(i.files)),i.value="")},R=d=>{var u;if(d.preventDefault(),b.value=!1,h.disabled)return;const i=Array.from(((u=d.dataTransfer)==null?void 0:u.files)||[]);N(i)},N=d=>{B.value="";const i=h.maxFiles-$.value;if(d.length>i){B.value=`Solo puedes agregar ${i} archivo(s) más. Límite: ${h.maxFiles}`;return}const u=[],o=[];d.forEach(e=>{var j;const w=h.maxSizeMB*1024*1024;if(e.size>w){o.push(`${e.name}: excede ${h.maxSizeMB}MB`);return}const C=`.${(j=e.name.split(".").pop())==null?void 0:j.toLowerCase()}`;if(!h.accept.split(",").map(U=>U.trim().toLowerCase()).includes(C)){o.push(`${e.name}: formato no permitido`);return}u.push(e)}),o.length>0&&(B.value=o.join(", ")),u.length>0&&(h.multiple?y.value.push(...u):y.value=[u[0]],n("files-added",y.value))},H=d=>{y.value.splice(d,1),n("files-added",y.value)},L=d=>{const i=_.value[d];i&&confirm("¿Estás seguro de eliminar este archivo?")&&n("file-removed",i.ruta)},V=d=>{if(!d)return"0 KB";const i=["B","KB","MB","GB"],u=Math.floor(Math.log(d)/Math.log(1024));return`${(d/Math.pow(1024,u)).toFixed(1)} ${i[u]}`},I=d=>{var i;return((i=d.split(".").pop())==null?void 0:i.toUpperCase())||"FILE"};return O({newFiles:y,clearNewFiles:()=>{y.value=[]}}),de(()=>h.error,d=>{d||(B.value="")}),(d,i)=>(r(),f("div",ke,[_.value.length>0?(r(),f("div",Fe,[s(t(S),{class:"text-sm font-medium"},{default:l(()=>[...i[2]||(i[2]=[v("Archivos actuales",-1)])]),_:1}),c("div",we,[(r(!0),f(G,null,W(_.value,(u,o)=>(r(),f("div",{key:`existing-${o}`,class:"flex items-center justify-between p-3 bg-muted rounded-lg border border-border hover:bg-accent/50 transition-colors"},[c("div",Ce,[s(t(_e),{class:"h-4 w-4 text-muted-foreground flex-shrink-0"}),c("div",Se,[c("p",ze,m(u.nombre_original),1),u.tamaño?(r(),f("p",Be,m(V(u.tamaño)),1)):g("",!0)]),s(t(oe),{variant:"outline",class:"flex-shrink-0"},{default:l(()=>[v(m(I(u.nombre_original)),1)]),_:2},1024)]),s(t(M),{type:"button",variant:"ghost",size:"icon",class:"h-8 w-8 text-destructive hover:text-destructive hover:bg-destructive/10 flex-shrink-0",onClick:e=>L(o),disabled:a.disabled},{default:l(()=>[s(t(X),{class:"h-4 w-4"})]),_:1},8,["onClick","disabled"])]))),128))])])):g("",!0),c("div",null,[a.label?(r(),k(t(S),{key:0,class:"text-sm font-medium"},{default:l(()=>[v(m(a.label),1)]),_:1})):g("",!0),c("div",{onDrop:R,onDragover:i[0]||(i[0]=ue(u=>b.value=!0,["prevent"])),onDragleave:i[1]||(i[1]=u=>b.value=!1),onClick:P,class:"relative mt-2"},[c("input",{ref_key:"fileInput",ref:z,type:"file",multiple:a.multiple,accept:a.accept,disabled:a.disabled,class:"hidden",onChange:T},null,40,Me),c("div",{class:A(["border-2 border-dashed rounded-lg p-6 text-center cursor-pointer transition-all",{"border-primary bg-primary/5 ring-2 ring-primary/20":b.value,"border-muted-foreground/25 hover:border-muted-foreground/50 hover:bg-muted/30":!b.value&&!a.disabled,"opacity-50 cursor-not-allowed":a.disabled,"border-destructive":a.error}])},[s(t(le),{class:A(["h-10 w-10 mx-auto mb-3 transition-colors",b.value?"text-primary":"text-muted-foreground"])},null,8,["class"]),c("p",Ve,m(b.value?"Suelta los archivos aquí":"Haz clic o arrastra archivos aquí"),1),c("p",Ie,m(a.description||`Formatos: ${a.accept}`),1),c("p",je,[v(" Máximo "+m(a.maxSizeMB)+"MB por archivo ",1),a.multiple?(r(),f("span",Ee," • Hasta "+m(a.maxFiles)+" archivos total",1)):g("",!0)])],2)],32)]),y.value.length>0?(r(),f("div",Ae,[s(t(S),{class:"text-sm font-medium"},{default:l(()=>[...i[3]||(i[3]=[v("Archivos a subir",-1)])]),_:1}),c("div",De,[(r(!0),f(G,null,W(y.value,(u,o)=>(r(),f("div",{key:`new-${o}`,class:"flex items-center justify-between p-3 bg-accent rounded-lg border border-primary/20"},[c("div",Pe,[s(t(le),{class:"h-4 w-4 text-primary flex-shrink-0"}),c("div",Ne,[c("p",Le,m(u.name),1),c("p",Ue,m(V(u.size)),1)]),s(t(oe),{variant:"secondary",class:"flex-shrink-0"},{default:l(()=>[v(m(I(u.name)),1)]),_:2},1024)]),s(t(M),{type:"button",variant:"ghost",size:"icon",class:"h-8 w-8 hover:bg-destructive/10 flex-shrink-0",onClick:e=>H(o),disabled:a.disabled},{default:l(()=>[s(t(X),{class:"h-4 w-4"})]),_:1},8,["onClick","disabled"])]))),128))])])):g("",!0),a.error?(r(),k(t(xe),{key:2,variant:"destructive"},{default:l(()=>[s(t(ye),{class:"h-4 w-4"}),s(t(he),null,{default:l(()=>[v(m(a.error),1)]),_:1})]),_:1})):g("",!0),!a.disabled&&(_.value.length>0||y.value.length>0)?(r(),f("div",qe,[v(m($.value)+" de "+m(a.maxFiles)+" archivos ",1),$.value>=a.maxFiles?(r(),f("span",Oe," (límite alcanzado)")):g("",!0)])):g("",!0)]))}}),Re={key:0},He={key:0,class:"p-3 bg-muted rounded-lg flex items-center justify-between mb-2"},Ke={class:"flex items-center gap-2"},Ge={class:"font-medium"},We={key:0,class:"text-sm text-muted-foreground"},Xe={key:1},Je={key:0,class:"flex items-center gap-2 h-10 px-3 border rounded-md bg-muted/50"},Qe={key:3,class:"text-xs text-muted-foreground mt-1"},Ye={class:"flex justify-end gap-2"},pt=ne({__name:"ObligacionForm",props:{obligacion:{},contratoId:{},contratos:{default:()=>[]},proyectos:{default:()=>[]},parentId:{},posiblesPadres:{default:()=>[]},usuarios:{default:()=>[]},loading:{type:Boolean,default:!1},errors:{default:()=>({})}},emits:["submit","cancel"],setup(a,{emit:O}){var L,V,I,d,i,u;const p=a,h=O,n=F({contrato_id:p.contratoId||((L=p.obligacion)==null?void 0:L.contrato_id)||0,parent_id:p.parentId||((V=p.obligacion)==null?void 0:V.parent_id)||null,titulo:((I=p.obligacion)==null?void 0:I.titulo)||"",descripcion:((d=p.obligacion)==null?void 0:d.descripcion)||"",archivos:[],archivos_eliminar:[]}),z=F(!1),b=F((i=p.obligacion)!=null&&i.contrato?{id:p.obligacion.contrato.id,nombre:p.obligacion.contrato.nombre,proyecto:p.obligacion.contrato.proyecto}:((u=p.contratos)==null?void 0:u.find(o=>o.id===n.value.contrato_id))||null),y=o=>{o.contratoIds.length>0&&(n.value.contrato_id=o.contratoIds[0],o.contratos&&o.contratos.length>0&&(b.value=o.contratos[0]),n.value.parent_id=null,P(o.contratoIds[0]))},B=()=>{n.value.contrato_id=0,b.value=null,n.value.parent_id=null,_.value=[]},_=F([]),$=F(!1),D=E(()=>p.contratoId?p.posiblesPadres||[]:_.value),P=async o=>{if(!o){_.value=[];return}$.value=!0;try{const e=await ce.get("/admin/obligaciones/posibles-padres",{params:{contrato_id:o}});e.data.success&&(_.value=e.data.posiblesPadres)}catch(e){console.error("Error cargando posibles padres:",e),_.value=[]}finally{$.value=!1}};de(()=>n.value.contrato_id,o=>{if(!p.contratoId&&o){n.value.parent_id=null;const e=typeof o=="string"?parseInt(o,10):o;e&&!isNaN(e)&&P(e)}});const T=E(()=>{var e;return(((e=p.obligacion)==null?void 0:e.archivos_adjuntos)||[]).filter(w=>{var C;return!((C=n.value.archivos_eliminar)!=null&&C.includes(w.ruta))})}),R=()=>{const o={...n.value};h("submit",o)},N=o=>{n.value.archivos=o},H=o=>{n.value.archivos_eliminar=n.value.archivos_eliminar||[],n.value.archivos_eliminar.includes(o)||n.value.archivos_eliminar.push(o)};return(o,e)=>(r(),f("form",{onSubmit:ue(R,["prevent"]),class:"space-y-4"},[s(t(ae),null,{default:l(()=>[s(t(Z),null,{default:l(()=>[s(t(ee),null,{default:l(()=>[...e[6]||(e[6]=[v("Información Básica",-1)])]),_:1})]),_:1}),s(t(te),{class:"space-y-4"},{default:l(()=>{var w,C,K,j,U,J,Q;return[a.contratoId?g("",!0):(r(),f("div",Re,[s(t(S),{for:"contrato_id",required:""},{default:l(()=>[...e[7]||(e[7]=[v("Contrato",-1)])]),_:1}),b.value?(r(),f("div",He,[c("div",Ke,[s(t(ie),{class:"h-4 w-4 text-muted-foreground"}),c("div",null,[c("p",Ge,m(b.value.nombre),1),b.value.proyecto?(r(),f("p",We,m(b.value.proyecto.nombre),1)):g("",!0)])]),s(t(M),{type:"button",variant:"ghost",size:"sm",onClick:B},{default:l(()=>[s(t(X),{class:"h-4 w-4"})]),_:1})])):g("",!0),s(t(M),{type:"button",variant:"outline",onClick:e[0]||(e[0]=x=>z.value=!0),class:A(["w-full",{"border-red-500":(w=a.errors)==null?void 0:w.contrato_id}])},{default:l(()=>[s(t(ie),{class:"h-4 w-4 mr-2"}),v(" "+m(b.value?"Cambiar Contrato":"Seleccionar Contrato"),1)]),_:1},8,["class"]),(C=a.errors)!=null&&C.contrato_id?(r(),k(q,{key:1,message:a.errors.contrato_id[0]},null,8,["message"])):g("",!0),e[8]||(e[8]=c("p",{class:"text-xs text-muted-foreground mt-1"}," Selecciona el contrato al que pertenecerá esta obligación ",-1)),s($e,{modelValue:z.value,"onUpdate:modelValue":e[1]||(e[1]=x=>z.value=x),title:"Seleccionar Contrato",description:"Selecciona el contrato para esta obligación","search-endpoint":"/admin/contratos/search",proyectos:a.proyectos,"excluded-ids":b.value?[b.value.id]:[],"max-selection":1,"submit-button-text":"Seleccionar",onSubmit:y},null,8,["modelValue","proyectos","excluded-ids"])])),c("div",null,[s(t(S),{for:"titulo",required:""},{default:l(()=>[...e[9]||(e[9]=[v("Título",-1)])]),_:1}),s(t(me),{id:"titulo",modelValue:n.value.titulo,"onUpdate:modelValue":e[2]||(e[2]=x=>n.value.titulo=x),type:"text",placeholder:"Título de la obligación",class:A({"border-red-500":(K=a.errors)==null?void 0:K.titulo})},null,8,["modelValue","class"]),(j=a.errors)!=null&&j.titulo?(r(),k(q,{key:0,message:a.errors.titulo[0]},null,8,["message"])):g("",!0)]),c("div",null,[s(t(S),{for:"descripcion"},{default:l(()=>[...e[10]||(e[10]=[v("Descripción",-1)])]),_:1}),s(t(fe),{id:"descripcion",modelValue:n.value.descripcion,"onUpdate:modelValue":e[3]||(e[3]=x=>n.value.descripcion=x),placeholder:"Descripción detallada de la obligación",rows:3,class:A({"border-red-500":(U=a.errors)==null?void 0:U.descripcion})},null,8,["modelValue","class"]),(J=a.errors)!=null&&J.descripcion?(r(),k(q,{key:0,message:a.errors.descripcion[0]},null,8,["message"])):g("",!0)]),a.contratoId||n.value.contrato_id?(r(),f("div",Xe,[s(t(S),{for:"parent_id"},{default:l(()=>[...e[11]||(e[11]=[v("Obligación Padre",-1)])]),_:1}),$.value?(r(),f("div",Je,[s(t(re),{class:"h-4 w-4 animate-spin"}),e[12]||(e[12]=c("span",{class:"text-sm text-muted-foreground"},"Cargando obligaciones...",-1))])):(r(),k(t(ve),{key:1,modelValue:n.value.parent_id,"onUpdate:modelValue":e[4]||(e[4]=x=>n.value.parent_id=x),disabled:$.value},{default:l(()=>[s(t(ge),{id:"parent_id"},{default:l(()=>[s(t(pe),{placeholder:"Seleccionar obligación padre (opcional)"})]),_:1}),s(t(be),null,{default:l(()=>[s(t(se),{value:null},{default:l(()=>[...e[13]||(e[13]=[v("Sin padre (raíz)",-1)])]),_:1}),(r(!0),f(G,null,W(D.value,x=>{var Y;return r(),k(t(se),{key:x.id,value:x.id,disabled:x.id===((Y=a.obligacion)==null?void 0:Y.id)},{default:l(()=>[v(m("  ".repeat(x.nivel))+m(x.titulo),1)]),_:2},1032,["value","disabled"])}),128))]),_:1})]),_:1},8,["modelValue","disabled"])),(Q=a.errors)!=null&&Q.parent_id?(r(),k(q,{key:2,message:a.errors.parent_id[0]},null,8,["message"])):g("",!0),!$.value&&D.value.length===0?(r(),f("p",Qe," Este contrato no tiene obligaciones existentes. La nueva obligación será raíz. ")):g("",!0)])):g("",!0)]}),_:1})]),_:1}),s(t(ae),null,{default:l(()=>[s(t(Z),null,{default:l(()=>[s(t(ee),null,{default:l(()=>[...e[14]||(e[14]=[v("Archivos Adjuntos",-1)])]),_:1})]),_:1}),s(t(te),null,{default:l(()=>[s(Te,{"existing-files":T.value,description:"Formatos: PDF, Word, Excel, Imágenes",multiple:!0,"max-files":20,"max-size-m-b":5,accept:".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png",onFilesAdded:N,onFileRemoved:H},null,8,["existing-files"])]),_:1})]),_:1}),c("div",Ye,[s(t(M),{type:"button",variant:"outline",onClick:e[5]||(e[5]=w=>o.$emit("cancel")),disabled:a.loading},{default:l(()=>[...e[15]||(e[15]=[v(" Cancelar ",-1)])]),_:1},8,["disabled"]),s(t(M),{type:"submit",disabled:a.loading||!n.value.titulo||!n.value.contrato_id},{default:l(()=>[a.loading?(r(),k(t(re),{key:0,class:"h-4 w-4 mr-2 animate-spin"})):g("",!0),v(" "+m(a.obligacion?"Actualizar":"Crear")+" Obligación ",1)]),_:1},8,["disabled"])])],32))}});export{pt as _};
