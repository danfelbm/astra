import{r as k,a as U,d as ee,c as P,i as g,g as n,e as F,j as y,w as b,h as j,t as v,f as c,n as H,F as O,k as G,m as u,b as S,l as R,y as te}from"./app-Bwo8gItk.js";import{_ as T}from"./createLucideIcon-CiWTV2sr.js";import{c as ae,_ as A}from"./CardTitle.vue_vue_type_script_setup_true_lang-CCSG5iJV.js";import{_ as D}from"./Label.vue_vue_type_script_setup_true_lang-CnYuL5N8.js";import{U as se}from"./upload-Dk12Veil.js";import{F as K}from"./file-BRX3dmf6.js";import{E as oe}from"./eye-CUy0CpYk.js";import{D as le}from"./download-CHuyfJkQ.js";import{X}from"./x-BLnECrCi.js";function re(){const i=k(!1),C=k({}),B=k(new Map),t=()=>{const l=window.location.pathname;return l.startsWith("/admin")?"/admin":l.startsWith("/miembro")?"/miembro":""};return{isUploading:i,uploadProgress:C,uploadErrors:B,uploadFiles:async(l,e)=>{var m,f;i.value=!0,B.value.clear();const s=new FormData;l.forEach(h=>{s.append("files[]",h)}),s.append("module",e.module),s.append("field_id",e.fieldId),e.folder&&s.append("folder",e.folder),e.maxSize&&s.append("max_size",e.maxSize.toString());try{const h=await U.post(`${t()}/api/files/upload`,s,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:z=>{if(z.total){const E=Math.round(z.loaded*100/z.total);l.forEach(M=>{C.value[M.name]=E,e.onProgress&&e.onProgress(M.name,E)})}}});if(h.data.success)return e.onSuccess&&e.onSuccess(h.data.files),h.data.files;throw new Error(h.data.message||"Error al subir archivos")}catch(h){const z=((f=(m=h.response)==null?void 0:m.data)==null?void 0:f.message)||h.message||"Error desconocido al subir archivos";throw l.forEach(E=>{B.value.set(E.name,z)}),e.onError&&e.onError(h),h}finally{i.value=!1,setTimeout(()=>{C.value={}},2e3)}},deleteFile:async l=>{try{return(await U.delete(`${t()}/api/files/delete`,{data:{path:l}})).data.success}catch(e){return console.error("Error al eliminar archivo:",e),!1}},downloadFile:async(l,e)=>{try{const s=await U.get(`${t()}/api/files/download`,{params:{path:l},responseType:"blob"}),m=window.URL.createObjectURL(new Blob([s.data])),f=document.createElement("a");f.href=m,f.setAttribute("download",e||l.split("/").pop()||"archivo"),document.body.appendChild(f),f.click(),f.remove(),window.URL.revokeObjectURL(m)}catch(s){throw console.error("Error al descargar archivo:",s),s}},getFileInfo:async l=>{try{const e=await U.get(`${t()}/api/files/info`,{params:{path:l}});return e.data.success?e.data.file:null}catch(e){return console.error("Error al obtener información del archivo:",e),null}},validateFileType:(l,e)=>{var f;const s=e.split(",").map(h=>h.trim().toLowerCase()),m="."+((f=l.name.split(".").pop())==null?void 0:f.toLowerCase());return s.some(h=>h===m)},validateFileSize:(l,e)=>{const s=e*1024*1024;return l.size<=s},formatFileSize:l=>{if(l===0)return"0 Bytes";const e=1024,s=["Bytes","KB","MB","GB"],m=Math.floor(Math.log(l)/Math.log(e));return Math.round(l/Math.pow(e,m)*100)/100+" "+s[m]}}}const ie={class:"space-y-2"},ne={key:0,class:"text-red-500 ml-1"},ce={key:0,class:"text-sm text-muted-foreground"},de={class:"flex flex-col items-center justify-center text-center"},ue={class:"text-sm font-medium mb-1"},me={class:"text-xs text-muted-foreground"},pe=["multiple","accept","disabled"],fe={key:0,class:"space-y-2"},he={class:"space-y-2"},ve={class:"flex items-center justify-between"},xe={class:"flex items-center space-x-3 flex-1"},ge={class:"min-w-0 flex-1"},ye={class:"text-sm font-medium truncate"},we={key:0,class:"text-xs text-muted-foreground"},Fe={class:"flex items-center space-x-2"},be={key:1,class:"space-y-2"},_e={class:"space-y-2"},ke={class:"space-y-2"},ze={class:"flex items-center justify-between"},Se={class:"flex items-center space-x-3 flex-1"},Ee=["src","alt"],Ce={class:"min-w-0 flex-1"},Be={class:"text-sm font-medium truncate"},Ve={class:"text-xs text-muted-foreground"},$e={key:0,class:"w-full space-y-1"},Me={class:"flex justify-between text-xs text-muted-foreground"},Ue={class:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden"},Te={key:1,class:"text-xs text-red-600"},Ie={key:2,class:"text-sm text-red-600"},Le={key:3,class:"text-xs text-muted-foreground"},Pe={key:0},Ge=ee({__name:"FileUploadField",props:{modelValue:{},label:{},description:{},required:{type:Boolean,default:!1},multiple:{type:Boolean,default:!1},maxFiles:{default:5},maxFileSize:{default:10},accept:{default:".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif"},error:{},disabled:{type:Boolean,default:!1},showPreview:{type:Boolean,default:!0},module:{default:"postulaciones"},fieldId:{default:"file"},autoUpload:{type:Boolean,default:!0}},emits:["update:modelValue","filesSelected"],setup(i,{expose:C,emit:B}){const t=i,V=B,{isUploading:$,uploadFiles:N,deleteFile:W,formatFileSize:I}=re(),L=k(),w=k([]),l=k(new Map),e=k(new Map),s=k(new Map);k(!1);const m=P(()=>t.modelValue?t.modelValue.length>0&&typeof t.modelValue[0]=="string"?t.modelValue.map((r,d)=>({id:`existing_${d}`,name:r.split("/").pop()||"archivo",size:0,path:r,url:`/storage/${r}`})):t.modelValue:[]),f=P(()=>{const r=m.value.length+w.value.length;return t.multiple?r<t.maxFiles:r===0}),h=P(()=>t.accept.split(",").map(r=>r.trim().toLowerCase())),z=()=>{var r;!t.disabled&&f.value&&((r=L.value)==null||r.click())},E=r=>{var p;if(t.accept.includes("/*")){const a=t.accept.split(",").map(x=>x.trim());for(const x of a)if(x.includes("/*")){const _=x.replace("/*","");if(r.type.startsWith(_+"/"))return!0}}const d="."+((p=r.name.split(".").pop())==null?void 0:p.toLowerCase());return h.value.some(a=>a===d)},M=r=>{const d=t.maxFileSize*1024*1024;return r.size<=d},J=async r=>{const d=r.target,o=Array.from(d.files||[]);s.value.clear();const p=[];if(o.forEach(a=>{if(!E(a)){s.value.set(a.name,`Tipo de archivo no permitido. Solo se permiten: ${t.accept}`);return}if(!M(a)){s.value.set(a.name,`El archivo excede el tamaño máximo de ${t.maxFileSize}MB`);return}const x=m.value.length+p.length;if(t.multiple&&x>=t.maxFiles){s.value.set(a.name,`Se ha alcanzado el límite de ${t.maxFiles} archivos`);return}if(p.push(a),a.type.startsWith("image/")&&t.showPreview){const _=new FileReader;_.onload=Z=>{var q;l.value.set(a.name,(q=Z.target)==null?void 0:q.result)},_.readAsDataURL(a)}}),t.multiple?w.value=[...w.value,...p]:w.value=p.slice(0,1),p.length>0&&(V("filesSelected",p),t.autoUpload&&t.module&&t.fieldId))try{const a=await N(p,{module:t.module,fieldId:t.fieldId,onProgress:(x,_)=>{e.value.set(x,_)},onSuccess:x=>{const _=[...m.value,...x];V("update:modelValue",_),w.value=[],l.value.clear()},onError:x=>{console.error("Error al subir archivos:",x),p.forEach(_=>{s.value.set(_.name,"Error al subir el archivo")})}})}catch(a){console.error("Error en carga automática:",a)}d.value=""},Q=r=>{const d=w.value[r];l.value.delete(d.name),e.value.delete(d.name),s.value.delete(d.name),w.value.splice(r,1)},Y=async r=>{var p;const d=m.value[r];if(d.path)try{await W(d.path)}catch(a){((p=a==null?void 0:a.response)==null?void 0:p.status)!==404&&(a==null?void 0:a.status)!==404&&console.error("Error al eliminar archivo del servidor:",a)}const o=[...m.value];if(o.splice(r,1),typeof t.modelValue[0]=="string"){const a=o.map(x=>x.path).filter(Boolean);V("update:modelValue",a)}else V("update:modelValue",o)};return C({selectedFiles:w,uploadProgress:e,uploadErrors:s}),(r,d)=>(u(),g("div",ie,[n("div",null,[F(c(D),{class:"text-sm font-medium"},{default:b(()=>[j(v(i.label)+" ",1),i.required?(u(),g("span",ne,"*")):y("",!0)]),_:1}),i.description?(u(),g("p",ce,v(i.description),1)):y("",!0)]),F(c(A),{class:H(["border-2 border-dashed hover:border-primary/50 transition-colors cursor-pointer",{"opacity-50 cursor-not-allowed":i.disabled||!f.value||c($),"border-red-300":i.error}]),onClick:z},{default:b(()=>[F(c(ae),{class:"p-6"},{default:b(()=>[n("div",de,[F(c(se),{class:"h-10 w-10 text-muted-foreground mb-3"}),n("p",ue,v(c($)?"Subiendo archivos...":f.value?"Haz clic para seleccionar archivos":"Límite de archivos alcanzado"),1),n("p",me,v(i.multiple?`Hasta ${i.maxFiles} archivos`:"Un archivo")+" • Máx. "+v(i.maxFileSize)+"MB • Formatos: "+v(i.accept),1)])]),_:1})]),_:1},8,["class"]),n("input",{ref_key:"fileInputRef",ref:L,type:"file",multiple:i.multiple,accept:i.accept,disabled:i.disabled||!f.value||c($),onChange:J,class:"hidden"},null,40,pe),m.value.length>0?(u(),g("div",fe,[F(c(D),{class:"text-xs text-muted-foreground"},{default:b(()=>[...d[0]||(d[0]=[j("Archivos cargados:",-1)])]),_:1}),n("div",he,[(u(!0),g(O,null,G(m.value,(o,p)=>(u(),S(c(A),{key:o.id,class:"p-3"},{default:b(()=>[n("div",ve,[n("div",xe,[F(c(K),{class:"h-5 w-5 text-muted-foreground flex-shrink-0"}),n("div",ge,[n("p",ye,v(o.name),1),o.size>0?(u(),g("p",we,v(c(I)(o.size)),1)):y("",!0)])]),n("div",Fe,[o.url?(u(),S(c(T),{key:0,type:"button",variant:"ghost",size:"sm",onClick:R(a=>r.window.open(o.url,"_blank"),["stop"])},{default:b(()=>[F(c(oe),{class:"h-4 w-4"})]),_:1},8,["onClick"])):y("",!0),o.url?(u(),S(c(T),{key:1,type:"button",variant:"ghost",size:"sm",onClick:R(a=>r.window.open(o.url+"?download=true","_blank"),["stop"])},{default:b(()=>[F(c(le),{class:"h-4 w-4"})]),_:1},8,["onClick"])):y("",!0),i.disabled?y("",!0):(u(),S(c(T),{key:2,type:"button",variant:"ghost",size:"sm",onClick:R(a=>Y(p),["stop"])},{default:b(()=>[F(c(X),{class:"h-4 w-4 text-destructive"})]),_:1},8,["onClick"]))])])]),_:2},1024))),128))])])):y("",!0),w.value.length>0?(u(),g("div",be,[F(c(D),{class:"text-xs text-muted-foreground"},{default:b(()=>[j(v(e.value.size>0?"Subiendo archivos...":"Archivos pendientes de carga:"),1)]),_:1}),n("div",_e,[(u(!0),g(O,null,G(w.value,(o,p)=>(u(),S(c(A),{key:o.name,class:H(["p-3",{"border-red-300":s.value.has(o.name)}])},{default:b(()=>[n("div",ke,[n("div",ze,[n("div",Se,[l.value.has(o.name)&&i.showPreview?(u(),g("img",{key:0,src:l.value.get(o.name),alt:o.name,class:"h-10 w-10 object-cover rounded flex-shrink-0"},null,8,Ee)):(u(),S(c(K),{key:1,class:"h-5 w-5 text-muted-foreground flex-shrink-0"})),n("div",Ce,[n("p",Be,v(o.name),1),n("p",Ve,v(c(I)(o.size)),1)])]),i.disabled?y("",!0):(u(),S(c(T),{key:0,type:"button",variant:"ghost",size:"sm",onClick:a=>Q(p)},{default:b(()=>[F(c(X),{class:"h-4 w-4 text-destructive"})]),_:1},8,["onClick"]))]),e.value.has(o.name)?(u(),g("div",$e,[n("div",Me,[d[1]||(d[1]=n("span",null,"Subiendo...",-1)),n("span",null,v(e.value.get(o.name))+"%",1)]),n("div",Ue,[n("div",{class:"bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all duration-300 ease-out",style:te({width:`${e.value.get(o.name)}%`})},[...d[2]||(d[2]=[n("div",{class:"h-full bg-white/30 animate-pulse"},null,-1)])],4)])])):y("",!0),s.value.has(o.name)?(u(),g("p",Te,v(s.value.get(o.name)),1)):y("",!0)])]),_:2},1032,["class"]))),128))])])):y("",!0),i.error?(u(),g("p",Ie,v(i.error),1)):y("",!0),!i.disabled&&f.value?(u(),g("div",Le,[i.multiple?(u(),g("p",Pe,v(m.value.length+w.value.length)+" de "+v(i.maxFiles)+" archivos ",1)):y("",!0)])):y("",!0)]))}});export{Ge as _,re as u};
