import{d as ce,k as c,c as fe,a as k,o as u,b as s,u as a,m as me,e as t,f as n,j as C,i as p,g as i,h as ve,t as y,F as L,r as H,q as N}from"./app-lge2-nVh.js";import{_ as pe}from"./GuestLayout.vue_vue_type_script_setup_true_lang-OtkqycHA.js";import{_ as M,a as W,b as F,c as Z}from"./CardTitle.vue_vue_type_script_setup_true_lang-BlmG1Y_n.js";import{_ as J}from"./CardDescription.vue_vue_type_script_setup_true_lang-CKrw1Xd3.js";import{_ as T}from"./createLucideIcon-BG5bY4f6.js";import{_ as ge}from"./Input.vue_vue_type_script_setup_true_lang-CDJmShOv.js";import{_ as q}from"./Label.vue_vue_type_script_setup_true_lang-DWC3z2Mr.js";import{_ as R,a as z}from"./index-NGc1FZHI.js";import{_ as K,a as Q,b as X}from"./PinInputSlot.vue_vue_type_script_setup_true_lang-CoPxzL3U.js";import{t as g}from"./index-e37EjlUX.js";import{S as _e}from"./search-BZUK1aOb.js";import{C as Y}from"./circle-alert-BMt58cK9.js";import{L as ee}from"./loader-circle-2TzcQ2bi.js";import{U as ye}from"./user-check-BrNpv4F8.js";import"./index-DIhNufxe.js";import"./AppLogo.vue_vue_type_script_setup_true_lang-C3wC9Sjv.js";import"./index-BxvmGUnK.js";import"./VisuallyHidden-B7fqfPuk.js";import"./VisuallyHiddenInput-IJgjN5DC.js";const we={class:"max-w-2xl mx-auto"},be={class:"bg-muted p-4 rounded-lg space-y-2"},xe={class:"flex flex-col gap-2 mt-3"},ke={key:0,class:"flex items-center gap-2"},Ce={class:"text-sm"},he={key:1,class:"flex items-center gap-2"},$e={class:"text-sm"},Ve={class:"flex gap-3"},Ae={key:0,class:"space-y-2"},Se={class:"flex gap-2 items-center"},Te={key:1,class:"space-y-2"},Ue={class:"flex gap-2 items-center"},De={key:3,class:"pt-4 border-t"},Ee={class:"space-y-3"},Ye=ce({__name:"RegistrationConfirmation",setup(Be){const V=c(!1),A=c(""),m=c(null),x=c(null),d=c(""),h=c("search"),f=c({email:"",whatsapp:""}),S=c(!1),I=c(!1),U=c(0),P=c(null),D=c(!1),j=c(!1),w=c({email:!1,whatsapp:!1}),ae=async()=>{var l,e,o;if(!A.value){g.error("Por favor ingresa un número de documento");return}V.value=!0,d.value="",m.value=null;try{const r=await N.post("/confirmar-registro/buscar",{documento_identidad:A.value});r.data.success&&(m.value=r.data.user,x.value=r.data.verification_id,h.value="found",g.success("Usuario encontrado correctamente"))}catch(r){((l=r.response)==null?void 0:l.status)===404?d.value="No se encontró ningún usuario registrado con ese documento.":d.value=((o=(e=r.response)==null?void 0:e.data)==null?void 0:o.message)||"Error al buscar el usuario",g.error(d.value)}finally{V.value=!1}},se=async()=>{var l,e,o;if(x.value){D.value=!0;try{const r=await N.post("/confirmar-registro/enviar-verificacion",{verification_id:x.value});r.data.success&&(j.value=!0,w.value=r.data.channels,h.value="verifying",te(),g.success("Códigos de verificación enviados"),w.value.email&&w.value.whatsapp?g.info("Revisa tu email y WhatsApp"):w.value.email?g.info("Revisa tu email"):w.value.whatsapp&&g.info("Revisa tu WhatsApp"))}catch(r){((l=r.response)==null?void 0:l.status)===429?d.value="Has excedido el límite de intentos. Por favor, espera 1 hora.":d.value=((o=(e=r.response)==null?void 0:e.data)==null?void 0:o.message)||"Error al enviar códigos",g.error(d.value)}finally{D.value=!1}}},te=()=>{U.value=10,P.value=setInterval(()=>{U.value--,U.value<=0&&(clearInterval(P.value),le())},1e3)},le=async()=>{if(x.value)try{(await N.post("/confirmar-registro/check-timeout",{verification_id:x.value})).data.can_proceed&&(I.value=!0)}catch(l){console.error("Error checking timeout:",l)}},E=async l=>{var r,_,b,$;const e=l==="email"?f.value.email:f.value.whatsapp,o=Array.isArray(e)?e.join(""):String(e);if(!o||o.length!==6){g.error("Por favor ingresa un código de 6 dígitos");return}S.value=!0;try{const v=await N.post("/confirmar-registro/verificar-codigo",{verification_id:x.value,code:o,channel:l});v.data.success&&(g.success("Código verificado correctamente"),v.data.fully_verified||v.data.can_proceed?O():l==="email"?w.value.email=!1:w.value.whatsapp=!1)}catch(v){(_=(r=v.response)==null?void 0:r.data)!=null&&_.expired?(d.value="Los códigos han expirado. Por favor, solicita nuevos códigos.",h.value="found",j.value=!1):d.value=(($=(b=v.response)==null?void 0:b.data)==null?void 0:$.message)||"Código incorrecto",g.error(d.value)}finally{S.value=!1}},O=()=>{window.location.href=`/confirmar-registro/actualizar-datos?verification_id=${x.value}`},oe=()=>{A.value="",m.value=null,x.value=null,h.value="search",j.value=!1,I.value=!1,d.value="",f.value={email:"",whatsapp:""},clearInterval(P.value)},G=fe(()=>U.value>0?`Si no recibes los códigos, podrás actualizar tus datos en ${U.value} segundos`:""),re=l=>l?l.split(" ").map(o=>{if(o.length<=2)return o;const r=o.substring(0,2),_="*".repeat(o.length-2);return r+_}).join(" "):"",ie=l=>{if(!l)return"";const[e,o]=l.split("@");if(!e||!o)return l;const[r,_]=o.split(".");if(!r||!_)return l;let b="";if(e.length<=3)b=e;else{const v=e.substring(0,2),B=e.substring(e.length-1),de="*".repeat(e.length-3);b=v+de+B}const $=r[0]+"*".repeat(r.length-1);return`${b}@${$}.${_}`},ne=l=>{if(!l)return"";if(l.length<=6)return l;const e=l.substring(0,5),o=l.substring(l.length-1),r="*".repeat(l.length-6);return e+r+o},ue=l=>{if(!l)return"";const e=l.includes("Z")||l.includes("+")?l:l+"Z",o=new Date(e),r={year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0,timeZone:"America/Bogota"};return o.toLocaleDateString("es-CO",r)+" (GMT-5)"};return(l,e)=>(u(),k(L,null,[s(a(me),{title:"Confirmar Registro"}),s(pe,{title:"Confirmación de Registro",description:"Verifica si estás registrado en el sistema y actualiza tus datos de contacto"},{default:t(()=>[n("div",we,[h.value==="search"?(u(),C(a(M),{key:0,class:"shadow-lg"},{default:t(()=>[s(a(W),null,{default:t(()=>[s(a(F),{class:"flex items-center gap-2"},{default:t(()=>[s(a(_e),{class:"w-5 h-5"}),e[7]||(e[7]=i(" Buscar Registro ",-1))]),_:1}),s(a(J),null,{default:t(()=>[...e[8]||(e[8]=[i(" Ingresa tu número de documento para verificar si estás registrado ",-1)])]),_:1})]),_:1}),s(a(Z),null,{default:t(()=>[n("form",{onSubmit:ve(ae,["prevent"]),class:"space-y-4"},[n("div",null,[s(a(q),{for:"documento"},{default:t(()=>[...e[9]||(e[9]=[i("Número de Documento",-1)])]),_:1}),s(a(ge),{id:"documento",modelValue:A.value,"onUpdate:modelValue":e[0]||(e[0]=o=>A.value=o),type:"text",placeholder:"Ej: 1234567890",disabled:V.value,class:"mt-1",autofocus:""},null,8,["modelValue","disabled"])]),d.value?(u(),C(a(R),{key:0,variant:"destructive"},{default:t(()=>[s(a(Y),{class:"h-4 w-4"}),s(a(z),null,{default:t(()=>[i(y(d.value),1)]),_:1})]),_:1})):p("",!0),s(a(T),{type:"submit",disabled:V.value||!A.value,class:"w-full"},{default:t(()=>[V.value?(u(),C(a(ee),{key:0,class:"mr-2 h-4 w-4 animate-spin"})):p("",!0),i(" "+y(V.value?"Buscando...":"Buscar"),1)]),_:1},8,["disabled"])],32)]),_:1})]),_:1})):h.value==="found"?(u(),C(a(M),{key:1,class:"shadow-lg"},{default:t(()=>[s(a(W),null,{default:t(()=>[s(a(F),{class:"flex items-center gap-2"},{default:t(()=>[s(a(ye),{class:"w-5 h-5 text-green-600"}),e[10]||(e[10]=i(" Usuario Encontrado ",-1))]),_:1})]),_:1}),s(a(Z),{class:"space-y-4"},{default:t(()=>{var o,r,_,b,$,v,B;return[n("div",be,[n("p",null,[e[11]||(e[11]=n("strong",null,"Nombre:",-1)),i(" "+y(re(((o=m.value)==null?void 0:o.name)||"")),1)]),n("p",null,[e[12]||(e[12]=n("strong",null,"Documento:",-1)),i(" "+y((r=m.value)==null?void 0:r.documento_identidad),1)]),n("p",null,[e[13]||(e[13]=n("strong",null,"Registrado en:",-1)),i(" "+y(ue(((_=m.value)==null?void 0:_.created_at)||"")),1)]),n("div",xe,[(b=m.value)!=null&&b.has_email&&(($=m.value)!=null&&$.email)?(u(),k("div",ke,[e[15]||(e[15]=n("span",{class:"text-sm text-green-600"},"✓",-1)),n("span",Ce,[e[14]||(e[14]=n("strong",null,"Email:",-1)),i(" "+y(ie(m.value.email)),1)])])):p("",!0),(v=m.value)!=null&&v.has_phone&&((B=m.value)!=null&&B.telefono)?(u(),k("div",he,[e[17]||(e[17]=n("span",{class:"text-sm text-green-600"},"✓",-1)),n("span",$e,[e[16]||(e[16]=n("strong",null,"Teléfono:",-1)),i(" "+y(ne(m.value.telefono)),1)])])):p("",!0)])]),s(a(R),null,{default:t(()=>[s(a(z),{class:"text-foreground"},{default:t(()=>[...e[18]||(e[18]=[i(" ¿Tus datos son correctos? Puedes validarlos a continuación y actualizarlos si deseas. Te enviaremos códigos de verificación a tu email y/o teléfono registrados (via WhatsApp). ",-1)])]),_:1})]),_:1}),n("div",Ve,[s(a(T),{onClick:se,disabled:D.value,class:"flex-1"},{default:t(()=>[D.value?(u(),C(a(ee),{key:0,class:"mr-2 h-4 w-4 animate-spin"})):p("",!0),i(" "+y(D.value?"Enviando...":"Validar Datos"),1)]),_:1},8,["disabled"]),s(a(T),{onClick:oe,variant:"outline"},{default:t(()=>[...e[19]||(e[19]=[i(" Buscar otro ",-1)])]),_:1})])]}),_:1})]),_:1})):h.value==="verifying"?(u(),C(a(M),{key:2,class:"shadow-lg"},{default:t(()=>[s(a(W),null,{default:t(()=>[s(a(F),null,{default:t(()=>[...e[20]||(e[20]=[i("Verificación de Códigos",-1)])]),_:1}),s(a(J),null,{default:t(()=>[...e[21]||(e[21]=[i(" Ingresa los códigos que recibiste ",-1)])]),_:1})]),_:1}),s(a(Z),{class:"space-y-4"},{default:t(()=>[w.value.email?(u(),k("div",Ae,[s(a(q),null,{default:t(()=>[...e[22]||(e[22]=[i("Código de Email",-1)])]),_:1}),n("div",Se,[s(a(K),{modelValue:f.value.email,"onUpdate:modelValue":e[1]||(e[1]=o=>f.value.email=o),disabled:S.value,placeholder:"○",onComplete:e[2]||(e[2]=()=>E("email"))},{default:t(()=>[s(a(Q),null,{default:t(()=>[(u(),k(L,null,H(6,(o,r)=>s(a(X),{key:r,index:r},null,8,["index"])),64))]),_:1})]),_:1},8,["modelValue","disabled"]),s(a(T),{onClick:e[3]||(e[3]=o=>E("email")),disabled:S.value||(Array.isArray(f.value.email)?f.value.email.join("").length!==6:f.value.email.length!==6),size:"sm"},{default:t(()=>[...e[23]||(e[23]=[i(" Verificar ",-1)])]),_:1},8,["disabled"])])])):p("",!0),w.value.whatsapp?(u(),k("div",Te,[s(a(q),null,{default:t(()=>[...e[24]||(e[24]=[i("Código de WhatsApp",-1)])]),_:1}),n("div",Ue,[s(a(K),{modelValue:f.value.whatsapp,"onUpdate:modelValue":e[4]||(e[4]=o=>f.value.whatsapp=o),disabled:S.value,placeholder:"○",onComplete:e[5]||(e[5]=()=>E("whatsapp"))},{default:t(()=>[s(a(Q),null,{default:t(()=>[(u(),k(L,null,H(6,(o,r)=>s(a(X),{key:r,index:r},null,8,["index"])),64))]),_:1})]),_:1},8,["modelValue","disabled"]),s(a(T),{onClick:e[6]||(e[6]=o=>E("whatsapp")),disabled:S.value||(Array.isArray(f.value.whatsapp)?f.value.whatsapp.join("").length!==6:f.value.whatsapp.length!==6),size:"sm"},{default:t(()=>[...e[25]||(e[25]=[i(" Verificar ",-1)])]),_:1},8,["disabled"])])])):p("",!0),G.value?(u(),C(a(R),{key:2,class:"border-green-200 bg-green-50"},{default:t(()=>[s(a(z),{class:"text-green-700"},{default:t(()=>[i(y(G.value),1)]),_:1})]),_:1})):p("",!0),I.value?(u(),k("div",De,[n("div",Ee,[e[27]||(e[27]=n("p",{class:"text-sm text-muted-foreground"}," Si no recibiste los códigos, puedes esperar un poco o bien puedes actualizar tus datos: ",-1)),s(a(T),{onClick:O,variant:"outline",class:"w-full"},{default:t(()=>[...e[26]||(e[26]=[i(" ¿Deseas actualizar datos? ",-1)])]),_:1})])])):p("",!0),d.value?(u(),C(a(R),{key:4,variant:"destructive"},{default:t(()=>[s(a(Y),{class:"h-4 w-4"}),s(a(z),null,{default:t(()=>[i(y(d.value),1)]),_:1})]),_:1})):p("",!0)]),_:1})]),_:1})):p("",!0)])]),_:1})],64))}});export{Ye as default};
