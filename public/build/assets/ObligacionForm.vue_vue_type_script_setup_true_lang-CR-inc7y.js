import{d as ie,r as C,c as A,p as oe,i as f,j as p,g as u,b as F,e as s,f as a,w as l,h as v,F as L,k as U,t as m,l as re,n as D,m as o,a as de}from"./app-DHyuBUYV.js";import{a as G,b as W,c as X,_ as J}from"./CardTitle.vue_vue_type_script_setup_true_lang-Wla0exjo.js";import{_ as S}from"./Label.vue_vue_type_script_setup_true_lang-BIxSev7U.js";import{_ as ue}from"./Input.vue_vue_type_script_setup_true_lang-DuS2P33b.js";import{_ as ce}from"./Textarea.vue_vue_type_script_setup_true_lang-D24ReoUk.js";import{_ as q}from"./createLucideIcon-BImpDyGn.js";import{_ as Q,a as Y,b as Z,c as ee,d as H}from"./SelectValue.vue_vue_type_script_setup_true_lang-d0KbVjOJ.js";import{_ as N}from"./InputError.vue_vue_type_script_setup_true_lang-D2h2JDc6.js";import{_ as te}from"./index-DbdIQHsm.js";import{_ as me,a as fe}from"./index-CLtTuG-_.js";import{U as ae}from"./upload-Du30osL6.js";import{C as ve}from"./circle-alert-C2NBzjLb.js";import{P as ge}from"./paperclip-BPhGPpwO.js";import{X as se}from"./x-C125qWK5.js";import{L as le}from"./loader-circle-Ak1iqwBz.js";const pe={class:"space-y-4"},xe={key:0,class:"space-y-2"},be={class:"space-y-2"},he={class:"flex items-center gap-3 flex-1 min-w-0"},ye={class:"min-w-0 flex-1"},_e={class:"text-sm font-medium truncate"},ke={key:0,class:"text-xs text-muted-foreground"},$e=["multiple","accept","disabled"],Fe={class:"text-sm font-medium mb-1"},we={class:"text-xs text-muted-foreground"},Be={class:"text-xs text-muted-foreground mt-1"},ze={key:0},Ce={key:1,class:"space-y-2"},Se={class:"space-y-2"},Ve={class:"flex items-center gap-3 flex-1 min-w-0"},Me={class:"min-w-0 flex-1"},Ee={class:"text-sm font-medium truncate"},Ae={class:"text-xs text-muted-foreground"},De={key:3,class:"text-xs text-muted-foreground"},Ie={key:0,class:"text-destructive"},Pe=ie({__name:"FileAttachmentManager",props:{existingFiles:{default:()=>[]},label:{},description:{},multiple:{type:Boolean,default:!0},maxFiles:{default:10},maxSizeMB:{default:5},accept:{default:".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png"},disabled:{type:Boolean,default:!1},error:{}},emits:["files-added","file-removed"],setup(t,{expose:O,emit:_}){const b=t,n=_,B=C(),h=C(!1),x=C([]),V=C(""),z=A(()=>b.existingFiles||[]),M=A(()=>z.value.length+x.value.length),R=A(()=>M.value<b.maxFiles),T=()=>{var i;!b.disabled&&R.value&&((i=B.value)==null||i.click())},I=i=>{const r=i.target;r.files&&(E(Array.from(r.files)),r.value="")},P=i=>{var d;if(i.preventDefault(),h.value=!1,b.disabled)return;const r=Array.from(((d=i.dataTransfer)==null?void 0:d.files)||[]);E(r)},E=i=>{V.value="";const r=b.maxFiles-M.value;if(i.length>r){V.value=`Solo puedes agregar ${r} archivo(s) más. Límite: ${b.maxFiles}`;return}const d=[],y=[];i.forEach(k=>{var K;const g=b.maxSizeMB*1024*1024;if(k.size>g){y.push(`${k.name}: excede ${b.maxSizeMB}MB`);return}const $=`.${(K=k.name.split(".").pop())==null?void 0:K.toLowerCase()}`;if(!b.accept.split(",").map(ne=>ne.trim().toLowerCase()).includes($)){y.push(`${k.name}: formato no permitido`);return}d.push(k)}),y.length>0&&(V.value=y.join(", ")),d.length>0&&(b.multiple?x.value.push(...d):x.value=[d[0]],n("files-added",x.value))},j=i=>{x.value.splice(i,1),n("files-added",x.value)},c=i=>{const r=z.value[i];r&&confirm("¿Estás seguro de eliminar este archivo?")&&n("file-removed",r.ruta)},e=i=>{if(!i)return"0 KB";const r=["B","KB","MB","GB"],d=Math.floor(Math.log(i)/Math.log(1024));return`${(i/Math.pow(1024,d)).toFixed(1)} ${r[d]}`},w=i=>{var r;return((r=i.split(".").pop())==null?void 0:r.toUpperCase())||"FILE"};return O({newFiles:x,clearNewFiles:()=>{x.value=[]}}),oe(()=>b.error,i=>{i||(V.value="")}),(i,r)=>(o(),f("div",pe,[z.value.length>0?(o(),f("div",xe,[s(a(S),{class:"text-sm font-medium"},{default:l(()=>[...r[2]||(r[2]=[v("Archivos actuales",-1)])]),_:1}),u("div",be,[(o(!0),f(L,null,U(z.value,(d,y)=>(o(),f("div",{key:`existing-${y}`,class:"flex items-center justify-between p-3 bg-muted rounded-lg border border-border hover:bg-accent/50 transition-colors"},[u("div",he,[s(a(ge),{class:"h-4 w-4 text-muted-foreground flex-shrink-0"}),u("div",ye,[u("p",_e,m(d.nombre_original),1),d.tamaño?(o(),f("p",ke,m(e(d.tamaño)),1)):p("",!0)]),s(a(te),{variant:"outline",class:"flex-shrink-0"},{default:l(()=>[v(m(w(d.nombre_original)),1)]),_:2},1024)]),s(a(q),{type:"button",variant:"ghost",size:"icon",class:"h-8 w-8 text-destructive hover:text-destructive hover:bg-destructive/10 flex-shrink-0",onClick:k=>c(y),disabled:t.disabled},{default:l(()=>[s(a(se),{class:"h-4 w-4"})]),_:1},8,["onClick","disabled"])]))),128))])])):p("",!0),u("div",null,[t.label?(o(),F(a(S),{key:0,class:"text-sm font-medium"},{default:l(()=>[v(m(t.label),1)]),_:1})):p("",!0),u("div",{onDrop:P,onDragover:r[0]||(r[0]=re(d=>h.value=!0,["prevent"])),onDragleave:r[1]||(r[1]=d=>h.value=!1),onClick:T,class:"relative mt-2"},[u("input",{ref_key:"fileInput",ref:B,type:"file",multiple:t.multiple,accept:t.accept,disabled:t.disabled,class:"hidden",onChange:I},null,40,$e),u("div",{class:D(["border-2 border-dashed rounded-lg p-6 text-center cursor-pointer transition-all",{"border-primary bg-primary/5 ring-2 ring-primary/20":h.value,"border-muted-foreground/25 hover:border-muted-foreground/50 hover:bg-muted/30":!h.value&&!t.disabled,"opacity-50 cursor-not-allowed":t.disabled,"border-destructive":t.error}])},[s(a(ae),{class:D(["h-10 w-10 mx-auto mb-3 transition-colors",h.value?"text-primary":"text-muted-foreground"])},null,8,["class"]),u("p",Fe,m(h.value?"Suelta los archivos aquí":"Haz clic o arrastra archivos aquí"),1),u("p",we,m(t.description||`Formatos: ${t.accept}`),1),u("p",Be,[v(" Máximo "+m(t.maxSizeMB)+"MB por archivo ",1),t.multiple?(o(),f("span",ze," • Hasta "+m(t.maxFiles)+" archivos total",1)):p("",!0)])],2)],32)]),x.value.length>0?(o(),f("div",Ce,[s(a(S),{class:"text-sm font-medium"},{default:l(()=>[...r[3]||(r[3]=[v("Archivos a subir",-1)])]),_:1}),u("div",Se,[(o(!0),f(L,null,U(x.value,(d,y)=>(o(),f("div",{key:`new-${y}`,class:"flex items-center justify-between p-3 bg-accent rounded-lg border border-primary/20"},[u("div",Ve,[s(a(ae),{class:"h-4 w-4 text-primary flex-shrink-0"}),u("div",Me,[u("p",Ee,m(d.name),1),u("p",Ae,m(e(d.size)),1)]),s(a(te),{variant:"secondary",class:"flex-shrink-0"},{default:l(()=>[v(m(w(d.name)),1)]),_:2},1024)]),s(a(q),{type:"button",variant:"ghost",size:"icon",class:"h-8 w-8 hover:bg-destructive/10 flex-shrink-0",onClick:k=>j(y),disabled:t.disabled},{default:l(()=>[s(a(se),{class:"h-4 w-4"})]),_:1},8,["onClick","disabled"])]))),128))])])):p("",!0),t.error?(o(),F(a(me),{key:2,variant:"destructive"},{default:l(()=>[s(a(ve),{class:"h-4 w-4"}),s(a(fe),null,{default:l(()=>[v(m(t.error),1)]),_:1})]),_:1})):p("",!0),!t.disabled&&(z.value.length>0||x.value.length>0)?(o(),f("div",De,[v(m(M.value)+" de "+m(t.maxFiles)+" archivos ",1),M.value>=t.maxFiles?(o(),f("span",Ie," (límite alcanzado)")):p("",!0)])):p("",!0)]))}}),je={key:0},Ne={key:0,class:"text-muted-foreground ml-1"},Le={key:1},Ue={key:0,class:"flex items-center gap-2 h-10 px-3 border rounded-md bg-muted/50"},qe={key:3,class:"text-xs text-muted-foreground mt-1"},Oe={class:"flex justify-end gap-2"},it=ie({__name:"ObligacionForm",props:{obligacion:{},contratoId:{},contratos:{default:()=>[]},parentId:{},posiblesPadres:{default:()=>[]},usuarios:{default:()=>[]},loading:{type:Boolean,default:!1},errors:{default:()=>({})}},emits:["submit","cancel"],setup(t,{emit:O}){var I,P,E,j;const _=t,b=O,n=C({contrato_id:_.contratoId||((I=_.obligacion)==null?void 0:I.contrato_id)||0,parent_id:_.parentId||((P=_.obligacion)==null?void 0:P.parent_id)||null,titulo:((E=_.obligacion)==null?void 0:E.titulo)||"",descripcion:((j=_.obligacion)==null?void 0:j.descripcion)||"",archivos:[],archivos_eliminar:[]}),B=C([]),h=C(!1),x=A(()=>_.contratoId?_.posiblesPadres||[]:B.value),V=async c=>{if(!c){B.value=[];return}h.value=!0;try{const e=await de.get("/admin/obligaciones/posibles-padres",{params:{contrato_id:c}});e.data.success&&(B.value=e.data.posiblesPadres)}catch(e){console.error("Error cargando posibles padres:",e),B.value=[]}finally{h.value=!1}};oe(()=>n.value.contrato_id,c=>{if(!_.contratoId&&c){n.value.parent_id=null;const e=typeof c=="string"?parseInt(c,10):c;e&&!isNaN(e)&&V(e)}});const z=A(()=>{var e;return(((e=_.obligacion)==null?void 0:e.archivos_adjuntos)||[]).filter(w=>{var i;return!((i=n.value.archivos_eliminar)!=null&&i.includes(w.ruta))})}),M=()=>{const c={...n.value};b("submit",c)},R=c=>{n.value.archivos=c},T=c=>{n.value.archivos_eliminar=n.value.archivos_eliminar||[],n.value.archivos_eliminar.includes(c)||n.value.archivos_eliminar.push(c)};return(c,e)=>(o(),f("form",{onSubmit:re(M,["prevent"]),class:"space-y-4"},[s(a(J),null,{default:l(()=>[s(a(G),null,{default:l(()=>[s(a(W),null,{default:l(()=>[...e[5]||(e[5]=[v("Información Básica",-1)])]),_:1})]),_:1}),s(a(X),{class:"space-y-4"},{default:l(()=>{var w,i,r,d,y,k;return[!t.contratoId&&t.contratos&&t.contratos.length>0?(o(),f("div",je,[s(a(S),{for:"contrato_id",required:""},{default:l(()=>[...e[6]||(e[6]=[v("Contrato",-1)])]),_:1}),s(a(Q),{modelValue:n.value.contrato_id,"onUpdate:modelValue":e[0]||(e[0]=g=>n.value.contrato_id=g)},{default:l(()=>{var g;return[s(a(Y),{id:"contrato_id",class:D({"border-red-500":(g=t.errors)==null?void 0:g.contrato_id})},{default:l(()=>[s(a(Z),{placeholder:"Seleccionar contrato"})]),_:1},8,["class"]),s(a(ee),null,{default:l(()=>[(o(!0),f(L,null,U(t.contratos,$=>(o(),F(a(H),{key:$.id,value:$.id},{default:l(()=>[v(m($.nombre)+" ",1),$.proyecto?(o(),f("span",Ne," ("+m($.proyecto.nombre)+") ",1)):p("",!0)]),_:2},1032,["value"]))),128))]),_:1})]}),_:1},8,["modelValue"]),(w=t.errors)!=null&&w.contrato_id?(o(),F(N,{key:0,message:t.errors.contrato_id[0]},null,8,["message"])):p("",!0),e[7]||(e[7]=u("p",{class:"text-xs text-muted-foreground mt-1"}," Selecciona el contrato al que pertenecerá esta obligación ",-1))])):p("",!0),u("div",null,[s(a(S),{for:"titulo",required:""},{default:l(()=>[...e[8]||(e[8]=[v("Título",-1)])]),_:1}),s(a(ue),{id:"titulo",modelValue:n.value.titulo,"onUpdate:modelValue":e[1]||(e[1]=g=>n.value.titulo=g),type:"text",placeholder:"Título de la obligación",class:D({"border-red-500":(i=t.errors)==null?void 0:i.titulo})},null,8,["modelValue","class"]),(r=t.errors)!=null&&r.titulo?(o(),F(N,{key:0,message:t.errors.titulo[0]},null,8,["message"])):p("",!0)]),u("div",null,[s(a(S),{for:"descripcion"},{default:l(()=>[...e[9]||(e[9]=[v("Descripción",-1)])]),_:1}),s(a(ce),{id:"descripcion",modelValue:n.value.descripcion,"onUpdate:modelValue":e[2]||(e[2]=g=>n.value.descripcion=g),placeholder:"Descripción detallada de la obligación",rows:3,class:D({"border-red-500":(d=t.errors)==null?void 0:d.descripcion})},null,8,["modelValue","class"]),(y=t.errors)!=null&&y.descripcion?(o(),F(N,{key:0,message:t.errors.descripcion[0]},null,8,["message"])):p("",!0)]),t.contratoId||n.value.contrato_id?(o(),f("div",Le,[s(a(S),{for:"parent_id"},{default:l(()=>[...e[10]||(e[10]=[v("Obligación Padre",-1)])]),_:1}),h.value?(o(),f("div",Ue,[s(a(le),{class:"h-4 w-4 animate-spin"}),e[11]||(e[11]=u("span",{class:"text-sm text-muted-foreground"},"Cargando obligaciones...",-1))])):(o(),F(a(Q),{key:1,modelValue:n.value.parent_id,"onUpdate:modelValue":e[3]||(e[3]=g=>n.value.parent_id=g),disabled:h.value},{default:l(()=>[s(a(Y),{id:"parent_id"},{default:l(()=>[s(a(Z),{placeholder:"Seleccionar obligación padre (opcional)"})]),_:1}),s(a(ee),null,{default:l(()=>[s(a(H),{value:null},{default:l(()=>[...e[12]||(e[12]=[v("Sin padre (raíz)",-1)])]),_:1}),(o(!0),f(L,null,U(x.value,g=>{var $;return o(),F(a(H),{key:g.id,value:g.id,disabled:g.id===(($=t.obligacion)==null?void 0:$.id)},{default:l(()=>[v(m("  ".repeat(g.nivel))+m(g.titulo),1)]),_:2},1032,["value","disabled"])}),128))]),_:1})]),_:1},8,["modelValue","disabled"])),(k=t.errors)!=null&&k.parent_id?(o(),F(N,{key:2,message:t.errors.parent_id[0]},null,8,["message"])):p("",!0),!h.value&&x.value.length===0?(o(),f("p",qe," Este contrato no tiene obligaciones existentes. La nueva obligación será raíz. ")):p("",!0)])):p("",!0)]}),_:1})]),_:1}),s(a(J),null,{default:l(()=>[s(a(G),null,{default:l(()=>[s(a(W),null,{default:l(()=>[...e[13]||(e[13]=[v("Archivos Adjuntos",-1)])]),_:1})]),_:1}),s(a(X),null,{default:l(()=>[s(Pe,{"existing-files":z.value,description:"Formatos: PDF, Word, Excel, Imágenes",multiple:!0,"max-files":20,"max-size-m-b":5,accept:".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png",onFilesAdded:R,onFileRemoved:T},null,8,["existing-files"])]),_:1})]),_:1}),u("div",Oe,[s(a(q),{type:"button",variant:"outline",onClick:e[4]||(e[4]=w=>c.$emit("cancel")),disabled:t.loading},{default:l(()=>[...e[14]||(e[14]=[v(" Cancelar ",-1)])]),_:1},8,["disabled"]),s(a(q),{type:"submit",disabled:t.loading||!n.value.titulo||!n.value.contrato_id},{default:l(()=>[t.loading?(o(),F(a(le),{key:0,class:"h-4 w-4 mr-2 animate-spin"})):p("",!0),v(" "+m(t.obligacion?"Actualizar":"Crear")+" Obligación ",1)]),_:1},8,["disabled"])])],32))}});export{it as _};
