import{d as ie,r as z,c as A,p as oe,i as m,j as p,g as u,b as F,e as s,f as t,w as l,h as f,F as U,k as N,t as c,l as re,n as D,m as o,a as de}from"./app-_gYD6cjj.js";import{a as G,b as W,c as X,_ as J}from"./CardTitle.vue_vue_type_script_setup_true_lang-quT184_r.js";import{_ as S}from"./Label.vue_vue_type_script_setup_true_lang-CH9csirK.js";import{_ as ue}from"./Input.vue_vue_type_script_setup_true_lang-C0f1vu2D.js";import{_ as ce}from"./Textarea.vue_vue_type_script_setup_true_lang-BZGOXbvw.js";import{_ as q}from"./createLucideIcon-COT61OVh.js";import{_ as Q,a as Y,b as Z,c as ee,d as H}from"./SelectValue.vue_vue_type_script_setup_true_lang-BprGPrBF.js";import{_ as L}from"./InputError.vue_vue_type_script_setup_true_lang-CNUeJVyD.js";import{_ as te}from"./index-CLTC7jgA.js";import{_ as me,a as fe}from"./index-BtkA9hwY.js";import{U as ae}from"./upload-BnA2BMfa.js";import{C as ve}from"./circle-alert-D8AOEgas.js";import{P as ge}from"./paperclip-DLkma_DP.js";import{X as se}from"./x-DlprnXja.js";import{L as le}from"./loader-circle-BEfkCpVq.js";const pe={class:"space-y-4"},xe={key:0,class:"space-y-2"},be={class:"space-y-2"},he={class:"flex items-center gap-3 flex-1 min-w-0"},ye={class:"min-w-0 flex-1"},_e={class:"text-sm font-medium truncate"},ke={key:0,class:"text-xs text-muted-foreground"},$e=["multiple","accept","disabled"],Fe={class:"text-sm font-medium mb-1"},we={class:"text-xs text-muted-foreground"},Ce={class:"text-xs text-muted-foreground mt-1"},Be={key:0},ze={key:1,class:"space-y-2"},Se={class:"space-y-2"},Ve={class:"flex items-center gap-3 flex-1 min-w-0"},Me={class:"min-w-0 flex-1"},Ee={class:"text-sm font-medium truncate"},Ae={class:"text-xs text-muted-foreground"},De={key:3,class:"text-xs text-muted-foreground"},Ie={key:0,class:"text-destructive"},Pe=ie({__name:"FileAttachmentManager",props:{existingFiles:{default:()=>[]},label:{},description:{},multiple:{type:Boolean,default:!0},maxFiles:{default:10},maxSizeMB:{default:5},accept:{default:".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png"},disabled:{type:Boolean,default:!1},error:{}},emits:["files-added","file-removed"],setup(e,{expose:O,emit:_}){const b=e,n=_,C=z(),h=z(!1),x=z([]),V=z(""),B=A(()=>b.existingFiles||[]),M=A(()=>B.value.length+x.value.length),R=A(()=>M.value<b.maxFiles),T=()=>{var i;!b.disabled&&R.value&&((i=C.value)==null||i.click())},I=i=>{const r=i.target;r.files&&(E(Array.from(r.files)),r.value="")},P=i=>{var d;if(i.preventDefault(),h.value=!1,b.disabled)return;const r=Array.from(((d=i.dataTransfer)==null?void 0:d.files)||[]);E(r)},E=i=>{V.value="";const r=b.maxFiles-M.value;if(i.length>r){V.value=`Solo puedes agregar ${r} archivo(s) más. Límite: ${b.maxFiles}`;return}const d=[],y=[];i.forEach(k=>{var K;const v=b.maxSizeMB*1024*1024;if(k.size>v){y.push(`${k.name}: excede ${b.maxSizeMB}MB`);return}const $=`.${(K=k.name.split(".").pop())==null?void 0:K.toLowerCase()}`;if(!b.accept.split(",").map(ne=>ne.trim().toLowerCase()).includes($)){y.push(`${k.name}: formato no permitido`);return}d.push(k)}),y.length>0&&(V.value=y.join(", ")),d.length>0&&(b.multiple?x.value.push(...d):x.value=[d[0]],n("files-added",x.value))},j=i=>{x.value.splice(i,1),n("files-added",x.value)},g=i=>{const r=B.value[i];r&&confirm("¿Estás seguro de eliminar este archivo?")&&n("file-removed",r.ruta)},a=i=>{if(!i)return"0 KB";const r=["B","KB","MB","GB"],d=Math.floor(Math.log(i)/Math.log(1024));return`${(i/Math.pow(1024,d)).toFixed(1)} ${r[d]}`},w=i=>{var r;return((r=i.split(".").pop())==null?void 0:r.toUpperCase())||"FILE"};return O({newFiles:x,clearNewFiles:()=>{x.value=[]}}),oe(()=>b.error,i=>{i||(V.value="")}),(i,r)=>(o(),m("div",pe,[B.value.length>0?(o(),m("div",xe,[s(t(S),{class:"text-sm font-medium"},{default:l(()=>[...r[2]||(r[2]=[f("Archivos actuales",-1)])]),_:1}),u("div",be,[(o(!0),m(U,null,N(B.value,(d,y)=>(o(),m("div",{key:`existing-${y}`,class:"flex items-center justify-between p-3 bg-muted rounded-lg border border-border hover:bg-accent/50 transition-colors"},[u("div",he,[s(t(ge),{class:"h-4 w-4 text-muted-foreground flex-shrink-0"}),u("div",ye,[u("p",_e,c(d.nombre_original),1),d.tamaño?(o(),m("p",ke,c(a(d.tamaño)),1)):p("",!0)]),s(t(te),{variant:"outline",class:"flex-shrink-0"},{default:l(()=>[f(c(w(d.nombre_original)),1)]),_:2},1024)]),s(t(q),{type:"button",variant:"ghost",size:"icon",class:"h-8 w-8 text-destructive hover:text-destructive hover:bg-destructive/10 flex-shrink-0",onClick:k=>g(y),disabled:e.disabled},{default:l(()=>[s(t(se),{class:"h-4 w-4"})]),_:1},8,["onClick","disabled"])]))),128))])])):p("",!0),u("div",null,[e.label?(o(),F(t(S),{key:0,class:"text-sm font-medium"},{default:l(()=>[f(c(e.label),1)]),_:1})):p("",!0),u("div",{onDrop:P,onDragover:r[0]||(r[0]=re(d=>h.value=!0,["prevent"])),onDragleave:r[1]||(r[1]=d=>h.value=!1),onClick:T,class:"relative mt-2"},[u("input",{ref_key:"fileInput",ref:C,type:"file",multiple:e.multiple,accept:e.accept,disabled:e.disabled,class:"hidden",onChange:I},null,40,$e),u("div",{class:D(["border-2 border-dashed rounded-lg p-6 text-center cursor-pointer transition-all",{"border-primary bg-primary/5 ring-2 ring-primary/20":h.value,"border-muted-foreground/25 hover:border-muted-foreground/50 hover:bg-muted/30":!h.value&&!e.disabled,"opacity-50 cursor-not-allowed":e.disabled,"border-destructive":e.error}])},[s(t(ae),{class:D(["h-10 w-10 mx-auto mb-3 transition-colors",h.value?"text-primary":"text-muted-foreground"])},null,8,["class"]),u("p",Fe,c(h.value?"Suelta los archivos aquí":"Haz clic o arrastra archivos aquí"),1),u("p",we,c(e.description||`Formatos: ${e.accept}`),1),u("p",Ce,[f(" Máximo "+c(e.maxSizeMB)+"MB por archivo ",1),e.multiple?(o(),m("span",Be," • Hasta "+c(e.maxFiles)+" archivos total",1)):p("",!0)])],2)],32)]),x.value.length>0?(o(),m("div",ze,[s(t(S),{class:"text-sm font-medium"},{default:l(()=>[...r[3]||(r[3]=[f("Archivos a subir",-1)])]),_:1}),u("div",Se,[(o(!0),m(U,null,N(x.value,(d,y)=>(o(),m("div",{key:`new-${y}`,class:"flex items-center justify-between p-3 bg-accent rounded-lg border border-primary/20"},[u("div",Ve,[s(t(ae),{class:"h-4 w-4 text-primary flex-shrink-0"}),u("div",Me,[u("p",Ee,c(d.name),1),u("p",Ae,c(a(d.size)),1)]),s(t(te),{variant:"secondary",class:"flex-shrink-0"},{default:l(()=>[f(c(w(d.name)),1)]),_:2},1024)]),s(t(q),{type:"button",variant:"ghost",size:"icon",class:"h-8 w-8 hover:bg-destructive/10 flex-shrink-0",onClick:k=>j(y),disabled:e.disabled},{default:l(()=>[s(t(se),{class:"h-4 w-4"})]),_:1},8,["onClick","disabled"])]))),128))])])):p("",!0),e.error?(o(),F(t(me),{key:2,variant:"destructive"},{default:l(()=>[s(t(ve),{class:"h-4 w-4"}),s(t(fe),null,{default:l(()=>[f(c(e.error),1)]),_:1})]),_:1})):p("",!0),!e.disabled&&(B.value.length>0||x.value.length>0)?(o(),m("div",De,[f(c(M.value)+" de "+c(e.maxFiles)+" archivos ",1),M.value>=e.maxFiles?(o(),m("span",Ie," (límite alcanzado)")):p("",!0)])):p("",!0)]))}}),je={key:0},Le={key:0,class:"text-muted-foreground ml-1"},Ue={key:1},Ne={key:0,class:"flex items-center gap-2 h-10 px-3 border rounded-md bg-muted/50"},qe={key:3,class:"text-xs text-muted-foreground mt-1"},Oe={class:"flex justify-end gap-2"},it=ie({__name:"ObligacionForm",props:{obligacion:{},contratoId:{},contratos:{default:()=>[]},parentId:{},posiblesPadres:{default:()=>[]},usuarios:{default:()=>[]},loading:{type:Boolean,default:!1},errors:{default:()=>({})}},emits:["submit","cancel"],setup(e,{emit:O}){var I,P,E,j;const _=e,b=O,n=z({contrato_id:_.contratoId||((I=_.obligacion)==null?void 0:I.contrato_id)||0,parent_id:_.parentId||((P=_.obligacion)==null?void 0:P.parent_id)||null,titulo:((E=_.obligacion)==null?void 0:E.titulo)||"",descripcion:((j=_.obligacion)==null?void 0:j.descripcion)||"",archivos:[],archivos_eliminar:[]}),C=z([]),h=z(!1),x=A(()=>_.contratoId?_.posiblesPadres||[]:C.value),V=async g=>{if(!g){C.value=[];return}h.value=!0;try{const a=await de.get("/admin/obligaciones/posibles-padres",{params:{contrato_id:g}});a.data.success&&(C.value=a.data.posiblesPadres)}catch(a){console.error("Error cargando posibles padres:",a),C.value=[]}finally{h.value=!1}};oe(()=>n.value.contrato_id,g=>{!_.contratoId&&g&&(n.value.parent_id=null,V(g))});const B=A(()=>{var a;return(((a=_.obligacion)==null?void 0:a.archivos_adjuntos)||[]).filter(w=>{var i;return!((i=n.value.archivos_eliminar)!=null&&i.includes(w.ruta))})}),M=()=>{const g={...n.value};b("submit",g)},R=g=>{n.value.archivos=g},T=g=>{n.value.archivos_eliminar=n.value.archivos_eliminar||[],n.value.archivos_eliminar.includes(g)||n.value.archivos_eliminar.push(g)};return(g,a)=>(o(),m("form",{onSubmit:re(M,["prevent"]),class:"space-y-4"},[s(t(J),null,{default:l(()=>[s(t(G),null,{default:l(()=>[s(t(W),null,{default:l(()=>[...a[5]||(a[5]=[f("Información Básica",-1)])]),_:1})]),_:1}),s(t(X),{class:"space-y-4"},{default:l(()=>{var w,i,r,d,y,k;return[!e.contratoId&&e.contratos&&e.contratos.length>0?(o(),m("div",je,[s(t(S),{for:"contrato_id",required:""},{default:l(()=>[...a[6]||(a[6]=[f("Contrato",-1)])]),_:1}),s(t(Q),{modelValue:n.value.contrato_id,"onUpdate:modelValue":a[0]||(a[0]=v=>n.value.contrato_id=v)},{default:l(()=>{var v;return[s(t(Y),{id:"contrato_id",class:D({"border-red-500":(v=e.errors)==null?void 0:v.contrato_id})},{default:l(()=>[s(t(Z),{placeholder:"Seleccionar contrato"})]),_:1},8,["class"]),s(t(ee),null,{default:l(()=>[(o(!0),m(U,null,N(e.contratos,$=>(o(),F(t(H),{key:$.id,value:$.id},{default:l(()=>[f(c($.nombre)+" ",1),$.proyecto?(o(),m("span",Le," ("+c($.proyecto.nombre)+") ",1)):p("",!0)]),_:2},1032,["value"]))),128))]),_:1})]}),_:1},8,["modelValue"]),(w=e.errors)!=null&&w.contrato_id?(o(),F(L,{key:0,message:e.errors.contrato_id[0]},null,8,["message"])):p("",!0),a[7]||(a[7]=u("p",{class:"text-xs text-muted-foreground mt-1"}," Selecciona el contrato al que pertenecerá esta obligación ",-1))])):p("",!0),u("div",null,[s(t(S),{for:"titulo",required:""},{default:l(()=>[...a[8]||(a[8]=[f("Título",-1)])]),_:1}),s(t(ue),{id:"titulo",modelValue:n.value.titulo,"onUpdate:modelValue":a[1]||(a[1]=v=>n.value.titulo=v),type:"text",placeholder:"Título de la obligación",class:D({"border-red-500":(i=e.errors)==null?void 0:i.titulo})},null,8,["modelValue","class"]),(r=e.errors)!=null&&r.titulo?(o(),F(L,{key:0,message:e.errors.titulo[0]},null,8,["message"])):p("",!0)]),u("div",null,[s(t(S),{for:"descripcion"},{default:l(()=>[...a[9]||(a[9]=[f("Descripción",-1)])]),_:1}),s(t(ce),{id:"descripcion",modelValue:n.value.descripcion,"onUpdate:modelValue":a[2]||(a[2]=v=>n.value.descripcion=v),placeholder:"Descripción detallada de la obligación",rows:3,class:D({"border-red-500":(d=e.errors)==null?void 0:d.descripcion})},null,8,["modelValue","class"]),(y=e.errors)!=null&&y.descripcion?(o(),F(L,{key:0,message:e.errors.descripcion[0]},null,8,["message"])):p("",!0)]),e.contratoId||n.value.contrato_id?(o(),m("div",Ue,[s(t(S),{for:"parent_id"},{default:l(()=>[...a[10]||(a[10]=[f("Obligación Padre",-1)])]),_:1}),h.value?(o(),m("div",Ne,[s(t(le),{class:"h-4 w-4 animate-spin"}),a[11]||(a[11]=u("span",{class:"text-sm text-muted-foreground"},"Cargando obligaciones...",-1))])):(o(),F(t(Q),{key:1,modelValue:n.value.parent_id,"onUpdate:modelValue":a[3]||(a[3]=v=>n.value.parent_id=v),disabled:h.value},{default:l(()=>[s(t(Y),{id:"parent_id"},{default:l(()=>[s(t(Z),{placeholder:"Seleccionar obligación padre (opcional)"})]),_:1}),s(t(ee),null,{default:l(()=>[s(t(H),{value:null},{default:l(()=>[...a[12]||(a[12]=[f("Sin padre (raíz)",-1)])]),_:1}),(o(!0),m(U,null,N(x.value,v=>{var $;return o(),F(t(H),{key:v.id,value:v.id,disabled:v.id===(($=e.obligacion)==null?void 0:$.id)},{default:l(()=>[f(c("  ".repeat(v.nivel))+c(v.titulo),1)]),_:2},1032,["value","disabled"])}),128))]),_:1})]),_:1},8,["modelValue","disabled"])),(k=e.errors)!=null&&k.parent_id?(o(),F(L,{key:2,message:e.errors.parent_id[0]},null,8,["message"])):p("",!0),!h.value&&x.value.length===0?(o(),m("p",qe," Este contrato no tiene obligaciones existentes. La nueva obligación será raíz. ")):p("",!0)])):p("",!0)]}),_:1})]),_:1}),s(t(J),null,{default:l(()=>[s(t(G),null,{default:l(()=>[s(t(W),null,{default:l(()=>[...a[13]||(a[13]=[f("Archivos Adjuntos",-1)])]),_:1})]),_:1}),s(t(X),null,{default:l(()=>[s(Pe,{"existing-files":B.value,description:"Formatos: PDF, Word, Excel, Imágenes",multiple:!0,"max-files":20,"max-size-m-b":5,accept:".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png",onFilesAdded:R,onFileRemoved:T},null,8,["existing-files"])]),_:1})]),_:1}),u("div",Oe,[s(t(q),{type:"button",variant:"outline",onClick:a[4]||(a[4]=w=>g.$emit("cancel")),disabled:e.loading},{default:l(()=>[...a[14]||(a[14]=[f(" Cancelar ",-1)])]),_:1},8,["disabled"]),s(t(q),{type:"submit",disabled:e.loading||!n.value.titulo||!n.value.contrato_id},{default:l(()=>[e.loading?(o(),F(t(le),{key:0,class:"h-4 w-4 mr-2 animate-spin"})):p("",!0),f(" "+c(e.obligacion?"Actualizar":"Crear")+" Obligación ",1)]),_:1},8,["disabled"])])],32))}});export{it as _};
