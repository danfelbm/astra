import{d as xe,C as ye,r as h,c as F,m as we,o as ke,y as Se,i as u,e as n,f as s,u as e,p as $e,w as l,g as r,b,W as Ce,h as p,j as g,t as v,F as S,k as O,q as X,a2 as Ee,I as je}from"./app-CbA_dzrH.js";import{_ as Ve}from"./UserLayout.vue_vue_type_script_setup_true_lang-C0kuRXSj.js";import{_ as Ae,a as Fe,b as Te,c as Ne}from"./CardTitle.vue_vue_type_script_setup_true_lang-Dpl1EP6e.js";import{_ as Y}from"./CardDescription.vue_vue_type_script_setup_true_lang-FdnBhRW4.js";import{_ as x}from"./createLucideIcon-0y3HvBb2.js";import{_ as E}from"./Label.vue_vue_type_script_setup_true_lang-BHOcaT7W.js";import{_ as De}from"./Textarea.vue_vue_type_script_setup_true_lang-DNuak2_2.js";import{_ as Oe,a as ze,b as Be,c as Ie,d as Me}from"./SelectValue.vue_vue_type_script_setup_true_lang-C7VbuHoF.js";import{_ as Pe}from"./Checkbox.vue_vue_type_script_setup_true_lang-mf8fWrST.js";import{_ as Ue}from"./Progress.vue_vue_type_script_setup_true_lang-D8y6e2Bc.js";import{_ as Ge}from"./index-MuREUf8q.js";import{u as We,_ as Le}from"./FileUploadField.vue_vue_type_script_setup_true_lang-BS4pHahu.js";import{u as qe}from"./useAutoSave-BhCs4tUl.js";import{t as _}from"./index-CXCj42Z3.js";import{F as P}from"./file-text-DINmkRZl.js";import{M as U}from"./music-B9Y123UW.js";import{V as G}from"./video-DOuG9gQV.js";import{I as W}from"./image-DImE3ow8.js";import{A as Re}from"./arrow-left-DWk22nOp.js";import{C as Z}from"./clock-Bx6DQ-_s.js";import{C as ee}from"./circle-check-big-CTzKScww.js";import{C as He}from"./circle-alert-CfNQ3Vlu.js";import{C as Ke}from"./camera-COQ6A8Gl.js";import{P as Je}from"./panel-left-ivBXt___.js";import{S as Qe}from"./save-CybCtRtH.js";import{_ as Xe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./UpdateLocationModal.vue_vue_type_script_setup_true_lang-C4x6rJ8B.js";import"./index-D-PGeZ3t.js";import"./floating-ui.vue-D3EH1Xba.js";import"./x-CxSWfWOJ.js";import"./Input.vue_vue_type_script_setup_true_lang-Dw2oMjuZ.js";import"./index-DzUkqZxm.js";import"./index-BGfSt6nP.js";import"./shield-yBic2gp-.js";import"./user-BnDczykq.js";import"./DropdownMenuTrigger.vue_vue_type_script_setup_true_lang-H44qAxpr.js";import"./chevron-right-pq_ChJ0s.js";import"./DialogTitle.vue_vue_type_script_setup_true_lang-H8FdC1v8.js";import"./VisuallyHidden-BOU54Fpc.js";import"./GeographicSelector.vue_vue_type_script_setup_true_lang-fWHHAQt9.js";import"./map-pin-B0r5dLQM.js";import"./AppLogo.vue_vue_type_script_setup_true_lang-BZUuILpY.js";import"./square-check-big-CDgrQbfI.js";import"./users-DLZP89St.js";import"./folder-open-B03CPFE8.js";import"./index-DPtKDKxs.js";import"./check-8t2yOxAa.js";import"./nullish-CHIgUVhi.js";import"./upload-D1gsNalI.js";import"./file-Dr1J4OKH.js";import"./eye-CuQC-PD5.js";import"./download-B_RhEBu7.js";import"./debounce-BMmXVQ06.js";const Ye={class:"flex h-full flex-1 flex-col gap-4 rounded-xl p-4 pb-24"},Ze={class:"flex items-center justify-between"},eo={class:"flex items-center justify-end gap-2 text-sm text-muted-foreground"},oo={key:0,class:"flex items-center gap-1.5"},to={key:1,class:"flex items-center gap-1.5"},ao={key:2,class:"flex items-center gap-1.5 text-amber-600"},io={class:"space-y-2"},so={key:0,class:"text-sm text-destructive"},ro={class:"space-y-2"},no={class:"grid grid-cols-2 md:grid-cols-4 gap-4"},lo={key:0,class:"text-sm text-destructive"},co={key:0,class:"space-y-2"},uo={key:0,class:"mb-4 p-4 border rounded-lg bg-muted/50"},mo={class:"flex items-center justify-between mb-2"},po={class:"grid grid-cols-2 md:grid-cols-4 gap-2"},vo={class:"text-xs"},fo={key:1,class:"space-y-4"},_o={class:"flex gap-2"},ho=["srcObject"],go={class:"space-y-2"},bo={class:"space-y-2 max-h-60 overflow-y-auto border rounded-lg p-4"},xo={class:"flex-1"},yo={class:"text-muted-foreground text-xs block"},wo={class:"space-y-2"},ko={key:0,class:"text-sm text-destructive"},So={class:"fixed bottom-0 left-0 right-0 z-50 px-2 sm:px-4 pb-2 sm:pb-4"},$o={class:"mx-auto max-w-7xl"},Co={class:"backdrop-blur-lg bg-tertiary-60 dark:bg-gray-900/80 border border-gray-200/50 dark:border-gray-700/50 rounded-xl sm:rounded-2xl shadow-2xl p-3 sm:p-4"},Eo={class:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4"},jo={class:"hidden sm:flex items-center"},Vo={class:"flex-1 sm:max-w-xs lg:max-w-sm mx-0 sm:mx-4"},Ao={class:"flex items-center gap-3"},Fo={class:"text-xs sm:text-sm text-muted-foreground whitespace-nowrap font-medium"},To={class:"flex items-center gap-2 sm:gap-3"},No=xe({__name:"Create",props:{contrato:{},obligaciones:{},entregables:{},tiposEvidencia:{}},setup(oe){const j=oe,te=[{title:"Dashboard",href:"/miembro/dashboard"},{title:"Mis Contratos",href:"/miembro/mis-contratos"},{title:j.contrato.nombre,href:`/miembro/mis-contratos/${j.contrato.id}`},{title:"Subir Evidencia",href:"#"}],{uploadFiles:L}=We(),t=ye({obligacion_id:null,tipo_evidencia:null,archivo_path:null,archivo_nombre:null,archivos_paths:[],archivos_nombres:[],tipos_archivos:null,descripcion:null,entregable_ids:[],metadata:null}),T=h([]),$=h({imagen:{paths:[],nombres:[],count:0},video:{paths:[],nombres:[],count:0},audio:{paths:[],nombres:[],count:0},documento:{paths:[],nombres:[],count:0}}),ae=h(null),y=h(!1),C=h(null),V=h(null),w=h(null),A=h(null),ie=h(null),se=F(()=>t.data()),{state:re,isSaving:z,hasSaved:ne,hasError:q,saveNow:le,startWatching:R,stopAutoSave:H,restoreDraft:de,clearLocalStorage:ce}=qe(se,{url:`/miembro/mis-contratos/${j.contrato.id}/evidencias/autosave`,debounceTime:3e3,showNotifications:!0,useLocalStorage:!0,localStorageKey:`evidencia_draft_contrato_${j.contrato.id}`}),ue=F(()=>{const a={imagen:{icon:W,accept:"image/*",capture:"environment",maxSize:10485760},video:{icon:G,accept:"video/*",capture:"environment",maxSize:524288e3},audio:{icon:U,accept:"audio/*",capture:!1,maxSize:52428800},documento:{icon:P,accept:".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.rtf",capture:!1,maxSize:20971520}};return t.tipo_evidencia?a[t.tipo_evidencia]:null}),B=F(()=>{const o=[t.obligacion_id,t.tipo_evidencia,t.archivo_path,t.descripcion,t.entregable_ids.length>0].filter(Boolean).length,c=Math.round(o/5*100);return{llenos:o,total:5,porcentaje:c}});we(()=>t.tipo_evidencia,a=>{a&&(ae.value=a,y.value&&N())});const me=a=>{const o=a.type;return o.startsWith("image/")?"imagen":o.startsWith("video/")?"video":o.startsWith("audio/")?"audio":"documento"},K=()=>{const a=[],o=[],c={};if(Object.entries($.value).forEach(([m,i])=>{i.paths.forEach((d,f)=>{a.push(d),o.push(i.nombres[f]),c[d]=m})}),t.archivos_paths=a,t.archivos_nombres=o,t.tipos_archivos=c,a.length>0&&!t.archivo_path&&(t.archivo_path=a[0],t.archivo_nombre=o[0]),T.value=a,Object.keys(c).length>0){const m=Object.values(c).reduce((d,f)=>(d[f]=(d[f]||0)+1,d),{}),i=Object.entries(m).reduce((d,f)=>d[1]>f[1]?d:f)[0];t.tipo_evidencia=i}},k=F(()=>Object.values($.value).reduce((a,o)=>a+o.count,0)),J=F(()=>t.obligacion_id&&t.tipo_evidencia&&(k.value>0||ie.value||A.value)),pe=async()=>{if(!t.tipo_evidencia||t.tipo_evidencia==="documento"){_.error("No se puede capturar este tipo de evidencia");return}try{y.value=!0;const a={video:t.tipo_evidencia==="imagen"||t.tipo_evidencia==="video",audio:t.tipo_evidencia==="audio"||t.tipo_evidencia==="video"};if(C.value=await navigator.mediaDevices.getUserMedia(a),t.tipo_evidencia==="audio"||t.tipo_evidencia==="video"){w.value=new MediaRecorder(C.value);const o=[];w.value.ondataavailable=c=>{o.push(c.data)},w.value.onstop=()=>{const c=new Blob(o,{type:t.tipo_evidencia==="audio"?"audio/webm":"video/webm"});A.value=c,Q(c)},w.value.start(),_.info("Grabación iniciada")}}catch(a){console.error("Error al iniciar captura:",a),_.error("No se pudo acceder a la cámara/micrófono"),y.value=!1}},N=()=>{C.value&&(C.value.getTracks().forEach(a=>a.stop()),C.value=null),w.value&&w.value.state==="recording"&&w.value.stop(),y.value=!1},ve=()=>{if(!V.value)return;const a=document.createElement("canvas");a.width=V.value.videoWidth,a.height=V.value.videoHeight;const o=a.getContext("2d");o&&(o.drawImage(V.value,0,0),a.toBlob(c=>{c&&(A.value=c,Q(c),N())},"image/jpeg",.95))},Q=async a=>{const o=`captura_${Date.now()}.${fe(a.type)}`,c=new File([a],o,{type:a.type});A.value=a,t.archivo_nombre=o,t.metadata={mime_type:a.type,size:a.size,captured_at:new Date().toISOString()};try{_.info("Subiendo archivo capturado...");const m=await L([c],{module:"evidencias",fieldId:t.tipo_evidencia||"archivo",onProgress:(i,d)=>{}});m.length>0&&(t.archivo_path=m[0].path,t.archivo_nombre=m[0].name,t.metadata=m[0].metadata,T.value=[m[0].path],A.value=null,_.success("Archivo subido exitosamente"))}catch(m){console.error("Error al subir archivo capturado:",m),_.error("Error al subir el archivo capturado")}},fe=a=>({"image/jpeg":"jpg","image/png":"png","image/webp":"webp","video/webm":"webm","audio/webm":"webm"})[a]||"bin",_e=async a=>{if(a.length>0){const o=k.value,c=a.length;if(o+c>10){_.error(`No puedes subir más de 10 archivos. Actualmente tienes ${o} archivo(s).`);return}const m={imagen:[],video:[],audio:[],documento:[]};a.forEach(i=>{const d=me(i);m[d].push(i)});try{let i=0;for(const[d,f]of Object.entries(m)){if(f.length===0)continue;_.info(`Subiendo ${f.length} archivo(s) de tipo ${d}...`);const I=await L(f,{module:"evidencias",fieldId:d,onProgress:(D,M)=>{}});if(I.length>0){const D=d;I.forEach(M=>{$.value[D].paths.push(M.path),$.value[D].nombres.push(M.name),$.value[D].count++}),i+=I.length}}i>0&&(K(),_.success(`${i} archivo(s) subido(s) exitosamente. Total: ${k.value}/10`))}catch(i){console.error("Error al subir archivos:",i),_.error("Error al subir archivos")}}},he=async()=>{await le(),_.success("Borrador guardado")},ge=async()=>{if(J.value){if(k.value===0&&!t.archivo_path){_.error("Por favor seleccione o capture al menos un archivo");return}K(),H(),t.post(`/miembro/mis-contratos/${j.contrato.id}/evidencias`,{onSuccess:()=>{ce(),_.success(`Evidencia subida exitosamente con ${t.archivos_paths.length} archivo(s)`)},onError:a=>{console.error("Errores de validación:",a),R()}})}},be=()=>{const a=document.querySelector('[data-sidebar="trigger"]');a&&a.click()};return ke(()=>{const a=de();a&&a.data&&Object.assign(t,a.data),R()}),Se(()=>{H(),N()}),(a,o)=>(n(),u(S,null,[s(e($e),{title:`Subir Evidencia - ${a.contrato.nombre}`},null,8,["title"]),s(Ve,{breadcrumbs:te},{default:l(()=>{var c;return[r("div",Ye,[r("div",Ze,[o[5]||(o[5]=r("div",null,[r("h1",{class:"text-3xl font-bold"},"Subir Evidencia"),r("p",{class:"text-muted-foreground"}," Adjunta las evidencias del cumplimiento de las obligaciones del contrato ")],-1)),s(e(x),{variant:"outline",onClick:o[0]||(o[0]=m=>e(Ce).visit(`/miembro/mis-contratos/${a.contrato.id}`))},{default:l(()=>[s(e(Re),{class:"mr-2 h-4 w-4"}),o[4]||(o[4]=p(" Volver ",-1))]),_:1})]),r("div",eo,[e(z)?(n(),u("div",oo,[s(e(Z),{class:"h-4 w-4 animate-spin"}),o[6]||(o[6]=r("span",null,"Guardando automáticamente...",-1))])):e(ne)&&!e(q)?(n(),u("div",to,[s(e(ee),{class:"h-4 w-4 text-green-600"}),r("span",null,"Guardado a las "+v((c=e(re).lastSaved)==null?void 0:c.toLocaleTimeString()),1)])):e(q)?(n(),u("div",ao,[s(e(He),{class:"h-4 w-4"}),o[7]||(o[7]=r("span",null,"Guardado localmente",-1))])):g("",!0)]),s(e(Ae),null,{default:l(()=>[s(e(Fe),null,{default:l(()=>[s(e(Te),null,{default:l(()=>[...o[8]||(o[8]=[p("Información de la Evidencia",-1)])]),_:1}),s(e(Y),null,{default:l(()=>[...o[9]||(o[9]=[p(" Selecciona la obligación, el tipo de evidencia y adjunta el archivo correspondiente ",-1)])]),_:1})]),_:1}),s(e(Ne),{class:"space-y-6"},{default:l(()=>{var m;return[r("div",io,[s(e(E),{htmlFor:"obligacion"},{default:l(()=>[...o[10]||(o[10]=[p("Obligación *",-1)])]),_:1}),s(e(Oe),{modelValue:e(t).obligacion_id,"onUpdate:modelValue":o[1]||(o[1]=i=>e(t).obligacion_id=i)},{default:l(()=>[s(e(ze),null,{default:l(()=>[s(e(Be),{placeholder:"Selecciona una obligación"})]),_:1}),s(e(Ie),null,{default:l(()=>[(n(!0),u(S,null,O(a.obligaciones,i=>(n(),b(e(Me),{key:i.id,value:i.id},{default:l(()=>[p(v(i.titulo),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"]),e(t).errors.obligacion_id?(n(),u("p",so,v(e(t).errors.obligacion_id),1)):g("",!0)]),r("div",ro,[s(e(E),null,{default:l(()=>[...o[11]||(o[11]=[p("Tipo de Evidencia *",-1)])]),_:1}),r("div",no,[(n(!0),u(S,null,O(a.tiposEvidencia,i=>(n(),b(e(x),{key:i.value,onClick:d=>e(t).tipo_evidencia=i.value,variant:e(t).tipo_evidencia===i.value?"default":"outline",class:"h-20 flex flex-col gap-2"},{default:l(()=>[(n(),b(X(i.value==="imagen"?e(W):i.value==="video"?e(G):i.value==="audio"?e(U):e(P)),{class:"h-6 w-6"})),r("span",null,v(i.label),1)]),_:2},1032,["onClick","variant"]))),128))]),e(t).errors.tipo_evidencia?(n(),u("p",lo,v(e(t).errors.tipo_evidencia),1)):g("",!0)]),e(t).tipo_evidencia?(n(),u("div",co,[s(e(E),null,{default:l(()=>[...o[12]||(o[12]=[p("Archivo de Evidencia *",-1)])]),_:1}),k.value>0?(n(),u("div",uo,[r("div",mo,[o[13]||(o[13]=r("span",{class:"text-sm font-medium"},"Archivos subidos",-1)),s(e(Ge),{variant:"outline"},{default:l(()=>[p(v(k.value)+"/10",1)]),_:1})]),r("div",po,[(n(!0),u(S,null,O($.value,(i,d)=>(n(),u("div",{key:d,class:"flex items-center gap-2"},[(n(),b(X(d==="imagen"?e(W):d==="video"?e(G):d==="audio"?e(U):e(P)),{class:"h-4 w-4 text-muted-foreground"})),r("span",vo,v(i.count)+" "+v(d),1)]))),128))])])):g("",!0),e(t).tipo_evidencia!=="documento"?(n(),u("div",fo,[r("div",_o,[y.value?(n(),b(e(x),{key:1,onClick:N,variant:"destructive",class:"flex-1"},{default:l(()=>[...o[14]||(o[14]=[p(" Detener ",-1)])]),_:1})):(n(),b(e(x),{key:0,onClick:pe,variant:"outline",class:"flex-1"},{default:l(()=>[s(e(Ke),{class:"mr-2 h-4 w-4"}),p(" "+v(e(t).tipo_evidencia==="audio"?"Grabar Audio":"Capturar"),1)]),_:1}))]),y.value&&(e(t).tipo_evidencia==="imagen"||e(t).tipo_evidencia==="video")?(n(),u("video",{key:0,ref_key:"videoElement",ref:V,srcObject:C.value,autoplay:"",playsinline:"",muted:"",class:"w-full rounded-lg border"},null,8,ho)):g("",!0),y.value&&e(t).tipo_evidencia==="imagen"?(n(),b(e(x),{key:1,onClick:ve,class:"w-full"},{default:l(()=>[...o[15]||(o[15]=[p(" Tomar Foto ",-1)])]),_:1})):g("",!0)])):g("",!0),s(Le,{modelValue:T.value,"onUpdate:modelValue":o[2]||(o[2]=i=>T.value=i),onFilesSelected:_e,label:"",description:`Selecciona archivos desde tu dispositivo (${k.value}/10 archivos)`,required:!0,multiple:!0,"max-files":10,"max-file-size":(m=ue.value)==null?void 0:m.maxSize,accept:"image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx",error:e(t).errors.archivo_path||e(t).errors.archivos_paths,disabled:e(t).processing,module:"evidencias","field-id":e(t).tipo_evidencia||"archivo","auto-upload":!1},null,8,["modelValue","description","max-file-size","error","disabled","field-id"])])):g("",!0),r("div",go,[s(e(E),null,{default:l(()=>[...o[16]||(o[16]=[p("Entregables Relacionados",-1)])]),_:1}),s(e(Y),null,{default:l(()=>[...o[17]||(o[17]=[p(" Selecciona los entregables del proyecto que se relacionan con esta evidencia ",-1)])]),_:1}),r("div",bo,[(n(!0),u(S,null,O(a.entregables,i=>(n(),u("div",{key:i.id,class:"flex items-start space-x-3"},[s(e(Pe),{id:`entregable-${i.id}`,checked:e(t).entregable_ids.includes(i.id),"onUpdate:checked":d=>{d?e(t).entregable_ids.push(i.id):e(t).entregable_ids=e(t).entregable_ids.filter(f=>f!==i.id)}},null,8,["id","checked","onUpdate:checked"]),r("div",xo,[s(e(E),{for:`entregable-${i.id}`,class:"text-sm font-normal cursor-pointer"},{default:l(()=>[p(v(i.nombre)+" ",1),r("span",yo," Hito: "+v(i.hito)+" "+v(i.fecha_fin?` • Vence: ${i.fecha_fin}`:""),1)]),_:2},1032,["for"])])]))),128))])]),r("div",wo,[s(e(E),{htmlFor:"descripcion"},{default:l(()=>[...o[18]||(o[18]=[p("Descripción",-1)])]),_:1}),s(e(De),{id:"descripcion",modelValue:e(t).descripcion,"onUpdate:modelValue":o[3]||(o[3]=i=>e(t).descripcion=i),placeholder:"Describe brevemente la evidencia adjuntada",rows:"3"},null,8,["modelValue"]),e(t).errors.descripcion?(n(),u("p",ko,v(e(t).errors.descripcion),1)):g("",!0)])]}),_:1})]),_:1})]),(n(),b(Ee,{to:"body"},[s(je,{name:"slide-up"},{default:l(()=>[r("div",So,[r("div",$o,[r("div",Co,[r("div",Eo,[r("div",jo,[s(e(x),{variant:"outline",type:"button",onClick:be,class:"backdrop-blur-sm flex-shrink-0 text-xs sm:text-sm py-2 px-3"},{default:l(()=>[s(e(Je),{class:"h-4 w-4"}),o[19]||(o[19]=r("span",{class:"ml-2"},"Ocultar sidebar",-1))]),_:1})]),r("div",Vo,[r("div",Ao,[s(e(Ue),{modelValue:B.value.porcentaje,class:"flex-1"},null,8,["modelValue"]),r("span",Fo,v(B.value.llenos)+" / "+v(B.value.total),1)]),o[20]||(o[20]=r("p",{class:"text-xs text-muted-foreground mt-1 text-center hidden sm:block"}," Campos completados ",-1))]),r("div",To,[s(e(x),{onClick:he,disabled:e(z),variant:"outline",class:"backdrop-blur-sm flex-1 sm:flex-none text-xs sm:text-sm py-2 px-3"},{default:l(()=>[e(z)?(n(),u(S,{key:0},[s(e(Z),{class:"mr-2 h-4 w-4 animate-spin"}),o[21]||(o[21]=p(" Guardando... ",-1))],64)):(n(),u(S,{key:1},[s(e(Qe),{class:"mr-2 h-4 w-4"}),o[22]||(o[22]=p(" Guardar borrador ",-1))],64))]),_:1},8,["disabled"]),s(e(x),{onClick:ge,disabled:!J.value||e(t).processing,class:"bg-green-600 hover:bg-green-700 text-white border-green-600 hover:border-green-700 disabled:bg-gray-400 disabled:border-gray-400 flex-1 sm:flex-none text-xs sm:text-sm py-2 px-3"},{default:l(()=>[s(e(ee),{class:"h-4 w-4"}),o[23]||(o[23]=r("span",{class:"ml-2 whitespace-nowrap"},"Subir Evidencia",-1))]),_:1},8,["disabled"])])])])])])]),_:1})]))]}),_:1})],64))}}),Nt=Xe(No,[["__scopeId","data-v-0b1912a4"]]);export{Nt as default};
