import{d as xe,u as ye,r as h,c as D,p as we,o as Se,B as ke,i as m,e as s,f as e,q as Ce,w as c,g as r,b as x,j as b,m as n,t as f,h as v,F as $,k as G,x as Z,a7 as $e,R as Ee}from"./app-BFYzQdzF.js";import{_ as Ve}from"./UserLayout.vue_vue_type_script_setup_true_lang-Bctce-pp.js";import{_ as je,a as Te,b as Fe,c as Ae}from"./CardTitle.vue_vue_type_script_setup_true_lang-DkTLPy8Q.js";import{_ as De}from"./CardDescription.vue_vue_type_script_setup_true_lang-DxxQYMbB.js";import{_ as k}from"./createLucideIcon-D1qz7YzX.js";import{_ as N}from"./Label.vue_vue_type_script_setup_true_lang-YHimyCcI.js";import{_ as Be}from"./Textarea.vue_vue_type_script_setup_true_lang-CT-Mv7S9.js";import{_ as Ne,a as ze,b as Oe,c as Me,d as Ie}from"./SelectValue.vue_vue_type_script_setup_true_lang-Bswj50XS.js";import{_ as Ge}from"./Progress.vue_vue_type_script_setup_true_lang-DyYDbhnG.js";import{_ as Pe}from"./index-NXNNUHoi.js";import{_ as Ue}from"./FileUploadField.vue_vue_type_script_setup_true_lang-pwxzZGJJ.js";import{_ as Re}from"./EntregableSelector.vue_vue_type_script_setup_true_lang-BCCxmy-l.js";import{u as We}from"./useAutoSave-DWZfASXg.js";import{u as Le}from"./useFileUpload-Bx62FzCC.js";import{t as p}from"./index-Brf5gYP6.js";import{F as P}from"./file-text-B8pkgjB3.js";import{M as U}from"./music-DeNYBo2A.js";import{V as R}from"./video-DK2gEvRf.js";import{I as W}from"./image-CdRVq3ON.js";import{C as ee}from"./clock-XIFde4bj.js";import{C as oe}from"./circle-check-big-D2wfk5vW.js";import{C as qe}from"./circle-alert-BxQ7VEYd.js";import{C as Ke}from"./camera-CtaCt-bU.js";import{T as He}from"./trash-2-BBOxtUL-.js";import{S as Je}from"./save-D8xi3v3F.js";import{_ as Qe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./useFlashMessages-Bqd6MZ7B.js";import"./index-DqLCS5TH.js";import"./floating-ui.vue-CrMUkeOu.js";import"./x-Dn8AgytN.js";import"./Input.vue_vue_type_script_setup_true_lang-D5Ji8-ky.js";import"./index-ZmM9pUBM.js";import"./index-DhndXmqU.js";import"./shield-Bo_7RbfF.js";import"./user-DNZxFcAJ.js";import"./DropdownMenuTrigger.vue_vue_type_script_setup_true_lang-DtIzBGea.js";import"./chevron-right-BzirJsa6.js";import"./DialogTitle.vue_vue_type_script_setup_true_lang-Didh4AbK.js";import"./VisuallyHidden-DcMqFjSC.js";import"./GeographicSelector.vue_vue_type_script_setup_true_lang-BMsEWk9D.js";import"./map-pin-C6_Thhfh.js";import"./AppLogo.vue_vue_type_script_setup_true_lang-DaE5iqF4.js";import"./ellipsis-BguP8aVY.js";import"./usePermissions-Vjs1bgpL.js";import"./square-check-big-B5nxNmZv.js";import"./users-BxdpmkiW.js";import"./folder-open-D1SxOjH9.js";import"./milestone-CbzOygeq.js";import"./index-Dd__5Ccb.js";import"./check-sEpy5eM4.js";import"./upload-DBHycjP2.js";import"./file-DO039f5e.js";import"./eye-Zdh8_iN9.js";import"./download-CGD42P15.js";import"./Checkbox.vue_vue_type_script_setup_true_lang-Cjy3tk7K.js";import"./ScrollArea.vue_vue_type_script_setup_true_lang-BlhmkWwI.js";import"./search-D_2xzlAP.js";import"./rotate-ccw-C-98RQN2.js";import"./calendar-JpKtXe5P.js";import"./debounce-D8IWg6Mh.js";const Xe={class:"flex h-full flex-1 flex-col gap-4 rounded-xl p-0 sm:p-4 pb-24"},Ye={class:"flex items-center justify-end gap-2 text-sm text-muted-foreground"},Ze={key:0,class:"flex items-center gap-1.5"},eo={key:1,class:"flex items-center gap-1.5"},oo={key:2,class:"flex items-center gap-1.5 text-amber-600"},to={class:"space-y-2"},ao={key:0,class:"text-sm text-destructive"},io={class:"space-y-2"},so={class:"grid grid-cols-2 md:grid-cols-4 gap-4"},ro={key:0,class:"text-sm text-destructive"},no={key:0,class:"space-y-2"},lo={key:0,class:"mb-4 p-4 border rounded-lg bg-muted/50"},co={class:"flex items-center justify-between mb-2"},uo={class:"grid grid-cols-2 md:grid-cols-4 gap-2"},mo={class:"text-xs"},po={key:1,class:"space-y-4"},vo={class:"flex gap-2"},fo=["srcObject"],_o={class:"space-y-2"},ho={key:0,class:"text-sm text-destructive"},bo={class:"fixed bottom-0 left-0 right-0 z-50 px-2 sm:px-4 pb-2 sm:pb-4"},go={class:"mx-auto max-w-7xl"},xo={class:"backdrop-blur-lg bg-tertiary-60 dark:bg-gray-900/80 border border-gray-200/50 dark:border-gray-700/50 rounded-xl sm:rounded-2xl shadow-2xl p-3 sm:p-4"},yo={class:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4"},wo={class:"hidden sm:flex items-center"},So={class:"flex-1 sm:max-w-xs lg:max-w-sm mx-0 sm:mx-4"},ko={class:"flex items-center gap-3"},Co={class:"text-xs sm:text-sm text-muted-foreground whitespace-nowrap font-medium"},$o={class:"flex items-center gap-2 sm:gap-3"},Eo=xe({__name:"Create",props:{contrato:{},obligaciones:{},entregables:{},tiposEvidencia:{}},setup(E){const V=E,te=[{title:"Dashboard",href:"/miembro/dashboard"},{title:"Mis Contratos",href:"/miembro/mis-contratos"},{title:V.contrato.nombre,href:`/miembro/mis-contratos/${V.contrato.id}`},{title:"Subir Evidencia",href:"#"}],{uploadFiles:L}=Le(),o=ye({obligacion_id:null,tipo_evidencia:null,archivo_path:null,archivo_nombre:null,archivos_paths:[],archivos_nombres:[],tipos_archivos:null,descripcion:null,entregable_ids:[],metadata:null}),j=h([]),y=h({imagen:{paths:[],nombres:[],count:0},video:{paths:[],nombres:[],count:0},audio:{paths:[],nombres:[],count:0},documento:{paths:[],nombres:[],count:0}}),ae=h(null),g=h(!1),C=h(null),T=h(null),w=h(null),F=h(null),ie=h(null),se=D(()=>o.data()),{state:re,isSaving:z,hasSaved:ne,hasError:q,saveNow:le,startWatching:K,stopAutoSave:H,restoreDraft:ce,clearLocalStorage:J}=We(se,{url:`/miembro/mis-contratos/${V.contrato.id}/evidencias/autosave`,debounceTime:3e3,showNotifications:!0,useLocalStorage:!0,localStorageKey:`evidencia_draft_contrato_${V.contrato.id}`}),de=D(()=>{const a={imagen:{icon:W,accept:"image/*",capture:"environment",maxSize:10485760},video:{icon:R,accept:"video/*",capture:"environment",maxSize:524288e3},audio:{icon:U,accept:"audio/*",capture:!1,maxSize:52428800},documento:{icon:P,accept:".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.rtf",capture:!1,maxSize:20971520}};return o.tipo_evidencia?a[o.tipo_evidencia]:null}),O=D(()=>{const t=[o.obligacion_id,o.tipo_evidencia,o.archivo_path,o.descripcion,o.entregable_ids.length>0].filter(Boolean).length,d=Math.round(t/5*100);return{llenos:t,total:5,porcentaje:d}});we(()=>o.tipo_evidencia,a=>{a&&(ae.value=a,g.value&&A())});const ue=a=>{const t=a.type;return t.startsWith("image/")?"imagen":t.startsWith("video/")?"video":t.startsWith("audio/")?"audio":"documento"},Q=()=>{const a=[],t=[],d={};if(Object.entries(y.value).forEach(([u,i])=>{i.paths.forEach((l,_)=>{a.push(l),t.push(i.nombres[_]),d[l]=u})}),o.archivos_paths=a,o.archivos_nombres=t,o.tipos_archivos=d,a.length>0&&!o.archivo_path&&(o.archivo_path=a[0],o.archivo_nombre=t[0]),j.value=a,Object.keys(d).length>0){const u=Object.values(d).reduce((l,_)=>(l[_]=(l[_]||0)+1,l),{}),i=Object.entries(u).reduce((l,_)=>l[1]>_[1]?l:_)[0];o.tipo_evidencia=i}},S=D(()=>Object.values(y.value).reduce((a,t)=>a+t.count,0)),me=()=>{y.value={imagen:{paths:[],nombres:[],count:0},video:{paths:[],nombres:[],count:0},audio:{paths:[],nombres:[],count:0},documento:{paths:[],nombres:[],count:0}},o.archivos_paths=[],o.archivos_nombres=[],o.tipos_archivos=null,o.archivo_path=null,o.archivo_nombre=null,j.value=[],p.info("Todos los archivos han sido eliminados")},X=D(()=>o.obligacion_id&&o.tipo_evidencia&&(S.value>0||ie.value||F.value)),pe=async()=>{if(!o.tipo_evidencia||o.tipo_evidencia==="documento"){p.error("No se puede capturar este tipo de evidencia");return}try{g.value=!0;const a={video:o.tipo_evidencia==="imagen"||o.tipo_evidencia==="video",audio:o.tipo_evidencia==="audio"||o.tipo_evidencia==="video"};if(C.value=await navigator.mediaDevices.getUserMedia(a),o.tipo_evidencia==="audio"||o.tipo_evidencia==="video"){w.value=new MediaRecorder(C.value);const t=[];w.value.ondataavailable=d=>{t.push(d.data)},w.value.onstop=()=>{const d=new Blob(t,{type:o.tipo_evidencia==="audio"?"audio/webm":"video/webm"});F.value=d,Y(d)},w.value.start(),p.info("Grabación iniciada")}}catch(a){console.error("Error al iniciar captura:",a),p.error("No se pudo acceder a la cámara/micrófono"),g.value=!1}},A=()=>{C.value&&(C.value.getTracks().forEach(a=>a.stop()),C.value=null),w.value&&w.value.state==="recording"&&w.value.stop(),g.value=!1},ve=()=>{if(!T.value)return;const a=document.createElement("canvas");a.width=T.value.videoWidth,a.height=T.value.videoHeight;const t=a.getContext("2d");t&&(t.drawImage(T.value,0,0),a.toBlob(d=>{d&&(F.value=d,Y(d),A())},"image/jpeg",.95))},Y=async a=>{const t=`captura_${Date.now()}.${fe(a.type)}`,d=new File([a],t,{type:a.type});F.value=a,o.archivo_nombre=t,o.metadata={mime_type:a.type,size:a.size,captured_at:new Date().toISOString()};try{p.info("Subiendo archivo capturado...");const u=await L([d],{module:"evidencias",fieldId:o.tipo_evidencia||"archivo",onProgress:(i,l)=>{}});u.length>0&&(o.archivo_path=u[0].path,o.archivo_nombre=u[0].name,o.metadata=u[0].metadata,j.value=[u[0].path],F.value=null,p.success("Archivo subido exitosamente"))}catch(u){console.error("Error al subir archivo capturado:",u),p.error("Error al subir el archivo capturado")}},fe=a=>({"image/jpeg":"jpg","image/png":"png","image/webp":"webp","video/webm":"webm","audio/webm":"webm"})[a]||"bin",_e=async a=>{if(a.length>0){const t=S.value,d=a.length;if(t+d>10){p.error(`No puedes subir más de 10 archivos. Actualmente tienes ${t} archivo(s).`);return}const u={imagen:[],video:[],audio:[],documento:[]};a.forEach(i=>{const l=ue(i);u[l].push(i)});try{let i=0;for(const[l,_]of Object.entries(u)){if(_.length===0)continue;p.info(`Subiendo ${_.length} archivo(s) de tipo ${l}...`);const M=await L(_,{module:"evidencias",fieldId:l,onProgress:(B,I)=>{}});if(M.length>0){const B=l;M.forEach(I=>{y.value[B].paths.push(I.path),y.value[B].nombres.push(I.name),y.value[B].count++}),i+=M.length}}i>0&&(Q(),p.success(`${i} archivo(s) subido(s) exitosamente. Total: ${S.value}/10`))}catch(i){console.error("Error al subir archivos:",i),p.error("Error al subir archivos")}}},he=async()=>{await le(),p.success("Borrador guardado")},be=async()=>{if(X.value){if(S.value===0&&!o.archivo_path){p.error("Por favor seleccione o capture al menos un archivo");return}Q(),H(),o.post(`/miembro/mis-contratos/${V.contrato.id}/evidencias`,{onSuccess:()=>{J(),p.success(`Evidencia subida exitosamente con ${o.archivos_paths.length} archivo(s)`)},onError:a=>{console.error("Errores de validación:",a),K()}})}},ge=()=>{confirm("¿Estás seguro de descartar el borrador? Se perderán todos los cambios no enviados.")&&(J(),o.reset(),me(),g.value&&A(),p.success("Borrador descartado"))};return Se(()=>{const a=ce();a&&a.data&&Object.assign(o,a.data),K()}),ke(()=>{H(),A()}),(a,t)=>(n(),m($,null,[s(e(Ce),{title:`Subir Evidencia - ${E.contrato.nombre}`},null,8,["title"]),s(Ve,{breadcrumbs:te},{default:c(()=>{var d;return[r("div",Xe,[r("div",Ye,[e(z)?(n(),m("div",Ze,[s(e(ee),{class:"h-4 w-4 animate-spin"}),t[4]||(t[4]=r("span",null,"Guardando automáticamente...",-1))])):e(ne)&&!e(q)?(n(),m("div",eo,[s(e(oe),{class:"h-4 w-4 text-green-600"}),r("span",null,"Guardado a las "+f((d=e(re).lastSaved)==null?void 0:d.toLocaleTimeString()),1)])):e(q)?(n(),m("div",oo,[s(e(qe),{class:"h-4 w-4"}),t[5]||(t[5]=r("span",null,"Guardado localmente",-1))])):b("",!0)]),s(e(je),null,{default:c(()=>[s(e(Te),null,{default:c(()=>[s(e(Fe),null,{default:c(()=>[...t[6]||(t[6]=[v("Información de la Evidencia",-1)])]),_:1}),s(e(De),null,{default:c(()=>[...t[7]||(t[7]=[v(" Selecciona la obligación, el tipo de evidencia y adjunta el archivo correspondiente ",-1)])]),_:1})]),_:1}),s(e(Ae),{class:"space-y-6 sm:mb-16"},{default:c(()=>{var u;return[r("div",to,[s(e(N),{htmlFor:"obligacion"},{default:c(()=>[...t[8]||(t[8]=[v("Obligación *",-1)])]),_:1}),s(e(Ne),{modelValue:e(o).obligacion_id,"onUpdate:modelValue":t[0]||(t[0]=i=>e(o).obligacion_id=i)},{default:c(()=>[s(e(ze),null,{default:c(()=>[s(e(Oe),{placeholder:"Selecciona una obligación"})]),_:1}),s(e(Me),null,{default:c(()=>[(n(!0),m($,null,G(E.obligaciones,i=>(n(),x(e(Ie),{key:i.id,value:i.id},{default:c(()=>[v(f(i.titulo),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"]),e(o).errors.obligacion_id?(n(),m("p",ao,f(e(o).errors.obligacion_id),1)):b("",!0)]),r("div",io,[s(e(N),null,{default:c(()=>[...t[9]||(t[9]=[v("Tipo de Evidencia *",-1)])]),_:1}),r("div",so,[(n(!0),m($,null,G(E.tiposEvidencia,i=>(n(),x(e(k),{key:i.value,onClick:l=>e(o).tipo_evidencia=i.value,variant:e(o).tipo_evidencia===i.value?"default":"outline",class:"h-20 flex flex-col gap-2"},{default:c(()=>[(n(),x(Z(i.value==="imagen"?e(W):i.value==="video"?e(R):i.value==="audio"?e(U):e(P)),{class:"h-6 w-6"})),r("span",null,f(i.label),1)]),_:2},1032,["onClick","variant"]))),128))]),e(o).errors.tipo_evidencia?(n(),m("p",ro,f(e(o).errors.tipo_evidencia),1)):b("",!0)]),e(o).tipo_evidencia?(n(),m("div",no,[s(e(N),null,{default:c(()=>[...t[10]||(t[10]=[v("Archivo de Evidencia *",-1)])]),_:1}),S.value>0?(n(),m("div",lo,[r("div",co,[t[11]||(t[11]=r("span",{class:"text-sm font-medium"},"Archivos subidos",-1)),s(e(Pe),{variant:"outline"},{default:c(()=>[v(f(S.value)+"/10",1)]),_:1})]),r("div",uo,[(n(!0),m($,null,G(y.value,(i,l)=>(n(),m("div",{key:l,class:"flex items-center gap-2"},[(n(),x(Z(l==="imagen"?e(W):l==="video"?e(R):l==="audio"?e(U):e(P)),{class:"h-4 w-4 text-muted-foreground"})),r("span",mo,f(i.count)+" "+f(l),1)]))),128))])])):b("",!0),e(o).tipo_evidencia!=="documento"?(n(),m("div",po,[r("div",vo,[g.value?(n(),x(e(k),{key:1,onClick:A,variant:"destructive",class:"flex-1"},{default:c(()=>[...t[12]||(t[12]=[v(" Detener ",-1)])]),_:1})):(n(),x(e(k),{key:0,onClick:pe,variant:"outline",class:"flex-1"},{default:c(()=>[s(e(Ke),{class:"mr-2 h-4 w-4"}),v(" "+f(e(o).tipo_evidencia==="audio"?"Grabar Audio":"Capturar"),1)]),_:1}))]),g.value&&(e(o).tipo_evidencia==="imagen"||e(o).tipo_evidencia==="video")?(n(),m("video",{key:0,ref_key:"videoElement",ref:T,srcObject:C.value,autoplay:"",playsinline:"",muted:"",class:"w-full rounded-lg border"},null,8,fo)):b("",!0),g.value&&e(o).tipo_evidencia==="imagen"?(n(),x(e(k),{key:1,onClick:ve,class:"w-full"},{default:c(()=>[...t[13]||(t[13]=[v(" Tomar Foto ",-1)])]),_:1})):b("",!0)])):b("",!0),s(Ue,{modelValue:j.value,"onUpdate:modelValue":t[1]||(t[1]=i=>j.value=i),onFilesSelected:_e,label:"",description:`Selecciona archivos desde tu dispositivo (${S.value}/10 archivos)`,required:!0,multiple:!0,"max-files":10,"max-file-size":(u=de.value)==null?void 0:u.maxSize,accept:"image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx",error:e(o).errors.archivo_path||e(o).errors.archivos_paths,disabled:e(o).processing,module:"evidencias","field-id":e(o).tipo_evidencia||"archivo","auto-upload":!1},null,8,["modelValue","description","max-file-size","error","disabled","field-id"])])):b("",!0),s(Re,{modelValue:e(o).entregable_ids,"onUpdate:modelValue":t[2]||(t[2]=i=>e(o).entregable_ids=i),entregables:E.entregables,label:"Entregables Relacionados",description:"Selecciona los entregables del proyecto que se relacionan con esta evidencia",disabled:e(o).processing},null,8,["modelValue","entregables","disabled"]),r("div",_o,[s(e(N),{htmlFor:"descripcion"},{default:c(()=>[...t[14]||(t[14]=[v("Descripción",-1)])]),_:1}),s(e(Be),{id:"descripcion",modelValue:e(o).descripcion,"onUpdate:modelValue":t[3]||(t[3]=i=>e(o).descripcion=i),placeholder:"Describe brevemente la evidencia adjuntada",rows:"3"},null,8,["modelValue"]),e(o).errors.descripcion?(n(),m("p",ho,f(e(o).errors.descripcion),1)):b("",!0)])]}),_:1})]),_:1})]),(n(),x($e,{to:"body"},[s(Ee,{name:"slide-up"},{default:c(()=>[r("div",bo,[r("div",go,[r("div",xo,[r("div",yo,[r("div",wo,[s(e(k),{variant:"outline",type:"button",onClick:ge,class:"backdrop-blur-sm flex-shrink-0 text-xs sm:text-sm py-2 px-3 text-destructive hover:text-destructive"},{default:c(()=>[s(e(He),{class:"h-4 w-4"}),t[15]||(t[15]=r("span",{class:"ml-2"},"Descartar borrador",-1))]),_:1})]),r("div",So,[r("div",ko,[s(e(Ge),{modelValue:O.value.porcentaje,class:"flex-1"},null,8,["modelValue"]),r("span",Co,f(O.value.llenos)+" / "+f(O.value.total),1)]),t[16]||(t[16]=r("p",{class:"text-xs text-muted-foreground mt-1 text-center hidden sm:block"}," Campos completados ",-1))]),r("div",$o,[s(e(k),{onClick:he,disabled:e(z),variant:"outline",class:"backdrop-blur-sm flex-1 sm:flex-none text-xs sm:text-sm py-2 px-3"},{default:c(()=>[e(z)?(n(),m($,{key:0},[s(e(ee),{class:"mr-2 h-4 w-4 animate-spin"}),t[17]||(t[17]=v(" Guardando... ",-1))],64)):(n(),m($,{key:1},[s(e(Je),{class:"mr-2 h-4 w-4"}),t[18]||(t[18]=v(" Guardar borrador ",-1))],64))]),_:1},8,["disabled"]),s(e(k),{onClick:be,disabled:!X.value||e(o).processing,class:"bg-green-600 hover:bg-green-700 text-white border-green-600 hover:border-green-700 disabled:bg-gray-400 disabled:border-gray-400 flex-1 sm:flex-none text-xs sm:text-sm py-2 px-3"},{default:c(()=>[s(e(oe),{class:"h-4 w-4"}),t[19]||(t[19]=r("span",{class:"ml-2 whitespace-nowrap"},"Subir Evidencia",-1))]),_:1},8,["disabled"])])])])])])]),_:1})]))]}),_:1})],64))}}),Bt=Qe(Eo,[["__scopeId","data-v-db684b70"]]);export{Bt as default};
