import{d as K,r as O,c as L,i as p,y as ae,n as G,g as c,j as y,b as _,f as t,l as B,w as d,e as n,t as j,h as F,Z as oe,m as i,F as Z,k as q,T as se,ax as ne}from"./app-CmZXEU6r.js";import{_ as D}from"./createLucideIcon-CnNZrfzB.js";import{_ as le}from"./Separator.vue_vue_type_script_setup_true_lang-B2egUMH3.js";import{a as V,b as J,c as M}from"./AdminLayout.vue_vue_type_script_setup_true_lang-CZ8TAy5u.js";import{_ as ie}from"./TooltipProvider.vue_vue_type_script_setup_true_lang-B1GtNxv7.js";import{u as Q}from"./usePermissions-BStJ4z0r.js";import{C as U}from"./chevron-right-CYROSQyW.js";import{C as de}from"./circle-DPi4Trf6.js";import{L as re}from"./layers-C2wfQz9A.js";import{P as ce}from"./paperclip-Ba41mm4S.js";import{P as W}from"./plus-mYLokCEG.js";import{P as ue}from"./pencil-BNaFtfSu.js";import{T as ge}from"./trash-2-D-RhzEvF.js";import{_ as X}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{C as fe}from"./SelectValue.vue_vue_type_script_setup_true_lang-D5V10iEd.js";import{L as ve}from"./loader-circle-CXSDkxRs.js";const pe=["draggable"],he={class:"flex items-start gap-2"},me={key:1,class:"w-6"},be={class:"h-6 w-6 rounded-full flex items-center justify-center shrink-0 bg-gray-100"},ye={class:"flex-1 min-w-0"},xe={class:"flex items-start justify-between"},_e={class:"flex-1"},$e={class:"font-medium text-sm truncate"},De={key:0,class:"text-xs text-gray-600 mt-1 line-clamp-2"},ke={class:"flex items-center gap-3 mt-2 text-xs text-gray-500"},Ce={key:0,class:"flex items-center gap-1"},we={key:1,class:"flex items-center gap-1"},je={key:0,class:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity"},Ne={key:0,class:"mt-2"},Se=K({__name:"ObligacionItem",props:{obligacion:{},nivel:{default:0},expanded:{type:Boolean,default:!1},selected:{type:Boolean,default:!1},editable:{type:Boolean,default:!0},onToggle:{},onSelect:{},onEdit:{},onDelete:{},onComplete:{},onAddChild:{},onDragStart:{},onDragOver:{},onDrop:{}},emits:["toggle","select","edit","delete","add-child","drag-start","drag-over","drop"],setup(l,{emit:I}){const f=l,v=I,{hasPermission:$}=Q(),k=O(!1),r=L(()=>f.editable&&$("obligaciones.edit")),N=()=>{f.selected||v("select")},C=()=>{const u=f.obligacion.tiene_hijos?`¿Estás seguro de eliminar "${f.obligacion.titulo}" y todas sus obligaciones hijas?`:`¿Estás seguro de eliminar "${f.obligacion.titulo}"?`;confirm(u)&&v("delete")},x=u=>{r.value&&v("drag-start",f.obligacion,u)},m=u=>{r.value&&(u.preventDefault(),v("drag-over",u))},A=u=>{r.value&&(k.value=!1,v("drop",f.obligacion,u))},P=()=>{r.value&&(k.value=!0)},z=()=>{r.value&&(k.value=!1)};return(u,g)=>{var S,w;return i(),p("div",{class:G(["obligacion-item group",l.selected&&"bg-blue-50 border-blue-300",k.value&&"bg-gray-100 border-dashed","border rounded-lg p-2 mb-1 transition-all cursor-pointer hover:shadow-sm"]),style:ae({marginLeft:`${l.nivel*24}px`}),draggable:r.value&&l.editable,onClick:N,onDragstart:x,onDragover:m,onDrop:A,onDragenter:P,onDragleave:z},[c("div",he,[l.obligacion.tiene_hijos?(i(),_(t(D),{key:0,variant:"ghost",size:"icon",class:"h-6 w-6 shrink-0",onClick:g[0]||(g[0]=B(T=>u.$emit("toggle"),["stop"]))},{default:d(()=>[n(t(U),{class:G(["h-4 w-4 transition-transform",l.expanded&&"rotate-90"])},null,8,["class"])]),_:1})):(i(),p("div",me)),c("div",be,[n(t(de),{class:"h-3 w-3 text-gray-600"})]),c("div",ye,[c("div",xe,[c("div",_e,[c("h4",$e,j(l.obligacion.titulo),1),l.obligacion.descripcion?(i(),p("p",De,j(l.obligacion.descripcion),1)):y("",!0),c("div",ke,[l.obligacion.tiene_hijos?(i(),p("div",Ce,[n(t(re),{class:"h-3 w-3"}),c("span",null,j(l.obligacion.total_hijos)+" hijos",1)])):y("",!0),(S=l.obligacion.archivos_adjuntos)!=null&&S.length?(i(),p("div",we,[n(t(ce),{class:"h-3 w-3"}),c("span",null,j(l.obligacion.archivos_adjuntos.length),1)])):y("",!0)])]),l.editable?(i(),p("div",je,[n(t(ie),null,{default:d(()=>[n(t(V),null,{default:d(()=>[n(t(J),{asChild:""},{default:d(()=>[t($)("obligaciones.create")?(i(),_(t(D),{key:0,variant:"ghost",size:"icon",class:"h-7 w-7",onClick:g[1]||(g[1]=B(T=>u.$emit("add-child"),["stop"]))},{default:d(()=>[n(t(W),{class:"h-3 w-3"})]),_:1})):y("",!0)]),_:1}),n(t(M),null,{default:d(()=>[...g[3]||(g[3]=[F("Añadir hijo",-1)])]),_:1})]),_:1}),n(t(V),null,{default:d(()=>[n(t(J),{asChild:""},{default:d(()=>[t($)("obligaciones.edit")?(i(),_(t(D),{key:0,variant:"ghost",size:"icon",class:"h-7 w-7",onClick:g[2]||(g[2]=B(T=>u.$emit("edit"),["stop"]))},{default:d(()=>[n(t(ue),{class:"h-3 w-3"})]),_:1})):y("",!0)]),_:1}),n(t(M),null,{default:d(()=>[...g[4]||(g[4]=[F("Editar",-1)])]),_:1})]),_:1}),n(t(V),null,{default:d(()=>[n(t(J),{asChild:""},{default:d(()=>[t($)("obligaciones.delete")?(i(),_(t(D),{key:0,variant:"ghost",size:"icon",class:"h-7 w-7 text-red-600 hover:text-red-700",onClick:B(C,["stop"])},{default:d(()=>[n(t(ge),{class:"h-3 w-3"})]),_:1})):y("",!0)]),_:1}),n(t(M),null,{default:d(()=>[...g[5]||(g[5]=[F("Eliminar",-1)])]),_:1})]),_:1})]),_:1})])):y("",!0)])])]),l.expanded&&((w=l.obligacion.hijos)!=null&&w.length)?(i(),p("div",Ne,[oe(u.$slots,"children",{},void 0,!0)])):y("",!0)],46,pe)}}}),H=X(Se,[["__scopeId","data-v-43c5dc18"]]),Te={class:"obligacion-tree"},Ee={class:"flex items-center justify-between mb-4 p-2 bg-gray-50 rounded-lg"},Oe={class:"flex items-center gap-2"},Ae={class:"flex items-center gap-2"},Pe={class:"text-sm text-gray-600"},ze={key:0,class:"flex items-center justify-center py-8"},Be={key:1,class:"text-center py-8 text-gray-500"},Le={key:0,class:"mt-4 bg-gray-50 p-2 rounded text-center"},Fe={class:"text-2xl font-bold"},Ie=K({__name:"ObligacionTree",props:{obligaciones:{},contratoId:{},editable:{type:Boolean,default:!0},selectable:{type:Boolean,default:!0},expandedNodes:{default:()=>[]},selectedNode:{default:null},onSelect:{},onEdit:{},onDelete:{},onComplete:{},onAddChild:{},onMove:{},onReorder:{}},emits:["select","edit","delete","add-child","create","move","reorder","update:expandedNodes","update:selectedNode"],setup(l,{emit:I}){const f=l,v=I,{hasPermission:$}=Q(),k=O(!1),r=O(f.expandedNodes),N=O(f.selectedNode),C=O(null),x=L(()=>f.editable&&$("obligaciones.edit")),m=L(()=>{const e=[],a=o=>{o.forEach(h=>{var s;e.push(h),(s=h.hijos)!=null&&s.length&&a(h.hijos)})};return a(f.obligaciones),e}),A=L(()=>ee(f.obligaciones)),P=e=>{const a=r.value.indexOf(e);a>-1?r.value.splice(a,1):r.value.push(e),v("update:expandedNodes",r.value)},z=e=>{if(N.value=e,v("update:selectedNode",e),e){const a=m.value.find(o=>o.id===e);a&&v("select",a)}},u=()=>{r.value=m.value.filter(e=>e.tiene_hijos).map(e=>e.id),v("update:expandedNodes",r.value)},g=()=>{r.value=[],v("update:expandedNodes",r.value)},S=(e,a)=>{x.value&&(C.value={obligacionId:e.id,parentId:e.parent_id,orden:e.orden,nivel:e.nivel},a.dataTransfer.effectAllowed="move",a.dataTransfer.setData("application/json",JSON.stringify(C.value)))},w=e=>{x.value&&(e.preventDefault(),e.dataTransfer.dropEffect="move")},T=(e,a)=>{if(!x.value)return;a.preventDefault(),a.stopPropagation();const o=JSON.parse(a.dataTransfer.getData("application/json"));if(!(!o||o.obligacionId===e.id)){if(R(o.obligacionId,e.id)){console.error("No se puede mover una obligación dentro de sus propios hijos");return}v("move",m.value.find(h=>h.id===o.obligacionId),e.id,e.orden+1),C.value=null}},Y=e=>{if(!x.value)return;e.preventDefault(),e.stopPropagation();const a=JSON.parse(e.dataTransfer.getData("application/json"));a&&(v("move",m.value.find(o=>o.id===a.obligacionId),null,1),C.value=null)},ee=e=>{if(!e||e.length===0)return[];const a=new Map,o=[],h=new Set(e.map(s=>s.id));return e.forEach(s=>{a.set(s.id,{...s,hijos:s.hijos?[...s.hijos]:[]})}),e.forEach(s=>{const b=a.get(s.id);if(s.parent_id===null||!h.has(s.parent_id))o.push(b);else{const E=a.get(s.parent_id);E&&(E.hijos=E.hijos||[],E.hijos.some(te=>te.id===b.id)||E.hijos.push(b))}}),o.sort((s,b)=>s.orden-b.orden)},R=(e,a)=>{const o=m.value.find(h=>h.id===a);return o?o.parent_id===e?!0:o.parent_id===null?!1:R(e,o.parent_id):!1};return(e,a)=>(i(),p("div",Te,[c("div",Ee,[c("div",Oe,[n(t(D),{size:"sm",variant:"outline",onClick:u,title:"Expandir todo"},{default:d(()=>[n(t(fe),{class:"h-4 w-4"})]),_:1}),n(t(D),{size:"sm",variant:"outline",onClick:g,title:"Colapsar todo"},{default:d(()=>[n(t(U),{class:"h-4 w-4"})]),_:1}),n(t(le),{orientation:"vertical",class:"h-6"}),l.editable&&t($)("obligaciones.create")?(i(),_(t(D),{key:0,size:"sm",variant:"outline",onClick:a[0]||(a[0]=o=>e.$emit("create"))},{default:d(()=>[n(t(W),{class:"h-4 w-4 mr-1"}),a[1]||(a[1]=F(" Nueva Obligación ",-1))]),_:1})):y("",!0)]),c("div",Ae,[c("span",Pe,j(m.value.length)+" obligaciones ",1)])]),c("div",{class:"obligacion-tree-container border rounded-lg p-2 min-h-[200px]",onDragover:w,onDrop:Y},[k.value?(i(),p("div",ze,[n(t(ve),{class:"h-8 w-8 animate-spin text-gray-400"})])):A.value.length?(i(),_(se,{key:2,name:"list",tag:"div",class:"space-y-1"},{default:d(()=>[(i(!0),p(Z,null,q(A.value,o=>{var h;return i(),_(H,{key:o.id,obligacion:o,nivel:0,expanded:r.value.includes(o.id),selected:N.value===o.id,editable:l.editable,draggable:x.value,onToggle:s=>P(o.id),onSelect:s=>z(o.id),onEdit:s=>e.$emit("edit",o),onDelete:s=>e.$emit("delete",o),onAddChild:s=>e.$emit("add-child",o),onDragStart:S,onDragOver:w,onDrop:T},ne({_:2},[(h=o.hijos)!=null&&h.length?{name:"children",fn:d(()=>[(i(!0),p(Z,null,q(o.hijos,s=>(i(),_(H,{key:s.id,obligacion:s,nivel:1,expanded:r.value.includes(s.id),selected:N.value===s.id,editable:l.editable,draggable:x.value,onToggle:b=>P(s.id),onSelect:b=>z(s.id),onEdit:b=>e.$emit("edit",s),onDelete:b=>e.$emit("delete",s),onAddChild:b=>e.$emit("add-child",s),onDragStart:S,onDragOver:w,onDrop:T},null,8,["obligacion","expanded","selected","editable","draggable","onToggle","onSelect","onEdit","onDelete","onAddChild"]))),128))]),key:"0"}:void 0]),1032,["obligacion","expanded","selected","editable","draggable","onToggle","onSelect","onEdit","onDelete","onAddChild"])}),128))]),_:1})):(i(),p("div",Be," No hay obligaciones registradas "))],32),m.value.length?(i(),p("div",Le,[c("div",Fe,j(m.value.length),1),a[2]||(a[2]=c("div",{class:"text-xs text-gray-600"},"Total de Obligaciones",-1))])):y("",!0)]))}}),at=X(Ie,[["__scopeId","data-v-d64237fc"]]);export{at as O};
