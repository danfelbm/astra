import{M as ee,c as w,d as H,r as R,i as b,y as te,n as J,g as v,j as $,b as N,f as t,l as B,w as u,e as l,t as E,h as L,Z as ae,m as r,F as G,k as Z,T as se,ax as oe}from"./app-CMX6Vu6p.js";import{_ as A}from"./createLucideIcon-DTFKXtIq.js";import{_ as ne}from"./Separator.vue_vue_type_script_setup_true_lang-Ch0jFkai.js";import{a as I,b as F,c as M}from"./AdminLayout.vue_vue_type_script_setup_true_lang-D6Epb0Do.js";import{_ as le}from"./TooltipProvider.vue_vue_type_script_setup_true_lang-CD79qoKs.js";import{C as K}from"./chevron-right-BvIaGSk1.js";import{C as ie}from"./circle-vN5oJBkJ.js";import{L as re}from"./layers-WN2TvaXv.js";import{P as de}from"./paperclip-DgE-opNG.js";import{P as Q}from"./plus-B-WcxdKR.js";import{P as ce}from"./pencil-Dzk_QgoH.js";import{T as ue}from"./trash-2-D7XcxkIg.js";import{_ as U}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{C as ge}from"./SelectValue.vue_vue_type_script_setup_true_lang-DYdKX5cQ.js";import{L as fe}from"./loader-circle-B8TEQAdk.js";function W(){const n=ee(),S=w(()=>{var o;return((o=n.props.auth)==null?void 0:o.permissions)||[]}),f=w(()=>{var o;return((o=n.props.auth)==null?void 0:o.roles)||[]}),g=w(()=>f.value.some(o=>o.name==="super_admin")),D=w(()=>{var o;return((o=n.props.auth)==null?void 0:o.hasAdministrativeRole)||!1}),x=o=>g.value?!0:S.value.includes(o),d=o=>g.value?!0:o.every(p=>x(p)),j=o=>g.value?!0:o.some(p=>x(p)),_=o=>f.value.some(p=>p.name===o);return{authPermissions:S,authRoles:f,authIsSuperAdmin:g,hasAdministrativeRole:D,hasPermission:x,hasAllPermissions:d,hasAnyPermission:j,hasRole:_,hasAllRoles:o=>o.every(p=>_(p)),hasAnyRole:o=>o.some(p=>_(p))}}const ve=["draggable"],me={class:"flex items-start gap-2"},pe={key:1,class:"w-6"},he={class:"h-6 w-6 rounded-full flex items-center justify-center shrink-0 bg-gray-100"},be={class:"flex-1 min-w-0"},ye={class:"flex items-start justify-between"},xe={class:"flex-1"},_e={class:"font-medium text-sm truncate"},$e={key:0,class:"text-xs text-gray-600 mt-1 line-clamp-2"},De={class:"flex items-center gap-3 mt-2 text-xs text-gray-500"},ke={key:0,class:"flex items-center gap-1"},Ce={key:1,class:"flex items-center gap-1"},we={key:0,class:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity"},Ne={key:0,class:"mt-2"},je=H({__name:"ObligacionItem",props:{obligacion:{},nivel:{default:0},expanded:{type:Boolean,default:!1},selected:{type:Boolean,default:!1},editable:{type:Boolean,default:!0},onToggle:{},onSelect:{},onEdit:{},onDelete:{},onComplete:{},onAddChild:{},onDragStart:{},onDragOver:{},onDrop:{}},emits:["toggle","select","edit","delete","add-child","drag-start","drag-over","drop"],setup(n,{emit:S}){const f=n,g=S,{hasPermission:D}=W(),x=R(!1),d=w(()=>f.editable&&D("obligaciones.edit")),j=()=>{f.selected||g("select")},_=()=>{const m=f.obligacion.tiene_hijos?`¿Estás seguro de eliminar "${f.obligacion.titulo}" y todas sus obligaciones hijas?`:`¿Estás seguro de eliminar "${f.obligacion.titulo}"?`;confirm(m)&&g("delete")},k=m=>{d.value&&g("drag-start",f.obligacion,m)},y=m=>{d.value&&(m.preventDefault(),g("drag-over",m))},o=m=>{d.value&&(x.value=!1,g("drop",f.obligacion,m))},p=()=>{d.value&&(x.value=!0)},z=()=>{d.value&&(x.value=!1)};return(m,h)=>{var O,T;return r(),b("div",{class:J(["obligacion-item group",n.selected&&"bg-blue-50 border-blue-300",x.value&&"bg-gray-100 border-dashed","border rounded-lg p-2 mb-1 transition-all cursor-pointer hover:shadow-sm"]),style:te({marginLeft:`${n.nivel*24}px`}),draggable:d.value&&n.editable,onClick:j,onDragstart:k,onDragover:y,onDrop:o,onDragenter:p,onDragleave:z},[v("div",me,[n.obligacion.tiene_hijos?(r(),N(t(A),{key:0,variant:"ghost",size:"icon",class:"h-6 w-6 shrink-0",onClick:h[0]||(h[0]=B(P=>m.$emit("toggle"),["stop"]))},{default:u(()=>[l(t(K),{class:J(["h-4 w-4 transition-transform",n.expanded&&"rotate-90"])},null,8,["class"])]),_:1})):(r(),b("div",pe)),v("div",he,[l(t(ie),{class:"h-3 w-3 text-gray-600"})]),v("div",be,[v("div",ye,[v("div",xe,[v("h4",_e,E(n.obligacion.titulo),1),n.obligacion.descripcion?(r(),b("p",$e,E(n.obligacion.descripcion),1)):$("",!0),v("div",De,[n.obligacion.tiene_hijos?(r(),b("div",ke,[l(t(re),{class:"h-3 w-3"}),v("span",null,E(n.obligacion.total_hijos)+" hijos",1)])):$("",!0),(O=n.obligacion.archivos_adjuntos)!=null&&O.length?(r(),b("div",Ce,[l(t(de),{class:"h-3 w-3"}),v("span",null,E(n.obligacion.archivos_adjuntos.length),1)])):$("",!0)])]),n.editable?(r(),b("div",we,[l(t(le),null,{default:u(()=>[l(t(I),null,{default:u(()=>[l(t(F),{asChild:""},{default:u(()=>[t(D)("obligaciones.create")?(r(),N(t(A),{key:0,variant:"ghost",size:"icon",class:"h-7 w-7",onClick:h[1]||(h[1]=B(P=>m.$emit("add-child"),["stop"]))},{default:u(()=>[l(t(Q),{class:"h-3 w-3"})]),_:1})):$("",!0)]),_:1}),l(t(M),null,{default:u(()=>[...h[3]||(h[3]=[L("Añadir hijo",-1)])]),_:1})]),_:1}),l(t(I),null,{default:u(()=>[l(t(F),{asChild:""},{default:u(()=>[t(D)("obligaciones.edit")?(r(),N(t(A),{key:0,variant:"ghost",size:"icon",class:"h-7 w-7",onClick:h[2]||(h[2]=B(P=>m.$emit("edit"),["stop"]))},{default:u(()=>[l(t(ce),{class:"h-3 w-3"})]),_:1})):$("",!0)]),_:1}),l(t(M),null,{default:u(()=>[...h[4]||(h[4]=[L("Editar",-1)])]),_:1})]),_:1}),l(t(I),null,{default:u(()=>[l(t(F),{asChild:""},{default:u(()=>[t(D)("obligaciones.delete")?(r(),N(t(A),{key:0,variant:"ghost",size:"icon",class:"h-7 w-7 text-red-600 hover:text-red-700",onClick:B(_,["stop"])},{default:u(()=>[l(t(ue),{class:"h-3 w-3"})]),_:1})):$("",!0)]),_:1}),l(t(M),null,{default:u(()=>[...h[5]||(h[5]=[L("Eliminar",-1)])]),_:1})]),_:1})]),_:1})])):$("",!0)])])]),n.expanded&&((T=n.obligacion.hijos)!=null&&T.length)?(r(),b("div",Ne,[ae(m.$slots,"children",{},void 0,!0)])):$("",!0)],46,ve)}}}),q=U(je,[["__scopeId","data-v-43c5dc18"]]),Ae={class:"obligacion-tree"},Se={class:"flex items-center justify-between mb-4 p-2 bg-gray-50 rounded-lg"},Te={class:"flex items-center gap-2"},Ee={class:"flex items-center gap-2"},Oe={class:"text-sm text-gray-600"},Pe={key:0,class:"flex items-center justify-center py-8"},Re={key:1,class:"text-center py-8 text-gray-500"},ze={key:0,class:"mt-4 bg-gray-50 p-2 rounded text-center"},Be={class:"text-2xl font-bold"},Le=H({__name:"ObligacionTree",props:{obligaciones:{},contratoId:{},editable:{type:Boolean,default:!0},selectable:{type:Boolean,default:!0},expandedNodes:{default:()=>[]},selectedNode:{default:null},onSelect:{},onEdit:{},onDelete:{},onComplete:{},onAddChild:{},onMove:{},onReorder:{}},emits:["select","edit","delete","add-child","create","move","reorder","update:expandedNodes","update:selectedNode"],setup(n,{emit:S}){const f=n,g=S,{hasPermission:D}=W(),x=R(!1),d=R(f.expandedNodes),j=R(f.selectedNode),_=R(null),k=w(()=>f.editable&&D("obligaciones.edit")),y=w(()=>{const e=[],a=s=>{s.forEach(c=>{var i;e.push(c),(i=c.hijos)!=null&&i.length&&a(c.hijos)})};return a(f.obligaciones),e}),o=w(()=>Y(f.obligaciones)),p=e=>{const a=d.value.indexOf(e);a>-1?d.value.splice(a,1):d.value.push(e),g("update:expandedNodes",d.value)},z=e=>{if(j.value=e,g("update:selectedNode",e),e){const a=y.value.find(s=>s.id===e);a&&g("select",a)}},m=()=>{d.value=y.value.filter(e=>e.tiene_hijos).map(e=>e.id),g("update:expandedNodes",d.value)},h=()=>{d.value=[],g("update:expandedNodes",d.value)},O=(e,a)=>{k.value&&(_.value={obligacionId:e.id,parentId:e.parent_id,orden:e.orden,nivel:e.nivel},a.dataTransfer.effectAllowed="move",a.dataTransfer.setData("application/json",JSON.stringify(_.value)))},T=e=>{k.value&&(e.preventDefault(),e.dataTransfer.dropEffect="move")},P=(e,a)=>{if(!k.value)return;a.preventDefault(),a.stopPropagation();const s=JSON.parse(a.dataTransfer.getData("application/json"));if(!(!s||s.obligacionId===e.id)){if(V(s.obligacionId,e.id)){console.error("No se puede mover una obligación dentro de sus propios hijos");return}g("move",y.value.find(c=>c.id===s.obligacionId),e.id,e.orden+1),_.value=null}},X=e=>{if(!k.value)return;e.preventDefault(),e.stopPropagation();const a=JSON.parse(e.dataTransfer.getData("application/json"));a&&(g("move",y.value.find(s=>s.id===a.obligacionId),null,1),_.value=null)},Y=e=>{const a=new Map,s=[];return e.forEach(c=>{a.set(c.id,{...c,hijos:[]})}),e.forEach(c=>{const i=a.get(c.id);if(c.parent_id===null)s.push(i);else{const C=a.get(c.parent_id);C&&(C.hijos=C.hijos||[],C.hijos.push(i))}}),s.sort((c,i)=>c.orden-i.orden)},V=(e,a)=>{const s=y.value.find(c=>c.id===a);return s?s.parent_id===e?!0:s.parent_id===null?!1:V(e,s.parent_id):!1};return(e,a)=>(r(),b("div",Ae,[v("div",Se,[v("div",Te,[l(t(A),{size:"sm",variant:"outline",onClick:m,title:"Expandir todo"},{default:u(()=>[l(t(ge),{class:"h-4 w-4"})]),_:1}),l(t(A),{size:"sm",variant:"outline",onClick:h,title:"Colapsar todo"},{default:u(()=>[l(t(K),{class:"h-4 w-4"})]),_:1}),l(t(ne),{orientation:"vertical",class:"h-6"}),n.editable&&t(D)("obligaciones.create")?(r(),N(t(A),{key:0,size:"sm",variant:"outline",onClick:a[0]||(a[0]=s=>e.$emit("create"))},{default:u(()=>[l(t(Q),{class:"h-4 w-4 mr-1"}),a[1]||(a[1]=L(" Nueva Obligación ",-1))]),_:1})):$("",!0)]),v("div",Ee,[v("span",Oe,E(y.value.length)+" obligaciones ",1)])]),v("div",{class:"obligacion-tree-container border rounded-lg p-2 min-h-[200px]",onDragover:T,onDrop:X},[x.value?(r(),b("div",Pe,[l(t(fe),{class:"h-8 w-8 animate-spin text-gray-400"})])):o.value.length?(r(),N(se,{key:2,name:"list",tag:"div",class:"space-y-1"},{default:u(()=>[(r(!0),b(G,null,Z(o.value,s=>{var c;return r(),N(q,{key:s.id,obligacion:s,nivel:0,expanded:d.value.includes(s.id),selected:j.value===s.id,editable:n.editable,draggable:k.value,onToggle:i=>p(s.id),onSelect:i=>z(s.id),onEdit:i=>e.$emit("edit",s),onDelete:i=>e.$emit("delete",s),onAddChild:i=>e.$emit("add-child",s),onDragStart:O,onDragOver:T,onDrop:P},oe({_:2},[(c=s.hijos)!=null&&c.length?{name:"children",fn:u(()=>[(r(!0),b(G,null,Z(s.hijos,i=>(r(),N(q,{key:i.id,obligacion:i,nivel:1,expanded:d.value.includes(i.id),selected:j.value===i.id,editable:n.editable,draggable:k.value,onToggle:C=>p(i.id),onSelect:C=>z(i.id),onEdit:C=>e.$emit("edit",i),onDelete:C=>e.$emit("delete",i),onAddChild:C=>e.$emit("add-child",i),onDragStart:O,onDragOver:T,onDrop:P},null,8,["obligacion","expanded","selected","editable","draggable","onToggle","onSelect","onEdit","onDelete","onAddChild"]))),128))]),key:"0"}:void 0]),1032,["obligacion","expanded","selected","editable","draggable","onToggle","onSelect","onEdit","onDelete","onAddChild"])}),128))]),_:1})):(r(),b("div",Re," No hay obligaciones registradas "))],32),y.value.length?(r(),b("div",ze,[v("div",Be,E(y.value.length),1),a[2]||(a[2]=v("div",{class:"text-xs text-gray-600"},"Total de Obligaciones",-1))])):$("",!0)]))}}),et=U(Le,[["__scopeId","data-v-9e4e2634"]]);export{et as O,W as u};
