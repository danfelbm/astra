import{r as b,a as U,d as ee,c as P,i as g,e as c,g as i,f as x,j as y,w as _,h as j,t as h,u as n,n as H,F as O,k as G,b as z,l as R,s as te}from"./app-Cuh3Sov_.js";import{_ as T}from"./createLucideIcon-zA0T3Uav.js";import{c as se,_ as A}from"./CardTitle.vue_vue_type_script_setup_true_lang-BO_pj4R6.js";import{_ as D}from"./Label.vue_vue_type_script_setup_true_lang-CWld6NAA.js";import{U as ae}from"./upload-BZF4hqVj.js";import{F as K}from"./file-CicIYebb.js";import{E as oe}from"./eye-DIZPcch6.js";import{D as le}from"./download-Dliug-M8.js";import{X}from"./x-nULAODCc.js";function re(){const E=b(!1),C=b({}),B=b(new Map),s=()=>{const r=window.location.pathname;return r.startsWith("/admin")?"/admin":r.startsWith("/miembro")?"/miembro":""};return{isUploading:E,uploadProgress:C,uploadErrors:B,uploadFiles:async(r,t)=>{var u,p;E.value=!0,B.value.clear();const o=new FormData;r.forEach(f=>{o.append("files[]",f)}),o.append("module",t.module),o.append("field_id",t.fieldId),t.folder&&o.append("folder",t.folder),t.maxSize&&o.append("max_size",t.maxSize.toString());try{const f=await U.post(`${s()}/api/files/upload`,o,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:k=>{if(k.total){const S=Math.round(k.loaded*100/k.total);r.forEach(M=>{C.value[M.name]=S,t.onProgress&&t.onProgress(M.name,S)})}}});if(f.data.success)return t.onSuccess&&t.onSuccess(f.data.files),f.data.files;throw new Error(f.data.message||"Error al subir archivos")}catch(f){const k=((p=(u=f.response)==null?void 0:u.data)==null?void 0:p.message)||f.message||"Error desconocido al subir archivos";throw r.forEach(S=>{B.value.set(S.name,k)}),t.onError&&t.onError(f),f}finally{E.value=!1,setTimeout(()=>{C.value={}},2e3)}},deleteFile:async r=>{try{return(await U.delete(`${s()}/api/files/delete`,{data:{path:r}})).data.success}catch(t){return console.error("Error al eliminar archivo:",t),!1}},downloadFile:async(r,t)=>{try{const o=await U.get(`${s()}/api/files/download`,{params:{path:r},responseType:"blob"}),u=window.URL.createObjectURL(new Blob([o.data])),p=document.createElement("a");p.href=u,p.setAttribute("download",t||r.split("/").pop()||"archivo"),document.body.appendChild(p),p.click(),p.remove(),window.URL.revokeObjectURL(u)}catch(o){throw console.error("Error al descargar archivo:",o),o}},getFileInfo:async r=>{try{const t=await U.get(`${s()}/api/files/info`,{params:{path:r}});return t.data.success?t.data.file:null}catch(t){return console.error("Error al obtener información del archivo:",t),null}},validateFileType:(r,t)=>{var p;const o=t.split(",").map(f=>f.trim().toLowerCase()),u="."+((p=r.name.split(".").pop())==null?void 0:p.toLowerCase());return o.some(f=>f===u)},validateFileSize:(r,t)=>{const o=t*1024*1024;return r.size<=o},formatFileSize:r=>{if(r===0)return"0 Bytes";const t=1024,o=["Bytes","KB","MB","GB"],u=Math.floor(Math.log(r)/Math.log(t));return Math.round(r/Math.pow(t,u)*100)/100+" "+o[u]}}}const ie={class:"space-y-2"},ne={key:0,class:"text-red-500 ml-1"},de={key:0,class:"text-sm text-muted-foreground"},ce={class:"flex flex-col items-center justify-center text-center"},ue={class:"text-sm font-medium mb-1"},me={class:"text-xs text-muted-foreground"},pe=["multiple","accept","disabled"],fe={key:0,class:"space-y-2"},he={class:"space-y-2"},ve={class:"flex items-center justify-between"},ge={class:"flex items-center space-x-3 flex-1"},ye={class:"min-w-0 flex-1"},we={class:"text-sm font-medium truncate"},xe={key:0,class:"text-xs text-muted-foreground"},_e={class:"flex items-center space-x-2"},Fe={key:1,class:"space-y-2"},be={class:"space-y-2"},ke={class:"space-y-2"},ze={class:"flex items-center justify-between"},Se={class:"flex items-center space-x-3 flex-1"},Ee=["src","alt"],Ce={class:"min-w-0 flex-1"},Be={class:"text-sm font-medium truncate"},Ve={class:"text-xs text-muted-foreground"},$e={key:0,class:"w-full space-y-1"},Me={class:"flex justify-between text-xs text-muted-foreground"},Ue={class:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden"},Te={key:1,class:"text-xs text-red-600"},Ie={key:2,class:"text-sm text-red-600"},Le={key:3,class:"text-xs text-muted-foreground"},Pe={key:0},Ge=ee({__name:"FileUploadField",props:{modelValue:{},label:{},description:{},required:{type:Boolean,default:!1},multiple:{type:Boolean,default:!1},maxFiles:{default:5},maxFileSize:{default:10},accept:{default:".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif"},error:{},disabled:{type:Boolean,default:!1},showPreview:{type:Boolean,default:!0},module:{default:"postulaciones"},fieldId:{default:"file"},autoUpload:{type:Boolean,default:!0}},emits:["update:modelValue","filesSelected"],setup(E,{expose:C,emit:B}){const s=E,V=B,{isUploading:$,uploadFiles:N,deleteFile:W,formatFileSize:I}=re(),L=b(),w=b([]),r=b(new Map),t=b(new Map),o=b(new Map);b(!1);const u=P(()=>s.modelValue?s.modelValue.length>0&&typeof s.modelValue[0]=="string"?s.modelValue.map((e,d)=>({id:`existing_${d}`,name:e.split("/").pop()||"archivo",size:0,path:e,url:`/storage/${e}`})):s.modelValue:[]),p=P(()=>{const e=u.value.length+w.value.length;return s.multiple?e<s.maxFiles:e===0}),f=P(()=>s.accept.split(",").map(e=>e.trim().toLowerCase())),k=()=>{var e;!s.disabled&&p.value&&((e=L.value)==null||e.click())},S=e=>{var m;if(s.accept.includes("/*")){const a=s.accept.split(",").map(v=>v.trim());for(const v of a)if(v.includes("/*")){const F=v.replace("/*","");if(e.type.startsWith(F+"/"))return!0}}const d="."+((m=e.name.split(".").pop())==null?void 0:m.toLowerCase());return f.value.some(a=>a===d)},M=e=>{const d=s.maxFileSize*1024*1024;return e.size<=d},J=async e=>{const d=e.target,l=Array.from(d.files||[]);o.value.clear();const m=[];if(l.forEach(a=>{if(!S(a)){o.value.set(a.name,`Tipo de archivo no permitido. Solo se permiten: ${s.accept}`);return}if(!M(a)){o.value.set(a.name,`El archivo excede el tamaño máximo de ${s.maxFileSize}MB`);return}const v=u.value.length+m.length;if(s.multiple&&v>=s.maxFiles){o.value.set(a.name,`Se ha alcanzado el límite de ${s.maxFiles} archivos`);return}if(m.push(a),a.type.startsWith("image/")&&s.showPreview){const F=new FileReader;F.onload=Z=>{var q;r.value.set(a.name,(q=Z.target)==null?void 0:q.result)},F.readAsDataURL(a)}}),s.multiple?w.value=[...w.value,...m]:w.value=m.slice(0,1),m.length>0&&(V("filesSelected",m),s.autoUpload&&s.module&&s.fieldId))try{const a=await N(m,{module:s.module,fieldId:s.fieldId,onProgress:(v,F)=>{t.value.set(v,F)},onSuccess:v=>{const F=[...u.value,...v];V("update:modelValue",F),w.value=[],r.value.clear()},onError:v=>{console.error("Error al subir archivos:",v),m.forEach(F=>{o.value.set(F.name,"Error al subir el archivo")})}})}catch(a){console.error("Error en carga automática:",a)}d.value=""},Q=e=>{const d=w.value[e];r.value.delete(d.name),t.value.delete(d.name),o.value.delete(d.name),w.value.splice(e,1)},Y=async e=>{var m;const d=u.value[e];if(d.path)try{await W(d.path)}catch(a){((m=a==null?void 0:a.response)==null?void 0:m.status)!==404&&(a==null?void 0:a.status)!==404&&console.error("Error al eliminar archivo del servidor:",a)}const l=[...u.value];if(l.splice(e,1),typeof s.modelValue[0]=="string"){const a=l.map(v=>v.path).filter(Boolean);V("update:modelValue",a)}else V("update:modelValue",l)};return C({selectedFiles:w,uploadProgress:t,uploadErrors:o}),(e,d)=>(c(),g("div",ie,[i("div",null,[x(n(D),{class:"text-sm font-medium"},{default:_(()=>[j(h(e.label)+" ",1),e.required?(c(),g("span",ne,"*")):y("",!0)]),_:1}),e.description?(c(),g("p",de,h(e.description),1)):y("",!0)]),x(n(A),{class:H(["border-2 border-dashed hover:border-primary/50 transition-colors cursor-pointer",{"opacity-50 cursor-not-allowed":e.disabled||!p.value||n($),"border-red-300":e.error}]),onClick:k},{default:_(()=>[x(n(se),{class:"p-6"},{default:_(()=>[i("div",ce,[x(n(ae),{class:"h-10 w-10 text-muted-foreground mb-3"}),i("p",ue,h(n($)?"Subiendo archivos...":p.value?"Haz clic para seleccionar archivos":"Límite de archivos alcanzado"),1),i("p",me,h(e.multiple?`Hasta ${e.maxFiles} archivos`:"Un archivo")+" • Máx. "+h(e.maxFileSize)+"MB • Formatos: "+h(e.accept),1)])]),_:1})]),_:1},8,["class"]),i("input",{ref_key:"fileInputRef",ref:L,type:"file",multiple:e.multiple,accept:e.accept,disabled:e.disabled||!p.value||n($),onChange:J,class:"hidden"},null,40,pe),u.value.length>0?(c(),g("div",fe,[x(n(D),{class:"text-xs text-muted-foreground"},{default:_(()=>[...d[0]||(d[0]=[j("Archivos cargados:",-1)])]),_:1}),i("div",he,[(c(!0),g(O,null,G(u.value,(l,m)=>(c(),z(n(A),{key:l.id,class:"p-3"},{default:_(()=>[i("div",ve,[i("div",ge,[x(n(K),{class:"h-5 w-5 text-muted-foreground flex-shrink-0"}),i("div",ye,[i("p",we,h(l.name),1),l.size>0?(c(),g("p",xe,h(n(I)(l.size)),1)):y("",!0)])]),i("div",_e,[l.url?(c(),z(n(T),{key:0,type:"button",variant:"ghost",size:"sm",onClick:R(a=>e.window.open(l.url,"_blank"),["stop"])},{default:_(()=>[x(n(oe),{class:"h-4 w-4"})]),_:2},1032,["onClick"])):y("",!0),l.url?(c(),z(n(T),{key:1,type:"button",variant:"ghost",size:"sm",onClick:R(a=>e.window.open(l.url+"?download=true","_blank"),["stop"])},{default:_(()=>[x(n(le),{class:"h-4 w-4"})]),_:2},1032,["onClick"])):y("",!0),e.disabled?y("",!0):(c(),z(n(T),{key:2,type:"button",variant:"ghost",size:"sm",onClick:R(a=>Y(m),["stop"])},{default:_(()=>[x(n(X),{class:"h-4 w-4 text-destructive"})]),_:2},1032,["onClick"]))])])]),_:2},1024))),128))])])):y("",!0),w.value.length>0?(c(),g("div",Fe,[x(n(D),{class:"text-xs text-muted-foreground"},{default:_(()=>[j(h(t.value.size>0?"Subiendo archivos...":"Archivos pendientes de carga:"),1)]),_:1}),i("div",be,[(c(!0),g(O,null,G(w.value,(l,m)=>(c(),z(n(A),{key:l.name,class:H(["p-3",{"border-red-300":o.value.has(l.name)}])},{default:_(()=>[i("div",ke,[i("div",ze,[i("div",Se,[r.value.has(l.name)&&e.showPreview?(c(),g("img",{key:0,src:r.value.get(l.name),alt:l.name,class:"h-10 w-10 object-cover rounded flex-shrink-0"},null,8,Ee)):(c(),z(n(K),{key:1,class:"h-5 w-5 text-muted-foreground flex-shrink-0"})),i("div",Ce,[i("p",Be,h(l.name),1),i("p",Ve,h(n(I)(l.size)),1)])]),e.disabled?y("",!0):(c(),z(n(T),{key:0,type:"button",variant:"ghost",size:"sm",onClick:a=>Q(m)},{default:_(()=>[x(n(X),{class:"h-4 w-4 text-destructive"})]),_:2},1032,["onClick"]))]),t.value.has(l.name)?(c(),g("div",$e,[i("div",Me,[d[1]||(d[1]=i("span",null,"Subiendo...",-1)),i("span",null,h(t.value.get(l.name))+"%",1)]),i("div",Ue,[i("div",{class:"bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all duration-300 ease-out",style:te({width:`${t.value.get(l.name)}%`})},[...d[2]||(d[2]=[i("div",{class:"h-full bg-white/30 animate-pulse"},null,-1)])],4)])])):y("",!0),o.value.has(l.name)?(c(),g("p",Te,h(o.value.get(l.name)),1)):y("",!0)])]),_:2},1032,["class"]))),128))])])):y("",!0),e.error?(c(),g("p",Ie,h(e.error),1)):y("",!0),!e.disabled&&p.value?(c(),g("div",Le,[e.multiple?(c(),g("p",Pe,h(u.value.length+w.value.length)+" de "+h(e.maxFiles)+" archivos ",1)):y("",!0)])):y("",!0)]))}});export{Ge as _,re as u};
