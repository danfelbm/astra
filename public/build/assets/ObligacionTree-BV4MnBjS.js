import{d as H,r as E,c as B,i as p,y as ee,n as R,g as u,j as b,b as _,f as t,l as z,w as r,e as s,t as N,h as L,Z as te,m as i,F as G,k as Z,T as ae,ax as oe}from"./app-DyDecVrT.js";import{_ as D}from"./createLucideIcon-BwdUYYzo.js";import{_ as se}from"./Separator.vue_vue_type_script_setup_true_lang-BDHLX3j8.js";import{a as I,b as V,c as J}from"./AdminLayout.vue_vue_type_script_setup_true_lang-BgilFYR4.js";import{_ as ne}from"./TooltipProvider.vue_vue_type_script_setup_true_lang-DoohyNXg.js";import{u as K}from"./usePermissions-BCy2So4p.js";import{C as Q}from"./chevron-right-E1uKy6vs.js";import{C as le}from"./circle-CdvhYBs-.js";import{L as ie}from"./layers-pQFBzKpy.js";import{P as de}from"./paperclip-oQM0k54v.js";import{P as U}from"./plus-AnKxd2ZI.js";import{P as re}from"./pencil-BUeCvv--.js";import{T as ce}from"./trash-2-C-QiAuMz.js";import{_ as W}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{C as ue}from"./SelectValue.vue_vue_type_script_setup_true_lang-U4o3oQo-.js";import{L as ge}from"./loader-circle-D7nGqTA1.js";const fe=["draggable"],ve={class:"flex items-start gap-2"},me={key:1,class:"w-6"},pe={class:"h-6 w-6 rounded-full flex items-center justify-center shrink-0 bg-gray-100"},he={class:"flex-1 min-w-0"},be={class:"flex items-start justify-between"},ye={class:"flex-1"},xe={class:"font-medium text-sm truncate"},_e={key:0,class:"text-xs text-gray-600 mt-1 line-clamp-2"},$e={class:"flex items-center gap-3 mt-2 text-xs text-gray-500"},De={key:0,class:"flex items-center gap-1"},ke={key:1,class:"flex items-center gap-1"},Ce={key:0,class:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity"},we={key:0,class:"mt-2"},Ne=H({__name:"ObligacionItem",props:{obligacion:{},nivel:{default:0},expanded:{type:Boolean,default:!1},selected:{type:Boolean,default:!1},editable:{type:Boolean,default:!0},onToggle:{},onSelect:{},onEdit:{},onDelete:{},onComplete:{},onAddChild:{},onDragStart:{},onDragOver:{},onDrop:{}},emits:["toggle","select","edit","delete","add-child","drag-start","drag-over","drop"],setup(l,{emit:F}){const v=l,m=F,{hasPermission:$}=K(),k=E(!1),c=B(()=>v.editable&&$("obligaciones.edit")),j=()=>{v.selected||m("select")},C=()=>{const g=v.obligacion.tiene_hijos?`¿Estás seguro de eliminar "${v.obligacion.titulo}" y todas sus obligaciones hijas?`:`¿Estás seguro de eliminar "${v.obligacion.titulo}"?`;confirm(g)&&m("delete")},x=g=>{c.value&&m("drag-start",v.obligacion,g)},h=g=>{c.value&&(g.preventDefault(),m("drag-over",g))},O=g=>{c.value&&(k.value=!1,m("drop",v.obligacion,g))},A=()=>{c.value&&(k.value=!0)},P=()=>{c.value&&(k.value=!1)};return(g,f)=>{var S,w;return i(),p("div",{class:R(["obligacion-item group",l.selected&&"bg-blue-50 border-blue-300",k.value&&"bg-gray-100 border-dashed","border rounded-lg p-2 mb-1 transition-all cursor-pointer hover:shadow-sm"]),style:ee({marginLeft:`${l.nivel*24}px`}),draggable:c.value&&l.editable,onClick:j,onDragstart:x,onDragover:h,onDrop:O,onDragenter:A,onDragleave:P},[u("div",ve,[l.obligacion.tiene_hijos?(i(),_(t(D),{key:0,variant:"ghost",size:"icon",class:"h-6 w-6 shrink-0",onClick:f[0]||(f[0]=z(T=>g.$emit("toggle"),["stop"]))},{default:r(()=>[s(t(Q),{class:R(["h-4 w-4 transition-transform",l.expanded&&"rotate-90"])},null,8,["class"])]),_:1})):(i(),p("div",me)),u("div",pe,[s(t(le),{class:"h-3 w-3 text-gray-600"})]),u("div",he,[u("div",be,[u("div",ye,[u("h4",xe,N(l.obligacion.titulo),1),l.obligacion.descripcion?(i(),p("p",_e,N(l.obligacion.descripcion),1)):b("",!0),u("div",$e,[l.obligacion.tiene_hijos?(i(),p("div",De,[s(t(ie),{class:"h-3 w-3"}),u("span",null,N(l.obligacion.total_hijos)+" hijos",1)])):b("",!0),(S=l.obligacion.archivos_adjuntos)!=null&&S.length?(i(),p("div",ke,[s(t(de),{class:"h-3 w-3"}),u("span",null,N(l.obligacion.archivos_adjuntos.length),1)])):b("",!0)])]),l.editable?(i(),p("div",Ce,[s(t(ne),null,{default:r(()=>[s(t(I),null,{default:r(()=>[s(t(V),{asChild:""},{default:r(()=>[t($)("obligaciones.create")?(i(),_(t(D),{key:0,variant:"ghost",size:"icon",class:"h-7 w-7",onClick:f[1]||(f[1]=z(T=>g.$emit("add-child"),["stop"]))},{default:r(()=>[s(t(U),{class:"h-3 w-3"})]),_:1})):b("",!0)]),_:1}),s(t(J),null,{default:r(()=>[...f[3]||(f[3]=[L("Añadir hijo",-1)])]),_:1})]),_:1}),s(t(I),null,{default:r(()=>[s(t(V),{asChild:""},{default:r(()=>[t($)("obligaciones.edit")?(i(),_(t(D),{key:0,variant:"ghost",size:"icon",class:"h-7 w-7",onClick:f[2]||(f[2]=z(T=>g.$emit("edit"),["stop"]))},{default:r(()=>[s(t(re),{class:"h-3 w-3"})]),_:1})):b("",!0)]),_:1}),s(t(J),null,{default:r(()=>[...f[4]||(f[4]=[L("Editar",-1)])]),_:1})]),_:1}),s(t(I),null,{default:r(()=>[s(t(V),{asChild:""},{default:r(()=>[t($)("obligaciones.delete")?(i(),_(t(D),{key:0,variant:"ghost",size:"icon",class:"h-7 w-7 text-red-600 hover:text-red-700",onClick:z(C,["stop"])},{default:r(()=>[s(t(ce),{class:"h-3 w-3"})]),_:1})):b("",!0)]),_:1}),s(t(J),null,{default:r(()=>[...f[5]||(f[5]=[L("Eliminar",-1)])]),_:1})]),_:1})]),_:1})])):b("",!0)])])]),l.expanded&&((w=l.obligacion.hijos)!=null&&w.length)?(i(),p("div",we,[te(g.$slots,"children",{},void 0,!0)])):b("",!0)],46,fe)}}}),q=W(Ne,[["__scopeId","data-v-43c5dc18"]]),je={class:"obligacion-tree"},Se={class:"flex items-center justify-between mb-4 p-2 bg-gray-50 rounded-lg"},Te={class:"flex items-center gap-2"},Ee={class:"flex items-center gap-2"},Oe={class:"text-sm text-gray-600"},Ae={key:0,class:"flex items-center justify-center py-8"},Pe={key:1,class:"text-center py-8 text-gray-500"},ze={key:0,class:"mt-4 bg-gray-50 p-2 rounded text-center"},Be={class:"text-2xl font-bold"},Le=H({__name:"ObligacionTree",props:{obligaciones:{},contratoId:{},editable:{type:Boolean,default:!0},selectable:{type:Boolean,default:!0},expandedNodes:{default:()=>[]},selectedNode:{default:null},onSelect:{},onEdit:{},onDelete:{},onComplete:{},onAddChild:{},onMove:{},onReorder:{}},emits:["select","edit","delete","add-child","create","move","reorder","update:expandedNodes","update:selectedNode"],setup(l,{emit:F}){const v=l,m=F,{hasPermission:$}=K(),k=E(!1),c=E(v.expandedNodes),j=E(v.selectedNode),C=E(null),x=B(()=>v.editable&&$("obligaciones.edit")),h=B(()=>{const e=[],a=o=>{o.forEach(d=>{var n;e.push(d),(n=d.hijos)!=null&&n.length&&a(d.hijos)})};return a(v.obligaciones),e}),O=B(()=>Y(v.obligaciones)),A=e=>{const a=c.value.indexOf(e);a>-1?c.value.splice(a,1):c.value.push(e),m("update:expandedNodes",c.value)},P=e=>{if(j.value=e,m("update:selectedNode",e),e){const a=h.value.find(o=>o.id===e);a&&m("select",a)}},g=()=>{c.value=h.value.filter(e=>e.tiene_hijos).map(e=>e.id),m("update:expandedNodes",c.value)},f=()=>{c.value=[],m("update:expandedNodes",c.value)},S=(e,a)=>{x.value&&(C.value={obligacionId:e.id,parentId:e.parent_id,orden:e.orden,nivel:e.nivel},a.dataTransfer.effectAllowed="move",a.dataTransfer.setData("application/json",JSON.stringify(C.value)))},w=e=>{x.value&&(e.preventDefault(),e.dataTransfer.dropEffect="move")},T=(e,a)=>{if(!x.value)return;a.preventDefault(),a.stopPropagation();const o=JSON.parse(a.dataTransfer.getData("application/json"));if(!(!o||o.obligacionId===e.id)){if(M(o.obligacionId,e.id)){console.error("No se puede mover una obligación dentro de sus propios hijos");return}m("move",h.value.find(d=>d.id===o.obligacionId),e.id,e.orden+1),C.value=null}},X=e=>{if(!x.value)return;e.preventDefault(),e.stopPropagation();const a=JSON.parse(e.dataTransfer.getData("application/json"));a&&(m("move",h.value.find(o=>o.id===a.obligacionId),null,1),C.value=null)},Y=e=>{const a=new Map,o=[];return e.forEach(d=>{a.set(d.id,{...d,hijos:[]})}),e.forEach(d=>{const n=a.get(d.id);if(d.parent_id===null)o.push(n);else{const y=a.get(d.parent_id);y&&(y.hijos=y.hijos||[],y.hijos.push(n))}}),o.sort((d,n)=>d.orden-n.orden)},M=(e,a)=>{const o=h.value.find(d=>d.id===a);return o?o.parent_id===e?!0:o.parent_id===null?!1:M(e,o.parent_id):!1};return(e,a)=>(i(),p("div",je,[u("div",Se,[u("div",Te,[s(t(D),{size:"sm",variant:"outline",onClick:g,title:"Expandir todo"},{default:r(()=>[s(t(ue),{class:"h-4 w-4"})]),_:1}),s(t(D),{size:"sm",variant:"outline",onClick:f,title:"Colapsar todo"},{default:r(()=>[s(t(Q),{class:"h-4 w-4"})]),_:1}),s(t(se),{orientation:"vertical",class:"h-6"}),l.editable&&t($)("obligaciones.create")?(i(),_(t(D),{key:0,size:"sm",variant:"outline",onClick:a[0]||(a[0]=o=>e.$emit("create"))},{default:r(()=>[s(t(U),{class:"h-4 w-4 mr-1"}),a[1]||(a[1]=L(" Nueva Obligación ",-1))]),_:1})):b("",!0)]),u("div",Ee,[u("span",Oe,N(h.value.length)+" obligaciones ",1)])]),u("div",{class:"obligacion-tree-container border rounded-lg p-2 min-h-[200px]",onDragover:w,onDrop:X},[k.value?(i(),p("div",Ae,[s(t(ge),{class:"h-8 w-8 animate-spin text-gray-400"})])):O.value.length?(i(),_(ae,{key:2,name:"list",tag:"div",class:"space-y-1"},{default:r(()=>[(i(!0),p(G,null,Z(O.value,o=>{var d;return i(),_(q,{key:o.id,obligacion:o,nivel:0,expanded:c.value.includes(o.id),selected:j.value===o.id,editable:l.editable,draggable:x.value,onToggle:n=>A(o.id),onSelect:n=>P(o.id),onEdit:n=>e.$emit("edit",o),onDelete:n=>e.$emit("delete",o),onAddChild:n=>e.$emit("add-child",o),onDragStart:S,onDragOver:w,onDrop:T},oe({_:2},[(d=o.hijos)!=null&&d.length?{name:"children",fn:r(()=>[(i(!0),p(G,null,Z(o.hijos,n=>(i(),_(q,{key:n.id,obligacion:n,nivel:1,expanded:c.value.includes(n.id),selected:j.value===n.id,editable:l.editable,draggable:x.value,onToggle:y=>A(n.id),onSelect:y=>P(n.id),onEdit:y=>e.$emit("edit",n),onDelete:y=>e.$emit("delete",n),onAddChild:y=>e.$emit("add-child",n),onDragStart:S,onDragOver:w,onDrop:T},null,8,["obligacion","expanded","selected","editable","draggable","onToggle","onSelect","onEdit","onDelete","onAddChild"]))),128))]),key:"0"}:void 0]),1032,["obligacion","expanded","selected","editable","draggable","onToggle","onSelect","onEdit","onDelete","onAddChild"])}),128))]),_:1})):(i(),p("div",Pe," No hay obligaciones registradas "))],32),h.value.length?(i(),p("div",ze,[u("div",Be,N(h.value.length),1),a[2]||(a[2]=u("div",{class:"text-xs text-gray-600"},"Total de Obligaciones",-1))])):b("",!0)]))}}),et=W(Le,[["__scopeId","data-v-9e4e2634"]]);export{et as O};
