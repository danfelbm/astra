import{d as Pe,u as je,c as y,r as A,i as f,b as h,j as p,e as s,g as i,w as t,f as e,h as d,t as u,n as B,F as q,k as D,l as Fe,s as Ne,m as c}from"./app-Bf6d3A8V.js";import{a as k,b as V,c as C,_ as E}from"./CardTitle.vue_vue_type_script_setup_true_lang-CWsLvUG8.js";import{_ as w}from"./CardDescription.vue_vue_type_script_setup_true_lang-CHxShqt8.js";import{_ as $}from"./createLucideIcon-YOpGmVvB.js";import{_ as L}from"./Input.vue_vue_type_script_setup_true_lang-CB0Htk7P.js";import{_ as v}from"./Label.vue_vue_type_script_setup_true_lang-BacdJgZB.js";import{_ as I}from"./Textarea.vue_vue_type_script_setup_true_lang-B_H8uLPM.js";import{_ as de,a as ue,b as ce,c as me,d as fe}from"./SelectValue.vue_vue_type_script_setup_true_lang-BCxhgvZ-.js";import{_ as be}from"./index-BnkuBoco.js";import{_ as pe,a as _e,b as ge}from"./index-Bl_xx9UH.js";import{a as ve,_ as xe}from"./index-Cqi08Cdd.js";import{_ as he}from"./AddUsersModal.vue_vue_type_script_setup_true_lang-Cv2I9zS6.js";import{_ as Re}from"./CamposPersonalizadosForm.vue_vue_type_script_setup_true_lang-jtEW3EHW.js";import{E as Be}from"./EtiquetaSelector-DVCaGzAB.js";import{u as Le}from"./useToast-pM951uF2.js";import{C as Ie}from"./circle-check-big-B06xTbJ1.js";import{a as Me}from"./target-BZIMUzZ1.js";import{X as ye}from"./x-CY3swbP8.js";import{U as ke}from"./user-plus-Xw1AQxib.js";import{C as Oe}from"./circle-alert-ArH3XEnl.js";import{A as Te}from"./arrow-left-BBom13CK.js";import{S as He}from"./save-KeojBsvl.js";import{F as Xe}from"./zap-Bu8DJO82.js";import{_ as Ge}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Je={class:"space-y-6"},Ke={class:"grid gap-4 md:grid-cols-3"},Qe={class:"font-medium"},We={class:"font-medium"},Ye={key:0,class:"text-sm text-red-600 mt-1"},Ze={key:0,class:"text-sm text-red-600 mt-1"},ea={class:"grid gap-4 md:grid-cols-2"},aa={class:"flex items-center gap-2"},sa={key:0,class:"mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800"},la={class:"text-sm font-normal ml-2"},oa={class:"grid gap-4 md:grid-cols-2"},ta={key:0,class:"text-sm text-red-600 mt-1"},ra={key:0,class:"text-sm text-red-600 mt-1"},na={class:"space-y-2"},ia={key:0,class:"p-3 bg-muted rounded-lg flex items-center justify-between"},da={class:"flex items-center gap-2"},ua={class:"font-medium"},ca={class:"text-sm text-muted-foreground"},ma={key:0,class:"text-sm text-red-600 mt-1"},fa={class:"flex items-center justify-between mb-2"},ba={key:0,class:"space-y-2 mt-3"},pa={class:"flex items-center gap-2"},_a={class:"font-medium"},ga={class:"text-sm text-muted-foreground"},va={key:1,class:"text-sm text-muted-foreground mt-3"},xa={class:"list-disc pl-4"},ha={class:"flex justify-end gap-2"},ya=Pe({__name:"EntregableForm",props:{mode:{},proyecto:{},hito:{},entregable:{},usuarios:{},usuariosAsignados:{default:()=>[]},camposPersonalizados:{},valoresCamposPersonalizados:{default:()=>({})},categorias:{},estados:{},prioridades:{},siguienteOrden:{default:1},submitUrl:{},cancelUrl:{},searchUsersEndpoint:{}},emits:["success","error"],setup(m,{emit:Ve}){var T,H,X,G,J,K,Q,W,Y,Z,ee,ae,se,le,oe;const n=m,S=Ve,{toast:z}=Le(),P=((T=n.entregable)==null?void 0:T.estado)||"pendiente",l=je({nombre:((H=n.entregable)==null?void 0:H.nombre)||"",descripcion:((X=n.entregable)==null?void 0:X.descripcion)||"",fecha_inicio:((G=n.entregable)==null?void 0:G.fecha_inicio)||"",fecha_fin:((J=n.entregable)==null?void 0:J.fecha_fin)||"",estado:((K=n.entregable)==null?void 0:K.estado)||"pendiente",prioridad:((Q=n.entregable)==null?void 0:Q.prioridad)||"media",responsable_id:((W=n.entregable)==null?void 0:W.responsable_id)||null,usuarios_asignados:n.usuariosAsignados||[],campos_personalizados:n.valoresCamposPersonalizados||{},etiquetas:((Z=(Y=n.entregable)==null?void 0:Y.etiquetas)==null?void 0:Z.map(r=>r.id))??[],orden:((ee=n.entregable)==null?void 0:ee.orden)||n.siguienteOrden||1,notas:"",observaciones_estado:""}),M=y(()=>n.mode==="create"?!1:l.estado!==P),Ce=y(()=>{var o,_;if(!M.value)return"";const r=((o=n.estados.find(x=>x.value===P))==null?void 0:o.label)||P,a=((_=n.estados.find(x=>x.value===l.estado))==null?void 0:_.label)||l.estado;return`${r} → ${a}`}),j=A(!1),F=A(!1),b=A(null),g=A(new Map);if(n.usuarios.forEach(r=>g.value.set(r.id,r)),(ae=n.entregable)!=null&&ae.responsable_id){const r=n.usuarios.find(a=>{var o;return a.id===((o=n.entregable)==null?void 0:o.responsable_id)});if(r)b.value=r;else{const a=n.entregable;b.value={id:n.entregable.responsable_id,name:((se=a.responsable)==null?void 0:se.name)||`Usuario #${n.entregable.responsable_id}`,email:((le=a.responsable)==null?void 0:le.email)||""},g.value.set(n.entregable.responsable_id,b.value)}}(oe=n.usuariosAsignados)==null||oe.forEach(r=>{var a,o,_;g.value.has(r.user_id)||g.value.set(r.user_id,{id:((a=r.user)==null?void 0:a.id)||r.user_id,name:((o=r.user)==null?void 0:o.name)||`Usuario #${r.user_id}`,email:((_=r.user)==null?void 0:_.email)||""})});const Ee=y(()=>[{name:"rol",label:"Rol",type:"select",options:[{value:"colaborador",label:"Colaborador"},{value:"revisor",label:"Revisor"}],value:"colaborador",required:!0}]),$e=y(()=>{const r=l.usuarios_asignados.map(a=>a.user_id);return l.responsable_id&&r.push(l.responsable_id),r}),Ue=r=>{if(r.userIds.length>0){const a=r.userIds[0];l.responsable_id=a,g.value.has(a)?b.value=g.value.get(a)||null:(b.value={id:a,name:`Usuario seleccionado (ID: ${a})`,email:"Se actualizará al guardar"},g.value.set(a,b.value))}},we=r=>{r.userIds.forEach(a=>{l.usuarios_asignados.some(_=>_.user_id===a)||(l.usuarios_asignados.push({user_id:a,rol:r.extraData.rol||"colaborador"}),g.value.has(a)||g.value.set(a,{id:a,name:`Usuario #${a}`,email:"Pendiente de actualizar"}))})},Se=()=>{l.responsable_id=null,b.value=null},ze=r=>{const a=l.usuarios_asignados.findIndex(o=>o.user_id===r);a>-1&&l.usuarios_asignados.splice(a,1)},U=r=>g.value.has(r)?g.value.get(r):n.usuarios.find(a=>a.id===r),Ae=()=>{const r={...l.data(),usuarios:l.usuarios_asignados};delete r.usuarios_asignados,n.mode==="create"?l.transform(()=>r).post(n.submitUrl,{preserveScroll:!0,onSuccess:()=>{z.success("Entregable creado exitosamente"),S("success","Entregable creado exitosamente")},onError:()=>{z.error("Error al crear el entregable"),S("error","Error al crear el entregable")}}):l.transform(()=>r).put(n.submitUrl,{preserveScroll:!0,onSuccess:()=>{z.success("Entregable actualizado exitosamente"),S("success","Entregable actualizado exitosamente")},onError:()=>{z.error("Error al actualizar el entregable"),S("error","Error al actualizar el entregable")}})},qe=()=>{Ne.get(n.cancelUrl)},N=y(()=>{const r=[];return l.nombre||r.push("El nombre es requerido"),l.nombre.length>255&&r.push("El nombre no puede exceder 255 caracteres"),l.fecha_inicio&&l.fecha_fin&&new Date(l.fecha_inicio)>new Date(l.fecha_fin)&&r.push("La fecha de inicio no puede ser posterior a la fecha de fin"),l.responsable_id||r.push("Debe asignar un responsable"),r}),De=y(()=>N.value.length===0&&!l.processing),O=y(()=>{var r,a,o;if(n.mode==="edit"&&((r=n.entregable)==null?void 0:r.estado)==="completado"&&((a=n.entregable)!=null&&a.completado_at)){const _=new Date(n.entregable.completado_at).toLocaleDateString("es-ES"),x=((o=n.entregable.completado_por)==null?void 0:o.name)||"Usuario desconocido";return`Completado el ${_} por ${x}`}return null});return(r,a)=>(c(),f("div",Je,[O.value?(c(),h(e(xe),{key:0,class:"bg-green-50 dark:bg-green-900/20 border-green-200"},{default:t(()=>[s(e(Ie),{class:"h-4 w-4 text-green-600"}),s(e(ve),{class:"text-green-800 dark:text-green-200"},{default:t(()=>[d(u(O.value),1)]),_:1})]),_:1})):p("",!0),m.categorias&&m.categorias.length>0?(c(),h(e(E),{key:1},{default:t(()=>[s(e(k),null,{default:t(()=>[s(e(V),{class:"flex items-center gap-2"},{default:t(()=>[s(e(Me),{class:"h-5 w-5"}),a[14]||(a[14]=d(" Categorías ",-1))]),_:1}),s(e(w),null,{default:t(()=>[...a[15]||(a[15]=[d("Asigna etiquetas para categorizar y organizar este entregable",-1)])]),_:1})]),_:1}),s(e(C),null,{default:t(()=>[s(Be,{modelValue:e(l).etiquetas,"onUpdate:modelValue":a[0]||(a[0]=o=>e(l).etiquetas=o),categorias:m.categorias,"max-etiquetas":10,placeholder:"Seleccionar etiquetas para el entregable...",description:"Puedes asignar hasta 10 etiquetas"},null,8,["modelValue","categorias"])]),_:1})]),_:1})):p("",!0),s(e(E),null,{default:t(()=>[s(e(k),null,{default:t(()=>[s(e(V),{class:"text-base"},{default:t(()=>[...a[16]||(a[16]=[d("Información del Hito",-1)])]),_:1})]),_:1}),s(e(C),null,{default:t(()=>[i("div",Ke,[i("div",null,[a[17]||(a[17]=i("p",{class:"text-sm text-muted-foreground"},"Hito",-1)),i("p",Qe,u(m.hito.nombre),1)]),i("div",null,[a[18]||(a[18]=i("p",{class:"text-sm text-muted-foreground"},"Estado",-1)),s(e(be),null,{default:t(()=>[d(u(m.hito.estado_label||m.hito.estado),1)]),_:1})]),i("div",null,[a[19]||(a[19]=i("p",{class:"text-sm text-muted-foreground"},"Progreso",-1)),i("p",We,u(m.hito.porcentaje_completado||0)+"%",1)])])]),_:1})]),_:1}),i("form",{onSubmit:Fe(Ae,["prevent"]),class:"space-y-4"},[s(e(E),null,{default:t(()=>[s(e(k),null,{default:t(()=>[s(e(V),null,{default:t(()=>[...a[20]||(a[20]=[d("Información Básica",-1)])]),_:1}),s(e(w),null,{default:t(()=>[...a[21]||(a[21]=[d("Datos principales del entregable",-1)])]),_:1})]),_:1}),s(e(C),{class:"space-y-4"},{default:t(()=>[i("div",null,[s(e(v),{for:"nombre",class:"required"},{default:t(()=>[...a[22]||(a[22]=[d("Nombre del entregable",-1)])]),_:1}),s(e(L),{id:"nombre",modelValue:e(l).nombre,"onUpdate:modelValue":a[1]||(a[1]=o=>e(l).nombre=o),placeholder:"Ej: Documento de diseño técnico",class:B({"border-red-500":e(l).errors.nombre})},null,8,["modelValue","class"]),e(l).errors.nombre?(c(),f("p",Ye,u(e(l).errors.nombre),1)):p("",!0)]),i("div",null,[s(e(v),{for:"descripcion"},{default:t(()=>[...a[23]||(a[23]=[d("Descripción",-1)])]),_:1}),s(e(I),{id:"descripcion",modelValue:e(l).descripcion,"onUpdate:modelValue":a[2]||(a[2]=o=>e(l).descripcion=o),placeholder:"Describe el entregable y sus objetivos...",rows:"4",class:B({"border-red-500":e(l).errors.descripcion})},null,8,["modelValue","class"]),e(l).errors.descripcion?(c(),f("p",Ze,u(e(l).errors.descripcion),1)):p("",!0)]),i("div",ea,[i("div",null,[s(e(v),{for:"estado"},{default:t(()=>[d(u(m.mode==="create"?"Estado inicial":"Estado"),1)]),_:1}),s(e(de),{modelValue:e(l).estado,"onUpdate:modelValue":a[3]||(a[3]=o=>e(l).estado=o)},{default:t(()=>[s(e(ue),null,{default:t(()=>[s(e(ce),{placeholder:"Seleccionar estado"})]),_:1}),s(e(me),null,{default:t(()=>[(c(!0),f(q,null,D(m.estados,o=>(c(),h(e(fe),{key:o.value,value:o.value},{default:t(()=>[d(u(o.label),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])]),i("div",null,[s(e(v),{for:"prioridad"},{default:t(()=>[...a[24]||(a[24]=[d("Prioridad",-1)])]),_:1}),s(e(de),{modelValue:e(l).prioridad,"onUpdate:modelValue":a[4]||(a[4]=o=>e(l).prioridad=o)},{default:t(()=>[s(e(ue),null,{default:t(()=>[s(e(ce),{placeholder:"Seleccionar prioridad"})]),_:1}),s(e(me),null,{default:t(()=>[(c(!0),f(q,null,D(m.prioridades,o=>(c(),h(e(fe),{key:o.value,value:o.value},{default:t(()=>[i("div",aa,[s(e(Xe),{class:B(["h-4 w-4",{"text-blue-500":o.value==="baja","text-yellow-500":o.value==="media","text-red-500":o.value==="alta"}])},null,8,["class"]),d(" "+u(o.label),1)])]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])])]),M.value?(c(),f("div",sa,[s(e(v),{for:"observaciones_estado",class:"text-blue-800 dark:text-blue-200"},{default:t(()=>[a[25]||(a[25]=d(" Observaciones del cambio de estado ",-1)),i("span",la,"("+u(Ce.value)+")",1)]),_:1}),s(e(I),{id:"observaciones_estado",modelValue:e(l).observaciones_estado,"onUpdate:modelValue":a[5]||(a[5]=o=>e(l).observaciones_estado=o),placeholder:"Describe el motivo del cambio de estado...",rows:"3",class:"mt-2"},null,8,["modelValue"]),a[26]||(a[26]=i("p",{class:"text-xs text-blue-600 dark:text-blue-300 mt-1"}," Las observaciones quedarán registradas en el historial de cambios. ",-1))])):p("",!0)]),_:1})]),_:1}),s(e(E),null,{default:t(()=>[s(e(k),null,{default:t(()=>[s(e(V),null,{default:t(()=>[...a[27]||(a[27]=[d("Fechas",-1)])]),_:1}),s(e(w),null,{default:t(()=>[...a[28]||(a[28]=[d("Define el período de ejecución del entregable",-1)])]),_:1})]),_:1}),s(e(C),null,{default:t(()=>[i("div",oa,[i("div",null,[s(e(v),{for:"fecha_inicio"},{default:t(()=>[...a[29]||(a[29]=[d("Fecha de inicio",-1)])]),_:1}),s(e(L),{id:"fecha_inicio",modelValue:e(l).fecha_inicio,"onUpdate:modelValue":a[6]||(a[6]=o=>e(l).fecha_inicio=o),type:"date",disabled:e(l).processing},null,8,["modelValue","disabled"]),e(l).errors.fecha_inicio?(c(),f("p",ta,u(e(l).errors.fecha_inicio),1)):p("",!0)]),i("div",null,[s(e(v),{for:"fecha_fin"},{default:t(()=>[...a[30]||(a[30]=[d("Fecha de fin",-1)])]),_:1}),s(e(L),{id:"fecha_fin",modelValue:e(l).fecha_fin,"onUpdate:modelValue":a[7]||(a[7]=o=>e(l).fecha_fin=o),type:"date",disabled:e(l).processing},null,8,["modelValue","disabled"]),e(l).errors.fecha_fin?(c(),f("p",ra,u(e(l).errors.fecha_fin),1)):p("",!0)])])]),_:1})]),_:1}),s(e(E),null,{default:t(()=>[s(e(k),null,{default:t(()=>[s(e(V),null,{default:t(()=>[...a[31]||(a[31]=[d("Asignación",-1)])]),_:1}),s(e(w),null,{default:t(()=>[...a[32]||(a[32]=[d("Asigna un responsable y colaboradores al entregable",-1)])]),_:1})]),_:1}),s(e(C),{class:"space-y-4"},{default:t(()=>[i("div",null,[s(e(v),{for:"responsable",class:"required"},{default:t(()=>[...a[33]||(a[33]=[d("Responsable principal",-1)])]),_:1}),i("div",na,[b.value?(c(),f("div",ia,[i("div",da,[s(e(pe),{class:"h-8 w-8"},{default:t(()=>[b.value.avatar?(c(),h(e(_e),{key:0,src:b.value.avatar},null,8,["src"])):p("",!0),s(e(ge),null,{default:t(()=>[d(u(b.value.name.substring(0,2).toUpperCase()),1)]),_:1})]),_:1}),i("div",null,[i("p",ua,u(b.value.name),1),i("p",ca,u(b.value.email),1)])]),s(e($),{type:"button",variant:"ghost",size:"sm",onClick:Se},{default:t(()=>[s(e(ye),{class:"h-4 w-4"})]),_:1})])):p("",!0),s(e($),{type:"button",variant:"outline",onClick:a[8]||(a[8]=o=>j.value=!0),class:"w-full"},{default:t(()=>[s(e(ke),{class:"h-4 w-4 mr-2"}),d(" "+u(b.value?"Cambiar Responsable":"Seleccionar Responsable"),1)]),_:1})]),e(l).errors.responsable_id?(c(),f("p",ma,u(e(l).errors.responsable_id),1)):p("",!0)]),i("div",null,[i("div",fa,[s(e(v),null,{default:t(()=>[...a[34]||(a[34]=[d("Colaboradores adicionales",-1)])]),_:1}),s(e($),{type:"button",variant:"outline",size:"sm",onClick:a[9]||(a[9]=o=>F.value=!0)},{default:t(()=>[s(e(ke),{class:"mr-2 h-4 w-4"}),a[35]||(a[35]=d(" Agregar colaboradores ",-1))]),_:1})]),e(l).usuarios_asignados.length>0?(c(),f("div",ba,[(c(!0),f(q,null,D(e(l).usuarios_asignados,o=>{var _,x;return c(),f("div",{key:o.user_id,class:"p-3 bg-muted rounded-lg flex items-center justify-between"},[i("div",pa,[s(e(pe),{class:"h-8 w-8"},{default:t(()=>{var R,te;return[(R=U(o.user_id))!=null&&R.avatar?(c(),h(e(_e),{key:0,src:(te=U(o.user_id))==null?void 0:te.avatar},null,8,["src"])):p("",!0),s(e(ge),null,{default:t(()=>{var re,ne,ie;return[d(u(((ie=(ne=(re=U(o.user_id))==null?void 0:re.name)==null?void 0:ne.substring(0,2))==null?void 0:ie.toUpperCase())||"US"),1)]}),_:2},1024)]}),_:2},1024),i("div",null,[i("p",_a,u(((_=U(o.user_id))==null?void 0:_.name)||`Usuario #${o.user_id}`),1),i("p",ga,u(((x=U(o.user_id))==null?void 0:x.email)||""),1)]),s(e(be),{variant:"outline"},{default:t(()=>[d(u(o.rol),1)]),_:2},1024)]),s(e($),{type:"button",variant:"ghost",size:"sm",onClick:R=>ze(o.user_id)},{default:t(()=>[s(e(ye),{class:"h-4 w-4"})]),_:1},8,["onClick"])])}),128))])):(c(),f("div",va,"No hay colaboradores asignados"))])]),_:1})]),_:1}),s(e(E),null,{default:t(()=>[s(e(k),null,{default:t(()=>[s(e(V),null,{default:t(()=>[d(u(m.mode==="create"?"Notas adicionales":"Notas de actualización"),1)]),_:1}),s(e(w),null,{default:t(()=>[d(u(m.mode==="create"?"Información adicional o consideraciones especiales":"Describe los cambios realizados (opcional)"),1)]),_:1})]),_:1}),s(e(C),null,{default:t(()=>[s(e(I),{modelValue:e(l).notas,"onUpdate:modelValue":a[10]||(a[10]=o=>e(l).notas=o),placeholder:m.mode==="create"?"Notas adicionales sobre el entregable...":"Notas sobre los cambios realizados...",rows:"4"},null,8,["modelValue","placeholder"])]),_:1})]),_:1}),m.camposPersonalizados&&m.camposPersonalizados.length>0?(c(),h(Re,{key:0,campos:m.camposPersonalizados,valores:e(l).campos_personalizados,errors:e(l).errors,onUpdate:a[11]||(a[11]=o=>e(l).campos_personalizados=o)},null,8,["campos","valores","errors"])):p("",!0),N.value.length>0?(c(),h(e(xe),{key:1,variant:"destructive"},{default:t(()=>[s(e(Oe),{class:"h-4 w-4"}),s(e(ve),null,{default:t(()=>[i("ul",xa,[(c(!0),f(q,null,D(N.value,o=>(c(),f("li",{key:o},u(o),1))),128))])]),_:1})]),_:1})):p("",!0),i("div",ha,[s(e($),{type:"button",variant:"outline",onClick:qe},{default:t(()=>[s(e(Te),{class:"mr-2 h-4 w-4"}),a[36]||(a[36]=d(" Cancelar ",-1))]),_:1}),s(e($),{type:"submit",disabled:!De.value},{default:t(()=>[s(e(He),{class:"mr-2 h-4 w-4"}),d(" "+u(e(l).processing?m.mode==="create"?"Creando...":"Actualizando...":m.mode==="create"?"Crear Entregable":"Actualizar Entregable"),1)]),_:1},8,["disabled"])])],32),s(he,{modelValue:j.value,"onUpdate:modelValue":a[12]||(a[12]=o=>j.value=o),title:"Seleccionar Responsable Principal",description:"Selecciona el usuario que será el responsable principal del entregable","search-endpoint":m.searchUsersEndpoint,"excluded-ids":e(l).responsable_id?[e(l).responsable_id]:[],"max-selection":1,"submit-button-text":"Seleccionar Responsable","search-placeholder":"Buscar por nombre, email, documento o teléfono...",onSubmit:Ue},null,8,["modelValue","search-endpoint","excluded-ids"]),s(he,{modelValue:F.value,"onUpdate:modelValue":a[13]||(a[13]=o=>F.value=o),title:"Agregar Colaboradores",description:"Selecciona los usuarios que colaborarán en este entregable","search-endpoint":m.searchUsersEndpoint,"excluded-ids":$e.value,"extra-fields":Ee.value,"submit-button-text":"Agregar Colaboradores","search-placeholder":"Buscar por nombre, email, documento o teléfono...",onSubmit:we},null,8,["modelValue","search-endpoint","excluded-ids","extra-fields"])]))}}),Xa=Ge(ya,[["__scopeId","data-v-528cbbf3"]]);export{Xa as E};
