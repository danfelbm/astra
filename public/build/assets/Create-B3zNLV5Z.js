import{d as xe,u as ye,r as h,c as T,p as we,o as ke,B as Se,i as u,e as s,f as e,q as $e,w as n,g as r,b,s as Ce,h as p,j as g,m as l,t as v,F as S,k as D,x as Y,a5 as Ee,O as je}from"./app-DlmWAWLM.js";import{_ as Ve}from"./UserLayout.vue_vue_type_script_setup_true_lang-DGztd13s.js";import{_ as Fe,a as Ae,b as Te,c as Ne}from"./CardTitle.vue_vue_type_script_setup_true_lang-AUjIYp68.js";import{_ as Z}from"./CardDescription.vue_vue_type_script_setup_true_lang-C5vEL4V-.js";import{_ as x}from"./createLucideIcon-B8281_2z.js";import{_ as j}from"./Label.vue_vue_type_script_setup_true_lang-BNREmH2a.js";import{_ as Oe}from"./Textarea.vue_vue_type_script_setup_true_lang-D0X9zjQb.js";import{_ as Be,a as De,b as ze,c as Me,d as Ie}from"./SelectValue.vue_vue_type_script_setup_true_lang-Bx32bmDw.js";import{_ as Pe}from"./Checkbox.vue_vue_type_script_setup_true_lang-B73_04CI.js";import{_ as Ue}from"./Progress.vue_vue_type_script_setup_true_lang-CJQhb8O8.js";import{_ as Ge}from"./index-CLy9LD5R.js";import{_ as Le}from"./FileUploadField.vue_vue_type_script_setup_true_lang-BtXOMXPx.js";import{u as We}from"./useAutoSave-Bdk_jogW.js";import{u as qe}from"./useFileUpload-sk8QU16o.js";import{t as _}from"./index-DXikczT9.js";import{F as U}from"./file-text-BbNX5nDR.js";import{M as G}from"./music-DV6wwun0.js";import{V as L}from"./video-C7K4maod.js";import{I as W}from"./image-Fne6k6y7.js";import{A as Re}from"./arrow-left-DVchKIoA.js";import{C as ee}from"./clock-BYrF0XxV.js";import{C as te}from"./circle-check-big-CiMLaX39.js";import{C as He}from"./circle-alert-0OWVYoS7.js";import{C as Ke}from"./camera--zuoaOMO.js";import{P as Je}from"./panel-left-C7VtaKld.js";import{S as Qe}from"./save-D8cKF_pE.js";import{_ as Xe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./UpdateLocationModal.vue_vue_type_script_setup_true_lang-712Z3z2u.js";import"./index-CnXpICxy.js";import"./floating-ui.vue-K2irEoRr.js";import"./x-CVmak5cP.js";import"./Input.vue_vue_type_script_setup_true_lang-CbyCCRkc.js";import"./index-D5ctPQxb.js";import"./index-BpP68Equ.js";import"./shield-NI0CGFrA.js";import"./user-BjlKIRQo.js";import"./DropdownMenuTrigger.vue_vue_type_script_setup_true_lang-Ds2nW1nv.js";import"./chevron-right-BldIB6XG.js";import"./DialogTitle.vue_vue_type_script_setup_true_lang-CtEt8JZt.js";import"./VisuallyHidden-DQEdmkNH.js";import"./GeographicSelector.vue_vue_type_script_setup_true_lang-BHiFKq2N.js";import"./map-pin-QIwnOWhZ.js";import"./AppLogo.vue_vue_type_script_setup_true_lang-C1BXh9TJ.js";import"./usePermissions-CC7_FkKZ.js";import"./square-check-big-f0riKPNX.js";import"./users-DH2VmlmU.js";import"./folder-open-CFnipNvv.js";import"./index-9YE0w0X4.js";import"./check-CsR91O3E.js";import"./upload-CsAsC6A6.js";import"./file-CppDrFfl.js";import"./eye-D0x12PRS.js";import"./download-DLLWdfPq.js";import"./debounce-DZkWJoHg.js";const Ye={class:"flex h-full flex-1 flex-col gap-4 rounded-xl p-4 pb-24"},Ze={class:"flex items-center justify-between"},et={class:"flex items-center justify-end gap-2 text-sm text-muted-foreground"},tt={key:0,class:"flex items-center gap-1.5"},ot={key:1,class:"flex items-center gap-1.5"},at={key:2,class:"flex items-center gap-1.5 text-amber-600"},it={class:"space-y-2"},st={key:0,class:"text-sm text-destructive"},rt={class:"space-y-2"},nt={class:"grid grid-cols-2 md:grid-cols-4 gap-4"},lt={key:0,class:"text-sm text-destructive"},dt={key:0,class:"space-y-2"},ct={key:0,class:"mb-4 p-4 border rounded-lg bg-muted/50"},ut={class:"flex items-center justify-between mb-2"},mt={class:"grid grid-cols-2 md:grid-cols-4 gap-2"},pt={class:"text-xs"},vt={key:1,class:"space-y-4"},ft={class:"flex gap-2"},_t=["srcObject"],ht={class:"space-y-2"},gt={class:"space-y-2 max-h-60 overflow-y-auto border rounded-lg p-4"},bt={class:"flex-1"},xt={class:"text-muted-foreground text-xs block"},yt={class:"space-y-2"},wt={key:0,class:"text-sm text-destructive"},kt={class:"fixed bottom-0 left-0 right-0 z-50 px-2 sm:px-4 pb-2 sm:pb-4"},St={class:"mx-auto max-w-7xl"},$t={class:"backdrop-blur-lg bg-tertiary-60 dark:bg-gray-900/80 border border-gray-200/50 dark:border-gray-700/50 rounded-xl sm:rounded-2xl shadow-2xl p-3 sm:p-4"},Ct={class:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4"},Et={class:"hidden sm:flex items-center"},jt={class:"flex-1 sm:max-w-xs lg:max-w-sm mx-0 sm:mx-4"},Vt={class:"flex items-center gap-3"},Ft={class:"text-xs sm:text-sm text-muted-foreground whitespace-nowrap font-medium"},At={class:"flex items-center gap-2 sm:gap-3"},Tt=xe({__name:"Create",props:{contrato:{},obligaciones:{},entregables:{},tiposEvidencia:{}},setup($){const V=$,oe=[{title:"Dashboard",href:"/miembro/dashboard"},{title:"Mis Contratos",href:"/miembro/mis-contratos"},{title:V.contrato.nombre,href:`/miembro/mis-contratos/${V.contrato.id}`},{title:"Subir Evidencia",href:"#"}],{uploadFiles:q}=qe(),o=ye({obligacion_id:null,tipo_evidencia:null,archivo_path:null,archivo_nombre:null,archivos_paths:[],archivos_nombres:[],tipos_archivos:null,descripcion:null,entregable_ids:[],metadata:null}),N=h([]),C=h({imagen:{paths:[],nombres:[],count:0},video:{paths:[],nombres:[],count:0},audio:{paths:[],nombres:[],count:0},documento:{paths:[],nombres:[],count:0}}),ae=h(null),y=h(!1),E=h(null),F=h(null),w=h(null),A=h(null),ie=h(null),se=T(()=>o.data()),{state:re,isSaving:z,hasSaved:ne,hasError:R,saveNow:le,startWatching:H,stopAutoSave:K,restoreDraft:de,clearLocalStorage:ce}=We(se,{url:`/miembro/mis-contratos/${V.contrato.id}/evidencias/autosave`,debounceTime:3e3,showNotifications:!0,useLocalStorage:!0,localStorageKey:`evidencia_draft_contrato_${V.contrato.id}`}),ue=T(()=>{const a={imagen:{icon:W,accept:"image/*",capture:"environment",maxSize:10485760},video:{icon:L,accept:"video/*",capture:"environment",maxSize:524288e3},audio:{icon:G,accept:"audio/*",capture:!1,maxSize:52428800},documento:{icon:U,accept:".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.rtf",capture:!1,maxSize:20971520}};return o.tipo_evidencia?a[o.tipo_evidencia]:null}),M=T(()=>{const t=[o.obligacion_id,o.tipo_evidencia,o.archivo_path,o.descripcion,o.entregable_ids.length>0].filter(Boolean).length,c=Math.round(t/5*100);return{llenos:t,total:5,porcentaje:c}});we(()=>o.tipo_evidencia,a=>{a&&(ae.value=a,y.value&&O())});const me=a=>{const t=a.type;return t.startsWith("image/")?"imagen":t.startsWith("video/")?"video":t.startsWith("audio/")?"audio":"documento"},J=()=>{const a=[],t=[],c={};if(Object.entries(C.value).forEach(([m,i])=>{i.paths.forEach((d,f)=>{a.push(d),t.push(i.nombres[f]),c[d]=m})}),o.archivos_paths=a,o.archivos_nombres=t,o.tipos_archivos=c,a.length>0&&!o.archivo_path&&(o.archivo_path=a[0],o.archivo_nombre=t[0]),N.value=a,Object.keys(c).length>0){const m=Object.values(c).reduce((d,f)=>(d[f]=(d[f]||0)+1,d),{}),i=Object.entries(m).reduce((d,f)=>d[1]>f[1]?d:f)[0];o.tipo_evidencia=i}},k=T(()=>Object.values(C.value).reduce((a,t)=>a+t.count,0)),Q=T(()=>o.obligacion_id&&o.tipo_evidencia&&(k.value>0||ie.value||A.value)),pe=async()=>{if(!o.tipo_evidencia||o.tipo_evidencia==="documento"){_.error("No se puede capturar este tipo de evidencia");return}try{y.value=!0;const a={video:o.tipo_evidencia==="imagen"||o.tipo_evidencia==="video",audio:o.tipo_evidencia==="audio"||o.tipo_evidencia==="video"};if(E.value=await navigator.mediaDevices.getUserMedia(a),o.tipo_evidencia==="audio"||o.tipo_evidencia==="video"){w.value=new MediaRecorder(E.value);const t=[];w.value.ondataavailable=c=>{t.push(c.data)},w.value.onstop=()=>{const c=new Blob(t,{type:o.tipo_evidencia==="audio"?"audio/webm":"video/webm"});A.value=c,X(c)},w.value.start(),_.info("Grabación iniciada")}}catch(a){console.error("Error al iniciar captura:",a),_.error("No se pudo acceder a la cámara/micrófono"),y.value=!1}},O=()=>{E.value&&(E.value.getTracks().forEach(a=>a.stop()),E.value=null),w.value&&w.value.state==="recording"&&w.value.stop(),y.value=!1},ve=()=>{if(!F.value)return;const a=document.createElement("canvas");a.width=F.value.videoWidth,a.height=F.value.videoHeight;const t=a.getContext("2d");t&&(t.drawImage(F.value,0,0),a.toBlob(c=>{c&&(A.value=c,X(c),O())},"image/jpeg",.95))},X=async a=>{const t=`captura_${Date.now()}.${fe(a.type)}`,c=new File([a],t,{type:a.type});A.value=a,o.archivo_nombre=t,o.metadata={mime_type:a.type,size:a.size,captured_at:new Date().toISOString()};try{_.info("Subiendo archivo capturado...");const m=await q([c],{module:"evidencias",fieldId:o.tipo_evidencia||"archivo",onProgress:(i,d)=>{}});m.length>0&&(o.archivo_path=m[0].path,o.archivo_nombre=m[0].name,o.metadata=m[0].metadata,N.value=[m[0].path],A.value=null,_.success("Archivo subido exitosamente"))}catch(m){console.error("Error al subir archivo capturado:",m),_.error("Error al subir el archivo capturado")}},fe=a=>({"image/jpeg":"jpg","image/png":"png","image/webp":"webp","video/webm":"webm","audio/webm":"webm"})[a]||"bin",_e=async a=>{if(a.length>0){const t=k.value,c=a.length;if(t+c>10){_.error(`No puedes subir más de 10 archivos. Actualmente tienes ${t} archivo(s).`);return}const m={imagen:[],video:[],audio:[],documento:[]};a.forEach(i=>{const d=me(i);m[d].push(i)});try{let i=0;for(const[d,f]of Object.entries(m)){if(f.length===0)continue;_.info(`Subiendo ${f.length} archivo(s) de tipo ${d}...`);const I=await q(f,{module:"evidencias",fieldId:d,onProgress:(B,P)=>{}});if(I.length>0){const B=d;I.forEach(P=>{C.value[B].paths.push(P.path),C.value[B].nombres.push(P.name),C.value[B].count++}),i+=I.length}}i>0&&(J(),_.success(`${i} archivo(s) subido(s) exitosamente. Total: ${k.value}/10`))}catch(i){console.error("Error al subir archivos:",i),_.error("Error al subir archivos")}}},he=async()=>{await le(),_.success("Borrador guardado")},ge=async()=>{if(Q.value){if(k.value===0&&!o.archivo_path){_.error("Por favor seleccione o capture al menos un archivo");return}J(),K(),o.post(`/miembro/mis-contratos/${V.contrato.id}/evidencias`,{onSuccess:()=>{ce(),_.success(`Evidencia subida exitosamente con ${o.archivos_paths.length} archivo(s)`)},onError:a=>{console.error("Errores de validación:",a),H()}})}},be=()=>{const a=document.querySelector('[data-sidebar="trigger"]');a&&a.click()};return ke(()=>{const a=de();a&&a.data&&Object.assign(o,a.data),H()}),Se(()=>{K(),O()}),(a,t)=>(l(),u(S,null,[s(e($e),{title:`Subir Evidencia - ${$.contrato.nombre}`},null,8,["title"]),s(Ve,{breadcrumbs:oe},{default:n(()=>{var c;return[r("div",Ye,[r("div",Ze,[t[5]||(t[5]=r("div",null,[r("h1",{class:"text-3xl font-bold"},"Subir Evidencia"),r("p",{class:"text-muted-foreground"}," Adjunta las evidencias del cumplimiento de las obligaciones del contrato ")],-1)),s(e(x),{variant:"outline",onClick:t[0]||(t[0]=m=>e(Ce).visit(`/miembro/mis-contratos/${$.contrato.id}`))},{default:n(()=>[s(e(Re),{class:"mr-2 h-4 w-4"}),t[4]||(t[4]=p(" Volver ",-1))]),_:1})]),r("div",et,[e(z)?(l(),u("div",tt,[s(e(ee),{class:"h-4 w-4 animate-spin"}),t[6]||(t[6]=r("span",null,"Guardando automáticamente...",-1))])):e(ne)&&!e(R)?(l(),u("div",ot,[s(e(te),{class:"h-4 w-4 text-green-600"}),r("span",null,"Guardado a las "+v((c=e(re).lastSaved)==null?void 0:c.toLocaleTimeString()),1)])):e(R)?(l(),u("div",at,[s(e(He),{class:"h-4 w-4"}),t[7]||(t[7]=r("span",null,"Guardado localmente",-1))])):g("",!0)]),s(e(Fe),null,{default:n(()=>[s(e(Ae),null,{default:n(()=>[s(e(Te),null,{default:n(()=>[...t[8]||(t[8]=[p("Información de la Evidencia",-1)])]),_:1}),s(e(Z),null,{default:n(()=>[...t[9]||(t[9]=[p(" Selecciona la obligación, el tipo de evidencia y adjunta el archivo correspondiente ",-1)])]),_:1})]),_:1}),s(e(Ne),{class:"space-y-6"},{default:n(()=>{var m;return[r("div",it,[s(e(j),{htmlFor:"obligacion"},{default:n(()=>[...t[10]||(t[10]=[p("Obligación *",-1)])]),_:1}),s(e(Be),{modelValue:e(o).obligacion_id,"onUpdate:modelValue":t[1]||(t[1]=i=>e(o).obligacion_id=i)},{default:n(()=>[s(e(De),null,{default:n(()=>[s(e(ze),{placeholder:"Selecciona una obligación"})]),_:1}),s(e(Me),null,{default:n(()=>[(l(!0),u(S,null,D($.obligaciones,i=>(l(),b(e(Ie),{key:i.id,value:i.id},{default:n(()=>[p(v(i.titulo),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"]),e(o).errors.obligacion_id?(l(),u("p",st,v(e(o).errors.obligacion_id),1)):g("",!0)]),r("div",rt,[s(e(j),null,{default:n(()=>[...t[11]||(t[11]=[p("Tipo de Evidencia *",-1)])]),_:1}),r("div",nt,[(l(!0),u(S,null,D($.tiposEvidencia,i=>(l(),b(e(x),{key:i.value,onClick:d=>e(o).tipo_evidencia=i.value,variant:e(o).tipo_evidencia===i.value?"default":"outline",class:"h-20 flex flex-col gap-2"},{default:n(()=>[(l(),b(Y(i.value==="imagen"?e(W):i.value==="video"?e(L):i.value==="audio"?e(G):e(U)),{class:"h-6 w-6"})),r("span",null,v(i.label),1)]),_:2},1032,["onClick","variant"]))),128))]),e(o).errors.tipo_evidencia?(l(),u("p",lt,v(e(o).errors.tipo_evidencia),1)):g("",!0)]),e(o).tipo_evidencia?(l(),u("div",dt,[s(e(j),null,{default:n(()=>[...t[12]||(t[12]=[p("Archivo de Evidencia *",-1)])]),_:1}),k.value>0?(l(),u("div",ct,[r("div",ut,[t[13]||(t[13]=r("span",{class:"text-sm font-medium"},"Archivos subidos",-1)),s(e(Ge),{variant:"outline"},{default:n(()=>[p(v(k.value)+"/10",1)]),_:1})]),r("div",mt,[(l(!0),u(S,null,D(C.value,(i,d)=>(l(),u("div",{key:d,class:"flex items-center gap-2"},[(l(),b(Y(d==="imagen"?e(W):d==="video"?e(L):d==="audio"?e(G):e(U)),{class:"h-4 w-4 text-muted-foreground"})),r("span",pt,v(i.count)+" "+v(d),1)]))),128))])])):g("",!0),e(o).tipo_evidencia!=="documento"?(l(),u("div",vt,[r("div",ft,[y.value?(l(),b(e(x),{key:1,onClick:O,variant:"destructive",class:"flex-1"},{default:n(()=>[...t[14]||(t[14]=[p(" Detener ",-1)])]),_:1})):(l(),b(e(x),{key:0,onClick:pe,variant:"outline",class:"flex-1"},{default:n(()=>[s(e(Ke),{class:"mr-2 h-4 w-4"}),p(" "+v(e(o).tipo_evidencia==="audio"?"Grabar Audio":"Capturar"),1)]),_:1}))]),y.value&&(e(o).tipo_evidencia==="imagen"||e(o).tipo_evidencia==="video")?(l(),u("video",{key:0,ref_key:"videoElement",ref:F,srcObject:E.value,autoplay:"",playsinline:"",muted:"",class:"w-full rounded-lg border"},null,8,_t)):g("",!0),y.value&&e(o).tipo_evidencia==="imagen"?(l(),b(e(x),{key:1,onClick:ve,class:"w-full"},{default:n(()=>[...t[15]||(t[15]=[p(" Tomar Foto ",-1)])]),_:1})):g("",!0)])):g("",!0),s(Le,{modelValue:N.value,"onUpdate:modelValue":t[2]||(t[2]=i=>N.value=i),onFilesSelected:_e,label:"",description:`Selecciona archivos desde tu dispositivo (${k.value}/10 archivos)`,required:!0,multiple:!0,"max-files":10,"max-file-size":(m=ue.value)==null?void 0:m.maxSize,accept:"image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx",error:e(o).errors.archivo_path||e(o).errors.archivos_paths,disabled:e(o).processing,module:"evidencias","field-id":e(o).tipo_evidencia||"archivo","auto-upload":!1},null,8,["modelValue","description","max-file-size","error","disabled","field-id"])])):g("",!0),r("div",ht,[s(e(j),null,{default:n(()=>[...t[16]||(t[16]=[p("Entregables Relacionados",-1)])]),_:1}),s(e(Z),null,{default:n(()=>[...t[17]||(t[17]=[p(" Selecciona los entregables del proyecto que se relacionan con esta evidencia ",-1)])]),_:1}),r("div",gt,[(l(!0),u(S,null,D($.entregables,i=>(l(),u("div",{key:i.id,class:"flex items-start space-x-3"},[s(e(Pe),{id:`entregable-${i.id}`,checked:e(o).entregable_ids.includes(i.id),"onUpdate:checked":d=>{d?e(o).entregable_ids.push(i.id):e(o).entregable_ids=e(o).entregable_ids.filter(f=>f!==i.id)}},null,8,["id","checked","onUpdate:checked"]),r("div",bt,[s(e(j),{for:`entregable-${i.id}`,class:"text-sm font-normal cursor-pointer"},{default:n(()=>[p(v(i.nombre)+" ",1),r("span",xt," Hito: "+v(i.hito)+" "+v(i.fecha_fin?` • Vence: ${i.fecha_fin}`:""),1)]),_:2},1032,["for"])])]))),128))])]),r("div",yt,[s(e(j),{htmlFor:"descripcion"},{default:n(()=>[...t[18]||(t[18]=[p("Descripción",-1)])]),_:1}),s(e(Oe),{id:"descripcion",modelValue:e(o).descripcion,"onUpdate:modelValue":t[3]||(t[3]=i=>e(o).descripcion=i),placeholder:"Describe brevemente la evidencia adjuntada",rows:"3"},null,8,["modelValue"]),e(o).errors.descripcion?(l(),u("p",wt,v(e(o).errors.descripcion),1)):g("",!0)])]}),_:1})]),_:1})]),(l(),b(Ee,{to:"body"},[s(je,{name:"slide-up"},{default:n(()=>[r("div",kt,[r("div",St,[r("div",$t,[r("div",Ct,[r("div",Et,[s(e(x),{variant:"outline",type:"button",onClick:be,class:"backdrop-blur-sm flex-shrink-0 text-xs sm:text-sm py-2 px-3"},{default:n(()=>[s(e(Je),{class:"h-4 w-4"}),t[19]||(t[19]=r("span",{class:"ml-2"},"Ocultar sidebar",-1))]),_:1})]),r("div",jt,[r("div",Vt,[s(e(Ue),{modelValue:M.value.porcentaje,class:"flex-1"},null,8,["modelValue"]),r("span",Ft,v(M.value.llenos)+" / "+v(M.value.total),1)]),t[20]||(t[20]=r("p",{class:"text-xs text-muted-foreground mt-1 text-center hidden sm:block"}," Campos completados ",-1))]),r("div",At,[s(e(x),{onClick:he,disabled:e(z),variant:"outline",class:"backdrop-blur-sm flex-1 sm:flex-none text-xs sm:text-sm py-2 px-3"},{default:n(()=>[e(z)?(l(),u(S,{key:0},[s(e(ee),{class:"mr-2 h-4 w-4 animate-spin"}),t[21]||(t[21]=p(" Guardando... ",-1))],64)):(l(),u(S,{key:1},[s(e(Qe),{class:"mr-2 h-4 w-4"}),t[22]||(t[22]=p(" Guardar borrador ",-1))],64))]),_:1},8,["disabled"]),s(e(x),{onClick:ge,disabled:!Q.value||e(o).processing,class:"bg-green-600 hover:bg-green-700 text-white border-green-600 hover:border-green-700 disabled:bg-gray-400 disabled:border-gray-400 flex-1 sm:flex-none text-xs sm:text-sm py-2 px-3"},{default:n(()=>[s(e(te),{class:"h-4 w-4"}),t[23]||(t[23]=r("span",{class:"ml-2 whitespace-nowrap"},"Subir Evidencia",-1))]),_:1},8,["disabled"])])])])])])]),_:1})]))]}),_:1})],64))}}),Oo=Xe(Tt,[["__scopeId","data-v-0b1912a4"]]);export{Oo as default};
