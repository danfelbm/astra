import{r as b,a as U,d as ee,c as P,i as v,e as c,g as r,f as _,j as g,w as x,h as j,t as h,u as n,n as H,F as O,k as G,b as z,l as R,s as te}from"./app-BY-r2Ws5.js";import{_ as T}from"./createLucideIcon-CuqvJpoP.js";import{c as se,_ as A}from"./CardTitle.vue_vue_type_script_setup_true_lang-CAAlIxJ_.js";import{_ as D}from"./Label.vue_vue_type_script_setup_true_lang-DbHCruY6.js";import{U as ae}from"./upload-D0Ijpzfr.js";import{F as K}from"./file-CHjkYlt4.js";import{E as oe}from"./eye-JtFQHEV4.js";import{D as le}from"./download-CnAcELYQ.js";import{X}from"./x-JNLCp3Uv.js";function re(){const S=b(!1),C=b({}),B=b(new Map),s=()=>{const o=window.location.pathname;return o.startsWith("/admin")?"/admin":o.startsWith("/miembro")?"/miembro":""};return{isUploading:S,uploadProgress:C,uploadErrors:B,uploadFiles:async(o,t)=>{var u,p;S.value=!0,B.value.clear();const l=new FormData;o.forEach(f=>{l.append("files[]",f)}),l.append("module",t.module),l.append("field_id",t.fieldId);try{const f=await U.post(`${s()}/api/files/upload`,l,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:k=>{if(k.total){const E=Math.round(k.loaded*100/k.total);o.forEach(M=>{C.value[M.name]=E,t.onProgress&&t.onProgress(M.name,E)})}}});if(f.data.success)return t.onSuccess&&t.onSuccess(f.data.files),f.data.files;throw new Error(f.data.message||"Error al subir archivos")}catch(f){const k=((p=(u=f.response)==null?void 0:u.data)==null?void 0:p.message)||f.message||"Error desconocido al subir archivos";throw o.forEach(E=>{B.value.set(E.name,k)}),t.onError&&t.onError(f),f}finally{S.value=!1,setTimeout(()=>{C.value={}},2e3)}},deleteFile:async o=>{try{return(await U.delete(`${s()}/api/files/delete`,{data:{path:o}})).data.success}catch(t){return console.error("Error al eliminar archivo:",t),!1}},downloadFile:async(o,t)=>{try{const l=await U.get(`${s()}/api/files/download`,{params:{path:o},responseType:"blob"}),u=window.URL.createObjectURL(new Blob([l.data])),p=document.createElement("a");p.href=u,p.setAttribute("download",t||o.split("/").pop()||"archivo"),document.body.appendChild(p),p.click(),p.remove(),window.URL.revokeObjectURL(u)}catch(l){throw console.error("Error al descargar archivo:",l),l}},getFileInfo:async o=>{try{const t=await U.get(`${s()}/api/files/info`,{params:{path:o}});return t.data.success?t.data.file:null}catch(t){return console.error("Error al obtener información del archivo:",t),null}},validateFileType:(o,t)=>{var p;const l=t.split(",").map(f=>f.trim().toLowerCase()),u="."+((p=o.name.split(".").pop())==null?void 0:p.toLowerCase());return l.some(f=>f===u)},validateFileSize:(o,t)=>{const l=t*1024*1024;return o.size<=l},formatFileSize:o=>{if(o===0)return"0 Bytes";const t=1024,l=["Bytes","KB","MB","GB"],u=Math.floor(Math.log(o)/Math.log(t));return Math.round(o/Math.pow(t,u)*100)/100+" "+l[u]}}}const ne={class:"space-y-2"},ie={key:0,class:"text-red-500 ml-1"},de={key:0,class:"text-sm text-muted-foreground"},ce={class:"flex flex-col items-center justify-center text-center"},ue={class:"text-sm font-medium mb-1"},me={class:"text-xs text-muted-foreground"},pe=["multiple","accept","disabled"],fe={key:0,class:"space-y-2"},he={class:"space-y-2"},ve={class:"flex items-center justify-between"},ge={class:"flex items-center space-x-3 flex-1"},ye={class:"min-w-0 flex-1"},we={class:"text-sm font-medium truncate"},_e={key:0,class:"text-xs text-muted-foreground"},xe={class:"flex items-center space-x-2"},Fe={key:1,class:"space-y-2"},be={class:"space-y-2"},ke={class:"space-y-2"},ze={class:"flex items-center justify-between"},Ee={class:"flex items-center space-x-3 flex-1"},Se=["src","alt"],Ce={class:"min-w-0 flex-1"},Be={class:"text-sm font-medium truncate"},Ve={class:"text-xs text-muted-foreground"},$e={key:0,class:"w-full space-y-1"},Me={class:"flex justify-between text-xs text-muted-foreground"},Ue={class:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden"},Te={key:1,class:"text-xs text-red-600"},Ie={key:2,class:"text-sm text-red-600"},Le={key:3,class:"text-xs text-muted-foreground"},Pe={key:0},Ge=ee({__name:"FileUploadField",props:{modelValue:{},label:{},description:{},required:{type:Boolean,default:!1},multiple:{type:Boolean,default:!1},maxFiles:{default:5},maxFileSize:{default:10},accept:{default:".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif"},error:{},disabled:{type:Boolean,default:!1},showPreview:{type:Boolean,default:!0},module:{default:"postulaciones"},fieldId:{default:"file"},autoUpload:{type:Boolean,default:!0}},emits:["update:modelValue","filesSelected"],setup(S,{expose:C,emit:B}){const s=S,V=B,{isUploading:$,uploadFiles:N,deleteFile:W,formatFileSize:I}=re(),L=b(),y=b([]),o=b(new Map),t=b(new Map),l=b(new Map);b(!1);const u=P(()=>s.modelValue?s.modelValue.length>0&&typeof s.modelValue[0]=="string"?s.modelValue.map((e,i)=>({id:`existing_${i}`,name:e.split("/").pop()||"archivo",size:0,path:e,url:`/storage/${e}`})):s.modelValue:[]),p=P(()=>{const e=u.value.length+y.value.length;return s.multiple?e<s.maxFiles:e===0}),f=P(()=>s.accept.split(",").map(e=>e.trim().toLowerCase())),k=()=>{var e;!s.disabled&&p.value&&((e=L.value)==null||e.click())},E=e=>{var m;if(s.accept.includes("/*")){const d=s.accept.split(",").map(w=>w.trim());for(const w of d)if(w.includes("/*")){const F=w.replace("/*","");if(e.type.startsWith(F+"/"))return!0}}const i="."+((m=e.name.split(".").pop())==null?void 0:m.toLowerCase());return f.value.some(d=>d===i)},M=e=>{const i=s.maxFileSize*1024*1024;return e.size<=i},J=async e=>{const i=e.target,a=Array.from(i.files||[]);l.value.clear();const m=[];if(a.forEach(d=>{if(!E(d)){l.value.set(d.name,`Tipo de archivo no permitido. Solo se permiten: ${s.accept}`);return}if(!M(d)){l.value.set(d.name,`El archivo excede el tamaño máximo de ${s.maxFileSize}MB`);return}const w=u.value.length+m.length;if(s.multiple&&w>=s.maxFiles){l.value.set(d.name,`Se ha alcanzado el límite de ${s.maxFiles} archivos`);return}if(m.push(d),d.type.startsWith("image/")&&s.showPreview){const F=new FileReader;F.onload=Z=>{var q;o.value.set(d.name,(q=Z.target)==null?void 0:q.result)},F.readAsDataURL(d)}}),s.multiple?y.value=[...y.value,...m]:y.value=m.slice(0,1),m.length>0&&(V("filesSelected",m),s.autoUpload&&s.module&&s.fieldId))try{const d=await N(m,{module:s.module,fieldId:s.fieldId,onProgress:(w,F)=>{t.value.set(w,F)},onSuccess:w=>{const F=[...u.value,...w];V("update:modelValue",F),y.value=[],o.value.clear()},onError:w=>{console.error("Error al subir archivos:",w),m.forEach(F=>{l.value.set(F.name,"Error al subir el archivo")})}})}catch(d){console.error("Error en carga automática:",d)}i.value=""},Q=e=>{const i=y.value[e];o.value.delete(i.name),t.value.delete(i.name),l.value.delete(i.name),y.value.splice(e,1)},Y=async e=>{const i=u.value[e];if(i.path)try{await W(i.path)}catch(m){console.error("Error al eliminar archivo del servidor:",m)}const a=[...u.value];if(a.splice(e,1),typeof s.modelValue[0]=="string"){const m=a.map(d=>d.path).filter(Boolean);V("update:modelValue",m)}else V("update:modelValue",a)};return C({selectedFiles:y,uploadProgress:t,uploadErrors:l}),(e,i)=>(c(),v("div",ne,[r("div",null,[_(n(D),{class:"text-sm font-medium"},{default:x(()=>[j(h(e.label)+" ",1),e.required?(c(),v("span",ie,"*")):g("",!0)]),_:1}),e.description?(c(),v("p",de,h(e.description),1)):g("",!0)]),_(n(A),{class:H(["border-2 border-dashed hover:border-primary/50 transition-colors cursor-pointer",{"opacity-50 cursor-not-allowed":e.disabled||!p.value||n($),"border-red-300":e.error}]),onClick:k},{default:x(()=>[_(n(se),{class:"p-6"},{default:x(()=>[r("div",ce,[_(n(ae),{class:"h-10 w-10 text-muted-foreground mb-3"}),r("p",ue,h(n($)?"Subiendo archivos...":p.value?"Haz clic para seleccionar archivos":"Límite de archivos alcanzado"),1),r("p",me,h(e.multiple?`Hasta ${e.maxFiles} archivos`:"Un archivo")+" • Máx. "+h(e.maxFileSize)+"MB • Formatos: "+h(e.accept),1)])]),_:1})]),_:1},8,["class"]),r("input",{ref_key:"fileInputRef",ref:L,type:"file",multiple:e.multiple,accept:e.accept,disabled:e.disabled||!p.value||n($),onChange:J,class:"hidden"},null,40,pe),u.value.length>0?(c(),v("div",fe,[_(n(D),{class:"text-xs text-muted-foreground"},{default:x(()=>[...i[0]||(i[0]=[j("Archivos cargados:",-1)])]),_:1}),r("div",he,[(c(!0),v(O,null,G(u.value,(a,m)=>(c(),z(n(A),{key:a.id,class:"p-3"},{default:x(()=>[r("div",ve,[r("div",ge,[_(n(K),{class:"h-5 w-5 text-muted-foreground flex-shrink-0"}),r("div",ye,[r("p",we,h(a.name),1),a.size>0?(c(),v("p",_e,h(n(I)(a.size)),1)):g("",!0)])]),r("div",xe,[a.url?(c(),z(n(T),{key:0,type:"button",variant:"ghost",size:"sm",onClick:R(d=>e.window.open(a.url,"_blank"),["stop"])},{default:x(()=>[_(n(oe),{class:"h-4 w-4"})]),_:2},1032,["onClick"])):g("",!0),a.url?(c(),z(n(T),{key:1,type:"button",variant:"ghost",size:"sm",onClick:R(d=>e.window.open(a.url+"?download=true","_blank"),["stop"])},{default:x(()=>[_(n(le),{class:"h-4 w-4"})]),_:2},1032,["onClick"])):g("",!0),e.disabled?g("",!0):(c(),z(n(T),{key:2,type:"button",variant:"ghost",size:"sm",onClick:R(d=>Y(m),["stop"])},{default:x(()=>[_(n(X),{class:"h-4 w-4 text-destructive"})]),_:2},1032,["onClick"]))])])]),_:2},1024))),128))])])):g("",!0),y.value.length>0?(c(),v("div",Fe,[_(n(D),{class:"text-xs text-muted-foreground"},{default:x(()=>[j(h(t.value.size>0?"Subiendo archivos...":"Archivos pendientes de carga:"),1)]),_:1}),r("div",be,[(c(!0),v(O,null,G(y.value,(a,m)=>(c(),z(n(A),{key:a.name,class:H(["p-3",{"border-red-300":l.value.has(a.name)}])},{default:x(()=>[r("div",ke,[r("div",ze,[r("div",Ee,[o.value.has(a.name)&&e.showPreview?(c(),v("img",{key:0,src:o.value.get(a.name),alt:a.name,class:"h-10 w-10 object-cover rounded flex-shrink-0"},null,8,Se)):(c(),z(n(K),{key:1,class:"h-5 w-5 text-muted-foreground flex-shrink-0"})),r("div",Ce,[r("p",Be,h(a.name),1),r("p",Ve,h(n(I)(a.size)),1)])]),e.disabled?g("",!0):(c(),z(n(T),{key:0,type:"button",variant:"ghost",size:"sm",onClick:d=>Q(m)},{default:x(()=>[_(n(X),{class:"h-4 w-4 text-destructive"})]),_:2},1032,["onClick"]))]),t.value.has(a.name)?(c(),v("div",$e,[r("div",Me,[i[1]||(i[1]=r("span",null,"Subiendo...",-1)),r("span",null,h(t.value.get(a.name))+"%",1)]),r("div",Ue,[r("div",{class:"bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all duration-300 ease-out",style:te({width:`${t.value.get(a.name)}%`})},[...i[2]||(i[2]=[r("div",{class:"h-full bg-white/30 animate-pulse"},null,-1)])],4)])])):g("",!0),l.value.has(a.name)?(c(),v("p",Te,h(l.value.get(a.name)),1)):g("",!0)])]),_:2},1032,["class"]))),128))])])):g("",!0),e.error?(c(),v("p",Ie,h(e.error),1)):g("",!0),!e.disabled&&p.value?(c(),v("div",Le,[e.multiple?(c(),v("p",Pe,h(u.value.length+y.value.length)+" de "+h(e.maxFiles)+" archivos ",1)):g("",!0)])):g("",!0)]))}});export{Ge as _,re as u};
