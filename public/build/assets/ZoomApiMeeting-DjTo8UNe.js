import{a as P,_ as I}from"./index-ClIauVf2.js";import{_ as S}from"./AlertTitle.vue_vue_type_script_setup_true_lang-CWC8zRVs.js";import{_ as A}from"./createLucideIcon-BxKKonsI.js";import{a as T,b as N,c as h,_ as R}from"./CardTitle.vue_vue_type_script_setup_true_lang-FpzMwRGj.js";import{_ as B}from"./CardDescription.vue_vue_type_script_setup_true_lang-BCccZNs6.js";import{t as y}from"./index-GrVQiRvY.js";import{d as ce,k as w,c as k,p as me,O as fe,a as E,o as u,f as n,i as g,j as d,b as s,u as a,e as t,n as pe,g as l,t as x,q as D}from"./app-CZVAIQ2j.js";import{V as G}from"./video-DbNfK7es.js";import{R as F}from"./refresh-cw-mqDHMj3d.js";import{L as O}from"./loader-circle-uyPXCWhW.js";import{C as U}from"./circle-alert-UNJr2893.js";import{I as W}from"./info-z8j0yHt_.js";import{C as ge}from"./circle-check-B810eUYk.js";import{C as X}from"./clock-p5N4RGrV.js";import{E as ee}from"./external-link-CyDMa5Xd.js";import{_ as ve}from"./_plugin-vue_export-helper-DlAUqK2U.js";const _e={class:"space-y-4"},be={class:"flex items-center gap-2 mb-4"},xe={key:0,class:"text-center py-8"},ye={class:"whitespace-pre-wrap text-gray-700"},we={key:3},ke={class:"flex gap-2"},Ee={key:0},Ce={class:"text-sm"},ze={key:1},Pe={class:"text-sm font-mono bg-gray-50 px-2 py-1 rounded"},Ie={class:"pt-2"},Se={key:0,class:"mb-3"},Ae={class:"space-y-3"},Le={class:"flex gap-2"},Me={key:0,class:"text-center"},Te={class:"text-xs text-muted-foreground mb-2"},Ne=["href"],he=5*60*1e3,Re=ce({__name:"ZoomApiMeeting",props:{asambleaId:{}},setup(ae){const j=ae,v=w(!1),C=w(!1),f=w(!1),z=w(null),V=w(null),c=w(null),i=w(null),{route:$}=window,L=async(o=!1)=>{try{o||(v.value=!0),c.value=null;const r=(await D.get($("user.api.zoom.registrants.status",j.asambleaId))).data;r.success?(f.value&&!r.existing_registration&&!r.processing&&(r.processing=!0),i.value=r,r.existing_registration&&r.existing_registration.status==="completed"||r.existing_registration&&r.existing_registration.status==="failed"?M():(r.processing||f.value)&&(z.value||q())):c.value=r.error||"Error obteniendo estado"}catch(e){console.error("Error fetching status:",e),c.value="Error de conexión"}finally{v.value=!1}},se=async()=>{c.value=null,i.value.existing_registration=null,await H()},H=async()=>{var o,e;try{C.value=!0,c.value=null;const r=await D.post($("user.api.zoom.registrants.register"),{asamblea_id:j.asambleaId});r.data.success?r.data.processing?(f.value=!0,i.value=r.data,q(),y.success("🔄 Procesando registro",{description:"Se está generando tu enlace de videoconferencia...",duration:4e3})):await L():c.value=r.data.error||"Error registrando usuario"}catch(r){console.error("Error registering user:",r),(e=(o=r.response)==null?void 0:o.data)!=null&&e.error?c.value=r.response.data.error:c.value="Error de conexión"}finally{C.value=!1}},te=async()=>{try{v.value=!0,c.value=null;const e=(await D.delete($("user.api.zoom.registrants.destroy",j.asambleaId))).data;e.success?await L():c.value=e.error||"Error cancelando registro"}catch(o){console.error("Error canceling registration:",o),c.value="Error de conexión"}finally{v.value=!1}},re=async()=>{var o,e;try{(await D.post($("user.asambleas.marcar-asistencia",j.asambleaId))).data.success&&y.success("✅ Asistencia registrada",{description:"Tu asistencia ha sido marcada exitosamente",duration:3e3})}catch(r){console.error("Error marcando asistencia:",r),((o=r.response)==null?void 0:o.status)===400?y.warning("La asamblea no está en curso",{duration:3e3}):((e=r.response)==null?void 0:e.status)===403?y.error("No eres participante de esta asamblea",{duration:3e3}):y.error("Error al registrar asistencia",{description:"Tu asistencia no pudo ser registrada, pero puedes unirte a la reunión",duration:4e3})}},oe=()=>{var p;const o=(p=b.value)==null?void 0:p.zoom_join_url;if(!o)return;let e=!1;const r=window.open(o,"_blank","noopener,noreferrer");(!r||r.closed||typeof r.closed>"u")&&(e=!0,setTimeout(()=>{const m=window.open(o,"_blank");if(!m||m.closed){const _=document.createElement("a");_.href=o,_.target="_blank",_.rel="noopener noreferrer",_.style.display="none",document.body.appendChild(_),_.click(),document.body.removeChild(_),le()}},0)),re().catch(m=>{console.error("Error marcando asistencia:",m)}),e&&y.warning("⚠️ Tu navegador bloqueó la ventana emergente",{description:"Usa el enlace manual debajo del botón para unirte a la reunión",duration:5e3})},le=()=>{y.error("No se pudo abrir automáticamente",{description:"Por favor usa el enlace manual debajo del botón",duration:6e3})},J=()=>/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),q=()=>{M(),V.value=Date.now(),z.value=setInterval(async()=>{try{if(V.value&&Date.now()-V.value>he){console.warn("Polling timeout alcanzado (5 minutos)"),c.value="El proceso está tomando más tiempo del esperado. Por favor, recarga la página.",M();return}await L(!0)}catch(o){console.error("Error en polling:",o)}},2e3)},M=()=>{z.value&&(clearInterval(z.value),z.value=null),V.value=null,f.value=!1},b=k(()=>{var e;if(!((e=i.value)!=null&&e.existing_registration))return null;const o=i.value.existing_registration;return{...o,statusColor:o.status==="completed"?"bg-green-100 text-green-800":o.status==="pending"?"bg-yellow-100 text-yellow-800":o.status==="failed"?"bg-red-100 text-red-800":"bg-gray-100 text-gray-800"}}),Z=k(()=>{var o,e;return((e=(o=i.value)==null?void 0:o.existing_registration)==null?void 0:e.status)==="failed"}),ne=k(()=>{var e,r;if(!Z.value)return null;const o=((r=(e=i.value)==null?void 0:e.existing_registration)==null?void 0:r.error_message)||"Error desconocido al registrar";return o.toLowerCase().includes("rate limit")?"Se ha alcanzado el límite diario de registros. Por favor, intenta nuevamente mañana.":o}),ie=k(()=>{var r,p;if(!Z.value)return!1;const o=((p=(r=i.value)==null?void 0:r.existing_registration)==null?void 0:p.error_message)||"";return!["no existe","capacidad máxima","no tiene permisos"].some(m=>o.toLowerCase().includes(m))}),ue=k(()=>{var o,e,r;return Z.value?!1:((o=i.value)==null?void 0:o.can_register)&&!((e=i.value)!=null&&e.existing_registration)&&!f.value&&!((r=i.value)!=null&&r.processing)}),Y=k(()=>{var r,p,m;const o=(r=i.value)==null?void 0:r.existing_registration,e=((m=(p=i.value)==null?void 0:p.asamblea)==null?void 0:m.estado)==="en_curso";return o&&o.status==="completed"&&o.zoom_join_url&&e}),de=k(()=>{var o,e;return((e=(o=i.value)==null?void 0:o.asamblea)==null?void 0:e.estado)==="en_curso"});return me(()=>{L()}),fe(()=>{M()}),(o,e)=>{var r,p,m,_,K,Q;return u(),E("div",_e,[n("div",be,[s(a(G),{class:"h-5 w-5 text-blue-600"}),e[0]||(e[0]=n("h3",{class:"text-lg font-semibold"},"Videoconferencia",-1)),s(a(A),{variant:"ghost",size:"sm",onClick:L,disabled:v.value,class:"ml-auto"},{default:t(()=>[s(a(F),{class:pe(["h-4 w-4",{"animate-spin":v.value}])},null,8,["class"])]),_:1},8,["disabled"])]),v.value&&!i.value?(u(),E("div",xe,[s(a(O),{class:"h-8 w-8 animate-spin mx-auto mb-2"}),e[1]||(e[1]=n("p",{class:"text-muted-foreground"},"Cargando información...",-1))])):g("",!0),c.value?(u(),d(a(I),{key:1,variant:"destructive"},{default:t(()=>[s(a(U),{class:"h-4 w-4"}),s(a(S),null,{default:t(()=>[...e[2]||(e[2]=[l("Error",-1)])]),_:1}),s(a(P),null,{default:t(()=>[l(x(c.value),1)]),_:1})]),_:1})):g("",!0),(p=(r=i.value)==null?void 0:r.asamblea)!=null&&p.zoom_api_message_enabled&&((_=(m=i.value)==null?void 0:m.asamblea)!=null&&_.zoom_api_message)?(u(),d(a(R),{key:2,class:"mb-4 border-blue-200 bg-blue-50"},{default:t(()=>[s(a(T),null,{default:t(()=>[s(a(N),{class:"flex items-center gap-2 text-blue-700"},{default:t(()=>[s(a(W),{class:"h-5 w-5"}),e[3]||(e[3]=l(" Información Importante ",-1))]),_:1})]),_:1}),s(a(h),null,{default:t(()=>[n("p",ye,x(i.value.asamblea.zoom_api_message),1)]),_:1})]),_:1})):g("",!0),i.value&&!v.value?(u(),E("div",we,[f.value||i.value.processing?(u(),d(a(R),{key:0,class:"border-blue-200 bg-blue-50"},{default:t(()=>[s(a(T),null,{default:t(()=>[s(a(N),{class:"flex items-center gap-2 text-blue-700"},{default:t(()=>[s(a(O),{class:"h-5 w-5 animate-spin"}),e[4]||(e[4]=l(" Procesando registro ",-1))]),_:1}),s(a(B),null,{default:t(()=>[...e[5]||(e[5]=[l(" Se está generando tu enlace personal de videoconferencia... ",-1)])]),_:1})]),_:1}),s(a(h),null,{default:t(()=>[...e[6]||(e[6]=[n("div",{class:"space-y-2"},[n("div",{class:"text-sm text-blue-600"},[l(" ✅ Validaciones completadas"),n("br"),l(" 🔄 Registrando en Zoom..."),n("br"),l(" 📧 Preparando notificación por email ")]),n("p",{class:"text-xs text-muted-foreground"}," Este proceso toma entre 1-2 minutos. La página se actualizará automáticamente. ")],-1)])]),_:1})]),_:1})):Z.value?(u(),d(a(R),{key:1,class:"border-red-200 bg-red-50"},{default:t(()=>[s(a(T),null,{default:t(()=>[s(a(N),{class:"flex items-center gap-2 text-red-700"},{default:t(()=>[s(a(U),{class:"h-5 w-5"}),e[7]||(e[7]=l(" Error en el registro ",-1))]),_:1}),s(a(B),{class:"text-red-600"},{default:t(()=>[...e[8]||(e[8]=[l(" No se pudo completar tu registro en la videoconferencia ",-1)])]),_:1})]),_:1}),s(a(h),{class:"space-y-4"},{default:t(()=>[s(a(I),{variant:"destructive"},{default:t(()=>[s(a(U),{class:"h-4 w-4"}),s(a(S),null,{default:t(()=>[...e[9]||(e[9]=[l("Detalles del error",-1)])]),_:1}),s(a(P),null,{default:t(()=>[l(x(ne.value),1)]),_:1})]),_:1}),n("div",ke,[ie.value?(u(),d(a(A),{key:0,onClick:se,disabled:C.value||f.value,class:"flex-1"},{default:t(()=>[C.value||f.value?(u(),d(a(F),{key:0,class:"mr-2 h-4 w-4 animate-spin"})):(u(),d(a(F),{key:1,class:"mr-2 h-4 w-4"})),e[10]||(e[10]=l(" Reintentar registro ",-1))]),_:1},8,["disabled"])):(u(),d(a(A),{key:1,variant:"outline",disabled:"",class:"flex-1"},{default:t(()=>[...e[11]||(e[11]=[l(" No se puede reintentar ",-1)])]),_:1}))]),e[12]||(e[12]=n("p",{class:"text-xs text-muted-foreground"}," Si el problema persiste, contacta al administrador. ",-1))]),_:1})]),_:1})):b.value&&b.value.status==="completed"?(u(),d(a(R),{key:2,class:"border-green-200"},{default:t(()=>[s(a(T),null,{default:t(()=>[s(a(N),{class:"flex items-center gap-2 text-green-700"},{default:t(()=>[s(a(ge),{class:"h-5 w-5"}),e[13]||(e[13]=l(" Ya estás registrado ",-1))]),_:1}),s(a(B),null,{default:t(()=>[...e[14]||(e[14]=[l(" Tienes acceso a esta videoconferencia ",-1)])]),_:1})]),_:1}),s(a(h),{class:"space-y-4"},{default:t(()=>[b.value.zoom_start_time?(u(),E("div",Ee,[e[15]||(e[15]=n("p",{class:"text-sm font-medium text-muted-foreground"},"Hora de inicio",-1)),n("p",Ce,x(new Date(b.value.zoom_start_time).toLocaleString("es-ES")),1)])):g("",!0),b.value.zoom_registrant_id?(u(),E("div",ze,[e[16]||(e[16]=n("p",{class:"text-sm font-medium text-muted-foreground"},"Token único de ingreso",-1)),n("p",Pe,x(b.value.zoom_registrant_id),1)])):g("",!0),n("div",Ie,[de.value?g("",!0):(u(),E("div",Se,[s(a(I),null,{default:t(()=>[s(a(X),{class:"h-4 w-4"}),s(a(S),null,{default:t(()=>[...e[17]||(e[17]=[l("Reunión no disponible",-1)])]),_:1}),s(a(P),null,{default:t(()=>[l(' La videoconferencia solo está disponible cuando la asamblea está "En Curso". Estado actual: '+x(i.value.asamblea.estado_label),1)]),_:1})]),_:1})])),n("div",Ae,[n("div",Le,[Y.value?(u(),d(a(A),{key:0,onClick:oe,class:"flex-1 bg-green-600 hover:bg-green-700 text-white"},{default:t(()=>[s(a(ee),{class:"mr-2 h-4 w-4"}),e[18]||(e[18]=l(" Unirse a la Videoconferencia ",-1))]),_:1})):g("",!0),s(a(A),{variant:"outline",onClick:te,disabled:v.value,size:"sm",class:"hidden"},{default:t(()=>[v.value?(u(),d(a(O),{key:0,class:"mr-2 h-4 w-4 animate-spin"})):g("",!0),e[19]||(e[19]=l(" Cancelar ",-1))]),_:1},8,["disabled"])]),Y.value&&b.value.zoom_join_url?(u(),E("div",Me,[n("p",Te,x(J()?"¿Problemas para abrir? Toca el enlace abajo:":"¿No se abre automáticamente?"),1),n("a",{href:b.value.zoom_join_url,target:"_blank",rel:"noopener noreferrer",class:"inline-flex items-center gap-1 text-sm text-blue-600 hover:text-blue-800 underline"},[s(a(ee),{class:"h-3 w-3"}),e[20]||(e[20]=l(" Abrir Zoom manualmente ",-1))],8,Ne)])):g("",!0)])])]),_:1})]),_:1})):ue.value?(u(),d(a(R),{key:3},{default:t(()=>[s(a(T),null,{default:t(()=>[s(a(N),{class:"flex items-center gap-2"},{default:t(()=>[s(a(G),{class:"h-5 w-5"}),e[21]||(e[21]=l(" Generar Acceso Personal ",-1))]),_:1}),s(a(B),null,{default:t(()=>[...e[22]||(e[22]=[l(" Genera tu link personal para acceder a la videoconferencia ",-1)])]),_:1})]),_:1}),s(a(h),null,{default:t(()=>[s(a(A),{onClick:H,disabled:C.value||f.value,class:"w-full"},{default:t(()=>[C.value||f.value?(u(),d(a(O),{key:0,class:"mr-2 h-4 w-4 animate-spin"})):(u(),d(a(G),{key:1,class:"mr-2 h-4 w-4"})),l(" "+x(f.value?"Procesando...":"Generar link de ingreso"),1)]),_:1},8,["disabled"])]),_:1})]),_:1})):(u(),d(a(I),{key:4},{default:t(()=>[s(a(X),{class:"h-4 w-4"}),s(a(S),null,{default:t(()=>[...e[23]||(e[23]=[l("No disponible",-1)])]),_:1}),s(a(P),null,{default:t(()=>[l(x(i.value.reason),1)]),_:1})]),_:1})),J()&&((Q=(K=i.value)==null?void 0:K.existing_registration)==null?void 0:Q.status)==="completed"?(u(),d(a(I),{key:5,class:"mt-4 border-blue-200 bg-blue-50"},{default:t(()=>[s(a(W),{class:"h-4 w-4 text-blue-600"}),s(a(S),{class:"text-blue-700"},{default:t(()=>[...e[24]||(e[24]=[l("Consejo para dispositivos móviles",-1)])]),_:1}),s(a(P),{class:"text-gray-700"},{default:t(()=>[...e[25]||(e[25]=[n("ul",{class:"list-disc list-inside space-y-1 mt-2 text-sm"},[n("li",null,"Si tienes la app de Zoom instalada, el enlace debería abrirla automáticamente"),n("li",null,'Si no se abre, usa el enlace manual "Abrir Zoom manualmente"'),n("li",null,"Es posible que tu navegador te pida permiso para abrir Zoom"),n("li",null,'En iOS, podrías necesitar mantener presionado el enlace y seleccionar "Abrir"')],-1)])]),_:1})]),_:1})):g("",!0),s(a(I),{variant:"destructive",class:"mt-4"},{default:t(()=>[s(a(U),{class:"h-4 w-4"}),s(a(S),null,{default:t(()=>[...e[26]||(e[26]=[l("Advertencia",-1)])]),_:1}),s(a(P),null,{default:t(()=>[...e[27]||(e[27]=[l(" Tu link es único, cuídalo, no lo compartas, si lo compartes podrías quedarte por fuera de la reunión, ya que solo se admite un usuario por link. ",-1)])]),_:1})]),_:1})])):g("",!0)])}}}),We=ve(Re,[["__scopeId","data-v-438f12b2"]]);export{We as default};
