import{d as ee,k as V,C as ae,c as I,j as y,o as m,e as l,i as _,b as t,u as a,g as r,t as v,a as g,f as c,n as N,F as E,r as T,W as se}from"./app-DOAYsCZu.js";import{_ as oe,a as le,b as U,c as D}from"./TabsTrigger.vue_vue_type_script_setup_true_lang-G03Zcb8D.js";import{a as te,b as ie,c as ne,_ as re}from"./CardTitle.vue_vue_type_script_setup_true_lang-D6eleDAW.js";import{_ as k}from"./createLucideIcon-SaHUbqll.js";import{_ as F,a as A}from"./Label.vue_vue_type_script_setup_true_lang-DyxLuJgg.js";import{_ as L,a as O,b as M,c as B,d as j}from"./SelectValue.vue_vue_type_script_setup_true_lang-DabtxXLF.js";import{_ as de}from"./Checkbox.vue_vue_type_script_setup_true_lang-Zm7j9L0W.js";import{_ as me,a as ue,b as P,c as S,d as ce,e as w}from"./TableHeader.vue_vue_type_script_setup_true_lang-BlQwDzQZ.js";import{_ as fe,a as pe}from"./index-CHwsamML.js";import{U as _e}from"./upload-Dcf_FlK6.js";import{G as ve}from"./git-branch-Ctgsc5mI.js";import{F as ge}from"./index-CwmjJmTB.js";import{C as be}from"./index-D68r5GbG.js";const ye={key:0,class:"mb-4"},ke={class:"text-sm text-muted-foreground"},$e={class:"flex items-center gap-2"},Ce={class:"flex items-center gap-2"},xe={class:"space-y-4"},Ve={class:"space-y-2"},Ie={key:0,class:"text-sm text-red-500"},Se={class:"space-y-2"},we={key:0,class:"text-sm text-red-500"},ze={class:"space-y-2"},Ee={class:"flex justify-end gap-2"},Te={key:0},Fe={key:0,class:"block mt-1"},je={key:1,class:"block mt-1"},Ne={class:"border rounded-lg overflow-x-auto"},Ue={key:0},De={key:0,class:"text-sm text-muted-foreground italic"},Ae={class:"text-sm text-muted-foreground max-w-32 truncate"},Le={class:"flex justify-between"},Oe={class:"flex gap-2"},Ze=ee({__name:"CsvImportWizard",props:{mode:{},votacionId:{},votacionTitulo:{},asambleaId:{},asambleaTitulo:{},redirectOnSuccess:{type:Boolean,default:!0}},emits:["success","cancel"],setup(R,{emit:W}){const u=R,z=W,$=V("config"),C=V(null),b=V(null),s=ae({name:"",csv_file:null,import_mode:"both",field_mappings:{},update_fields:[],votacion_id:u.votacionId||null,asamblea_id:u.asambleaId||null}),x=V(!1),q=I(()=>s.name&&s.csv_file&&s.import_mode&&b.value),G=[{value:"insert",label:"Solo añadir usuarios nuevos"},{value:"update",label:"Solo actualizar usuarios existentes"},{value:"both",label:"Añadir nuevos y actualizar existentes"}],H=I(()=>u.mode==="votacion"&&u.votacionTitulo?`Importar votantes para: ${u.votacionTitulo}`:u.mode==="asamblea"&&u.asambleaTitulo?`Importar participantes para: ${u.asambleaTitulo}`:"Nueva Importación CSV"),K=I(()=>u.mode==="votacion"?"Los usuarios importados serán asignados automáticamente a esta votación":u.mode==="asamblea"?"Los usuarios importados serán asignados automáticamente como participantes de esta asamblea":"Importa usuarios desde un archivo CSV"),X=n=>{var f;const o=(f=n.target.files)==null?void 0:f[0];o&&(C.value=o,s.csv_file=o,b.value=null)},J=async()=>{var n;if(!(!C.value||!s.name.trim())){x.value=!0;try{const e=new FormData;e.append("csv_file",C.value);const o=await fetch("/admin/imports/analyze",{method:"POST",body:e,headers:{"X-CSRF-TOKEN":((n=document.querySelector('meta[name="csrf-token"]'))==null?void 0:n.getAttribute("content"))||""}}),f=await o.json();if(o.ok){b.value=f;const d={};f.headers.forEach(p=>{const i=p.toLowerCase().trim();i.includes("nombre")||i==="name"?d[p]="name":i.includes("email")||i.includes("correo")?d[p]="email":i.includes("documento")||i.includes("cedula")||i.includes("identification")?d[p]="documento_identidad":i==="tipo_documento"||i.includes("tipo")&&i.includes("doc")?d[p]="tipo_documento":i.includes("telefono")||i.includes("phone")?d[p]="telefono":i.includes("direccion")||i.includes("address")?d[p]="direccion":i==="territorio"||i==="territorio_id"?d[p]="territorio_id":i==="departamento"||i==="departamento_id"?d[p]="departamento_id":i==="municipio"||i==="municipio_id"?d[p]="municipio_id":i==="localidad"||i==="localidad_id"?d[p]="localidad_id":i==="cargo"||i==="cargo_id"?d[p]="cargo_id":i==="rol"||i==="role"?d[p]="rol":i==="activo"||i==="active"?d[p]="activo":(i==="es_miembro"||i==="miembro")&&(d[p]="es_miembro")}),s.field_mappings=d,u.mode==="votacion"&&!s.name&&(s.name=`Importación votantes - ${new Date().toLocaleDateString()}`),$.value="mapping"}else alert(f.error||"Error al analizar archivo")}catch(e){console.error("Error:",e),alert("Error al analizar archivo")}finally{x.value=!1}}},Q=(n,e)=>{const o=String(e);!o||o==="none"?delete s.field_mappings[n]:s.field_mappings[n]=o},Y=(n,e)=>{if(e)s.update_fields.includes(n)||s.update_fields.push(n);else{const o=s.update_fields.indexOf(n);o>-1&&s.update_fields.splice(o,1)}},Z=()=>{let n="/admin/imports";u.mode==="votacion"?n=`/admin/votaciones/${u.votacionId}/imports/store`:u.mode==="asamblea"&&(n=`/admin/asambleas/${u.asambleaId}/imports/store`),console.log("Creando importación:",{url:n,mode:u.mode,name:s.name,import_mode:s.import_mode,field_mappings:s.field_mappings,update_fields:s.update_fields,csv_file:s.csv_file,asamblea_id:u.asambleaId,votacion_id:u.votacionId}),s.post(n,{preserveScroll:!0,forceFormData:!0,onSuccess:e=>{var f,d;console.log("Respuesta exitosa:",e);const o=((f=e.props.import)==null?void 0:f.id)||((d=e.props.flash)==null?void 0:d.import_id);o?(z("success",o),u.redirectOnSuccess&&se.get(`/admin/imports/${o}`)):console.error("No se recibió ID de importación en la respuesta")},onError:e=>{console.error("Error al crear importación:",e)},onFinish:()=>{console.log("Petición finalizada")}})},h=I(()=>{const n=Object.values(s.field_mappings),e=n.includes("name"),o=n.includes("email");return e&&o});return(n,e)=>(m(),y(a(re),null,{default:l(()=>[n.mode==="general"?(m(),y(a(te),{key:0},{default:l(()=>[t(a(ie),null,{default:l(()=>[r(v(H.value),1)]),_:1})]),_:1})):_("",!0),t(a(ne),{class:"p-6"},{default:l(()=>[n.mode==="votacion"?(m(),g("div",ye,[c("p",ke,v(K.value),1)])):_("",!0),t(a(oe),{modelValue:$.value,"onUpdate:modelValue":e[5]||(e[5]=o=>$.value=o),class:"w-full"},{default:l(()=>[t(a(le),{class:"grid w-full grid-cols-2"},{default:l(()=>[t(a(U),{value:"config"},{default:l(()=>[c("span",$e,[t(a(_e),{class:"h-4 w-4"}),e[6]||(e[6]=r(" Configuración "))])]),_:1}),t(a(U),{value:"mapping",disabled:!q.value},{default:l(()=>[c("span",Ce,[t(a(ve),{class:"h-4 w-4"}),e[7]||(e[7]=r(" Mapeo de Campos "))])]),_:1},8,["disabled"])]),_:1}),t(a(D),{value:"config",class:"space-y-6"},{default:l(()=>[c("div",xe,[c("div",Ve,[t(a(F),{for:"name"},{default:l(()=>e[8]||(e[8]=[r("Nombre de la Importación")])),_:1}),t(a(A),{id:"name",modelValue:a(s).name,"onUpdate:modelValue":e[0]||(e[0]=o=>a(s).name=o),placeholder:n.mode==="votacion"?"Ej: Votantes primera vuelta":"Ej: Importación militantes enero 2025",class:N({"border-red-500":a(s).errors.name})},null,8,["modelValue","placeholder","class"]),a(s).errors.name?(m(),g("p",Ie,v(a(s).errors.name),1)):_("",!0)]),c("div",Se,[t(a(F),{for:"csv_file"},{default:l(()=>e[9]||(e[9]=[r("Archivo CSV")])),_:1}),t(a(A),{id:"csv_file",type:"file",accept:".csv",onChange:X,class:N({"border-red-500":a(s).errors.csv_file})},null,8,["class"]),a(s).errors.csv_file?(m(),g("p",we,v(a(s).errors.csv_file),1)):_("",!0),e[10]||(e[10]=c("p",{class:"text-sm text-muted-foreground"}," El archivo debe contener al menos las columnas: nombre y email ",-1)),e[11]||(e[11]=c("p",{class:"text-sm text-blue-600"},[c("a",{href:"/ejemplo-usuarios.csv",download:"",class:"underline"}," 📥 Descargar plantilla CSV de ejemplo ")],-1))]),c("div",ze,[t(a(F),{for:"import_mode"},{default:l(()=>e[12]||(e[12]=[r("Modo de Importación")])),_:1}),t(a(L),{modelValue:a(s).import_mode,"onUpdate:modelValue":e[1]||(e[1]=o=>a(s).import_mode=o)},{default:l(()=>[t(a(O),null,{default:l(()=>[t(a(M),{placeholder:"Selecciona el modo"})]),_:1}),t(a(B),null,{default:l(()=>[(m(),g(E,null,T(G,o=>t(a(j),{key:o.value,value:o.value},{default:l(()=>[r(v(o.label),1)]),_:2},1032,["value"])),64))]),_:1})]),_:1},8,["modelValue"]),e[13]||(e[13]=c("p",{class:"text-sm text-muted-foreground"}," Define cómo manejar usuarios que ya existen en el sistema ",-1))]),c("div",Ee,[n.mode==="votacion"||n.mode==="asamblea"?(m(),y(a(k),{key:0,variant:"outline",onClick:e[2]||(e[2]=o=>z("cancel"))},{default:l(()=>e[14]||(e[14]=[r(" Cancelar ")])),_:1})):_("",!0),t(a(k),{onClick:J,disabled:!a(s).name||!C.value||x.value},{default:l(()=>[t(a(ge),{class:"mr-2 h-4 w-4"}),r(" "+v(x.value?"Analizando...":"Analizar CSV"),1)]),_:1},8,["disabled"])])])]),_:1}),t(a(D),{value:"mapping",class:"space-y-6"},{default:l(()=>[b.value?(m(),g("div",Te,[t(a(fe),{class:"mb-4"},{default:l(()=>[t(a(be),{class:"h-4 w-4"}),t(a(pe),null,{default:l(()=>[e[15]||(e[15]=r(" Se encontraron ")),c("strong",null,v(b.value.total_rows),1),e[16]||(e[16]=r(" registros. Los campos ")),e[17]||(e[17]=c("strong",null,"Nombre",-1)),e[18]||(e[18]=r(" y ")),e[19]||(e[19]=c("strong",null,"Email",-1)),e[20]||(e[20]=r(" son obligatorios. ")),n.mode==="votacion"?(m(),g("span",Fe," Los usuarios serán asignados automáticamente a la votación. ")):_("",!0),n.mode==="asamblea"?(m(),g("span",je," Los usuarios serán asignados automáticamente como participantes de la asamblea. ")):_("",!0)]),_:1})]),_:1}),c("div",Ne,[t(a(me),null,{default:l(()=>[t(a(ue),null,{default:l(()=>[t(a(P),null,{default:l(()=>[t(a(S),null,{default:l(()=>e[21]||(e[21]=[r("Columna del CSV")])),_:1}),t(a(S),null,{default:l(()=>e[22]||(e[22]=[r("Mapear a Campo")])),_:1}),a(s).import_mode!=="insert"?(m(),y(a(S),{key:0},{default:l(()=>e[23]||(e[23]=[r("Actualizar")])),_:1})):_("",!0),t(a(S),null,{default:l(()=>e[24]||(e[24]=[r("Vista Previa")])),_:1})]),_:1})]),_:1}),t(a(ce),null,{default:l(()=>[(m(!0),g(E,null,T(b.value.headers,o=>(m(),y(a(P),{key:o},{default:l(()=>[t(a(w),{class:"font-medium"},{default:l(()=>[r(v(o),1)]),_:2},1024),t(a(w),null,{default:l(()=>[t(a(L),{"model-value":a(s).field_mappings[o]||"none","onUpdate:modelValue":f=>Q(o,f)},{default:l(()=>[t(a(O),{class:"w-full"},{default:l(()=>[t(a(M))]),_:1}),t(a(B),null,{default:l(()=>[t(a(j),{value:"none"},{default:l(()=>e[25]||(e[25]=[r("-- No mapear --")])),_:1}),(m(!0),g(E,null,T(b.value.available_fields,(f,d)=>(m(),y(a(j),{key:d,value:d},{default:l(()=>[r(v(f),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:2},1032,["model-value","onUpdate:modelValue"])]),_:2},1024),a(s).import_mode!=="insert"?(m(),y(a(w),{key:0},{default:l(()=>[a(s).field_mappings[o]&&a(s).field_mappings[o]!=="none"?(m(),g("div",Ue,[a(s).field_mappings[o]==="email"||a(s).field_mappings[o]==="documento_identidad"?(m(),g("div",De," Resolución manual ")):(m(),y(a(de),{key:1,checked:a(s).update_fields.includes(a(s).field_mappings[o]),"onUpdate:checked":f=>Y(a(s).field_mappings[o],f)},null,8,["checked","onUpdate:checked"]))])):_("",!0)]),_:2},1024)):_("",!0),t(a(w),null,{default:l(()=>{var f;return[c("div",Ae,v(((f=b.value.sample_data[0])==null?void 0:f[b.value.headers.indexOf(o)])||"-"),1)]}),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),c("div",Le,[t(a(k),{variant:"outline",onClick:e[3]||(e[3]=o=>$.value="config")},{default:l(()=>e[26]||(e[26]=[r(" Volver a Configuración ")])),_:1}),c("div",Oe,[n.mode==="votacion"||n.mode==="asamblea"?(m(),y(a(k),{key:0,variant:"outline",onClick:e[4]||(e[4]=o=>z("cancel"))},{default:l(()=>e[27]||(e[27]=[r(" Cancelar ")])),_:1})):_("",!0),t(a(k),{onClick:Z,disabled:!h.value||a(s).processing},{default:l(()=>[r(v(a(s).processing?"Procesando...":"Iniciar Importación"),1)]),_:1},8,["disabled"])])])])):_("",!0)]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}))}});export{Ze as _};
