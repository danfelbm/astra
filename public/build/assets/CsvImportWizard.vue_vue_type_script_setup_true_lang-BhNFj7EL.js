import{d as ee,k as V,C as ae,c as S,j as y,o as u,e as o,i as p,b as t,u as e,g as r,t as _,a as v,f as m,n as N,F as E,r as j,W as se}from"./app-DqUUG6Uh.js";import{_ as oe,a as te,b as T,c as A}from"./TabsTrigger.vue_vue_type_script_setup_true_lang-qtcU2neu.js";import{a as le,b as ie,c as ne,_ as re}from"./CardTitle.vue_vue_type_script_setup_true_lang-BgMXDg7e.js";import{_ as k}from"./createLucideIcon-fihB36_E.js";import{_ as U,a as D}from"./Label.vue_vue_type_script_setup_true_lang-DBH3RslB.js";import{_ as O,a as M,b as B,c as L,d as F}from"./SelectValue.vue_vue_type_script_setup_true_lang-BfjlA0yq.js";import{_ as de}from"./Checkbox.vue_vue_type_script_setup_true_lang-DkxFB_ng.js";import{_ as ue,a as me,b as P,c as w,d as ce,e as I}from"./TableHeader.vue_vue_type_script_setup_true_lang-CKCyEF-F.js";import{_ as fe,a as pe}from"./index-CJkA0bOm.js";import{U as _e}from"./upload-_mDdVHoQ.js";import{G as ve}from"./git-branch-C43_4dus.js";import{F as ge}from"./index-BPAHaQmV.js";import{C as be}from"./index-Dv-N3nwb.js";const ye={key:0,class:"mb-4"},ke={class:"text-sm text-muted-foreground"},$e={class:"flex items-center gap-2"},Ce={class:"flex items-center gap-2"},xe={class:"space-y-4"},Ve={class:"space-y-2"},Se={key:0,class:"text-sm text-red-500"},we={class:"space-y-2"},Ie={key:0,class:"text-sm text-red-500"},ze={class:"space-y-2"},Ee={class:"flex justify-end gap-2"},je={key:0},Ue={key:0,class:"block mt-1"},Fe={class:"border rounded-lg overflow-x-auto"},Ne={key:0},Te={key:0,class:"text-sm text-muted-foreground italic"},Ae={class:"text-sm text-muted-foreground max-w-32 truncate"},De={class:"flex justify-between"},Oe={class:"flex gap-2"},Ye=ee({__name:"CsvImportWizard",props:{mode:{},votacionId:{},votacionTitulo:{},redirectOnSuccess:{type:Boolean,default:!0}},emits:["success","cancel"],setup(W,{emit:q}){const g=W,z=q,$=V("config"),C=V(null),b=V(null),l=ae({name:"",csv_file:null,import_mode:"both",field_mappings:{},update_fields:[],votacion_id:g.votacionId||null}),x=V(!1),G=S(()=>l.name&&l.csv_file&&l.import_mode&&b.value),R=[{value:"insert",label:"Solo añadir usuarios nuevos"},{value:"update",label:"Solo actualizar usuarios existentes"},{value:"both",label:"Añadir nuevos y actualizar existentes"}],H=S(()=>g.mode==="votacion"&&g.votacionTitulo?`Importar votantes para: ${g.votacionTitulo}`:"Nueva Importación CSV"),K=S(()=>g.mode==="votacion"?"Los usuarios importados serán asignados automáticamente a esta votación":"Importa usuarios desde un archivo CSV"),X=n=>{var c;const s=(c=n.target.files)==null?void 0:c[0];s&&(C.value=s,l.csv_file=s,b.value=null)},J=async()=>{var n;if(!(!C.value||!l.name.trim())){x.value=!0;try{const a=new FormData;a.append("csv_file",C.value);const s=await fetch("/admin/imports/analyze",{method:"POST",body:a,headers:{"X-CSRF-TOKEN":((n=document.querySelector('meta[name="csrf-token"]'))==null?void 0:n.getAttribute("content"))||""}}),c=await s.json();if(s.ok){b.value=c;const d={};c.headers.forEach(f=>{const i=f.toLowerCase().trim();i.includes("nombre")||i==="name"?d[f]="name":i.includes("email")||i.includes("correo")?d[f]="email":i.includes("documento")||i.includes("cedula")||i.includes("identification")?d[f]="documento_identidad":i==="tipo_documento"||i.includes("tipo")&&i.includes("doc")?d[f]="tipo_documento":i.includes("telefono")||i.includes("phone")?d[f]="telefono":i.includes("direccion")||i.includes("address")?d[f]="direccion":i==="territorio"||i==="territorio_id"?d[f]="territorio_id":i==="departamento"||i==="departamento_id"?d[f]="departamento_id":i==="municipio"||i==="municipio_id"?d[f]="municipio_id":i==="localidad"||i==="localidad_id"?d[f]="localidad_id":i==="cargo"||i==="cargo_id"?d[f]="cargo_id":i==="rol"||i==="role"?d[f]="rol":i==="activo"||i==="active"?d[f]="activo":(i==="es_miembro"||i==="miembro")&&(d[f]="es_miembro")}),l.field_mappings=d,g.mode==="votacion"&&!l.name&&(l.name=`Importación votantes - ${new Date().toLocaleDateString()}`),$.value="mapping"}else alert(c.error||"Error al analizar archivo")}catch(a){console.error("Error:",a),alert("Error al analizar archivo")}finally{x.value=!1}}},Q=(n,a)=>{const s=String(a);!s||s==="none"?delete l.field_mappings[n]:l.field_mappings[n]=s},Y=(n,a)=>{if(a)l.update_fields.includes(n)||l.update_fields.push(n);else{const s=l.update_fields.indexOf(n);s>-1&&l.update_fields.splice(s,1)}},Z=()=>{const n=g.mode==="votacion"?`/admin/votaciones/${g.votacionId}/imports/store`:"/admin/imports";l.post(n,{preserveScroll:!0,onSuccess:a=>{var c,d;const s=((c=a.props.import)==null?void 0:c.id)||((d=a.props.flash)==null?void 0:d.import_id);s&&(z("success",s),g.redirectOnSuccess&&se.get(`/admin/imports/${s}`))},onError:a=>{console.error("Error al crear importación:",a)}})},h=S(()=>{const n=Object.values(l.field_mappings),a=n.includes("name"),s=n.includes("email");return a&&s});return(n,a)=>(u(),y(e(re),null,{default:o(()=>[n.mode==="general"?(u(),y(e(le),{key:0},{default:o(()=>[t(e(ie),null,{default:o(()=>[r(_(H.value),1)]),_:1})]),_:1})):p("",!0),t(e(ne),{class:"p-6"},{default:o(()=>[n.mode==="votacion"?(u(),v("div",ye,[m("p",ke,_(K.value),1)])):p("",!0),t(e(oe),{modelValue:$.value,"onUpdate:modelValue":a[5]||(a[5]=s=>$.value=s),class:"w-full"},{default:o(()=>[t(e(te),{class:"grid w-full grid-cols-2"},{default:o(()=>[t(e(T),{value:"config"},{default:o(()=>[m("span",$e,[t(e(_e),{class:"h-4 w-4"}),a[6]||(a[6]=r(" Configuración "))])]),_:1}),t(e(T),{value:"mapping",disabled:!G.value},{default:o(()=>[m("span",Ce,[t(e(ve),{class:"h-4 w-4"}),a[7]||(a[7]=r(" Mapeo de Campos "))])]),_:1},8,["disabled"])]),_:1}),t(e(A),{value:"config",class:"space-y-6"},{default:o(()=>[m("div",xe,[m("div",Ve,[t(e(U),{for:"name"},{default:o(()=>a[8]||(a[8]=[r("Nombre de la Importación")])),_:1}),t(e(D),{id:"name",modelValue:e(l).name,"onUpdate:modelValue":a[0]||(a[0]=s=>e(l).name=s),placeholder:n.mode==="votacion"?"Ej: Votantes primera vuelta":"Ej: Importación militantes enero 2025",class:N({"border-red-500":e(l).errors.name})},null,8,["modelValue","placeholder","class"]),e(l).errors.name?(u(),v("p",Se,_(e(l).errors.name),1)):p("",!0)]),m("div",we,[t(e(U),{for:"csv_file"},{default:o(()=>a[9]||(a[9]=[r("Archivo CSV")])),_:1}),t(e(D),{id:"csv_file",type:"file",accept:".csv",onChange:X,class:N({"border-red-500":e(l).errors.csv_file})},null,8,["class"]),e(l).errors.csv_file?(u(),v("p",Ie,_(e(l).errors.csv_file),1)):p("",!0),a[10]||(a[10]=m("p",{class:"text-sm text-muted-foreground"}," El archivo debe contener al menos las columnas: nombre y email ",-1)),a[11]||(a[11]=m("p",{class:"text-sm text-blue-600"},[m("a",{href:"/ejemplo-usuarios.csv",download:"",class:"underline"}," 📥 Descargar plantilla CSV de ejemplo ")],-1))]),m("div",ze,[t(e(U),{for:"import_mode"},{default:o(()=>a[12]||(a[12]=[r("Modo de Importación")])),_:1}),t(e(O),{modelValue:e(l).import_mode,"onUpdate:modelValue":a[1]||(a[1]=s=>e(l).import_mode=s)},{default:o(()=>[t(e(M),null,{default:o(()=>[t(e(B),{placeholder:"Selecciona el modo"})]),_:1}),t(e(L),null,{default:o(()=>[(u(),v(E,null,j(R,s=>t(e(F),{key:s.value,value:s.value},{default:o(()=>[r(_(s.label),1)]),_:2},1032,["value"])),64))]),_:1})]),_:1},8,["modelValue"]),a[13]||(a[13]=m("p",{class:"text-sm text-muted-foreground"}," Define cómo manejar usuarios que ya existen en el sistema ",-1))]),m("div",Ee,[n.mode==="votacion"?(u(),y(e(k),{key:0,variant:"outline",onClick:a[2]||(a[2]=s=>z("cancel"))},{default:o(()=>a[14]||(a[14]=[r(" Cancelar ")])),_:1})):p("",!0),t(e(k),{onClick:J,disabled:!e(l).name||!C.value||x.value},{default:o(()=>[t(e(ge),{class:"mr-2 h-4 w-4"}),r(" "+_(x.value?"Analizando...":"Analizar CSV"),1)]),_:1},8,["disabled"])])])]),_:1}),t(e(A),{value:"mapping",class:"space-y-6"},{default:o(()=>[b.value?(u(),v("div",je,[t(e(fe),{class:"mb-4"},{default:o(()=>[t(e(be),{class:"h-4 w-4"}),t(e(pe),null,{default:o(()=>[a[15]||(a[15]=r(" Se encontraron ")),m("strong",null,_(b.value.total_rows),1),a[16]||(a[16]=r(" registros. Los campos ")),a[17]||(a[17]=m("strong",null,"Nombre",-1)),a[18]||(a[18]=r(" y ")),a[19]||(a[19]=m("strong",null,"Email",-1)),a[20]||(a[20]=r(" son obligatorios. ")),n.mode==="votacion"?(u(),v("span",Ue," Los usuarios serán asignados automáticamente a la votación. ")):p("",!0)]),_:1})]),_:1}),m("div",Fe,[t(e(ue),null,{default:o(()=>[t(e(me),null,{default:o(()=>[t(e(P),null,{default:o(()=>[t(e(w),null,{default:o(()=>a[21]||(a[21]=[r("Columna del CSV")])),_:1}),t(e(w),null,{default:o(()=>a[22]||(a[22]=[r("Mapear a Campo")])),_:1}),e(l).import_mode!=="insert"?(u(),y(e(w),{key:0},{default:o(()=>a[23]||(a[23]=[r("Actualizar")])),_:1})):p("",!0),t(e(w),null,{default:o(()=>a[24]||(a[24]=[r("Vista Previa")])),_:1})]),_:1})]),_:1}),t(e(ce),null,{default:o(()=>[(u(!0),v(E,null,j(b.value.headers,s=>(u(),y(e(P),{key:s},{default:o(()=>[t(e(I),{class:"font-medium"},{default:o(()=>[r(_(s),1)]),_:2},1024),t(e(I),null,{default:o(()=>[t(e(O),{"model-value":e(l).field_mappings[s]||"none","onUpdate:modelValue":c=>Q(s,c)},{default:o(()=>[t(e(M),{class:"w-full"},{default:o(()=>[t(e(B))]),_:1}),t(e(L),null,{default:o(()=>[t(e(F),{value:"none"},{default:o(()=>a[25]||(a[25]=[r("-- No mapear --")])),_:1}),(u(!0),v(E,null,j(b.value.available_fields,(c,d)=>(u(),y(e(F),{key:d,value:d},{default:o(()=>[r(_(c),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:2},1032,["model-value","onUpdate:modelValue"])]),_:2},1024),e(l).import_mode!=="insert"?(u(),y(e(I),{key:0},{default:o(()=>[e(l).field_mappings[s]&&e(l).field_mappings[s]!=="none"?(u(),v("div",Ne,[e(l).field_mappings[s]==="email"||e(l).field_mappings[s]==="documento_identidad"?(u(),v("div",Te," Resolución manual ")):(u(),y(e(de),{key:1,checked:e(l).update_fields.includes(e(l).field_mappings[s]),"onUpdate:checked":c=>Y(e(l).field_mappings[s],c)},null,8,["checked","onUpdate:checked"]))])):p("",!0)]),_:2},1024)):p("",!0),t(e(I),null,{default:o(()=>{var c;return[m("div",Ae,_(((c=b.value.sample_data[0])==null?void 0:c[b.value.headers.indexOf(s)])||"-"),1)]}),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),m("div",De,[t(e(k),{variant:"outline",onClick:a[3]||(a[3]=s=>$.value="config")},{default:o(()=>a[26]||(a[26]=[r(" Volver a Configuración ")])),_:1}),m("div",Oe,[n.mode==="votacion"?(u(),y(e(k),{key:0,variant:"outline",onClick:a[4]||(a[4]=s=>z("cancel"))},{default:o(()=>a[27]||(a[27]=[r(" Cancelar ")])),_:1})):p("",!0),t(e(k),{onClick:Z,disabled:!h.value||e(l).processing},{default:o(()=>[r(_(e(l).processing?"Procesando...":"Iniciar Importación"),1)]),_:1},8,["disabled"])])])])):p("",!0)]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}))}});export{Ye as _};
