import{d as ye,u as we,r as h,c as B,p as ke,o as Se,B as $e,i as u,e as i,f as e,q as Ce,w as l,g as r,b as x,j as g,m as n,t as p,h as v,F as S,k as z,x as Z,a7 as Ee,R as je}from"./app-DT0SERA6.js";import{_ as Te}from"./UserLayout.vue_vue_type_script_setup_true_lang-D9dqVqq7.js";import{_ as Ve,a as Fe,b as Ae,c as De}from"./CardTitle.vue_vue_type_script_setup_true_lang-BDp8Jyga.js";import{_ as ee}from"./CardDescription.vue_vue_type_script_setup_true_lang-BLJDHFNu.js";import{_ as $}from"./createLucideIcon-D4eqIL-7.js";import{_ as E}from"./Label.vue_vue_type_script_setup_true_lang-C-LfjaMp.js";import{_ as Be}from"./Textarea.vue_vue_type_script_setup_true_lang-BG3KDCQf.js";import{_ as Ne,a as ze,b as Oe,c as Me,d as Ie}from"./SelectValue.vue_vue_type_script_setup_true_lang-BpLTO_Fk.js";import{_ as Ue}from"./Checkbox.vue_vue_type_script_setup_true_lang-r6-WqLc5.js";import{_ as Ge}from"./Progress.vue_vue_type_script_setup_true_lang-DdMVLt2D.js";import{_ as Pe}from"./index-COqFhz_u.js";import{_ as Re}from"./FileUploadField.vue_vue_type_script_setup_true_lang-BgFJL2y-.js";import{u as We}from"./useAutoSave-DW9-1Ovx.js";import{u as Le}from"./useFileUpload-CuJX_mx4.js";import{t as f}from"./index-DQIoP908.js";import{F as G}from"./file-text-BmX4rZ_q.js";import{M as P}from"./music-VaJ22ASB.js";import{V as R}from"./video-2MB2bKUA.js";import{I as W}from"./image-BY-ByD_U.js";import{C as oe}from"./clock-C3Wb5EQw.js";import{C as te}from"./circle-check-big-DUQ7xPC9.js";import{C as qe}from"./circle-alert-BAB4EMBM.js";import{C as He}from"./camera-DvFN7jQs.js";import{T as Ke}from"./trash-2-B9JUSulB.js";import{S as Je}from"./save-D4mgBthl.js";import{_ as Qe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./useFlashMessages-DALYGju6.js";import"./index-BMuRvwFI.js";import"./floating-ui.vue-C_794pPk.js";import"./x-PAZqFLMZ.js";import"./Input.vue_vue_type_script_setup_true_lang-DYhXX8kY.js";import"./index-BkdycJFx.js";import"./index-BTaHOvJu.js";import"./shield-BXba9qg9.js";import"./user-DYqF3qdc.js";import"./DropdownMenuTrigger.vue_vue_type_script_setup_true_lang-B2FJ08Y-.js";import"./chevron-right-VBTxcZsx.js";import"./DialogTitle.vue_vue_type_script_setup_true_lang-DNpAjCPv.js";import"./VisuallyHidden-C-vWMVD8.js";import"./GeographicSelector.vue_vue_type_script_setup_true_lang-oxAxqqVn.js";import"./map-pin-CGJx4hhK.js";import"./AppLogo.vue_vue_type_script_setup_true_lang-C06kIXfd.js";import"./ellipsis-uPAR5e4O.js";import"./usePermissions-CnVVJssp.js";import"./square-check-big-C9W7SzaP.js";import"./users-qhStRoah.js";import"./folder-open-BkNsL0cC.js";import"./index-CjxZrtgj.js";import"./check-vqihQ8Gi.js";import"./upload-CRwMkySK.js";import"./file-CYZqGsRR.js";import"./eye-ComCEHnm.js";import"./download-DJg7m3Hv.js";import"./debounce-BTMGkFAs.js";const Xe={class:"flex h-full flex-1 flex-col gap-4 rounded-xl p-0 sm:p-4 pb-24"},Ye={class:"flex items-center justify-end gap-2 text-sm text-muted-foreground"},Ze={key:0,class:"flex items-center gap-1.5"},eo={key:1,class:"flex items-center gap-1.5"},oo={key:2,class:"flex items-center gap-1.5 text-amber-600"},to={class:"space-y-2"},ao={key:0,class:"text-sm text-destructive"},so={class:"space-y-2"},io={class:"grid grid-cols-2 md:grid-cols-4 gap-4"},ro={key:0,class:"text-sm text-destructive"},no={key:0,class:"space-y-2"},lo={key:0,class:"mb-4 p-4 border rounded-lg bg-muted/50"},co={class:"flex items-center justify-between mb-2"},uo={class:"grid grid-cols-2 md:grid-cols-4 gap-2"},mo={class:"text-xs"},po={key:1,class:"space-y-4"},vo={class:"flex gap-2"},fo=["srcObject"],_o={class:"space-y-2"},ho={class:"space-y-2 max-h-60 overflow-y-auto border rounded-lg p-4"},go={class:"flex-1"},bo={class:"text-muted-foreground text-xs"},xo={class:"space-y-2"},yo={key:0,class:"text-sm text-destructive"},wo={class:"fixed bottom-0 left-0 right-0 z-50 px-2 sm:px-4 pb-2 sm:pb-4"},ko={class:"mx-auto max-w-7xl"},So={class:"backdrop-blur-lg bg-tertiary-60 dark:bg-gray-900/80 border border-gray-200/50 dark:border-gray-700/50 rounded-xl sm:rounded-2xl shadow-2xl p-3 sm:p-4"},$o={class:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4"},Co={class:"hidden sm:flex items-center"},Eo={class:"flex-1 sm:max-w-xs lg:max-w-sm mx-0 sm:mx-4"},jo={class:"flex items-center gap-3"},To={class:"text-xs sm:text-sm text-muted-foreground whitespace-nowrap font-medium"},Vo={class:"flex items-center gap-2 sm:gap-3"},Fo=ye({__name:"Create",props:{contrato:{},obligaciones:{},entregables:{},tiposEvidencia:{}},setup(j){const T=j,ae=[{title:"Dashboard",href:"/miembro/dashboard"},{title:"Mis Contratos",href:"/miembro/mis-contratos"},{title:T.contrato.nombre,href:`/miembro/mis-contratos/${T.contrato.id}`},{title:"Subir Evidencia",href:"#"}],{uploadFiles:L}=Le(),o=we({obligacion_id:null,tipo_evidencia:null,archivo_path:null,archivo_nombre:null,archivos_paths:[],archivos_nombres:[],tipos_archivos:null,descripcion:null,entregable_ids:[],metadata:null}),V=h([]),y=h({imagen:{paths:[],nombres:[],count:0},video:{paths:[],nombres:[],count:0},audio:{paths:[],nombres:[],count:0},documento:{paths:[],nombres:[],count:0}}),se=h(null),b=h(!1),C=h(null),F=h(null),w=h(null),A=h(null),ie=h(null),re=B(()=>o.data()),{state:ne,isSaving:O,hasSaved:le,hasError:q,saveNow:ce,startWatching:H,stopAutoSave:K,restoreDraft:de,clearLocalStorage:J}=We(re,{url:`/miembro/mis-contratos/${T.contrato.id}/evidencias/autosave`,debounceTime:3e3,showNotifications:!0,useLocalStorage:!0,localStorageKey:`evidencia_draft_contrato_${T.contrato.id}`}),ue=B(()=>{const a={imagen:{icon:W,accept:"image/*",capture:"environment",maxSize:10485760},video:{icon:R,accept:"video/*",capture:"environment",maxSize:524288e3},audio:{icon:P,accept:"audio/*",capture:!1,maxSize:52428800},documento:{icon:G,accept:".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.rtf",capture:!1,maxSize:20971520}};return o.tipo_evidencia?a[o.tipo_evidencia]:null}),M=B(()=>{const t=[o.obligacion_id,o.tipo_evidencia,o.archivo_path,o.descripcion,o.entregable_ids.length>0].filter(Boolean).length,d=Math.round(t/5*100);return{llenos:t,total:5,porcentaje:d}});ke(()=>o.tipo_evidencia,a=>{a&&(se.value=a,b.value&&D())});const me=a=>{const t=a.type;return t.startsWith("image/")?"imagen":t.startsWith("video/")?"video":t.startsWith("audio/")?"audio":"documento"},Q=()=>{const a=[],t=[],d={};if(Object.entries(y.value).forEach(([m,s])=>{s.paths.forEach((c,_)=>{a.push(c),t.push(s.nombres[_]),d[c]=m})}),o.archivos_paths=a,o.archivos_nombres=t,o.tipos_archivos=d,a.length>0&&!o.archivo_path&&(o.archivo_path=a[0],o.archivo_nombre=t[0]),V.value=a,Object.keys(d).length>0){const m=Object.values(d).reduce((c,_)=>(c[_]=(c[_]||0)+1,c),{}),s=Object.entries(m).reduce((c,_)=>c[1]>_[1]?c:_)[0];o.tipo_evidencia=s}},k=B(()=>Object.values(y.value).reduce((a,t)=>a+t.count,0)),pe=()=>{y.value={imagen:{paths:[],nombres:[],count:0},video:{paths:[],nombres:[],count:0},audio:{paths:[],nombres:[],count:0},documento:{paths:[],nombres:[],count:0}},o.archivos_paths=[],o.archivos_nombres=[],o.tipos_archivos=null,o.archivo_path=null,o.archivo_nombre=null,V.value=[],f.info("Todos los archivos han sido eliminados")},X=B(()=>o.obligacion_id&&o.tipo_evidencia&&(k.value>0||ie.value||A.value)),ve=async()=>{if(!o.tipo_evidencia||o.tipo_evidencia==="documento"){f.error("No se puede capturar este tipo de evidencia");return}try{b.value=!0;const a={video:o.tipo_evidencia==="imagen"||o.tipo_evidencia==="video",audio:o.tipo_evidencia==="audio"||o.tipo_evidencia==="video"};if(C.value=await navigator.mediaDevices.getUserMedia(a),o.tipo_evidencia==="audio"||o.tipo_evidencia==="video"){w.value=new MediaRecorder(C.value);const t=[];w.value.ondataavailable=d=>{t.push(d.data)},w.value.onstop=()=>{const d=new Blob(t,{type:o.tipo_evidencia==="audio"?"audio/webm":"video/webm"});A.value=d,Y(d)},w.value.start(),f.info("Grabación iniciada")}}catch(a){console.error("Error al iniciar captura:",a),f.error("No se pudo acceder a la cámara/micrófono"),b.value=!1}},D=()=>{C.value&&(C.value.getTracks().forEach(a=>a.stop()),C.value=null),w.value&&w.value.state==="recording"&&w.value.stop(),b.value=!1},fe=()=>{if(!F.value)return;const a=document.createElement("canvas");a.width=F.value.videoWidth,a.height=F.value.videoHeight;const t=a.getContext("2d");t&&(t.drawImage(F.value,0,0),a.toBlob(d=>{d&&(A.value=d,Y(d),D())},"image/jpeg",.95))},Y=async a=>{const t=`captura_${Date.now()}.${_e(a.type)}`,d=new File([a],t,{type:a.type});A.value=a,o.archivo_nombre=t,o.metadata={mime_type:a.type,size:a.size,captured_at:new Date().toISOString()};try{f.info("Subiendo archivo capturado...");const m=await L([d],{module:"evidencias",fieldId:o.tipo_evidencia||"archivo",onProgress:(s,c)=>{}});m.length>0&&(o.archivo_path=m[0].path,o.archivo_nombre=m[0].name,o.metadata=m[0].metadata,V.value=[m[0].path],A.value=null,f.success("Archivo subido exitosamente"))}catch(m){console.error("Error al subir archivo capturado:",m),f.error("Error al subir el archivo capturado")}},_e=a=>({"image/jpeg":"jpg","image/png":"png","image/webp":"webp","video/webm":"webm","audio/webm":"webm"})[a]||"bin",he=async a=>{if(a.length>0){const t=k.value,d=a.length;if(t+d>10){f.error(`No puedes subir más de 10 archivos. Actualmente tienes ${t} archivo(s).`);return}const m={imagen:[],video:[],audio:[],documento:[]};a.forEach(s=>{const c=me(s);m[c].push(s)});try{let s=0;for(const[c,_]of Object.entries(m)){if(_.length===0)continue;f.info(`Subiendo ${_.length} archivo(s) de tipo ${c}...`);const I=await L(_,{module:"evidencias",fieldId:c,onProgress:(N,U)=>{}});if(I.length>0){const N=c;I.forEach(U=>{y.value[N].paths.push(U.path),y.value[N].nombres.push(U.name),y.value[N].count++}),s+=I.length}}s>0&&(Q(),f.success(`${s} archivo(s) subido(s) exitosamente. Total: ${k.value}/10`))}catch(s){console.error("Error al subir archivos:",s),f.error("Error al subir archivos")}}},ge=async()=>{await ce(),f.success("Borrador guardado")},be=async()=>{if(X.value){if(k.value===0&&!o.archivo_path){f.error("Por favor seleccione o capture al menos un archivo");return}Q(),K(),o.post(`/miembro/mis-contratos/${T.contrato.id}/evidencias`,{onSuccess:()=>{J(),f.success(`Evidencia subida exitosamente con ${o.archivos_paths.length} archivo(s)`)},onError:a=>{console.error("Errores de validación:",a),H()}})}},xe=()=>{confirm("¿Estás seguro de descartar el borrador? Se perderán todos los cambios no enviados.")&&(J(),o.reset(),pe(),b.value&&D(),f.success("Borrador descartado"))};return Se(()=>{const a=de();a&&a.data&&Object.assign(o,a.data),H()}),$e(()=>{K(),D()}),(a,t)=>(n(),u(S,null,[i(e(Ce),{title:`Subir Evidencia - ${j.contrato.nombre}`},null,8,["title"]),i(Te,{breadcrumbs:ae},{default:l(()=>{var d;return[r("div",Xe,[r("div",Ye,[e(O)?(n(),u("div",Ze,[i(e(oe),{class:"h-4 w-4 animate-spin"}),t[3]||(t[3]=r("span",null,"Guardando automáticamente...",-1))])):e(le)&&!e(q)?(n(),u("div",eo,[i(e(te),{class:"h-4 w-4 text-green-600"}),r("span",null,"Guardado a las "+p((d=e(ne).lastSaved)==null?void 0:d.toLocaleTimeString()),1)])):e(q)?(n(),u("div",oo,[i(e(qe),{class:"h-4 w-4"}),t[4]||(t[4]=r("span",null,"Guardado localmente",-1))])):g("",!0)]),i(e(Ve),null,{default:l(()=>[i(e(Fe),null,{default:l(()=>[i(e(Ae),null,{default:l(()=>[...t[5]||(t[5]=[v("Información de la Evidencia",-1)])]),_:1}),i(e(ee),null,{default:l(()=>[...t[6]||(t[6]=[v(" Selecciona la obligación, el tipo de evidencia y adjunta el archivo correspondiente ",-1)])]),_:1})]),_:1}),i(e(De),{class:"space-y-6 sm:mb-16"},{default:l(()=>{var m;return[r("div",to,[i(e(E),{htmlFor:"obligacion"},{default:l(()=>[...t[7]||(t[7]=[v("Obligación *",-1)])]),_:1}),i(e(Ne),{modelValue:e(o).obligacion_id,"onUpdate:modelValue":t[0]||(t[0]=s=>e(o).obligacion_id=s)},{default:l(()=>[i(e(ze),null,{default:l(()=>[i(e(Oe),{placeholder:"Selecciona una obligación"})]),_:1}),i(e(Me),null,{default:l(()=>[(n(!0),u(S,null,z(j.obligaciones,s=>(n(),x(e(Ie),{key:s.id,value:s.id},{default:l(()=>[v(p(s.titulo),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"]),e(o).errors.obligacion_id?(n(),u("p",ao,p(e(o).errors.obligacion_id),1)):g("",!0)]),r("div",so,[i(e(E),null,{default:l(()=>[...t[8]||(t[8]=[v("Tipo de Evidencia *",-1)])]),_:1}),r("div",io,[(n(!0),u(S,null,z(j.tiposEvidencia,s=>(n(),x(e($),{key:s.value,onClick:c=>e(o).tipo_evidencia=s.value,variant:e(o).tipo_evidencia===s.value?"default":"outline",class:"h-20 flex flex-col gap-2"},{default:l(()=>[(n(),x(Z(s.value==="imagen"?e(W):s.value==="video"?e(R):s.value==="audio"?e(P):e(G)),{class:"h-6 w-6"})),r("span",null,p(s.label),1)]),_:2},1032,["onClick","variant"]))),128))]),e(o).errors.tipo_evidencia?(n(),u("p",ro,p(e(o).errors.tipo_evidencia),1)):g("",!0)]),e(o).tipo_evidencia?(n(),u("div",no,[i(e(E),null,{default:l(()=>[...t[9]||(t[9]=[v("Archivo de Evidencia *",-1)])]),_:1}),k.value>0?(n(),u("div",lo,[r("div",co,[t[10]||(t[10]=r("span",{class:"text-sm font-medium"},"Archivos subidos",-1)),i(e(Pe),{variant:"outline"},{default:l(()=>[v(p(k.value)+"/10",1)]),_:1})]),r("div",uo,[(n(!0),u(S,null,z(y.value,(s,c)=>(n(),u("div",{key:c,class:"flex items-center gap-2"},[(n(),x(Z(c==="imagen"?e(W):c==="video"?e(R):c==="audio"?e(P):e(G)),{class:"h-4 w-4 text-muted-foreground"})),r("span",mo,p(s.count)+" "+p(c),1)]))),128))])])):g("",!0),e(o).tipo_evidencia!=="documento"?(n(),u("div",po,[r("div",vo,[b.value?(n(),x(e($),{key:1,onClick:D,variant:"destructive",class:"flex-1"},{default:l(()=>[...t[11]||(t[11]=[v(" Detener ",-1)])]),_:1})):(n(),x(e($),{key:0,onClick:ve,variant:"outline",class:"flex-1"},{default:l(()=>[i(e(He),{class:"mr-2 h-4 w-4"}),v(" "+p(e(o).tipo_evidencia==="audio"?"Grabar Audio":"Capturar"),1)]),_:1}))]),b.value&&(e(o).tipo_evidencia==="imagen"||e(o).tipo_evidencia==="video")?(n(),u("video",{key:0,ref_key:"videoElement",ref:F,srcObject:C.value,autoplay:"",playsinline:"",muted:"",class:"w-full rounded-lg border"},null,8,fo)):g("",!0),b.value&&e(o).tipo_evidencia==="imagen"?(n(),x(e($),{key:1,onClick:fe,class:"w-full"},{default:l(()=>[...t[12]||(t[12]=[v(" Tomar Foto ",-1)])]),_:1})):g("",!0)])):g("",!0),i(Re,{modelValue:V.value,"onUpdate:modelValue":t[1]||(t[1]=s=>V.value=s),onFilesSelected:he,label:"",description:`Selecciona archivos desde tu dispositivo (${k.value}/10 archivos)`,required:!0,multiple:!0,"max-files":10,"max-file-size":(m=ue.value)==null?void 0:m.maxSize,accept:"image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx",error:e(o).errors.archivo_path||e(o).errors.archivos_paths,disabled:e(o).processing,module:"evidencias","field-id":e(o).tipo_evidencia||"archivo","auto-upload":!1},null,8,["modelValue","description","max-file-size","error","disabled","field-id"])])):g("",!0),r("div",_o,[i(e(E),null,{default:l(()=>[...t[13]||(t[13]=[v("Entregables Relacionados",-1)])]),_:1}),i(e(ee),null,{default:l(()=>[...t[14]||(t[14]=[v(" Selecciona los entregables del proyecto que se relacionan con esta evidencia ",-1)])]),_:1}),r("div",ho,[(n(!0),u(S,null,z(j.entregables,s=>(n(),u("div",{key:s.id,class:"flex items-start space-x-3"},[i(e(Ue),{id:`entregable-${s.id}`,checked:e(o).entregable_ids.includes(s.id),"onUpdate:checked":c=>{c?e(o).entregable_ids.push(s.id):e(o).entregable_ids=e(o).entregable_ids.filter(_=>_!==s.id)}},null,8,["id","checked","onUpdate:checked"]),r("div",go,[i(e(E),{for:`entregable-${s.id}`,class:"text-sm font-normal cursor-pointer flex flex-col items-start sm:flex-row sm:flex-wrap sm:items-center sm:gap-x-2"},{default:l(()=>[r("span",null,p(s.nombre),1),r("span",bo," Hito: "+p(s.hito)+p(s.fecha_fin?` • Vence: ${s.fecha_fin}`:""),1)]),_:2},1032,["for"])])]))),128))])]),r("div",xo,[i(e(E),{htmlFor:"descripcion"},{default:l(()=>[...t[15]||(t[15]=[v("Descripción",-1)])]),_:1}),i(e(Be),{id:"descripcion",modelValue:e(o).descripcion,"onUpdate:modelValue":t[2]||(t[2]=s=>e(o).descripcion=s),placeholder:"Describe brevemente la evidencia adjuntada",rows:"3"},null,8,["modelValue"]),e(o).errors.descripcion?(n(),u("p",yo,p(e(o).errors.descripcion),1)):g("",!0)])]}),_:1})]),_:1})]),(n(),x(Ee,{to:"body"},[i(je,{name:"slide-up"},{default:l(()=>[r("div",wo,[r("div",ko,[r("div",So,[r("div",$o,[r("div",Co,[i(e($),{variant:"outline",type:"button",onClick:xe,class:"backdrop-blur-sm flex-shrink-0 text-xs sm:text-sm py-2 px-3 text-destructive hover:text-destructive"},{default:l(()=>[i(e(Ke),{class:"h-4 w-4"}),t[16]||(t[16]=r("span",{class:"ml-2"},"Descartar borrador",-1))]),_:1})]),r("div",Eo,[r("div",jo,[i(e(Ge),{modelValue:M.value.porcentaje,class:"flex-1"},null,8,["modelValue"]),r("span",To,p(M.value.llenos)+" / "+p(M.value.total),1)]),t[17]||(t[17]=r("p",{class:"text-xs text-muted-foreground mt-1 text-center hidden sm:block"}," Campos completados ",-1))]),r("div",Vo,[i(e($),{onClick:ge,disabled:e(O),variant:"outline",class:"backdrop-blur-sm flex-1 sm:flex-none text-xs sm:text-sm py-2 px-3"},{default:l(()=>[e(O)?(n(),u(S,{key:0},[i(e(oe),{class:"mr-2 h-4 w-4 animate-spin"}),t[18]||(t[18]=v(" Guardando... ",-1))],64)):(n(),u(S,{key:1},[i(e(Je),{class:"mr-2 h-4 w-4"}),t[19]||(t[19]=v(" Guardar borrador ",-1))],64))]),_:1},8,["disabled"]),i(e($),{onClick:be,disabled:!X.value||e(o).processing,class:"bg-green-600 hover:bg-green-700 text-white border-green-600 hover:border-green-700 disabled:bg-gray-400 disabled:border-gray-400 flex-1 sm:flex-none text-xs sm:text-sm py-2 px-3"},{default:l(()=>[i(e(te),{class:"h-4 w-4"}),t[20]||(t[20]=r("span",{class:"ml-2 whitespace-nowrap"},"Subir Evidencia",-1))]),_:1},8,["disabled"])])])])])])]),_:1})]))]}),_:1})],64))}}),At=Qe(Fo,[["__scopeId","data-v-cfd9ac08"]]);export{At as default};
